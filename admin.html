<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://telegram.org https://fonts.googleapis.com https://fonts.gstatic.com https://cdn4.telesco.pe https://cdn*.telesco.pe https://*.telesco.pe data:; img-src 'self' data: https: http: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://telegram.org; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com;">
  <title>‚öôÔ∏è –ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- –®—Ä–∏—Ñ—Ç –¥–ª—è —Ç–µ–º—ã Mario -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <!-- –ì–æ—Ç–∏—á–µ—Å–∫–∏–π —à—Ä–∏—Ñ—Ç –¥–ª—è —Ç–µ–º—ã Attack on Titan -->
  <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Nosifer&family=UnifrakturMaguntia&display=swap" rel="stylesheet">

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      if (window.Telegram?.WebApp) {
        console.log('‚úÖ Telegram WebApp –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
        Telegram.WebApp.expand();
        Telegram.WebApp.ready();
        console.log('‚úÖ Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        console.log('üì± –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:', Telegram.WebApp.platform);
        console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', Telegram.WebApp.initDataUnsafe?.user);
      } else {
        console.warn('‚ö†Ô∏è Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        console.warn('üí° –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –æ–ø–ª–∞—Ç—ã –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –≤ Telegram');
        console.warn('üí° –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç–µ —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º');
      }
    });
  </script>

  <style>
    /* üíß Ripple —ç—Ñ—Ñ–µ–∫—Ç */
    .ripple {
      position: absolute;
      border-radius: 50%;
      transform: scale(0);
      animation: ripple 0.6s linear;
      background: rgba(255, 255, 255, 0.4);
      pointer-events: none;
    }

    @keyframes ripple {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }

    /* üéØ –ö—Ä—É—Ç–∏–ª–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π */
    @keyframes spinUp {
      from { transform: translateY(80px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes spinDown {
      from { transform: translateY(-80px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .number-spin-up {
      animation: spinUp 0.3s ease-out;
    }
    
    .number-spin-down {
      animation: spinDown 0.3s ease-out;
    }
    
    /* üîÑ –ê–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ä–µ—Ä–æ–ª–ª–∞ */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä—Å–æ–≤ */
    .contest-confirmed {
      opacity: 0.8;
      pointer-events: none;
    }

    /* üì± –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
    #contest-modal,
    #contest-type-modal,
    #prizes-modal {
      /* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª –¥–∞–∂–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ */
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      /* –ó–∞–ø—Ä–µ—â–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
      overflow-x: hidden !important;
      overflow-y: auto !important;
      /* –ó–∞–ø—Ä–µ—â–∞–µ–º zoom */
      touch-action: pan-y;
      /* –§–∏–∫—Å–∏—Ä—É–µ–º —à–∏—Ä–∏–Ω—É –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ */
      max-width: 100vw;
      width: 100%;
    }
    
    #contest-modal > div,
    #contest-type-modal > div,
    #prizes-modal > div {
      /* –ü–æ–∑–≤–æ–ª—è–µ–º —Å–∫—Ä–æ–ª–ª–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏ —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ */
      overscroll-behavior: contain;
      overflow-x: hidden !important;
      overflow-y: auto !important;
      /* –ó–∞–ø—Ä–µ—â–∞–µ–º zoom */
      touch-action: pan-y;
      /* –§–∏–∫—Å–∏—Ä—É–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É */
      max-width: 100%;
      width: 100%;
    }
    
    @media (max-height: 600px) {
      /* –ö–æ–≥–¥–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –æ—Ç–∫—Ä—ã—Ç–∞, —É–º–µ–Ω—å—à–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É */
      #contest-modal > div,
      #prizes-modal > div {
        max-height: calc(100vh - 2rem);
      }
    }
    
    /* –ó–∞–ø—Ä–µ—Ç zoom –¥–ª—è –≤—Å–µ–≥–æ body –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –º–æ–¥–∞–ª–∫–∞—Ö */
    body.modal-open {
      overflow: hidden;
      touch-action: pan-y;
      position: fixed;
      width: 100%;
      height: 100%;
    }

    /* üåô –¢–µ–º—ã */
    .theme-default { background-color: #111827; color: white; }
    .theme-newyear { background: linear-gradient(180deg, #002b5c, #0077ff); color: #fff; }
    .theme-halloween { background: linear-gradient(180deg, #2b0000, #ff6a00); color: #fff; }

    /* üü£ Black + Neon Purple global theme */
    :root {
      --neon-purple-1: #7c3aed; /* violet-600 */
      --neon-purple-2: #8b5cf6; /* violet-500 */
      --neon-purple-3: #a78bfa; /* violet-400 */
      --neon-pink: #ec4899;     /* pink-500 */
      --neon-white: #ffffff;
      --neon-bg: #000000;
      --text-primary: #e5e7eb;
    }

    .page-dark { background-color: var(--neon-bg); color: var(--text-primary); }

    /* –°–∫—Ä—ã—Ç–∏–µ —Å–ø–∏–Ω–Ω–µ—Ä–∞ —É input[type="number"] */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      appearance: none;
      margin: 0;
    }
    
    input[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    @keyframes neonFlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Liquid flow animations for multi-layer backgrounds */
    @keyframes liquidDown {
      0%   { background-position: center 0%, center 100%, center 50%; }
      50%  { background-position: center 100%, center 0%, center 0%; }
      100% { background-position: center 0%, center 100%, center 50%; }
    }
    @keyframes liquidUp {
      0%   { background-position: center 100%, center 0%, center 50%; }
      50%  { background-position: center 0%, center 100%, center 100%; }
      100% { background-position: center 100%, center 0%, center 50%; }
    }
    @keyframes liquidHorizontal {
      0%   { background-position: 0% center, 100% center, 50% center; }
      50%  { background-position: 100% center, 0% center, 0% center; }
      100% { background-position: 0% center, 100% center, 50% center; }
    }

    /* Text-flow like gradient for side bars */
    @keyframes sideflow {
      from { background-position: center 0%; }
      to { background-position: center 200%; }
    }
    @keyframes sideflowReverse {
      from { background-position: center 200%; }
      to { background-position: center 0%; }
    }

    /* ‚ú® Neon side stripes */
    .neon-sides::before,
    .neon-sides::after {
      content: "";
      position: fixed;
      top: 3vh;
      bottom: 96px; /* extend and connect with lifted bottom bar */
      width: 4px; /* even thinner */
      border-radius: 9999px;
      background: linear-gradient(180deg,
        var(--neon-purple-1) 0%,
        var(--neon-purple-1) 25%,
        var(--neon-pink) 55%,
        var(--neon-white) 85%,
        var(--neon-purple-1) 100%
      );
      background-size: 100% 250%;
      box-shadow:
        0 0 12px rgba(167, 139, 250, 0.6),
        0 0 28px rgba(139, 92, 246, 0.45),
        inset 0 0 16px rgba(167, 139, 250, 0.35);
      z-index: 5;
      pointer-events: none;
    }

    .neon-sides::before { left: 10px; animation: sideflow 5s linear infinite; }
    .neon-sides::after { right: 10px; animation: sideflowReverse 5s linear infinite; }

    /* üîª Bottom neon shimmer bar */
    .neon-bottom {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 86px;
      display: flex;
      align-items: center;
      justify-content: center;
      background:
        radial-gradient(60% 140% at 50% 100%, rgba(139, 92, 246, 0.16), rgba(0, 0, 0, 0) 60%),
        radial-gradient(25% 100% at 0% 100%, rgba(236, 72, 153, 0.18), transparent 70%),
        radial-gradient(25% 100% at 100% 100%, rgba(255, 255, 255, 0.08), transparent 70%);
      z-index: 4;
      pointer-events: none;
    }

    .neon-bottom::before {
      content: "";
      position: absolute;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      width: min(560px, 92vw);
      height: 13px;
      border-radius: 9999px;
      background:
        /* liquid bands */
        repeating-linear-gradient(to right,
          rgba(255,255,255,0.85) 0 18px,
          transparent 18px 34px
        ),
        repeating-linear-gradient(to right,
          rgba(236,72,153,0.6) 0 14px,
          transparent 14px 30px
        ),
        repeating-linear-gradient(to right,
          rgba(139,92,246,0.6) 0 16px,
          transparent 16px 32px
        );
      background-blend-mode: screen;
      animation: liquidHorizontal 9s linear infinite;
      box-shadow:
        0 0 22px rgba(167, 139, 250, 0.75),
        0 0 44px rgba(139, 92, 246, 0.65),
        inset 0 0 10px rgba(167, 139, 250, 0.55);
    }

    /* Smooth connectors from sides to bottom bar */
    .neon-bottom::after {
      content: "";
      position: absolute;
      bottom: 24px;
      left: 10px;
      right: 10px;
      height: 18px;
      border-bottom-left-radius: 9999px;
      border-bottom-right-radius: 9999px;
      background: linear-gradient(90deg, transparent, rgba(167,139,250,0.25), rgba(236,72,153,0.25), rgba(255,255,255,0.18), rgba(167,139,250,0.25), transparent);
      filter: blur(8px);
      pointer-events: none;
    }

    /* üß≠ Neon nav */
    .neon-nav {
      background: rgba(10, 10, 16, 0.85) !important;
      backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(167, 139, 250, 0.25);
      box-shadow: 0 0 24px rgba(139, 92, 246, 0.25);
    }

    .nav-button {
      color: var(--text-primary);
      padding: 0.35rem 0.5rem; /* smaller */
      border-radius: 0.5rem;
      transition: transform .15s ease, box-shadow .2s ease;
      box-shadow: inset 0 0 0 1px rgba(167, 139, 250, 0.35);
      font-size: 0.875rem; /* text-sm */
    }

    .nav-button.active,
    .nav-button:hover {
      box-shadow:
        0 0 12px rgba(167, 139, 250, 0.55),
        inset 0 0 0 1px rgba(167, 139, 250, 0.65);
      transform: translateY(-1px);
    }

    /* üîò Neon buttons */
    .neon-button {
      position: relative;
      background: #0b0b0f !important;
      color: #ffffff !important;
      border: 1px solid rgba(167, 139, 250, 0.45) !important;
      box-shadow:
        0 0 16px rgba(139, 92, 246, 0.35),
        inset 0 0 18px rgba(139, 92, 246, 0.2);
      transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
      overflow: hidden;
    }

    .neon-button::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      background: linear-gradient(120deg, transparent 0%, rgba(167, 139, 250, 0.35) 40%, rgba(167, 139, 250, 0.6) 50%, rgba(167, 139, 250, 0.35) 60%, transparent 100%);
      background-size: 300% 100%;
      animation: neonFlow 6s linear infinite;
      z-index: 0;
      pointer-events: none;
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
              mask-composite: exclude;
      padding: 1px;
    }

    .neon-button > * { position: relative; z-index: 1; }

    .neon-button:hover {
      box-shadow:
        0 0 22px rgba(139, 92, 246, 0.55),
        inset 0 0 24px rgba(139, 92, 246, 0.28);
      transform: translateY(-1px);
      border-color: rgba(167, 139, 250, 0.75) !important;
    }

    .neon-button:active { transform: translateY(0); }

    /* üìù Inputs */
    .input-field {
      background: #0f0f16 !important;
      border: 1px solid rgba(148, 163, 184, 0.15);
      color: var(--text-primary) !important;
      box-shadow: inset 0 0 0 1px rgba(167, 139, 250, 0.15);
      transition: box-shadow .2s ease, border-color .2s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: rgba(167, 139, 250, 0.55);
      box-shadow:
        0 0 0 3px rgba(167, 139, 250, 0.25),
        inset 0 0 0 1px rgba(167, 139, 250, 0.55);
    }

    /* –ò—Å–ø–∞—Ä–µ–Ω–∏–µ –∫—Ä–∞—Å–Ω—ã–º —Ü–≤–µ—Ç–æ–º - –∞–Ω–∏–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è */
    .evaporating-item {
      position: relative;
      overflow: hidden;
      z-index: 1000;
    }

    @keyframes evaporate-red {
      0% {
        opacity: 1;
        transform: scale(1);
        filter: blur(0px) hue-rotate(0deg);
        background-color: transparent;
      }
      20% {
        opacity: 0.9;
        transform: scale(1.02);
        filter: blur(1px) hue-rotate(10deg);
      }
      40% {
        opacity: 0.7;
        transform: scale(1.05);
        filter: blur(3px) hue-rotate(20deg);
        background-color: rgba(239, 68, 68, 0.2);
      }
      60% {
        opacity: 0.4;
        transform: scale(1.1);
        filter: blur(6px) hue-rotate(30deg);
        background-color: rgba(239, 68, 68, 0.4);
      }
      80% {
        opacity: 0.2;
        transform: scale(1.15);
        filter: blur(10px) hue-rotate(40deg);
        background-color: rgba(239, 68, 68, 0.6);
      }
      100% {
        opacity: 0;
        transform: scale(1.2);
        filter: blur(15px) hue-rotate(50deg);
        background-color: rgba(239, 68, 68, 0.8);
      }
    }

    @keyframes evaporate-red-glow {
      0%, 100% {
        box-shadow: 
          0 0 0 rgba(239, 68, 68, 0),
          inset 0 0 0 rgba(239, 68, 68, 0);
      }
      30% {
        box-shadow: 
          0 0 20px rgba(239, 68, 68, 0.6),
          inset 0 0 30px rgba(239, 68, 68, 0.3);
      }
      60% {
        box-shadow: 
          0 0 40px rgba(239, 68, 68, 0.8),
          inset 0 0 50px rgba(239, 68, 68, 0.5);
      }
      100% {
        box-shadow: 
          0 0 60px rgba(239, 68, 68, 1),
          inset 0 0 70px rgba(239, 68, 68, 0.7);
      }
    }

    .evaporating-item.evaporating-now {
      animation: 
        evaporate-red 1.5s cubic-bezier(0.4, 0, 0.6, 1) forwards,
        evaporate-red-glow 1.5s ease-in-out forwards;
      pointer-events: none;
    }

    .deletable-item {
      position: relative;
      transition: transform 0.2s ease;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    /* Prevent text selection on buttons */
    .neon-button,
    .nav-button,
    button {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      -webkit-touch-callout: none;
    }

    /* ‚ú® Shimmer animation for experience bar */
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .animate-shimmer {
      animation: shimmer 2s infinite;
    }

    /* üéØ Level badge glow */
    #level-badge {
      background: linear-gradient(135deg, 
        #000000 0%, 
        #4c1d95 25%, 
        #7c3aed 50%, 
        #ec4899 75%, 
        #dc2626 100%
      );
      background-size: 200% 200%;
      color: #ffffff;
      border: 1px solid rgba(167, 139, 250, 0.5);
      box-shadow: 
        0 0 15px rgba(124, 58, 237, 0.6),
        0 0 30px rgba(236, 72, 153, 0.4),
        inset 0 0 10px rgba(0, 0, 0, 0.5);
      animation: level-badge-flow 3s ease-in-out infinite, level-badge-pulse 2s ease-in-out infinite;
      text-shadow: 0 0 10px rgba(167, 139, 250, 0.8);
    }

    @keyframes level-badge-flow {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    @keyframes level-badge-pulse {
      0%, 100% {
      box-shadow: 
        0 0 15px rgba(124, 58, 237, 0.6),
        0 0 30px rgba(236, 72, 153, 0.4),
        inset 0 0 10px rgba(0, 0, 0, 0.5);
      }
      50% {
      box-shadow: 
        0 0 25px rgba(124, 58, 237, 0.9),
        0 0 50px rgba(236, 72, 153, 0.7),
        0 0 20px rgba(220, 38, 38, 0.5),
        inset 0 0 15px rgba(0, 0, 0, 0.7);
      }
    }

    /* üê± Kitty theme - —Ä–æ–∑–æ–≤–∞—è —Ç–µ–º–∞ */
    body.theme-kitty {
      --neon-purple-1: #ff6b9d;
      --neon-purple-2: #ff8cc8;
      --neon-purple-3: #ffb3d9;
      --neon-pink: #ff1493;
      --neon-white: #ffffff;
      --neon-bg: #fff0f5;
      --text-primary: #8b4a6b;
      --card-bg: #ffe6f2;
      --border-color: #ffb3d9;
    }

    body.theme-kitty.page-dark {
      background-color: var(--neon-bg) !important;
      color: var(--text-primary) !important;
    }

    body.theme-kitty .rounded-lg.border,
    body.theme-kitty .bg-black\/30,
    body.theme-kitty main {
      background-color: var(--card-bg) !important;
      border-color: var(--border-color) !important;
      color: var(--text-primary) !important;
    }

    body.theme-kitty .text-white {
      color: var(--text-primary) !important;
    }

    body.theme-kitty .text-gray-300,
    body.theme-kitty .text-gray-400 {
      color: #b87a9d !important;
    }

    body.theme-kitty .text-gray-500 {
      color: #a06a8a !important;
    }

    body.theme-kitty .nav-button {
      color: var(--text-primary) !important;
      box-shadow: inset 0 0 0 1px rgba(255, 107, 157, 0.4) !important;
    }

    body.theme-kitty .nav-button.active,
    body.theme-kitty .nav-button:hover {
      box-shadow:
        0 0 12px rgba(255, 107, 157, 0.6),
        inset 0 0 0 1px rgba(255, 107, 157, 0.7) !important;
    }

    body.theme-kitty .neon-button {
      background: #ffe6f2 !important;
      color: var(--text-primary) !important;
      border: 1px solid rgba(255, 107, 157, 0.5) !important;
      box-shadow:
        0 0 16px rgba(255, 107, 157, 0.4),
        inset 0 0 18px rgba(255, 140, 200, 0.3) !important;
    }

    body.theme-kitty .neon-button:hover {
      box-shadow:
        0 0 22px rgba(255, 107, 157, 0.6),
        inset 0 0 24px rgba(255, 140, 200, 0.4) !important;
      border-color: rgba(255, 107, 157, 0.8) !important;
    }

    body.theme-kitty .neon-sides::before,
    body.theme-kitty .neon-sides::after {
      background: linear-gradient(180deg,
        #ff6b9d 0%,
        #ff6b9d 25%,
        #ff1493 55%,
        #ffffff 85%,
        #ff8cc8 100%
      );
      box-shadow:
        0 0 12px rgba(255, 140, 200, 0.7),
        0 0 28px rgba(255, 107, 157, 0.5),
        inset 0 0 16px rgba(255, 179, 217, 0.4);
    }

    body.theme-kitty .neon-bottom {
      background:
        radial-gradient(60% 140% at 50% 100%, rgba(255, 107, 157, 0.2), rgba(255, 240, 245, 0) 60%),
        radial-gradient(25% 100% at 0% 100%, rgba(255, 20, 147, 0.22), transparent 70%),
        radial-gradient(25% 100% at 100% 100%, rgba(255, 255, 255, 0.1), transparent 70%);
    }

    body.theme-kitty .neon-bottom::before {
      background:
        repeating-linear-gradient(to right,
          rgba(255,255,255,0.9) 0 18px,
          transparent 18px 34px
        ),
        repeating-linear-gradient(to right,
          rgba(255,20,147,0.7) 0 14px,
          transparent 14px 30px
        ),
        repeating-linear-gradient(to right,
          rgba(255,107,157,0.7) 0 16px,
          transparent 16px 32px
        );
      box-shadow:
        0 0 22px rgba(255, 140, 200, 0.8),
        0 0 44px rgba(255, 107, 157, 0.7),
        inset 0 0 10px rgba(255, 179, 217, 0.6);
    }

    body.theme-kitty .neon-bottom::after {
      background: linear-gradient(90deg, transparent, rgba(255,107,157,0.3), rgba(255,20,147,0.3), rgba(255,255,255,0.22), rgba(255,140,200,0.3), transparent);
    }

    body.theme-kitty .text-violet-400 {
      color: #ff6b9d !important;
    }

    body.theme-kitty .text-pink-400 {
      color: #ff1493 !important;
    }

    body.theme-kitty .text-blue-400 {
      color: #ff8cc8 !important;
    }

    body.theme-kitty .text-green-400 {
      color: #4ade80 !important;
    }

    body.theme-kitty .border-violet-400\/30,
    body.theme-kitty .border-violet-400\/20 {
      border-color: rgba(255, 179, 217, 0.5) !important;
    }

    body.theme-kitty .neon-nav {
      background: rgba(255, 230, 242, 0.9) !important;
      border-bottom: 1px solid rgba(255, 179, 217, 0.3) !important;
      box-shadow: 0 0 24px rgba(255, 107, 157, 0.3) !important;
    }

    body.theme-kitty #theme-selector-modal,
    body.theme-kitty #contact-owner-modal {
      background: rgba(255, 240, 245, 0.95) !important;
    }

    body.theme-kitty #theme-selector-modal > div,
    body.theme-kitty #contact-owner-modal > div {
      background: var(--card-bg) !important;
      border-color: var(--border-color) !important;
    }

    body.theme-kitty .input-field {
      background: #ffffff !important;
      border: 1px solid rgba(255, 179, 217, 0.3) !important;
      color: var(--text-primary) !important;
    }

    body.theme-kitty .input-field:focus {
      border-color: rgba(255, 107, 157, 0.7) !important;
      box-shadow:
        0 0 0 3px rgba(255, 107, 157, 0.3),
        inset 0 0 0 1px rgba(255, 107, 157, 0.7) !important;
    }

    @keyframes kitty-bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes kitty-float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-15px) rotate(5deg); }
    }

    @keyframes kitty-heart {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    /* üçÑ Mario theme - —Ä–µ—Ç—Ä–æ —Å—Ç–∏–ª—å Super Mario Bros */
    body.theme-mario {
      font-family: 'Press Start 2P', cursive, monospace !important;
      --mario-sky: #5C94FC;
      --mario-cloud: #FFFFFF;
      --mario-hill: #00C000;
      --mario-brick: #B85C00;
      --mario-orange: #FF8C00;
      --mario-yellow: #FFD700;
      --mario-brown: #8B4513;
      --mario-blue: #0066FF;
      --mario-green: #00AA00;
      --mario-red: #FF0000;
      --mario-text: #000000;
      --mario-white: #FFFFFF;
    }

    body.theme-mario.page-dark {
      position: relative;
      background: 
        radial-gradient(ellipse 120px 60px at 30% 25%, #FFFFFF 0%, #FFFFFF 70%, rgba(135, 206, 235, 0.2) 70%, transparent 100%),
        radial-gradient(ellipse 120px 60px at 75% 20%, #FFFFFF 0%, #FFFFFF 70%, rgba(135, 206, 235, 0.2) 70%, transparent 100%),
        repeating-linear-gradient(0deg, #B85C00 0px, #B85C00 16px, #8B4513 16px, #8B4513 20px),
        repeating-linear-gradient(90deg, transparent 0px, transparent 31px, rgba(0, 0, 0, 0.4) 31px, rgba(0, 0, 0, 0.4) 32px),
        #87CEEB;
      background-size: 120px 60px, 120px 60px, 32px 32px, 32px 32px, 100% 100%;
      background-position: 30% 25%, 75% 20%, 0 67%, 0 67%, 0 0;
      background-repeat: no-repeat;
      color: var(--mario-text) !important;
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
      min-height: 100vh;
    }

    body.theme-mario.page-dark::after {
      content: '?';
      position: fixed;
      right: 5%;
      bottom: 15%;
      width: 40px;
      height: 40px;
      background: var(--mario-yellow);
      border: 3px solid #000000;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: #000000;
      z-index: 0;
      box-shadow: 
        inset 0 -3px 0 rgba(0, 0, 0, 0.3),
        0 3px 0 rgba(0, 0, 0, 0.2);
      font-family: 'Press Start 2P', cursive, monospace;
      pointer-events: none;
    }

    body.theme-mario main,
    body.theme-mario #profile-section {
      position: relative;
      z-index: 1;
    }

    @keyframes mario-clouds {
      0% { 
        background-position: 30% 25%, 75% 20%, 0 67%, 0 67%, 0 0; 
      }
      100% { 
        background-position: 32% 25%, 77% 20%, 32px 67%, 32px 67%, 0 0; 
      }
    }

    body.theme-mario.page-dark {
      animation: mario-clouds 30s linear infinite;
    }

    body.theme-mario h2 {
      background: rgba(255, 140, 0, 0.85) !important;
      color: var(--mario-white) !important;
      padding: 16px 20px !important;
      border-radius: 12px !important;
      border: 3px solid #CC7000 !important;
      box-shadow: 
        inset 0 -4px 0 rgba(0, 0, 0, 0.3),
        0 4px 0 rgba(0, 0, 0, 0.2) !important;
      text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.5) !important;
      font-size: 0.8rem !important;
      letter-spacing: 1px !important;
      text-align: center !important;
      margin-bottom: 20px !important;
      width: 100% !important;
      backdrop-filter: blur(2px);
    }

    body.theme-mario .rounded-lg.border,
    body.theme-mario .bg-black\/30 {
      background: rgba(255, 215, 0, 0.85) !important;
      border: 3px solid #CCAA00 !important;
      border-radius: 8px !important;
      box-shadow: 
        inset 0 -4px 0 rgba(0, 0, 0, 0.2),
        0 4px 0 rgba(0, 0, 0, 0.15) !important;
      color: var(--mario-text) !important;
      backdrop-filter: blur(2px);
    }

    body.theme-mario main {
      background: transparent !important;
    }

    body.theme-mario .nav-button {
      background: var(--mario-green) !important;
      color: var(--mario-white) !important;
      border: 3px solid #008800 !important;
      box-shadow: 
        inset 0 -3px 0 rgba(0, 0, 0, 0.3),
        0 3px 0 rgba(0, 0, 0, 0.2) !important;
      text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.5) !important;
      font-size: 0.6rem !important;
      transition: transform 0.1s !important;
    }

    body.theme-mario .nav-button:active {
      transform: translateY(2px) !important;
      box-shadow: 
        inset 0 -1px 0 rgba(0, 0, 0, 0.3),
        0 1px 0 rgba(0, 0, 0, 0.2) !important;
    }

    body.theme-mario #change-theme-btn {
      background: rgba(255, 140, 0, 0.85) !important;
      color: var(--mario-white) !important;
      border: 3px solid #CC7000 !important;
      border-radius: 12px !important;
      box-shadow: 
        inset 0 -3px 0 rgba(0, 0, 0, 0.3),
        0 3px 0 rgba(0, 0, 0, 0.2) !important;
      text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.5) !important;
      font-size: 0.65rem !important;
      padding: 14px !important;
      margin-bottom: 12px !important;
      backdrop-filter: blur(2px);
    }

    body.theme-mario .text-white {
      color: var(--mario-white) !important;
    }

    body.theme-mario .text-gray-300,
    body.theme-mario .text-gray-400 {
      color: #333333 !important;
    }

    body.theme-mario .text-violet-400 {
      color: var(--mario-blue) !important;
    }

    @keyframes mario-jump {
      0%, 100% { transform: translateY(0) scale(1); }
      25% { transform: translateY(-5px) scale(1.05); }
      50% { transform: translateY(-8px) scale(1.1); }
      75% { transform: translateY(-5px) scale(1.05); }
    }

    body.theme-mario button:hover {
      animation: mario-jump 0.3s ease-in-out;
    }

    body.theme-mario * {
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }

    /* ‚öîÔ∏è Attack on Titan theme */
    body.theme-aot {
      font-family: 'UnifrakturMaguntia', 'Creepster', serif !important;
      --aot-parchment: #f4e4bc;
      --aot-sepia: #8b6f47;
      --aot-blood: #8b0000;
      --aot-text: #3d2817;
      --aot-border: #5c4a2f;
    }

    body.theme-aot.page-dark {
      background: repeating-linear-gradient(0deg, rgba(139, 111, 71, 0.03) 0px, rgba(139, 111, 71, 0.03) 1px, transparent 1px, transparent 2px),
        repeating-linear-gradient(90deg, rgba(139, 111, 71, 0.03) 0px, rgba(139, 111, 71, 0.03) 1px, transparent 1px, transparent 2px),
        radial-gradient(ellipse at top, #e8d5b7 0%, #d4c4a4 50%, #c9b99b 100%), #f4e4bc;
      background-size: 20px 20px, 20px 20px, 100% 60%, 100% 100%;
      color: var(--aot-text) !important;
    }

    body.theme-aot #aot-titan-image {
      display: block !important;
      position: relative !important;
      width: 100% !important;
      margin-bottom: 20px !important;
    }

    body.theme-aot #aot-titan-image img {
      width: 100% !important;
      height: auto !important;
      max-height: 300px !important;
      object-fit: contain !important;
    }

    @media (max-width: 640px) {
      body.theme-aot #aot-titan-image img { max-height: 200px !important; }
    }

    body.theme-aot .rounded-lg.border,
    body.theme-aot .bg-black\/30 {
      background: repeating-linear-gradient(0deg, rgba(139, 111, 71, 0.05) 0px, rgba(139, 111, 71, 0.05) 1px, transparent 1px, transparent 2px),
        linear-gradient(135deg, #f4e4bc 0%, #e8d5b7 100%) !important;
      border: 2px solid var(--aot-border) !important;
      color: var(--aot-text) !important;
    }

    body.theme-aot h2 {
      font-family: 'UnifrakturMaguntia', serif !important;
      color: var(--aot-text) !important;
      font-size: 2rem !important;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3) !important;
    }

    body.theme-aot .nav-button,
    body.theme-aot .neon-button {
      background: linear-gradient(135deg, #8b6f47 0%, #5c4a2f 100%) !important;
      color: #f4e4bc !important;
      border: 2px solid var(--aot-border) !important;
      font-family: 'UnifrakturMaguntia', serif !important;
    }

    body.theme-aot .text-white,
    body.theme-aot .text-gray-300,
    body.theme-aot .text-violet-400 {
      color: var(--aot-sepia) !important;
    }

    /* üí∞ –°—Ç–∏–ª–∏ –¥–ª—è –±–ª–æ–∫–∞ –º–æ–Ω–µ—Ç–æ–∫ */
    #coins-header {
      transition: all 0.3s ease;
    }
    
    #add-coins-btn:hover {
      transform: scale(1.1);
    }
    
    body.theme-kitty #coins-header {
      background: rgba(255, 107, 157, 0.9) !important;
      border-color: rgba(255, 20, 147, 0.6);
      box-shadow: 0 0 24px rgba(255, 20, 147, 0.4);
    }
    
    body.theme-kitty #add-coins-btn {
      background: #ff1493;
    }
    
    body.theme-kitty #add-coins-btn:hover {
      background: #ff6b9d;
    }
    
    body.theme-mario #coins-header {
      background: rgba(220, 38, 38, 0.9) !important;
      border-color: rgba(255, 193, 7, 0.6);
      box-shadow: 0 0 24px rgba(255, 193, 7, 0.4);
    }
    
    body.theme-mario #add-coins-btn {
      background: #dc2626;
    }
    
    body.theme-mario #add-coins-btn:hover {
      background: #ef4444;
    }
    
    body.theme-aot #coins-header {
      background: rgba(92, 74, 47, 0.9) !important;
      border-color: rgba(139, 111, 71, 0.6);
      box-shadow: 0 0 24px rgba(139, 111, 71, 0.4);
    }
    
    body.theme-aot #add-coins-btn {
      background: #5c4a2f;
    }
    
    body.theme-aot #add-coins-btn:hover {
      background: #8b6f47;
    }
  </style>
</head>
<body class="page-dark text-white min-h-screen flex flex-col neon-sides">

  <!-- üí∞ –ë–ª–æ–∫ –º–æ–Ω–µ—Ç–æ–∫ —Å–ø—Ä–∞–≤–∞ —Å–≤–µ—Ä—Ö—É -->
  <div id="coins-header" class="fixed top-2 right-4 z-50 flex items-center gap-2 bg-black/80 backdrop-blur-sm rounded-full px-3 py-2 border border-purple-500/50 shadow-lg shadow-purple-500/30">
    <button id="add-coins-btn" class="w-8 h-8 flex items-center justify-center rounded-full bg-purple-600 hover:bg-purple-500 transition-colors text-white font-bold text-lg leading-none" style="line-height: 1;">+</button>
    <div class="flex items-center gap-1">
      <span id="coins-count" class="text-white font-semibold text-sm">0</span>
      <img src="monkeyscoin.png" alt="Monkey Coin" class="w-10 h-10 object-contain">
    </div>
  </div>

  <!-- üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ -->
  <div id="loading-spinner" class="relative w-full h-screen flex flex-col items-center justify-center" style="background: #000; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999;">
    <div class="flex flex-col items-center">
      <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-white mb-4"></div>
      <p class="text-white text-lg font-semibold">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞–Ω–µ–ª–∏...</p>
    </div>
  </div>

  <!-- üöÄ –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
  <nav id="admin-nav" class="hidden neon-nav fixed left-0 right-0 z-10 flex justify-around items-center px-2 pb-2 pt-3" style="bottom: 18px;">
    <button class="nav-button active relative" data-section="contests-section">üèÜ –ö–æ–Ω–∫—É—Ä—Å—ã</button>
    <button class="nav-button relative" data-section="rating-section">‚≠ê –†–µ–π—Ç–∏–Ω–≥</button>
    <button class="nav-button relative" data-section="profile-section">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
    <button class="nav-button relative" data-section="shop-section">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
  </nav>

  <!-- üì¶ –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
  <main class="flex-1 p-6 space-y-6 pb-24">

    <!-- üèÜ –ö–æ–Ω–∫—É—Ä—Å—ã -->
    <section id="contests-section" class="content-section" style="padding-top: 40px;">
      <h2 class="text-xl font-bold mb-4">–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä—Å—ã</h2>
      <button id="create-contest-btn" class="neon-button w-full py-3 rounded-lg mb-6">‚ûï –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω–∫—É—Ä—Å</button>
      <div id="contest-list" class="space-y-4"></div>
    </section>

    <!-- ‚≠ê –†–µ–π—Ç–∏–Ω–≥ -->
    <section id="rating-section" class="content-section hidden">
      <h2 class="text-xl font-bold mb-4">–†–µ–π—Ç–∏–Ω–≥</h2>
      
      <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –∞–¥–º–∏–Ω–∞–º–∏ -->
      <div class="flex gap-2 mb-4">
        <button id="rating-users-btn" class="nav-button active px-4 py-2 rounded-lg" data-role="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
        <button id="rating-admins-btn" class="nav-button px-4 py-2 rounded-lg" data-role="admin">–ê–¥–º–∏–Ω—ã</button>
      </div>
      
      <!-- –°–ø–∏—Å–æ–∫ —Ä–µ–π—Ç–∏–Ω–≥–∞ -->
      <div id="rating-list" class="space-y-2">
        <div class="text-center text-gray-400 py-8">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</div>
      </div>
    </section>

    <!-- üë§ –ü—Ä–æ—Ñ–∏–ª—å -->
    <section id="profile-section" class="content-section hidden">
      <!-- Attack Titan –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ–º—ã AoT -->
      <div id="aot-titan-image" class="hidden absolute top-0 left-0 right-0 -mt-8 mb-4 z-0 pointer-events-none" style="border: 3px solid #5c4a2f; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); min-height: 200px; max-height: 300px; height: auto;">
        <img src="AoT.jpg" 
             alt="Attack Titan" 
             class="w-full h-auto opacity-95"
             style="filter: sepia(70%) contrast(1.5) brightness(0.75) saturate(0.6) hue-rotate(-10deg); object-fit: contain; display: block; max-height: 300px; width: 100%; height: auto;">
        <div class="absolute inset-0 pointer-events-none" style="background: repeating-linear-gradient(0deg, rgba(139,111,71,0.03) 0px, transparent 1px, transparent 2px), repeating-linear-gradient(90deg, rgba(139,111,71,0.03) 0px, transparent 1px, transparent 2px); mix-blend-mode: overlay;"></div>
      </div>
      <h2 class="text-xl font-bold mb-6">–ü—Ä–æ—Ñ–∏–ª—å</h2>
      
      <div class="rounded-lg border border-violet-400/30 p-6 bg-black/30 space-y-4 mb-6">
        <div class="flex items-center gap-3">
          <div class="w-16 h-16 rounded-full bg-gradient-to-br from-violet-500 to-pink-500 flex items-center justify-center text-2xl font-bold">
            <span id="profile-avatar">üë§</span>
          </div>
          <div>
            <div class="text-lg font-semibold" id="profile-username">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
            <div class="text-sm text-gray-400">ID: <span id="profile-id" class="text-violet-400"></span></div>
          </div>
        </div>
        
        <div class="pt-4 border-t border-violet-400/20 space-y-3">
          <div class="flex justify-between items-center">
            <span class="text-gray-400">–ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥:</span>
            <span id="profile-first-login" class="text-blue-400"></span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-400">–°—Ç–∞—Ç—É—Å:</span>
            <span id="profile-status" class="text-green-400 font-semibold"></span>
          </div>
        </div>
      </div>

      <!-- ‚≠ê –°–∏—Å—Ç–µ–º–∞ —É—Ä–æ–≤–Ω–µ–π –∏ –æ–ø—ã—Ç–∞ -->
      <div class="mb-6">
        <div class="rounded-lg border border-violet-400/30 p-6 bg-black/30 space-y-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold flex items-center gap-2">
              <span id="level-badge" class="px-3 py-1 rounded-full text-sm font-bold">–£—Ä–æ–≤–µ–Ω—å 1</span>
              <span class="text-violet-400">‚≠ê</span>
            </h3>
            <div class="text-right">
              <div class="text-2xl font-bold text-violet-400" id="current-experience">0</div>
              <div class="text-xs text-gray-400">–æ–ø—ã—Ç–∞</div>
            </div>
          </div>
          
          <!-- –ü–æ–ª–æ—Å–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
          <div class="relative">
            <div class="w-full h-6 bg-gray-800 rounded-full overflow-hidden border border-violet-400/20">
              <div id="experience-progress-bar" class="h-full bg-gradient-to-r from-violet-500 via-pink-500 to-violet-500 rounded-full transition-all duration-500 ease-out relative overflow-hidden" style="width: 0%; background-size: 200% 100%; animation: neonFlow 3s linear infinite;">
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent animate-shimmer"></div>
              </div>
            </div>
            <div class="flex justify-between items-center mt-2 text-xs text-gray-400">
              <span id="current-level-exp">0</span>
              <span id="next-level-exp">100</span>
            </div>
          </div>
          
          <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
          <div class="pt-3 border-t border-violet-400/20">
            <div class="text-center p-3 rounded-lg bg-black/40 border border-violet-400/20">
              <div class="text-2xl font-bold text-violet-400" id="contests-created">0</div>
              <div class="text-xs text-gray-400 mt-1">–°–æ–∑–¥–∞–Ω–æ –∫–æ–Ω–∫—É—Ä—Å–æ–≤</div>
            </div>
          </div>
        </div>
      </div>

      <!-- üíé –ê–∫—Ç–∏–≤—ã -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold mb-4">üíé –ê–∫—Ç–∏–≤—ã</h3>
        <div id="assets-list" class="space-y-3">
          <div id="channel-asset" class="hidden rounded-lg border border-violet-400/30 p-3 bg-black/30">
            <div class="text-xs text-gray-500 mb-1">üì¢ –ö–∞–Ω–∞–ª</div>
            <a id="channel-link" href="#" target="_blank" class="text-blue-400 hover:underline text-sm break-all"></a>
          </div>
          <div id="chat-asset" class="hidden rounded-lg border border-violet-400/30 p-3 bg-black/30">
            <div class="text-xs text-gray-500 mb-1">üí¨ –ß–∞—Ç</div>
            <a id="chat-link" href="#" target="_blank" class="text-blue-400 hover:underline text-sm break-all"></a>
          </div>
          <div id="no-assets" class="text-gray-500 text-sm">
            –ê–∫—Ç–∏–≤—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã
          </div>
        </div>
      </div>

      <!-- üé® –°–º–µ–Ω–∞ —Ç–µ–º—ã -->
      <button id="change-theme-btn" class="neon-button w-full py-3 rounded-lg mb-3 relative">
        <span class="kitty-btn-icon">üé®</span> –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É
      </button>

      <!-- üì® –°–≤—è–∑—å —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º -->
      <button id="contact-owner-btn" class="neon-button w-full py-3 rounded-lg">
        üì® –°–≤—è–∑—å —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º
      </button>
    </section>

    <!-- üõí –ú–∞–≥–∞–∑–∏–Ω -->
    <section id="shop-section" class="content-section hidden">
      <h2 class="text-xl font-bold mb-6">üõí –ú–∞–≥–∞–∑–∏–Ω</h2>
      
      <div class="space-y-4">
        <div class="rounded-lg border border-violet-400/30 p-6 bg-black/30">
          <h3 class="text-lg font-semibold mb-4">üé® –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–º—ã</h3>
          <div id="themes-shop" class="grid grid-cols-1 gap-3">
            <!-- –¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
          </div>
        </div>
      </div>
    </section>
    
    <!-- üí≥ –ú–æ–¥–∞–ª–∫–∞: –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã -->
    <div id="payment-method-modal" class="hidden fixed inset-0 z-30 flex items-center justify-center bg-black/70 backdrop-blur-sm">
      <div class="relative w-full sm:w-[500px] bg-[#0b0b10] rounded-2xl border border-violet-500/30 shadow-2xl p-6 mx-4">
        <button id="close-payment-modal" class="absolute -top-3 -right-3 bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        <h3 class="text-lg font-semibold mb-4">üí≥ –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h3>
        <div id="payment-methods-list" class="space-y-3">
          <!-- –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
      </div>
    </div>

    <!-- üé® –ú–æ–¥–∞–ª–∫–∞: –í—ã–±–æ—Ä —Ç–µ–º—ã -->
    <div id="theme-selector-modal" class="hidden fixed inset-0 z-30 flex items-center justify-center bg-black/70 backdrop-blur-sm">
      <div class="relative w-full sm:w-[500px] bg-[#0b0b10] rounded-2xl border border-violet-500/30 shadow-2xl p-6 mx-4 max-h-[90vh] overflow-y-auto">
        <button id="close-theme-modal" class="absolute top-4 right-4 bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button z-10" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        <h3 class="text-lg font-semibold mb-4">üé® –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É</h3>
        <div id="themes-list" class="space-y-3">
          <!-- –¢–µ–º—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
      </div>
    </div>

    <!-- üí∞ –ú–æ–¥–∞–ª–∫–∞: –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ Monkey Coins -->
    <div id="topup-coins-modal" class="hidden fixed inset-0 z-30 flex items-center justify-center bg-black/70 backdrop-blur-sm">
      <div class="relative w-full sm:w-[450px] bg-[#0b0b10] rounded-2xl border border-violet-500/30 shadow-2xl p-4 mx-4">
        <button id="close-topup-modal" class="absolute -top-3 -right-3 bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        <h3 class="text-base font-semibold mb-3">üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</h3>
        
        <!-- –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã - –≤ —Ä—è–¥ -->
        <div id="topup-payment-methods" class="grid grid-cols-2 gap-2 mb-3">
          <!-- NFT (Soon) -->
          <div class="rounded-lg border border-gray-600/30 bg-black/20 cursor-not-allowed opacity-60 p-3 text-center">
            <div class="text-2xl mb-1">üéÅ</div>
            <div class="font-semibold text-gray-500 text-xs">NFT</div>
            <div class="text-xs text-gray-500">–°–∫–æ—Ä–æ</div>
          </div>
          
          <!-- TON (Soon) -->
          <div class="rounded-lg border border-gray-600/30 bg-black/20 cursor-not-allowed opacity-60 p-3 text-center">
            <div class="text-2xl mb-1">üíé</div>
            <div class="font-semibold text-gray-500 text-xs">TON</div>
            <div class="text-xs text-gray-500">–°–∫–æ—Ä–æ</div>
          </div>
          
          <!-- CryptoBot (TON) -->
          <div id="topup-method-cryptobot" class="rounded-lg border border-violet-400/30 bg-black/30 cursor-pointer hover:border-violet-400/50 hover:bg-black/40 p-3 text-center transition-all" onclick="window.selectTopupMethod('cryptobot')">
            <div class="text-2xl mb-1">ü§ñ</div>
            <div class="font-semibold text-white text-xs">CryptoBot</div>
            <div class="text-xs text-gray-400">1 TON = 100</div>
          </div>
          
          <!-- Telegram Stars -->
          <div id="topup-method-stars" class="rounded-lg border border-violet-400/30 bg-black/30 cursor-pointer hover:border-violet-400/50 hover:bg-black/40 p-3 text-center transition-all" onclick="window.selectTopupMethod('stars')">
            <div class="text-2xl mb-1">‚≠ê</div>
            <div class="font-semibold text-white text-xs">‚≠ê</div>
            <div class="text-xs text-gray-400">1 ‚≠ê = 1</div>
          </div>
        </div>
        
        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å—É–º–º—ã (—Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div id="topup-amount-section" class="hidden space-y-3">
          <div>
            <label id="topup-amount-label" class="block text-xs text-gray-400 mb-1">–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É:</label>
            <input 
              type="number" 
              id="topup-amount-input" 
              min="1" 
              step="1" 
              class="input-field w-full p-2 rounded bg-black/50 border border-violet-400/30 text-white focus:border-violet-400 focus:outline-none text-sm" 
              placeholder="0"
              style="-moz-appearance: textfield; appearance: textfield;"
            />
            <div id="topup-conversion-info" class="text-xs text-violet-400 mt-1"></div>
          </div>
          <button id="topup-pay-btn" class="neon-button w-full py-2 rounded-lg font-semibold text-sm">
            üí≥ –û–ø–ª–∞—Ç–∏—Ç—å
          </button>
        </div>
      </div>
    </div>

    <!-- üì® –ú–æ–¥–∞–ª–∫–∞: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É -->
    <div id="contact-owner-modal" class="hidden fixed inset-0 z-30 flex items-center justify-center bg-black/70 backdrop-blur-sm">
      <div class="relative w-full sm:w-[500px] bg-[#0b0b10] rounded-2xl border border-violet-500/30 shadow-2xl p-6 mx-4">
        <button id="close-contact-modal" class="absolute -top-3 -right-3 bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        <h3 class="text-lg font-semibold mb-4">üì® –°–≤—è–∑—å —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-gray-400 mb-2">–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</label>
            <textarea id="contact-message-text" class="input-field w-full p-3 rounded" rows="6" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
          </div>
          <button id="send-contact-message" class="neon-button w-full py-3 rounded-lg">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- üîç –ú–æ–¥–∞–ª–∫–∞: –°–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç –∫–æ–Ω–∫—É—Ä—Å–∞ -->
    <div id="contest-works-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black/80 backdrop-blur-sm">
      <div class="relative w-full sm:w-[600px] max-h-[90vh] bg-[#0b0b10] rounded-2xl border border-violet-500/30 shadow-2xl p-6 mx-4 overflow-y-auto">
        <button id="close-contest-works-modal" class="absolute -top-3 -right-3 bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        <h3 class="text-lg font-semibold mb-4">üîç –†–∞–±–æ—Ç—ã –∫–æ–Ω–∫—É—Ä—Å–∞</h3>
        <div id="contest-works-list" class="space-y-3">
          <div class="text-center text-gray-400 py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
      </div>
    </div>
    
    <!-- üóëÔ∏è –ú–æ–¥–∞–ª–∫–∞: –ü—Ä–∏—á–∏–Ω–∞ –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã -->
    <div id="cancel-work-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
      <div class="relative w-full sm:w-[500px] bg-[#0b0b10] rounded-2xl border border-violet-500/30 shadow-2xl p-6 mx-4">
        <button id="close-cancel-work-modal" class="absolute -top-3 -right-3 bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        <h3 class="text-lg font-semibold mb-4">üóëÔ∏è –ê–Ω–Ω—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-gray-400 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
            <select id="cancel-reason-select" class="input-field w-full p-2 rounded">
              <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É --</option>
              <option value="–ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–º–µ –∫–æ–Ω–∫—É—Ä—Å–∞">–ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–º–µ –∫–æ–Ω–∫—É—Ä—Å–∞</option>
              <option value="–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –∫–æ–Ω–∫—É—Ä—Å–∞">–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –∫–æ–Ω–∫—É—Ä—Å–∞</option>
              <option value="–ù–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—Ç—ã">–ù–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—Ç—ã</option>
              <option value="–ü–ª–∞–≥–∏–∞—Ç">–ü–ª–∞–≥–∏–∞—Ç</option>
              <option value="–î—Ä—É–≥–∞—è –ø—Ä–∏—á–∏–Ω–∞">–î—Ä—É–≥–∞—è –ø—Ä–∏—á–∏–Ω–∞</option>
            </select>
          </div>
          <div id="custom-reason-div" class="hidden">
            <label class="block text-sm text-gray-400 mb-2">–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É:</label>
            <textarea id="custom-reason-text" class="input-field w-full p-2 rounded" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è..."></textarea>
          </div>
          <div class="flex gap-3 pt-4">
            <button id="cancel-work-confirm-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-semibold">üóëÔ∏è –ê–Ω–Ω—É–ª–∏—Ä–æ–≤–∞—Ç—å</button>
            <button id="cancel-work-cancel-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-semibold">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- üóëÔ∏è –ú–æ–¥–∞–ª–∫–∞: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è -->
  <div id="delete-confirm-modal" class="hidden fixed inset-0 z-30 flex items-center justify-center bg-black/70 backdrop-blur-sm">
    <div class="relative w-full sm:w-[400px] bg-[#0b0b10] rounded-2xl border border-red-500/50 shadow-2xl p-6 mx-4">
      <h3 class="text-lg font-semibold mb-4 text-center">‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
      <p id="delete-confirm-text" class="text-gray-300 text-center mb-6"></p>
      <div class="flex gap-3">
        <button id="delete-confirm-cancel" class="neon-button flex-1 py-3 rounded-lg border-gray-500">–û—Ç–º–µ–Ω–∞</button>
        <button id="delete-confirm-ok" class="bg-red-600 hover:bg-red-700 text-white flex-1 py-3 rounded-lg font-semibold">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- ü™Ñ –ú–æ–¥–∞–ª–∫–∞: –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω–∫—É—Ä—Å -->
  <div id="contest-modal" class="hidden fixed inset-0 z-20 flex items-end sm:items-center justify-center bg-black/60 p-4 overflow-y-auto" style="pointer-events: auto;">
    <div class="relative w-full max-w-[520px] max-h-[90vh] sm:max-h-[85vh] bg-[#0b0b10] rounded-t-2xl sm:rounded-2xl border border-violet-500/30 shadow-2xl p-5 my-auto overflow-y-auto" style="pointer-events: auto;">
      <button id="close-contest-modal" class="absolute -top-3 -right-3 bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button z-10" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      <h3 class="text-lg font-semibold mb-3 sticky top-0 bg-[#0b0b10] pb-2 z-0" style="pointer-events: auto;">–°–æ–∑–¥–∞—Ç—å –∫–æ–Ω–∫—É—Ä—Å</h3>
      <div id="post-link-error" class="hidden text-red-400 text-sm mb-2 p-2 bg-red-900/20 rounded border border-red-500/30">
        ‚ö†Ô∏è –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å—Ç –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∏–∑ –≤–∞—à–µ–≥–æ –∫–∞–Ω–∞–ª–∞!
      </div>
      <div class="space-y-3" style="pointer-events: auto;">
        <div>
          <label class="block text-sm text-gray-400 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—É—Ä—Å–∞</label>
          <input id="contest-title" class="input-field w-full p-2 rounded" value="–†–∞–Ω–¥–æ–º–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" readonly />
        </div>
        
        <div>
          <label class="block text-sm text-gray-400 mb-1">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å—Ç</label>
          <input id="contest-post-link" type="text" class="input-field w-full p-2 rounded" placeholder="üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å—Ç –∏–∑ –≤–∞—à–µ–≥–æ –∫–∞–Ω–∞–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: https://t.me/monkeys_giveaways/19)" style="pointer-events: auto; position: relative; z-index: 1;" />
          <p class="text-xs text-gray-500 mt-1">–ü–æ—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑ –≤–∞—à–µ–≥–æ –∫–∞–Ω–∞–ª–∞</p>
        </div>
        
        <div>
          <label class="block text-sm text-gray-400 mb-1">–£—Å–ª–æ–≤–∏—è —É—á–∞—Å—Ç–∏—è</label>
          <div class="flex gap-2 items-start">
            <textarea id="contest-conditions" class="input-field flex-1 p-2 rounded" rows="3" placeholder="üìã –£—Å–ª–æ–≤–∏—è —É—á–∞—Å—Ç–∏—è –≤ –∫–æ–Ω–∫—É—Ä—Å–µ" style="pointer-events: auto; position: relative; z-index: 1;"></textarea>
            <button id="add-subscription-condition-btn" class="w-10 h-10 rounded-full bg-violet-600 hover:bg-violet-700 text-white font-semibold transition-colors flex items-center justify-center text-lg mt-1" title="–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª–æ–≤–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∞–∫—Ç–∏–≤—ã">+</button>
          </div>
        </div>
        
        <div>
          <label class="block text-sm text-gray-400 mb-1">üèÜ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π</label>
          <div class="flex items-center gap-3">
            <button id="winners-count-decrease" class="w-10 h-10 rounded-full bg-violet-600 hover:bg-violet-700 text-white font-bold text-xl flex items-center justify-center transition-colors">‚àí</button>
            <div class="flex-1 relative overflow-hidden" style="height: 80px;">
              <div id="winners-count-picker" class="absolute inset-0 flex flex-col items-center justify-center">
                <div id="winners-count-value" class="text-4xl font-bold text-violet-400 transition-transform duration-300" style="line-height: 80px;">1</div>
              </div>
            </div>
            <button id="winners-count-increase" class="w-10 h-10 rounded-full bg-violet-600 hover:bg-violet-700 text-white font-bold text-xl flex items-center justify-center transition-colors">+</button>
          </div>
          <input type="hidden" id="contest-winners-count" value="1" />
        </div>
        
        <div class="p-3 rounded-md bg-violet-900/20 border border-violet-400/30 text-sm text-gray-300">
          ‚è± –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞ –±–æ–ª—å—à–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è ‚Äî –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–¥–≤–µ—Å—Ç–∏ –∏—Ç–æ–≥–∏ –≤—Ä—É—á–Ω—É—é –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç.
        </div>
      </div>
      <button id="submit-contest" class="neon-button w-full mt-4 py-3 rounded-lg">–î–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    </div>
  </div>

  <!-- üéØ –ú–æ–¥–∞–ª–∫–∞: –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∫–æ–Ω–∫—É—Ä—Å–∞ -->
  <div id="contest-type-selection-modal" class="hidden fixed inset-0 z-25 flex items-end sm:items-center justify-center bg-black/60 p-4" style="pointer-events: auto;">
    <div class="relative w-full max-w-[520px] max-h-[90vh] sm:max-h-[85vh] bg-[#0b0b10] rounded-t-2xl sm:rounded-2xl border border-violet-500/30 shadow-2xl p-5 my-auto" style="pointer-events: auto;">
      <button id="close-contest-type-selection-modal" class="absolute -top-3 -right-3 bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button z-10" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      <h3 class="text-lg font-semibold mb-4 sticky top-0 bg-[#0b0b10] pb-2 z-0">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–æ–Ω–∫—É—Ä—Å–∞</h3>
      <div class="space-y-3" style="pointer-events: auto;">
        <button id="select-random-comment-contest" class="w-full neon-button py-4 rounded-lg text-left px-4 flex items-center justify-between">
          <div>
            <div class="font-semibold text-lg">üé≤ –†–∞–Ω–¥–æ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
            <div class="text-sm text-gray-400 mt-1">–ö–æ–Ω–∫—É—Ä—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–∑ –ø–æ—Å—Ç–∞</div>
          </div>
          <span class="text-2xl">‚Üí</span>
        </button>
        <button id="select-drawing-contest" class="w-full neon-button py-4 rounded-lg text-left px-4 flex items-center justify-between">
          <div>
            <div class="font-semibold text-lg">üé® –ö–æ–Ω–∫—É—Ä—Å —Ä–∏—Å—É–Ω–∫–æ–≤</div>
            <div class="text-sm text-gray-400 mt-1">–ö–æ–Ω–∫—É—Ä—Å –Ω–∞ –ª—É—á—à–∏–π —Ä–∏—Å—É–Ω–æ–∫ –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ</div>
          </div>
          <span class="text-2xl">‚Üí</span>
        </button>
        <button id="select-collection-contest" class="w-full neon-button py-4 rounded-lg text-left px-4 flex items-center justify-between">
          <div>
            <div class="font-semibold text-lg">üñºÔ∏è –ö–æ–Ω–∫—É—Ä—Å –∫–æ–ª–ª–µ–∫—Ü–∏–π</div>
            <div class="text-sm text-gray-400 mt-1">–ö–æ–Ω–∫—É—Ä—Å –Ω–∞ –ª—É—á—à—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é NFT (9 —à—Ç—É–∫)</div>
          </div>
          <span class="text-2xl">‚Üí</span>
        </button>
      </div>
    </div>
  </div>

  <!-- üé® –ú–æ–¥–∞–ª–∫–∞: –°–æ–∑–¥–∞—Ç—å/–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—É—Ä—Å —Ä–∏—Å—É–Ω–∫–æ–≤ -->
  <div id="drawing-contest-modal" class="hidden fixed inset-0 z-20 flex items-end sm:items-center justify-center bg-black/60 p-4" style="pointer-events: auto; overflow-x: hidden; overflow-y: auto; touch-action: pan-y;">
    <div class="relative w-full max-w-[520px] max-h-[90vh] sm:max-h-[85vh] bg-[#0b0b10] rounded-t-2xl sm:rounded-2xl border border-violet-500/30 shadow-2xl p-5 my-auto" style="pointer-events: auto; overflow-x: hidden; overflow-y: auto; touch-action: pan-y; width: 100%; max-width: 520px;">
      <button id="close-drawing-contest-modal" class="absolute -top-3 -right-3 bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button z-10" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      <h3 id="drawing-contest-modal-title" class="text-lg font-semibold mb-3 sticky top-0 bg-[#0b0b10] pb-2 z-0" style="pointer-events: auto;">–°–æ–∑–¥–∞—Ç—å –∫–æ–Ω–∫—É—Ä—Å —Ä–∏—Å—É–Ω–∫–æ–≤</h3>
      <div class="space-y-3" style="pointer-events: auto;">
        <div>
          <label class="block text-sm text-gray-400 mb-1">–¢–µ–º–∞ —Ä–∏—Å—É–Ω–∫–æ–≤</label>
          <input id="drawing-contest-theme" class="input-field w-full p-2 rounded" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –∫–æ–Ω–∫—É—Ä—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö–æ—Å–º–æ—Å)" />
        </div>
        
        <div>
          <label class="block text-sm text-gray-400 mb-1">–£—Å–ª–æ–≤–∏—è —É—á–∞—Å—Ç–∏—è</label>
          <div class="space-y-2">
            <textarea id="drawing-contest-conditions-base" class="input-field w-full p-2 rounded" rows="3" readonly style="pointer-events: auto; position: relative; z-index: 1; background-color: #1a1a2e; resize: none; cursor: not-allowed;"></textarea>
            <div>
              <label class="block text-xs text-gray-500 mb-1">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
              <textarea id="drawing-contest-conditions-additional" class="input-field w-full p-2 rounded" rows="2" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è —É—á–∞—Å—Ç–∏—è..." style="pointer-events: auto; position: relative; z-index: 1;"></textarea>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-1">–£—Å–ª–æ–≤–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è. –í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –Ω–∏–∂–µ.</p>
        </div>
        
        <div>
          <label class="block text-sm text-gray-400 mb-1">üèÜ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π</label>
          <div class="flex items-center gap-3">
            <button id="drawing-winners-count-decrease" class="w-10 h-10 rounded-full bg-violet-600 hover:bg-violet-700 text-white font-bold text-xl flex items-center justify-center transition-colors">‚àí</button>
            <div class="flex-1 relative overflow-hidden" style="height: 80px;">
              <div id="drawing-winners-count-picker" class="absolute inset-0 flex flex-col items-center justify-center">
                <div id="drawing-winners-count-value" class="text-4xl font-bold text-violet-400 transition-transform duration-300" style="line-height: 80px;">1</div>
              </div>
            </div>
            <button id="drawing-winners-count-increase" class="w-10 h-10 rounded-full bg-violet-600 hover:bg-violet-700 text-white font-bold text-xl flex items-center justify-center transition-colors">+</button>
          </div>
          <input type="hidden" id="drawing-contest-winners-count" value="1" />
        </div>
        
        <div>
          <label class="block text-sm text-gray-400 mb-1">‚è∞ –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç</label>
          <input id="drawing-contest-submission-end" type="datetime-local" class="input-field w-full p-2 rounded" />
        </div>
        
        <div>
          <label class="block text-sm text-gray-400 mb-1">‚è∞ –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è</label>
          <input id="drawing-contest-voting-end" type="datetime-local" class="input-field w-full p-2 rounded" />
          <p class="text-xs text-gray-500 mt-1">–ú–µ–∂–¥—É –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º –ø—Ä–∏–µ–º–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 10 –º–∏–Ω—É—Ç</p>
        </div>
        
        <!-- –°–µ–∫—Ü–∏—è –∂—é—Ä–∏ -->
        <div class="border-t border-violet-500/30 pt-3 mt-3">
          <div class="flex items-center justify-between mb-3">
            <label class="block text-sm text-gray-400">üë®‚Äç‚öñÔ∏è –ñ—é—Ä–∏</label>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="drawing-contest-jury-enabled" class="sr-only peer" />
              <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-violet-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-violet-600"></div>
            </label>
          </div>
          
          <div id="drawing-contest-jury-settings" class="hidden space-y-3">
            <div>
              <label class="block text-sm text-gray-400 mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–ª–µ–Ω–æ–≤ –∂—é—Ä–∏</label>
              <div class="flex items-center gap-3">
                <button type="button" id="drawing-jury-count-decrease" class="w-10 h-10 rounded-full bg-violet-600 hover:bg-violet-700 text-white font-bold text-xl flex items-center justify-center transition-colors">‚àí</button>
                <div class="flex-1 relative overflow-hidden" style="height: 60px;">
                  <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <div id="drawing-jury-count-value" class="text-3xl font-bold text-violet-400 transition-transform duration-300" style="line-height: 60px;">1</div>
                  </div>
                </div>
                <button type="button" id="drawing-jury-count-increase" class="w-10 h-10 rounded-full bg-violet-600 hover:bg-violet-700 text-white font-bold text-xl flex items-center justify-center transition-colors">+</button>
              </div>
              <input type="hidden" id="drawing-contest-jury-count" value="1" />
            </div>
            <p class="text-xs text-gray-500">–î–∞–Ω–Ω—ã–µ —á–ª–µ–Ω–æ–≤ –∂—é—Ä–∏ (ID –∏ –∫–∞–Ω–∞–ª) –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –≤–≤–µ—Å—Ç–∏ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞</p>
          </div>
        </div>
      </div>
      <button id="submit-drawing-contest" class="neon-button w-full mt-4 py-3 rounded-lg">–î–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
      <button id="update-drawing-contest" class="neon-button w-full mt-4 py-3 rounded-lg hidden">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
    </div>
  </div>

  <!-- üèÜ –ú–æ–¥–∞–ª–∫–∞: –ò—Ç–æ–≥–∏ –∫–æ–Ω–∫—É—Ä—Å–∞ —Ä–∏—Å—É–Ω–∫–æ–≤ -->
  <div id="drawing-results-modal" class="hidden fixed inset-0 z-30 flex items-end sm:items-center justify-center bg-black/60 p-4 overflow-y-auto" style="pointer-events: auto;">
    <div class="relative w-full max-w-2xl bg-gradient-to-br from-gray-900 via-purple-900/20 to-gray-900 border border-violet-400/40 rounded-2xl shadow-2xl p-6 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-white">üèÜ –ò—Ç–æ–≥–∏ –∫–æ–Ω–∫—É—Ä—Å–∞</h2>
        <button onclick="document.getElementById('drawing-results-modal').classList.add('hidden'); document.body.classList.remove('modal-open');" class="bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button flex items-center justify-center" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      <div id="drawing-results-content" class="space-y-4">
        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
    </div>
  </div>

  <!-- üñºÔ∏è –ú–æ–¥–∞–ª–∫–∞: –°–æ–∑–¥–∞—Ç—å/–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—É—Ä—Å –∫–æ–ª–ª–µ–∫—Ü–∏–π -->
  <div id="collection-contest-modal" class="hidden fixed inset-0 z-20 flex items-end sm:items-center justify-center bg-black/60 p-4" style="pointer-events: auto; overflow-x: hidden; overflow-y: auto; touch-action: pan-y;">
    <div class="relative w-full max-w-[520px] max-h-[90vh] sm:max-h-[85vh] bg-[#0b0b10] rounded-t-2xl sm:rounded-2xl border border-violet-500/30 shadow-2xl p-5 my-auto" style="pointer-events: auto; overflow-x: hidden; overflow-y: auto; touch-action: pan-y; width: 100%; max-width: 520px;">
      <button id="close-collection-contest-modal" class="absolute -top-3 -right-3 bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button z-10" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      <h3 id="collection-contest-modal-title" class="text-lg font-semibold mb-3 sticky top-0 bg-[#0b0b10] pb-2 z-0" style="pointer-events: auto;">–°–æ–∑–¥–∞—Ç—å –∫–æ–Ω–∫—É—Ä—Å –∫–æ–ª–ª–µ–∫—Ü–∏–π</h3>
      <div class="space-y-3" style="pointer-events: auto;">
        <div>
          <label class="block text-sm text-gray-400 mb-1">–¢–µ–º–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–π</label>
          <input id="collection-contest-theme" class="input-field w-full p-2 rounded" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –∫–æ–Ω–∫—É—Ä—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö–æ—Å–º–æ—Å)" />
        </div>
        
        <div>
          <label class="block text-sm text-gray-400 mb-1">–£—Å–ª–æ–≤–∏—è —É—á–∞—Å—Ç–∏—è</label>
          <div class="space-y-2">
            <textarea id="collection-contest-conditions-base" class="input-field w-full p-2 rounded" rows="3" readonly style="pointer-events: auto; position: relative; z-index: 1; background-color: #1a1a2e; resize: none; cursor: not-allowed;"></textarea>
            <div>
              <label class="block text-xs text-gray-500 mb-1">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
              <textarea id="collection-contest-conditions-additional" class="input-field w-full p-2 rounded" rows="2" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è —É—á–∞—Å—Ç–∏—è..." style="pointer-events: auto; position: relative; z-index: 1;"></textarea>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-1">–£—Å–ª–æ–≤–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è. –í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –Ω–∏–∂–µ.</p>
        </div>
        
        <div>
          <label class="block text-sm text-gray-400 mb-1">üèÜ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π</label>
          <div class="flex items-center gap-3">
            <button id="collection-winners-count-decrease" class="w-10 h-10 rounded-full bg-violet-600 hover:bg-violet-700 text-white font-bold text-xl flex items-center justify-center transition-colors">‚àí</button>
            <div class="flex-1 relative overflow-hidden" style="height: 80px;">
              <div id="collection-winners-count-picker" class="absolute inset-0 flex flex-col items-center justify-center">
                <div id="collection-winners-count-value" class="text-4xl font-bold text-violet-400 transition-transform duration-300" style="line-height: 80px;">1</div>
              </div>
            </div>
            <button id="collection-winners-count-increase" class="w-10 h-10 rounded-full bg-violet-600 hover:bg-violet-700 text-white font-bold text-xl flex items-center justify-center transition-colors">+</button>
          </div>
          <input type="hidden" id="collection-contest-winners-count" value="1" />
        </div>
        
        <div>
          <label class="block text-sm text-gray-400 mb-1">‚è∞ –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç</label>
          <input id="collection-contest-submission-end" type="datetime-local" class="input-field w-full p-2 rounded" />
        </div>
        
        <div>
          <label class="block text-sm text-gray-400 mb-1">‚è∞ –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è</label>
          <input id="collection-contest-voting-end" type="datetime-local" class="input-field w-full p-2 rounded" />
          <p class="text-xs text-gray-500 mt-1">–ú–µ–∂–¥—É –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º –ø—Ä–∏–µ–º–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 10 –º–∏–Ω—É—Ç</p>
        </div>
      </div>
      <button id="submit-collection-contest" class="neon-button w-full mt-4 py-3 rounded-lg">–î–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
      <button id="update-collection-contest" class="neon-button w-full mt-4 py-3 rounded-lg hidden">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
    </div>
  </div>

  <!-- üèÜ –ú–æ–¥–∞–ª–∫–∞: –ò—Ç–æ–≥–∏ –∫–æ–Ω–∫—É—Ä—Å–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–π -->
  <div id="collection-results-modal" class="hidden fixed inset-0 z-30 flex items-end sm:items-center justify-center bg-black/60 p-4 overflow-y-auto" style="pointer-events: auto;">
    <div class="relative w-full max-w-2xl bg-gradient-to-br from-gray-900 via-purple-900/20 to-gray-900 border border-violet-400/40 rounded-2xl shadow-2xl p-6 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-white">üèÜ –ò—Ç–æ–≥–∏ –∫–æ–Ω–∫—É—Ä—Å–∞</h2>
        <button onclick="document.getElementById('collection-results-modal').classList.add('hidden'); document.body.classList.remove('modal-open');" class="bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button flex items-center justify-center" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      <div id="collection-results-content" class="space-y-4">
        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
    </div>
  </div>

  <!-- üéÅ –ú–æ–¥–∞–ª–∫–∞: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–∑—ã -->
  <div id="prizes-modal" class="hidden fixed inset-0 z-30 flex items-end sm:items-center justify-center bg-black/60 p-4" style="pointer-events: auto; overflow-y: auto; overflow-x: hidden; touch-action: pan-y pinch-zoom;">
    <div class="relative w-full max-w-[520px] max-h-[90vh] sm:max-h-[85vh] bg-[#0b0b10] rounded-t-2xl sm:rounded-2xl border border-violet-500/30 shadow-2xl p-5 my-auto" style="pointer-events: auto; overflow-y: auto; overflow-x: hidden; touch-action: pan-y; width: 100%; max-width: 520px;">
      <button id="close-prizes-modal" class="absolute -top-3 -right-3 bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button z-10" aria-label="–ó–∞–∫—Ä—ã—Ç—å" style="pointer-events: auto;">‚úï</button>
      <h3 class="text-lg font-semibold mb-3 sticky top-0 bg-[#0b0b10] pb-2 z-0" style="pointer-events: auto;">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–∑—ã</h3>
      <p class="text-sm text-gray-400 mb-4">–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–∏–∑—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ: t.me/nft/–Ω–∞–∑–≤–∞–Ω–∏–µ-–∫–æ–ª–ª–µ–∫—Ü–∏–∏-–Ω–æ–º–µ—Ä</p>
      <p class="text-xs text-gray-500 mb-4">–ü—Ä–∏–º–µ—Ä: t.me/nft/SnoopDogg-119754</p>
      <div id="prizes-list" class="space-y-3 mb-4" style="pointer-events: auto;">
        <!-- –ü—Ä–∏–∑—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
      
      <!-- –°–µ–∫—Ü–∏—è –∂—é—Ä–∏ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ) -->
      <div id="prizes-modal-jury-section" class="hidden border-t border-violet-500/30 pt-4 mt-4">
        <h4 class="text-sm font-semibold text-gray-300 mb-3">üë®‚Äç‚öñÔ∏è –î–∞–Ω–Ω—ã–µ —á–ª–µ–Ω–æ–≤ –∂—é—Ä–∏</h4>
        <div id="prizes-modal-jury-members" class="space-y-3 mb-4">
          <!-- –ß–ª–µ–Ω—ã –∂—é—Ä–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
      </div>
      
      <button id="add-prize-btn" class="neon-button w-full py-2 rounded-lg mb-4" style="pointer-events: auto;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–∑</button>
      <button id="submit-prizes" class="neon-button w-full py-3 rounded-lg" style="pointer-events: auto;">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏–∑—ã</button>
    </div>
  </div>

  <!-- üü£ Bottom neon shimmer backdrop for buttons -->
  <div class="neon-bottom"></div>

  <!-- üß† –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ UI/–∑–∞–≥—Ä—É–∑–∫–∞ -->
  <script>
    (function() {
      let currentUserRole = null;
      let currentUserId = null;
      const spinner = document.getElementById('loading-spinner');
      const topNav = document.getElementById('admin-nav');
      const main = document.querySelector('main');
      const contentSections = document.querySelectorAll('.content-section');
      const navButtons = topNav.querySelectorAll('.nav-button');

      function showSection(id) {
        contentSections.forEach(s => s.classList.toggle('hidden', s.id !== id));
        navButtons.forEach(b => b.classList.toggle('active', b.dataset.section === id));
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ —Å–µ–∫—Ü–∏–∏
        if (id === 'rating-section') {
          setTimeout(() => {
            if (typeof window.loadRating === 'function') {
              window.loadRating(currentRatingRole || 'user');
            }
          }, 100);
        }
      }

      navButtons.forEach(btn => {
        btn.addEventListener('click', () => showSection(btn.dataset.section));
      });

      // Loading control
      function hideSpinnerAndShowPanel() {
        spinner.classList.add('hidden');
        topNav.classList.remove('hidden');
        main.classList.remove('hidden');
      }

      // Access check and initialization
      async function checkAccess() {
        const params = new URLSearchParams(window.location.search);
        const tgId = params.get("tg_id");
        const roleParam = params.get("role");

        if (!tgId || !roleParam) {
          window.location.href = "index.html";
          return;
        }

        // Fallback: —Å–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥, –¥–∞–∂–µ –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –∑–∞–≤–∏—Å–∞–µ—Ç
        const fallbackTimeout = setTimeout(() => {
          console.warn('–¢–∞–π–º–∞—É—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞, —Å–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –ø–æ fallback');
          hideSpinnerAndShowPanel();
        }, 5000);

        try {
          const data = await fetchJSON(`/api/auth?tg_id=${tgId}`);
          clearTimeout(fallbackTimeout);

          if (!data.authorized || (data.role !== "admin" && data.role !== "creator")) {
            window.location.href = "index.html";
            return;
          }

          currentUserRole = data.role;
          currentUserId = parseInt(tgId);
          window.currentUserId = currentUserId; // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π

          // Telegram WebApp initialization
          if (window.Telegram?.WebApp) {
            Telegram.WebApp.ready();
            const tgUser = window.Telegram.WebApp.initDataUnsafe?.user;
            if (tgUser) {
              const usernameEl = document.getElementById('profile-username');
              if (usernameEl) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º username –∏–∑ Telegram WebApp –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ first_name, –∏–Ω–∞—á–µ "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"
                const displayName = tgUser.username || tgUser.first_name || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
                usernameEl.textContent = displayName;
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º username –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                if (tgUser.username) {
                  fetch(`/api/profile/update-username?tg_id=${currentUserId}&username=${encodeURIComponent(tgUser.username)}`, {
                    method: 'POST'
                  }).catch(() => {});
                }
              }
              const profileIdEl = document.getElementById('profile-id');
              if (profileIdEl) {
                profileIdEl.textContent = tgUser.id || tgId;
              }
            }
          }

          // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
          hideSpinnerAndShowPanel();
          
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –ø–∞–Ω–µ–ª—å –ø–æ–∫–∞–∑–∞–Ω–∞
          setTimeout(() => {
            try {
              loadContests();
              loadProfile();
            } catch (error) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
            }
          }, 100);
        } catch (err) {
          clearTimeout(fallbackTimeout);
          console.error("–û—à–∏–±–∫–∞:", err);
          // –î–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–µ–ª –±–µ—Å–∫–æ–Ω–µ—á–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É
          hideSpinnerAndShowPanel();
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
          if (spinner) {
            spinner.innerHTML = '<div class="text-yellow-500 text-lg font-semibold">‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</div>';
          }
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        checkAccess();
      });

      // Utilities: format to Moscow time
      function toMoscowDateTime(value) {
        if (!value) return '';
        const d = (value instanceof Date) ? value : new Date(value);
        if (Number.isNaN(d.getTime())) return '';
        return new Intl.DateTimeFormat('ru-RU', {
          timeZone: 'Europe/Moscow',
          year: 'numeric', month: '2-digit', day: '2-digit',
          hour: '2-digit', minute: '2-digit'
        }).format(d);
      }

      // Data fetching helpers
      window.fetchJSON = async function fetchJSON(url, options = {}) {
        // –î–ª—è –≤—ã–±–æ—Ä–∫–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ Telethon –¥–∞—ë–º –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ (–¥–æ 60 —Å–µ–∫—É–Ω–¥)
        const defaultTimeout = url.includes('/select-winners') ? 60000 : 10000;
        const timeout = options.timeout || defaultTimeout;
        
        // –£—á–∏—Ç—ã–≤–∞–µ–º –≤–Ω–µ—à–Ω–∏–π AbortController, –µ—Å–ª–∏ –æ–Ω –ø–µ—Ä–µ–¥–∞–Ω
        const controller = options.signal instanceof AbortController ? options.signal : new AbortController();
        const timeoutId = setTimeout(() => {
          if (!(options.signal instanceof AbortController)) {
            controller.abort();
          }
        }, timeout);
        
        try {
          const res = await fetch(url, {
            ...options,
            signal: controller.signal
          });
          clearTimeout(timeoutId);
          
          if (!res.ok) {
            let errorMessage = `HTTP error! status: ${res.status}`;
            try {
              const errorData = await res.json();
              if (errorData.detail) {
                errorMessage = errorData.detail;
              } else if (errorData.message) {
                errorMessage = errorData.message;
              }
            } catch (e) {
              // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            }
            const error = new Error(errorMessage);
            error.status = res.status;
            error.response = res;
            throw error;
          }
          
          const jsonData = await res.json();
          console.log('üìã fetchJSON: –û—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω:', jsonData);
          return jsonData;
        } catch (error) {
          clearTimeout(timeoutId);
          if (error.name === 'AbortError') {
            const timeoutError = new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
            timeoutError.status = 408;
            throw timeoutError;
          }
          throw error;
        }
      }

      // Extract username from Telegram link
      function extractUsernameFromLink(link) {
        if (!link) return null;
        // Formats: https://t.me/username, https://telegram.me/username, @username, t.me/username
        const match = link.match(/(?:t\.me|telegram\.me)\/([a-zA-Z0-9_]+)|@([a-zA-Z0-9_]+)/);
        return match ? (match[1] || match[2]) : null;
      }

      // Get chat/channel title from Telegram API
      async function getChatTitle(link) {
        try {
          // Try to get title via backend API
          const username = extractUsernameFromLink(link);
          if (!username) return link; // Fallback to link if can't parse
          
          const response = await fetch(`/api/chat-info?link=${encodeURIComponent(link)}`);
          if (response.ok) {
            const data = await response.json();
            return data.title || data.username || link;
          }
          
          // Fallback: try to parse from link and show username
          return `@${username}`;
        } catch (e) {
          // Final fallback: show the link or username
          const username = extractUsernameFromLink(link);
          return username ? `@${username}` : link;
        }
      }

      // Contests - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–æ–ª–∏
      const contestList = document.getElementById('contest-list');
      const openContestBtn = document.getElementById('create-contest-btn');
      const contestModal = document.getElementById('contest-modal');
      const closeContestModal = document.getElementById('close-contest-modal');
      const submitContest = document.getElementById('submit-contest');
      const postLinkError = document.getElementById('post-link-error');

      let adminChannelLink = null; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞–Ω–∞–ª –∞–¥–º–∏–Ω–∞
      let adminChatLink = null; // –°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç –∞–¥–º–∏–Ω–∞
      let currentContestType = "–†–∞–Ω–¥–æ–º–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"; // –¢–∏–ø —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–Ω–∫—É—Ä—Å–∞
      let currentDrawingWinnersCount = 1; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞ —Ä–∏—Å—É–Ω–∫–æ–≤
      let currentCollectionWinnersCount = 1; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–π
      let originalBaseValue = ''; // –ó–∞—â–∏—â–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö —É—Å–ª–æ–≤–∏–π
      let currentEditContestId = null; // ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –∫–æ–Ω–∫—É—Ä—Å–∞
      const telethonInProgress = new Set(); // –ö–æ–Ω–∫—É—Ä—Å—ã, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö —É–∂–µ –∑–∞–ø—É—â–µ–Ω —Å–±–æ—Ä –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤

      function openModal(el) { el.classList.remove('hidden'); }
      function closeModal(el) { el.classList.add('hidden'); }
      
      // –û–±—ä—è–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é openPrizesModal –∑–∞—Ä–∞–Ω–µ–µ, —á—Ç–æ–±—ã –æ–Ω–∞ –±—ã–ª–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
      let openPrizesModal = null; // –ë—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –ø–æ–∑–∂–µ

      if (openContestBtn) {
        openContestBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –∫–æ–Ω–∫—É—Ä—Å–∞
          const contestTypeSelectionModal = document.getElementById('contest-type-selection-modal');
          if (contestTypeSelectionModal) {
            openModal(contestTypeSelectionModal);
          } else {
            console.error('‚ùå –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –∫–æ–Ω–∫—É—Ä—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!');
          }
        });
      }
      if (closeContestModal) {
        closeContestModal.addEventListener('click', () => {
          closeModal(contestModal);
        });
      }

      // –ö—Ä—É—Ç–∏–ª–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π (admin)
      const winnersCountValue = document.getElementById('winners-count-value');
      const winnersCountInput = document.getElementById('contest-winners-count');
      const winnersCountDecrease = document.getElementById('winners-count-decrease');
      const winnersCountIncrease = document.getElementById('winners-count-increase');
      
      let currentWinnersCount = 1;
      const minCount = 1;
      const maxCount = 50;
      
      function updateWinnersCount(newValue, direction) {
        if (newValue < minCount) newValue = minCount;
        if (newValue > maxCount) newValue = maxCount;
        
        if (newValue !== currentWinnersCount) {
          currentWinnersCount = newValue;
          
          // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∑–∞–Ω–æ–≤–æ, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã
          const winnersCountValueEl = document.getElementById('winners-count-value');
          const winnersCountInputEl = document.getElementById('contest-winners-count');
          
          if (winnersCountValueEl) {
            winnersCountValueEl.classList.remove('number-spin-up', 'number-spin-down');
            void winnersCountValueEl.offsetWidth;
            
            if (direction === 'up') {
              winnersCountValueEl.classList.add('number-spin-up');
            } else if (direction === 'down') {
              winnersCountValueEl.classList.add('number-spin-down');
            }
            
            winnersCountValueEl.textContent = currentWinnersCount;
          }
          
          if (winnersCountInputEl) {
            winnersCountInputEl.value = currentWinnersCount;
          }
        }
      }
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
      // –≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ DOM
      // contestModal —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω –≤—ã—à–µ (—Å—Ç—Ä–æ–∫–∞ 830)
      if (contestModal) {
        contestModal.addEventListener('click', (e) => {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ –Ω–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ —É–º–µ–Ω—å—à–µ–Ω–∏—è
          if (e.target && (e.target.id === 'winners-count-decrease' || e.target.closest('#winners-count-decrease'))) {
            e.preventDefault();
            e.stopPropagation();
            updateWinnersCount(currentWinnersCount - 1, 'down');
          }
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ –Ω–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ —É–≤–µ–ª–∏—á–µ–Ω–∏—è
          if (e.target && (e.target.id === 'winners-count-increase' || e.target.closest('#winners-count-increase'))) {
            e.preventDefault();
            e.stopPropagation();
            updateWinnersCount(currentWinnersCount + 1, 'up');
          }
        });
      }
      
      // –¢–∞–∫–∂–µ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä—è–º—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
      if (winnersCountDecrease) {
        winnersCountDecrease.addEventListener('click', () => {
          updateWinnersCount(currentWinnersCount - 1, 'down');
        });
      }
      
      if (winnersCountIncrease) {
        winnersCountIncrease.addEventListener('click', () => {
          updateWinnersCount(currentWinnersCount + 1, 'up');
        });
      }

      const contestTitleInput = document.getElementById('contest-title');

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –∫–æ–Ω–∫—É—Ä—Å–∞
      const contestTypeSelectionModal = document.getElementById('contest-type-selection-modal');
      const closeContestTypeSelectionModal = document.getElementById('close-contest-type-selection-modal');
      const selectRandomCommentContest = document.getElementById('select-random-comment-contest');
      const selectDrawingContest = document.getElementById('select-drawing-contest');
      
      if (closeContestTypeSelectionModal && contestTypeSelectionModal) {
        closeContestTypeSelectionModal.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeModal(contestTypeSelectionModal);
        });
      }
      
      if (selectRandomCommentContest) {
        selectRandomCommentContest.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeModal(contestTypeSelectionModal);
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∏–ø –∫–æ–Ω–∫—É—Ä—Å–∞
          currentContestType = "–†–∞–Ω–¥–æ–º–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π";
          if (contestTitleInput) {
            contestTitleInput.value = "–†–∞–Ω–¥–æ–º–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π";
          }
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
          document.getElementById('contest-conditions').value = '';
          updateWinnersCount(1, 'up');
          if (contestModal) {
            openModal(contestModal);
          }
        });
      }
      
      if (selectDrawingContest) {
        selectDrawingContest.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeModal(contestTypeSelectionModal);
          const drawingContestModal = document.getElementById('drawing-contest-modal');
          if (drawingContestModal) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π
            try {
              const profileResponse = await fetchJSON(`/api/profile?tg_id=${currentUserId}`);
              const adminChannelLink = profileResponse.channel_link || '';
              const adminChatLink = profileResponse.chat_link || '';
              const creatorChannelLink = 't.me/monkeys_giveaways';
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –∞–¥–º–∏–Ω–∞ –µ—Å—Ç—å –∫–∞–Ω–∞–ª –∏ —á–∞—Ç
              if (!adminChannelLink || !adminChatLink) {
                alert('‚ö†Ô∏è –£ –≤–∞—Å –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –∫–∞–Ω–∞–ª –∏/–∏–ª–∏ —á–∞—Ç! –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Å–æ–∑–¥–∞—Ç–µ–ª—é –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–æ–≤.');
                return;
              }
              
              // –§–æ—Ä–º–∏—Ä—É–µ–º –±–∞–∑–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è —É—á–∞—Å—Ç–∏—è
              let baseConditionsText = '–î–ª—è —É—á–∞—Å—Ç–∏—è –≤ –∫–æ–Ω–∫—É—Ä—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:\n';
              baseConditionsText += `- –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª –∞–¥–º–∏–Ω–∞: ${adminChannelLink}\n`;
              baseConditionsText += `- –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —á–∞—Ç –∞–¥–º–∏–Ω–∞: ${adminChatLink}\n`;
              baseConditionsText += `- –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª —Å–æ–∑–¥–∞—Ç–µ–ª—è: ${creatorChannelLink}\n`;
              baseConditionsText += '- –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫ –Ω–∞ –∑–∞–¥–∞–Ω–Ω—É—é —Ç–µ–º—É';
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–∞–∑–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ (readonly)
              const baseConditionsTextarea = document.getElementById('drawing-contest-conditions-base');
              if (baseConditionsTextarea) {
                baseConditionsTextarea.value = baseConditionsText;
                originalBaseValue = baseConditionsText;
              }
              
              // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π
              const additionalConditionsTextarea = document.getElementById('drawing-contest-conditions-additional');
              if (additionalConditionsTextarea) {
                additionalConditionsTextarea.value = '';
              }
            } catch (error) {
              console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è:', error);
              alert('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –∫–∞–Ω–∞–ª –∏ —á–∞—Ç.');
              return;
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω–∫—É—Ä—Å–∞
            currentEditContestId = null;
            const submitBtn = document.getElementById('submit-drawing-contest');
            const updateBtn = document.getElementById('update-drawing-contest');
            if (submitBtn) submitBtn.classList.remove('hidden');
            if (updateBtn) updateBtn.classList.add('hidden');
            const modalTitle = document.getElementById('drawing-contest-modal-title');
            if (modalTitle) modalTitle.textContent = '–°–æ–∑–¥–∞—Ç—å –∫–æ–Ω–∫—É—Ä—Å —Ä–∏—Å—É–Ω–∫–æ–≤';
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –º–æ–¥–∞–ª–∫–∏
            document.getElementById('drawing-contest-theme').value = '';
            document.getElementById('drawing-contest-submission-end').value = '';
            document.getElementById('drawing-contest-voting-end').value = '';
            document.getElementById('drawing-contest-conditions-additional').value = '';
            currentDrawingWinnersCount = 1;
            const drawingWinnersCountValueEl = document.getElementById('drawing-winners-count-value');
            const drawingWinnersCountInputEl = document.getElementById('drawing-contest-winners-count');
            if (drawingWinnersCountValueEl) drawingWinnersCountValueEl.textContent = '1';
            if (drawingWinnersCountInputEl) drawingWinnersCountInputEl.value = '1';
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∑–∞—â–∏—Ç—É –±–∞–∑–æ–≤—ã—Ö —É—Å–ª–æ–≤–∏–π
            setTimeout(() => {
              if (typeof window.setupBaseConditionsProtection === 'function') {
                window.setupBaseConditionsProtection();
              }
            }, 150);
            
            openModal(drawingContestModal);
          }
        });
      }
      
      const selectCollectionContest = document.getElementById('select-collection-contest');
      if (selectCollectionContest) {
        selectCollectionContest.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeModal(contestTypeSelectionModal);
          const collectionContestModal = document.getElementById('collection-contest-modal');
          if (collectionContestModal) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π
            try {
              const profileResponse = await fetchJSON(`/api/profile?tg_id=${currentUserId}`);
              const adminChannelLink = profileResponse.channel_link || '';
              const adminChatLink = profileResponse.chat_link || '';
              const creatorChannelLink = 't.me/monkeys_giveaways';
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –∞–¥–º–∏–Ω–∞ –µ—Å—Ç—å –∫–∞–Ω–∞–ª –∏ —á–∞—Ç
              if (!adminChannelLink || !adminChatLink) {
                alert('‚ö†Ô∏è –£ –≤–∞—Å –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –∫–∞–Ω–∞–ª –∏/–∏–ª–∏ —á–∞—Ç! –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Å–æ–∑–¥–∞—Ç–µ–ª—é –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–æ–≤.');
                return;
              }
              
              // –§–æ—Ä–º–∏—Ä—É–µ–º –±–∞–∑–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è —É—á–∞—Å—Ç–∏—è
              let baseConditionsText = '–î–ª—è —É—á–∞—Å—Ç–∏—è –≤ –∫–æ–Ω–∫—É—Ä—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:\n';
              baseConditionsText += `- –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª –∞–¥–º–∏–Ω–∞: ${adminChannelLink}\n`;
              baseConditionsText += `- –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —á–∞—Ç –∞–¥–º–∏–Ω–∞: ${adminChatLink}\n`;
              baseConditionsText += `- –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª —Å–æ–∑–¥–∞—Ç–µ–ª—è: ${creatorChannelLink}\n`;
              baseConditionsText += '- –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é –∏–∑ 9 NFT';
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–∞–∑–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ (readonly)
              const baseConditionsTextarea = document.getElementById('collection-contest-conditions-base');
              if (baseConditionsTextarea) {
                baseConditionsTextarea.value = baseConditionsText;
                originalBaseValue = baseConditionsText;
              }
              
              // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π
              const additionalConditionsTextarea = document.getElementById('collection-contest-conditions-additional');
              if (additionalConditionsTextarea) {
                additionalConditionsTextarea.value = '';
              }
            } catch (error) {
              console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è:', error);
              alert('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –∫–∞–Ω–∞–ª –∏ —á–∞—Ç.');
              return;
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            currentEditContestId = null;
            const submitBtn = document.getElementById('submit-collection-contest');
            const updateBtn = document.getElementById('update-collection-contest');
            if (submitBtn) submitBtn.classList.remove('hidden');
            if (updateBtn) updateBtn.classList.add('hidden');
            const modalTitle = document.getElementById('collection-contest-modal-title');
            if (modalTitle) modalTitle.textContent = '–°–æ–∑–¥–∞—Ç—å –∫–æ–Ω–∫—É—Ä—Å –∫–æ–ª–ª–µ–∫—Ü–∏–π';
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –º–æ–¥–∞–ª–∫–∏
            document.getElementById('collection-contest-theme').value = '';
            document.getElementById('collection-contest-submission-end').value = '';
            document.getElementById('collection-contest-voting-end').value = '';
            document.getElementById('collection-contest-conditions-additional').value = '';
            currentCollectionWinnersCount = 1;
            const collectionWinnersCountValueEl = document.getElementById('collection-winners-count-value');
            const collectionWinnersCountInputEl = document.getElementById('collection-contest-winners-count');
            if (collectionWinnersCountValueEl) collectionWinnersCountValueEl.textContent = '1';
            if (collectionWinnersCountInputEl) collectionWinnersCountInputEl.value = '1';
            
            openModal(collectionContestModal);
          }
        });
      }

      // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å–ª–æ–≤–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)
      const addSubscriptionConditionBtn = document.getElementById('add-subscription-condition-btn');
      const contestConditionsTextarea = document.getElementById('contest-conditions');

      if (addSubscriptionConditionBtn) {
        addSubscriptionConditionBtn.addEventListener('click', () => {
          if (!contestConditionsTextarea) return;
          
          let subscriptionText = '';
          const conditions = [];
          
          if (adminChannelLink) {
            const channelUsername = extractChannelUsername(adminChannelLink);
            if (channelUsername) {
              conditions.push(`üì¢ –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª: @${channelUsername}`);
            }
          }
          
          if (adminChatLink) {
            const chatUsername = extractChannelUsername(adminChatLink);
            if (chatUsername) {
              conditions.push(`üí¨ –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —á–∞—Ç: @${chatUsername}`);
            }
          }
          
          if (conditions.length === 0) {
            alert('‚ö†Ô∏è –£ –≤–∞—Å –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –∞–∫—Ç–∏–≤—ã (–∫–∞–Ω–∞–ª –∏–ª–∏ —á–∞—Ç)!');
            return;
          }
          
          subscriptionText = conditions.join('\n');
          
          // –î–æ–±–∞–≤–ª—è–µ–º –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —É—Å–ª–æ–≤–∏—è–º –∏–ª–∏ –∑–∞–º–µ–Ω—è–µ–º
          const currentConditions = contestConditionsTextarea.value.trim();
          if (currentConditions) {
            contestConditionsTextarea.value = currentConditions + '\n\n' + subscriptionText;
          } else {
            contestConditionsTextarea.value = subscriptionText;
          }
        });
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è username –∫–∞–Ω–∞–ª–∞ –∏–∑ —Å—Å—ã–ª–∫–∏
      function extractChannelUsername(link) {
        if (!link) return null;
        // –§–æ—Ä–º–∞—Ç—ã: https://t.me/channel, t.me/channel, @channel, https://telegram.me/channel
        const match = link.match(/(?:t\.me|telegram\.me)\/([a-zA-Z0-9_]+)|@([a-zA-Z0-9_]+)/);
        return match ? (match[1] || match[2]) : null;
      }

      // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –ø–æ—Å—Ç –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –∫–∞–Ω–∞–ª—É –∞–¥–º–∏–Ω–∞
      function validatePostLink(postLink, channelLink) {
        if (!postLink || !channelLink) return false;
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º username –∫–∞–Ω–∞–ª–∞
        const channelUsername = extractChannelUsername(channelLink);
        if (!channelUsername) return false;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø–æ—Å—Ç: https://t.me/channel_username/post_id
        // –ü—Ä–∏–º–µ—Ä: https://t.me/monkeys_giveaways/19
        const postPattern = new RegExp(`(?:t\\.me|telegram\\.me)/${channelUsername.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}/(\\d+)`, 'i');
        return postPattern.test(postLink);
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø–æ—Å—Ç –ø—Ä–∏ –≤–≤–æ–¥–µ
      const postLinkInput = document.getElementById('contest-post-link');
      if (postLinkInput) {
        postLinkInput.addEventListener('blur', () => {
          const postLink = postLinkInput.value.trim();
          if (postLink && adminChannelLink) {
            if (!validatePostLink(postLink, adminChannelLink)) {
              postLinkError.classList.remove('hidden');
            } else {
              postLinkError.classList.add('hidden');
            }
          } else {
            postLinkError.classList.add('hidden');
          }
        });
      }

      async function loadContests() {
        try {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
          contestList.innerHTML = '<div class="text-gray-400 text-center py-4">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω–∫—É—Ä—Å–æ–≤...</div>';
          
          // –î–ª—è –∞–¥–º–∏–Ω–∞ –¥–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä admin_id –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è - –≤—Å–µ –∫–æ–Ω–∫—É—Ä—Å—ã
          const url = currentUserRole === 'admin' 
            ? `/api/contests?admin_id=${currentUserId}`
            : '/api/contests';
          
          const items = await fetchJSON(url);
          contestList.innerHTML = '';
          if (items.length === 0) {
            contestList.innerHTML = '<div class="text-gray-500 text-center py-4">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä—Å–æ–≤</div>';
            return;
          }
          
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω–∫—É—Ä—Å–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.
          // –î–ª—è –∞–¥–º–∏–Ω–∞ –ø–µ—Ä–µ–¥–∞—ë–º current_user_id, —á—Ç–æ–±—ã –æ–Ω –≤–∏–¥–µ–ª —Å–≤–æ–∏—Ö –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
          const winnersPromises = items.map(c => 
            fetchJSON(`/api/contests/${c.id}/winners?current_user_id=${currentUserId}`).catch(e => {
              console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞ ${c.id}:`, e);
              return { winners: [], is_confirmed: false };
            })
          );
          const winnersResults = await Promise.all(winnersPromises);
          
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω–∫—É—Ä—Å–∞ (–∞–∫—Ç–∏–≤–Ω—ã–π/–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π)
          const contestsWithStatus = items.map((c, index) => {
            const winnersData = winnersResults[index];
            let isEnded = false;
            
            if (c.end_at || c.end_date) {
              try {
                const endDate = new Date(c.end_at || c.end_date);
                const now = new Date();
                isEnded = endDate < now;
              } catch (e) {
                console.error(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞ ${c.id}:`, e);
              }
            }
            
            const isConfirmed = winnersData?.is_confirmed || false;
            const hasWinners = winnersData?.winners && winnersData.winners.length > 0;
            const isCompleted = isEnded || isConfirmed || hasWinners;
            
            return {
              contest: c,
              index: index,
              isCompleted: isCompleted,
              winnersData: winnersData
            };
          });
          
          // –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ
          const activeContests = contestsWithStatus.filter(item => !item.isCompleted);
          const completedContests = contestsWithStatus.filter(item => item.isCompleted);
          
          // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä—Å–æ–≤
          contestList.innerHTML = '';
          
          if (activeContests.length > 0) {
            const activeHeader = document.createElement('div');
            activeHeader.className = 'text-xl font-bold text-violet-400 mb-4 mt-4';
            activeHeader.textContent = '‚ú® –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä—Å—ã';
            contestList.appendChild(activeHeader);
          }
          
          // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä—Å–æ–≤
          for (let idx = 0; idx < activeContests.length; idx++) {
            const { contest: c, index: i, winnersData } = activeContests[idx];
            
            const card = document.createElement('div');
            card.className = 'deletable-item rounded-lg border border-violet-400/30 p-3 bg-black/30';
            card.dataset.contestId = c.id;
            
            const period = (c.start_at || c.end_at)
              ? `<div class="text-xs text-gray-400 mt-1">${c.start_at ? '–°—Ç–∞—Ä—Ç: ' + toMoscowDateTime(c.start_at) : ''} ${c.end_at ? ' ¬∑ –ö–æ–Ω–µ—Ü: ' + toMoscowDateTime(c.end_at) : ''}</div>`
              : '';
            
            const postLink = c.post_link 
              ? `<div class="mt-2 pt-2 border-t border-violet-400/20">
                   <div class="text-xs text-gray-500 mb-1">üîó –ß–∞—Å—Ç—å 1: –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å—Ç</div>
                   <a href="${c.post_link}" target="_blank" class="text-blue-400 hover:underline text-sm break-all">${c.post_link}</a>
                 </div>` 
              : '';
            
            const conditions = c.conditions 
              ? `<div class="mt-2 pt-2 border-t border-violet-400/20">
                   <div class="text-xs text-gray-500 mb-1">üìã –ß–∞—Å—Ç—å 2: –£—Å–ª–æ–≤–∏—è —É—á–∞—Å—Ç–∏—è</div>
                   <div class="text-sm text-gray-300">${c.conditions}</div>
                 </div>` 
              : '';
            
            // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—É—Ä—Å–∞
            const contestTitle = c.title || c.name || '–ö–æ–Ω–∫—É—Ä—Å';
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–∏–∑—ã (–º–∞–∫—Å–∏–º—É–º 3, –Ω–æ –µ—Å–ª–∏ –º–µ–Ω—å—à–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ)
            let prizesHtml = '';
            if (c.prize_links && Array.isArray(c.prize_links) && c.prize_links.length > 0) {
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º 3 –ø—Ä–∏–∑–∞ (–∑–∞ –ø–µ—Ä–≤—ã–µ 3 –º–µ—Å—Ç–∞)
              const prizesToShow = c.prize_links.slice(0, Math.min(3, c.prize_links.length));
              
              // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–∏–∑
              function normalizePrizeLink(link) {
                if (!link) return '';
                link = link.trim();
                if (link.startsWith('http://') || link.startsWith('https://')) {
                  return link;
                }
                if (link.startsWith('t.me/')) {
                  return 'https://' + link;
                }
                return 'https://' + link;
              }
              
              // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è NFT - –∏—Å–ø–æ–ª—å–∑—É–µ–º img —Å –∑–∞–≥—Ä—É–∑–∫–æ–π —á–µ—Ä–µ–∑ API
              function getNFTImageHtml(link, idx) {
                const normalizedLink = normalizePrizeLink(link);
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º img —Å src, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ API endpoint
                return `
                  <img 
                    src="/api/nft-preview?nft_link=${encodeURIComponent(normalizedLink)}" 
                    alt="–ü—Ä–∏–∑ ${idx + 1}"
                    class="w-full h-full object-cover rounded-lg prize-image"
                    onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');"
                    loading="lazy"
                  />
                `;
              }
              
              // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è grid
              const gridCols = prizesToShow.length === 1 ? 'grid-cols-1' : prizesToShow.length === 2 ? 'grid-cols-2' : 'grid-cols-3';
              
              prizesHtml = `
                <div class="mb-4">
                  <div class="grid ${gridCols} gap-3 mb-3">
                    ${prizesToShow.map((prizeLink, idx) => {
                      const normalizedLink = normalizePrizeLink(prizeLink);
                      return `
                      <div class="relative rounded-xl overflow-hidden border-2 border-violet-400/40 bg-gradient-to-br from-violet-600/30 via-pink-600/30 to-purple-600/30 aspect-square group hover:scale-105 transition-transform shadow-lg cursor-pointer">
                        <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48cGF0dGVybiBpZD0iZ3JpZCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiBwYXR0ZXJuVW5pdHM9InVzZXJTcGFjZU9uVXNlIj48Y2lyY2xlIGN4PSIxMCIgY3k9IjEwIiByPSIxLjUiIGZpbGw9IiNmZmYiIG9wYWNpdHk9IjAuMSIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9InVybCgjZ3JpZCkiLz48L3N2Zz4=')] opacity-20"></div>
                        <a href="${normalizedLink}" target="_blank" class="absolute inset-0 z-10 block">
                          <div class="w-full h-full relative">
                            ${getNFTImageHtml(prizeLink, idx)}
                            <div class="absolute inset-0 flex items-center justify-center bg-black/30 rounded-lg fallback-prize hidden">
                              <div class="text-5xl opacity-70">üéÅ</div>
                            </div>
                          </div>
                        </a>
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-2 z-20 pointer-events-none">
                          <div class="text-xs text-white font-semibold text-center">${idx + 1} –º–µ—Å—Ç–æ</div>
                        </div>
                      </div>
                    `;
                    }).join('')}
                  </div>
                  ${c.prize_links.length > 3 ? `<div class="text-xs text-gray-400 text-center">+${c.prize_links.length - 3} –µ—â–µ –ø—Ä–∏–∑–æ–≤</div>` : ''}
                </div>
              `;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω –ª–∏ –∫–æ–Ω–∫—É—Ä—Å
            let isEnded = false;
            if (c.end_at) {
              try {
                const endDate = new Date(c.end_at);
                const now = new Date();
                isEnded = endDate < now;
                console.log(`–ö–æ–Ω–∫—É—Ä—Å ${c.id}: end_at=${c.end_at}, parsed=${endDate.toISOString()}, now=${now.toISOString()}, isEnded=${isEnded}`);
              } catch (e) {
                console.error(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞ ${c.id}:`, e);
              }
            } else {
              // –ï—Å–ª–∏ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ—Ç (–¥–ª—è —Ä–∞–Ω–¥–æ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –≤—Ä–µ–º—è –Ω–µ –∑–∞–¥–∞—ë–º),
              // —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –∫–æ–Ω–∫—É—Ä—Å –º–æ–∂–Ω–æ –∑–∞–≤–µ—Ä—à–∞—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç
              isEnded = true;
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–æ–Ω–∫—É—Ä—Å–∞
            const contestType = c.contest_type || 'random_comment';
            const isDrawingContest = contestType === 'drawing';
            const isCollectionContest = contestType === 'collection';
            const isRandomCommentContest = contestType === 'random_comment';
            
            // –î–ª—è –∫–æ–Ω–∫—É—Ä—Å–æ–≤ —Ä–∏—Å—É–Ω–∫–æ–≤ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∏—Ç–æ–≥–æ–≤
            let drawingResultsHtml = '';
            let drawingResultsCalculated = false;
            let drawingIsCreator = false;
            
            // –î–ª—è –∫–æ–Ω–∫—É—Ä—Å–æ–≤ –∫–æ–ª–ª–µ–∫—Ü–∏–π –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∏—Ç–æ–≥–æ–≤
            let collectionResultsHtml = '';
            let collectionResultsCalculated = false;
            let collectionIsCreator = false;
            
            if (isDrawingContest) {
              try {
                const resultsResponse = await fetchJSON(`/api/contests/${c.id}/results`).catch((err) => {
                  console.log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞ ${c.id}:`, err);
                  return { results_calculated: false };
                });
                drawingResultsCalculated = resultsResponse?.results_calculated || false;
                const currentUserIdNum = Number(currentUserId);
                const createdByIdNum = c.created_by ? Number(c.created_by) : null;
                drawingIsCreator = createdByIdNum !== null && currentUserIdNum === createdByIdNum;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–¥–µ—Ç –ª–∏ –≤—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç
                const submissionEndDate = c.submission_end_date ? new Date(c.submission_end_date) : null;
                const now = new Date();
                const isSubmissionPeriodActive = submissionEndDate && now <= submissionEndDate;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
                const isAdmin = window.currentUserRole === 'admin' || window.currentUserRole === 'creator';
                
                if (isSubmissionPeriodActive && (drawingIsCreator || isAdmin)) {
                  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—ã" –≤–æ –≤—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç
                  drawingResultsHtml = `<div class="mt-2 pt-2 border-t border-violet-400/20">
                    <button 
                      onclick="showContestWorks(${c.id})" 
                      class="neon-button w-full py-2 rounded-lg text-sm"
                      id="check-works-btn-${c.id}"
                    >
                      üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—ã
                    </button>
                  </div>`;
                } else if (isEnded && !drawingResultsCalculated) {
                  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–¥—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤" —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞
                  if (drawingIsCreator) {
                    drawingResultsHtml = `<div class="mt-2 pt-2 border-t border-violet-400/20">
                      <button 
                        class="neon-button w-full py-2 rounded-lg text-sm"
                        id="calculate-results-btn-${c.id}"
                        style="pointer-events: auto; cursor: pointer;"
                      >
                        üìä –ü–æ–¥—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤
                      </button>
                    </div>`;
                  }
                } else if (drawingResultsCalculated) {
                  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Ç–æ–≥–∏" –¥–ª—è –≤—Å–µ—Ö –ø–æ—Å–ª–µ –ø–æ–¥—Å—á–µ—Ç–∞
                  drawingResultsHtml = `<div class="mt-2 pt-2 border-t border-violet-400/20">
                    <button 
                      onclick="showDrawingResults(${c.id})" 
                      class="neon-button w-full py-2 rounded-lg text-sm"
                      id="view-results-btn-${c.id}"
                    >
                      üèÜ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Ç–æ–≥–∏
                    </button>
                  </div>`;
                }
              } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∏—Ç–æ–≥–æ–≤:', e);
              }
            }
            
            // –î–ª—è –∫–æ–Ω–∫—É—Ä—Å–æ–≤ –∫–æ–ª–ª–µ–∫—Ü–∏–π –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∏—Ç–æ–≥–æ–≤
            if (isCollectionContest) {
              try {
                const resultsResponse = await fetchJSON(`/api/contests/${c.id}/collection-results`).catch((err) => {
                  console.log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–π ${c.id}:`, err);
                  return { results_calculated: false };
                });
                collectionResultsCalculated = resultsResponse?.results_calculated || false;
                const currentUserIdNum = Number(currentUserId);
                const createdByIdNum = c.created_by ? Number(c.created_by) : null;
                collectionIsCreator = createdByIdNum !== null && currentUserIdNum === createdByIdNum;
                
                if (isEnded && !collectionResultsCalculated) {
                  if (collectionIsCreator) {
                    collectionResultsHtml = `<div class="mt-2 pt-2 border-t border-violet-400/20">
                      <button 
                        class="neon-button w-full py-2 rounded-lg text-sm"
                        id="calculate-collection-results-btn-${c.id}"
                        style="pointer-events: auto; cursor: pointer;"
                      >
                        üìä –ü–æ–¥—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤
                      </button>
                    </div>`;
                  }
                } else if (collectionResultsCalculated) {
                  collectionResultsHtml = `<div class="mt-2 pt-2 border-t border-violet-400/20">
                    <button 
                      onclick="showCollectionResults(${c.id})" 
                      class="neon-button w-full py-2 rounded-lg text-sm"
                      id="view-collection-results-btn-${c.id}"
                    >
                      üèÜ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Ç–æ–≥–∏
                    </button>
                  </div>`;
                }
              } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∏—Ç–æ–≥–æ–≤ –∫–æ–Ω–∫—É—Ä—Å–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–π:', e);
              }
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –∏–∑ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–∫–∞–∫ –≤ creator.html)
            let winnersHtml = '';
            let isConfirmed = false;
            try {
              const winners = winnersData?.winners || winnersData || [];
              isConfirmed = winnersData?.is_confirmed || false;
              
              // –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –∫–æ–Ω–∫—É—Ä—Å–∞ –º–æ–∂–µ—Ç –ø–æ–¥–≤–æ–¥–∏—Ç—å –∏—Ç–æ–≥–∏ / —Ä–µ—Ä–æ–ª–ª–∏—Ç—å / –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å
              const currentUserIdNum = Number(currentUserId);
              const createdByIdNum = c.created_by ? Number(c.created_by) : null;
              const isOwner = createdByIdNum !== null && currentUserIdNum === createdByIdNum;
              
              if (winners && winners.length > 0) {
                winnersHtml = `<div class="mt-2 pt-2 border-t border-violet-400/20">
                  <div class="text-xs text-gray-500 mb-2">üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ (${winners.length}):</div>
                  <div class="space-y-2">
                    ${winners.map((w, idx) => {
                      const place = w.place || (idx + 1);
                      const userDisplay = w.user_username ? `@${w.user_username}` : (w.user_id ? `ID: ${w.user_id}` : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');
                      // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø—Ä–∏–∑
                      let prizeLink = w.prize_link;
                      if (prizeLink && !prizeLink.startsWith('http://') && !prizeLink.startsWith('https://')) {
                        prizeLink = 'https://' + prizeLink;
                      }
                      const prizeDisplay = prizeLink ? `<a href="${prizeLink}" target="_blank" class="text-pink-400 hover:underline font-semibold">üéÅ –ü—Ä–∏–∑ ${place} –º–µ—Å—Ç–∞</a>` : '<span class="text-gray-500">–ù–µ—Ç –ø—Ä–∏–∑–∞</span>';
                      const winnerLink = w.comment_link || w.photo_link;
                      // –î–ª—è –∞–¥–º–∏–Ω–∞ —Ä–µ—Ä–æ–ª–ª –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É –∫–æ–Ω–∫—É—Ä—Å–∞ –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                      const contestType = c.contest_type || 'random_comment';
                      const showReroll = contestType !== 'drawing' && !isConfirmed && isOwner;
                      return `
                      <div class="flex flex-col gap-1 text-sm p-2 rounded-lg bg-black/20 border border-violet-400/20">
                        <div class="flex items-center gap-2">
                          <span class="text-violet-400 font-bold flex-shrink-0">${place} –º–µ—Å—Ç–æ</span>
                          <span class="text-gray-300">${userDisplay}</span>
                          ${showReroll ? `
                            <button 
                              onclick="rerollWinner(${c.id}, '${winnerLink}')" 
                              class="reroll-btn w-8 h-8 rounded-full bg-violet-600 hover:bg-violet-700 text-white flex items-center justify-center transition-all duration-200 flex-shrink-0 ml-auto"
                              data-winner-link="${winnerLink}"
                              title="–†–µ—Ä–∞–Ω–¥–æ–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è"
                            >
                              <svg class="w-4 h-4 reroll-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                              </svg>
                            </button>
                          ` : ''}
                        </div>
                        <div class="flex items-center gap-2 text-xs">
                          ${winnerLink ? `
                            <a href="${winnerLink}" target="_blank" class="text-blue-400 hover:underline break-all flex-1 min-w-0">${winnerLink}</a>
                          ` : '<span class="text-gray-500">–°—Å—ã–ª–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞</span>'}
                        </div>
                        <div class="text-xs text-gray-400">
                          –ü—Ä–∏–∑: ${prizeDisplay}
                        </div>
                      </div>
                    `;
                    }).join('')}
                  </div>
                  ${!isConfirmed && isOwner ? `
                    <button 
                      onclick="confirmWinners(${c.id})" 
                      class="neon-button w-full py-2 rounded-lg text-sm mt-3"
                    >
                      ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
                    </button>
                  ` : ''}
                </div>`;
              } else if (isEnded && !isConfirmed && isRandomCommentContest) {
                // –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥–≤–µ—Å—Ç–∏ –∏—Ç–æ–≥–∏" —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∫–æ–Ω–∫—É—Ä—Å–∞
                if (isOwner) {
                  winnersHtml = `<div class="mt-2 pt-2 border-t border-violet-400/20">
                    <button 
                      onclick="selectWinnersViaTelethon(${c.id})" 
                      class="neon-button w-full py-2 rounded-lg text-sm"
                      id="select-winners-btn-${c.id}"
                    >
                      üé≤ –ü–æ–¥–≤–µ—Å—Ç–∏ –∏—Ç–æ–≥–∏
                    </button>
                  </div>`;
                }
              }
            } catch (e) {
              console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π:', e);
              if (isEnded && !isConfirmed && isRandomCommentContest) {
                winnersHtml = `<div class="mt-2 pt-2 border-t border-violet-400/20">
                  <button 
                    onclick="selectWinnersViaTelethon(${c.id})" 
                    class="neon-button w-full py-2 rounded-lg text —Å–º"
                    id="select-winners-btn-${c.id}"
                  >
                    üé≤ –ü–æ–¥–≤–µ—Å—Ç–∏ –∏—Ç–æ–≥–∏
                  </button>
                </div>`;
              }
            }
            
            // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            console.log(`–ö–æ–Ω–∫—É—Ä—Å ${c.id}: prize_links =`, c.prize_links, 'type:', typeof c.prize_links, 'isArray:', Array.isArray(c.prize_links));
            
            card.innerHTML = `
              ${prizesHtml || ''}
              
              <div class="font-bold text-xl text-white mb-3">${contestTitle}</div>
              
              ${postLink}
              ${conditions}
              
              <div class="mt-2 pt-2 border-t border-violet-400/20">
                ${period}
              </div>
              
              ${drawingResultsHtml}
              ${collectionResultsHtml}
              ${winnersHtml}
            `;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–æ–¥—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤" –∫–æ–Ω–∫—É—Ä—Å–∞ —Ä–∏—Å—É–Ω–∫–æ–≤ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ DOM
            if (drawingResultsHtml && isDrawingContest) {
              setTimeout(() => {
                const calculateBtn = document.getElementById(`calculate-results-btn-${c.id}`);
                if (calculateBtn) {
                  const newBtn = calculateBtn.cloneNode(true);
                  calculateBtn.parentNode.replaceChild(newBtn, calculateBtn);
                  newBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    await window.calculateDrawingResults(c.id);
                  });
                }
              }, 100);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–æ–¥—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤" –∫–æ–Ω–∫—É—Ä—Å–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–π –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ DOM
            if (collectionResultsHtml && isCollectionContest) {
              setTimeout(() => {
                const calculateBtn = document.getElementById(`calculate-collection-results-btn-${c.id}`);
                if (calculateBtn) {
                  const newBtn = calculateBtn.cloneNode(true);
                  calculateBtn.parentNode.replaceChild(newBtn, calculateBtn);
                  newBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    await window.calculateCollectionResults(c.id);
                  });
                }
              }, 100);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ iframe –ø—Ä–∏–∑–æ–≤
            if (prizesHtml) {
              setTimeout(() => {
                const iframes = card.querySelectorAll('iframe');
                iframes.forEach((iframe) => {
                  iframe.onerror = () => {
                    const fallback = iframe.closest('.relative')?.querySelector('.fallback-prize');
                    if (fallback) fallback.classList.remove('hidden');
                  };
                  setTimeout(() => {
                    try {
                      if (!iframe.contentDocument && !iframe.contentWindow) {
                        const fallback = iframe.closest('.relative')?.querySelector('.fallback-prize');
                        if (fallback) fallback.classList.remove('hidden');
                      }
                    } catch (e) {
                      // Cross-origin error - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
                    }
                  }, 2000);
                });
              }, 100);
            }
            
            // –ï—Å–ª–∏ –∫–æ–Ω–∫—É—Ä—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω, —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è
            if (c.is_confirmed) {
              card.classList.add('contest-confirmed');
            }
            
            contestList.appendChild(card);
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º long press –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ DOM (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω)
            if (!c.is_confirmed) {
              setupLongPress(card, c.id, 'contest', c.title || c.name || '–ö–æ–Ω–∫—É—Ä—Å');
            }
          }
          
          // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä—Å–æ–≤
          if (completedContests.length > 0) {
            const completedHeader = document.createElement('div');
            completedHeader.className = 'text-xl font-bold text-gray-400 mb-4 mt-6';
            completedHeader.textContent = 'üèÅ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä—Å—ã';
            contestList.appendChild(completedHeader);
          }
          
          // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä—Å–æ–≤
          for (let idx = 0; idx < completedContests.length; idx++) {
            const { contest: c, index: i, winnersData } = completedContests[idx];
            
            const card = document.createElement('div');
            card.className = 'deletable-item rounded-lg border border-violet-400/30 p-3 bg-black/30 opacity-75';
            card.dataset.contestId = c.id;
            
            const period = (c.start_at || c.end_at)
              ? `<div class="text-xs text-gray-400 mt-1">${c.start_at ? '–°—Ç–∞—Ä—Ç: ' + toMoscowDateTime(c.start_at) : ''} ${c.end_at ? ' ¬∑ –ö–æ–Ω–µ—Ü: ' + toMoscowDateTime(c.end_at) : ''}</div>`
              : '';
            
            const postLink = c.post_link 
              ? `<div class="mt-2 pt-2 border-t border-violet-400/20">
                   <div class="text-xs text-gray-500 mb-1">üîó –ß–∞—Å—Ç—å 1: –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å—Ç</div>
                   <a href="${c.post_link}" target="_blank" class="text-blue-400 hover:underline text-sm break-all">${c.post_link}</a>
                 </div>` 
              : '';
            
            const conditions = c.conditions 
              ? `<div class="mt-2 pt-2 border-t border-violet-400/20">
                   <div class="text-xs text-gray-500 mb-1">üìã –ß–∞—Å—Ç—å 2: –£—Å–ª–æ–≤–∏—è —É—á–∞—Å—Ç–∏—è</div>
                   <div class="text-sm text-gray-300">${c.conditions}</div>
                 </div>` 
              : '';
            
            const contestTitle = c.title || c.name || '–ö–æ–Ω–∫—É—Ä—Å';
            
            // –ö–æ–ø–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏–∑–æ–≤, –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –∏ —Ç.–¥. –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä—Å–æ–≤
            // (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö - –±–µ–∑ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π)
            let prizesHtml = '';
            if (c.prize_links && Array.isArray(c.prize_links) && c.prize_links.length > 0) {
              const prizesToShow = c.prize_links.slice(0, Math.min(3, c.prize_links.length));
              
              function normalizePrizeLink(link) {
                if (!link) return '';
                link = link.trim();
                if (link.startsWith('http://') || link.startsWith('https://')) {
                  return link;
                }
                if (link.startsWith('t.me/')) {
                  return 'https://' + link;
                }
                return 'https://' + link;
              }
              
              function getNFTImageHtml(link, idx) {
                const normalizedLink = normalizePrizeLink(link);
                return `
                  <img 
                    src="/api/nft-preview?nft_link=${encodeURIComponent(normalizedLink)}" 
                    alt="–ü—Ä–∏–∑ ${idx + 1}"
                    class="w-full h-full object-cover rounded-lg prize-image"
                    onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');"
                    loading="lazy"
                  />
                `;
              }
              
              const gridCols = prizesToShow.length === 1 ? 'grid-cols-1' : prizesToShow.length === 2 ? 'grid-cols-2' : 'grid-cols-3';
              
              prizesHtml = `
                <div class="mb-4">
                  <div class="grid ${gridCols} gap-3 mb-3">
                    ${prizesToShow.map((prizeLink, idx) => {
                      const normalizedLink = normalizePrizeLink(prizeLink);
                      return `
                      <div class="relative rounded-xl overflow-hidden border-2 border-violet-400/40 bg-gradient-to-br from-violet-600/30 via-pink-600/30 to-purple-600/30 aspect-square group hover:scale-105 transition-transform shadow-lg cursor-pointer">
                        <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48cGF0dGVybiBpZD0iZ3JpZCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiBwYXR0ZXJuVW5pdHM9InVzZXJTcGFjZU9uVXNlIj48Y2lyY2xlIGN4PSIxMCIgY3k9IjEwIiByPSIxLjUiIGZpbGw9IiNmZmYiIG9wYWNpdHk9IjAuMSIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9InVybCgjZ3JpZCkiLz48L3N2Zz4=')] opacity-20"></div>
                        <a href="${normalizedLink}" target="_blank" class="absolute inset-0 z-10 block">
                          <div class="w-full h-full relative">
                            ${getNFTImageHtml(prizeLink, idx)}
                            <div class="absolute inset-0 flex items-center justify-center bg-black/30 rounded-lg fallback-prize hidden">
                              <div class="text-5xl opacity-70">üéÅ</div>
                            </div>
                          </div>
                        </a>
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-2 z-20 pointer-events-none">
                          <div class="text-xs text-white font-semibold text-center">${idx + 1} –º–µ—Å—Ç–æ</div>
                        </div>
                      </div>
                    `;
                    }).join('')}
                  </div>
                  ${c.prize_links.length > 3 ? `<div class="text-xs text-gray-400 text-center">+${c.prize_links.length - 3} –µ—â–µ –ø—Ä–∏–∑–æ–≤</div>` : ''}
                </div>
              `;
            }
            
            // –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä—Å–æ–≤
            let winnersHtml = '';
            try {
              const winners = winnersData?.winners || [];
              const isConfirmed = winnersData?.is_confirmed || false;
              
              if (winners && winners.length > 0) {
                winnersHtml = `<div class="mt-2 pt-2 border-t border-violet-400/20">
                  <div class="text-xs text-gray-500 mb-2">üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ (${winners.length}):</div>
                  <div class="space-y-2">
                    ${winners.map((w, idx) => {
                      const place = w.place || (idx + 1);
                      const userDisplay = w.user_username ? `@${w.user_username}` : (w.user_id ? `ID: ${w.user_id}` : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');
                      let prizeLink = w.prize_link;
                      if (prizeLink && !prizeLink.startsWith('http://') && !prizeLink.startsWith('https://')) {
                        prizeLink = 'https://' + prizeLink;
                      }
                      const prizeDisplay = prizeLink ? `<a href="${prizeLink}" target="_blank" class="text-pink-400 hover:underline font-semibold">üéÅ –ü—Ä–∏–∑ ${place} –º–µ—Å—Ç–∞</a>` : '<span class="text-gray-500">–ù–µ—Ç –ø—Ä–∏–∑–∞</span>';
                      const winnerLink = w.comment_link || w.photo_link;
                      return `
                      <div class="flex flex-col gap-1 text-sm p-2 rounded-lg bg-black/20 border border-violet-400/20">
                        <div class="flex items-center gap-2">
                          <span class="text-violet-400 font-bold flex-shrink-0">${place} –º–µ—Å—Ç–æ</span>
                          <span class="text-gray-300">${userDisplay}</span>
                        </div>
                        <div class="flex items-center gap-2 text-xs">
                          ${winnerLink ? `
                            <a href="${winnerLink}" target="_blank" class="text-blue-400 hover:underline break-all flex-1 min-w-0">${winnerLink}</a>
                          ` : '<span class="text-gray-500">–°—Å—ã–ª–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞</span>'}
                        </div>
                        <div class="text-xs text-gray-400">
                          –ü—Ä–∏–∑: ${prizeDisplay}
                        </div>
                      </div>
                    `;
                    }).join('')}
                  </div>
                </div>`;
              }
            } catch (e) {
              console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π:', e);
            }
            
            card.innerHTML = `
              ${prizesHtml || ''}
              
              <div class="font-bold text-xl text-white mb-3">${contestTitle}</div>
              
              ${postLink}
              ${conditions}
              
              <div class="mt-2 pt-2 border-t border-violet-400/20">
                ${period}
              </div>
              
              ${winnersHtml}
            `;
            
            if (c.is_confirmed) {
              card.classList.add('contest-confirmed');
            }
            
            contestList.appendChild(card);
            if (!c.is_confirmed) {
              setupLongPress(card, c.id, 'contest', c.title || c.name || '–ö–æ–Ω–∫—É—Ä—Å');
            }
          }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω–∫—É—Ä—Å–æ–≤:', e);
          if (contestList) {
            const errorMessage = e.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω–∫—É—Ä—Å–æ–≤';
            contestList.innerHTML = `<div class="text-red-400 text-center py-4">‚ùå ${errorMessage}</div>`;
          }
        }
      }
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π (legacy - —Ç–µ–ø–µ—Ä—å –≤—ã–±–∏—Ä–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
      // –û—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ UI
      window.selectWinners = async function(contestId, winnersCount) {
        alert('–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –≤—ã–±–∏—Ä–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.');
      };
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ Telethon
      window.selectWinnersViaTelethon = async function(contestId) {
        const btn = document.getElementById(`select-winners-btn-${contestId}`);
        if (!btn) return;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '‚è≥ –°–±–æ—Ä –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ —á–µ—Ä–µ–∑ Telethon...';
        
        try {
          // –í—ã–∑—ã–≤–∞–µ–º API endpoint –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ Telethon
          const response = await fetchJSON(`/api/contests/${contestId}/select-winners?current_user_id=${currentUserId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          
          // –ï—Å–ª–∏ API –≤–µ—Ä–Ω—É–ª, —á—Ç–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω—ã
          if (response.success) {
            btn.innerHTML = '‚úÖ –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –≤—ã–±—Ä–∞–Ω—ã!';
            btn.classList.add('bg-green-600');
            
            setTimeout(async () => {
              await loadContests();
            }, 1000);
            return;
          }

          // –ï—Å–ª–∏ API –≥–æ–≤–æ—Ä–∏—Ç, —á—Ç–æ —Å–µ–π—á–∞—Å –∏–¥–µ—Ç —Å–±–æ—Ä –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (Telethon —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ)
          if (response.collecting) {
            btn.innerHTML = '‚è≥ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è...';
            
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä, –ø–æ—è–≤–∏–ª–∏—Å—å –ª–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª–∏
            const waitForWinners = async (attempt = 0) => {
              const maxAttempts = 150; // –¥–æ ~5 –º–∏–Ω—É—Ç (150 * 2—Å)
              if (attempt >= maxAttempts) {
                // –ü–µ—Ä–µ—Å—Ç–∞—ë–º –¥–µ—Ä–≥–∞—Ç—å —Å–µ—Ä–≤–µ—Ä, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è,
                // —á—Ç–æ–±—ã –∞–¥–º–∏–Ω –ø–æ–Ω—è–ª, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –µ—â—ë –∏–¥—ë—Ç
                btn.disabled = true;
                btn.innerHTML = '‚è≥ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Å–æ–±–∏—Ä–∞—Ç—å—Å—è...';
                return;
              }
              
              try {
                const winnersData = await fetchJSON(`/api/contests/${contestId}/winners?current_user_id=${currentUserId}`);
                const winners = winnersData?.winners || winnersData || [];
                if (Array.isArray(winners) && winners.length > 0) {
                  btn.innerHTML = '‚úÖ –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –≤—ã–±—Ä–∞–Ω—ã!';
                  btn.classList.add('bg-green-600');
                  
                  setTimeout(async () => {
                    await loadContests();
                  }, 1000);
                  return;
                }
              } catch (pollError) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–æ—Å–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π:', pollError);
              }
              
              // –ñ–¥—ë–º 2 —Å–µ–∫—É–Ω–¥—ã –∏ –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
              setTimeout(() => {
                waitForWinners(attempt + 1);
              }, 2000);
            };
            
            await waitForWinners(0);
            return;
          }

          // –õ—é–±–∞—è –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞
          btn.innerHTML = originalText;
          btn.disabled = false;
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π: ' + (response.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        } catch (e) {
          btn.innerHTML = originalText;
          btn.disabled = false;
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π:', e);
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π: ' + e.message);
        }
      };
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ—Ä–æ–ª–ª–∞ –æ–¥–Ω–æ–≥–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
      window.rerollWinner = async function(contestId, oldWinnerLink) {
        const btn = document.querySelector(`.reroll-btn[data-winner-link="${oldWinnerLink}"]`);
        if (!btn) return;
        
        const icon = btn.querySelector('.reroll-icon');
        if (!icon) return;
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –≤—Ä–∞—â–µ–Ω–∏—è
        btn.disabled = true;
        icon.classList.add('animate-spin');
        
        try {
          const response = await fetchJSON(`/api/contests/${contestId}/reroll-winner`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              old_winner_link: oldWinnerLink,
              current_user_id: currentUserId 
            })
          });
          
          if (response.success) {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            icon.classList.remove('animate-spin');
            btn.disabled = false;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—É—Ä—Å–æ–≤
            await loadContests();
          } else {
            icon.classList.remove('animate-spin');
            btn.disabled = false;
            alert('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ—Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è');
          }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ —Ä–µ—Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è:', e);
          icon.classList.remove('animate-spin');
          btn.disabled = false;
          alert('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ—Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
      };
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
      window.confirmWinners = async function(contestId) {
        if (!confirm('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π? –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–∫—Ä–æ–º–µ –≤—ã–∏–≥—Ä—ã—à–Ω—ã—Ö) –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –∏–∑ –ë–î, –∏ –∫–æ–Ω–∫—É—Ä—Å –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å.')) {
          return;
        }
        
        try {
          const response = await fetchJSON(`/api/contests/${contestId}/confirm-winners?current_user_id=${currentUserId}`, {
            method: 'POST'
          });
          
          if (response.success) {
            alert(`‚úÖ –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã! –£–¥–∞–ª–µ–Ω–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: ${response.winners_count || 0}`);
            await loadContests();
          } else {
            alert('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π');
          }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π:', e);
          alert('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
      };
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –∏—Ç–æ–≥–æ–≤ –∫–æ–Ω–∫—É—Ä—Å–∞ —Ä–∏—Å—É–Ω–∫–æ–≤
      window.calculateDrawingResults = async function(contestId) {
        const btn = document.getElementById(`calculate-results-btn-${contestId}`);
        if (btn) {
          btn.disabled = true;
          btn.textContent = '‚è≥ –ü–æ–¥—Å—á–µ—Ç...';
        }
        
        try {
          const response = await fetchJSON(`/api/contests/${contestId}/calculate-results?current_user_id=${currentUserId}`, {
            method: 'POST'
          });
          
          if (response.success) {
            alert('‚úÖ –ò—Ç–æ–≥–∏ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Å—á–∏—Ç–∞–Ω—ã!');
            await loadContests();
          } else {
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å—á–µ—Ç–µ –∏—Ç–æ–≥–æ–≤: ' + (response.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            if (btn) {
              btn.disabled = false;
              btn.textContent = 'üìä –ü–æ–¥—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤';
            }
          }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –∏—Ç–æ–≥–æ–≤:', e);
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å—á–µ—Ç–µ –∏—Ç–æ–≥–æ–≤: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          if (btn) {
            btn.disabled = false;
            btn.textContent = 'üìä –ü–æ–¥—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤';
          }
        }
      };
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤ –∫–æ–Ω–∫—É—Ä—Å–∞ —Ä–∏—Å—É–Ω–∫–æ–≤
      window.showDrawingResults = async function(contestId) {
        try {
          const response = await fetchJSON(`/api/contests/${contestId}/results`);
          
          if (!response.results_calculated) {
            alert('–ò—Ç–æ–≥–∏ –µ—â–µ –Ω–µ –ø–æ–¥—Å—á–∏—Ç–∞–Ω—ã');
            return;
          }
          
          const results = response.results || [];
          const resultsModal = document.getElementById('drawing-results-modal');
          const resultsContent = document.getElementById('drawing-results-content');
          
          if (!resultsModal || !resultsContent) {
            alert('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            return;
          }
          
          // –§–æ—Ä–º–∏—Ä—É–µ–º HTML —Å –∏—Ç–æ–≥–∞–º–∏
          let resultsHtml = '<div class="space-y-4">';
          
          for (const result of results) {
            const place = result.place;
            const username = result.username || '';
            const userId = result.participant_user_id;
            const userDisplay = username ? `${username} (ID: ${userId})` : `ID: ${userId}`;
            const imageUrl = `/api/drawing-contests/${contestId}/works/${result.work_number}/image`;
            const prizeLink = result.prize_link;
            const averageScore = result.average_score || 0;
            const votesCount = result.votes_count || 0;
            
            resultsHtml += `
              <div class="rounded-lg border border-violet-400/30 p-4 bg-black/30">
                <div class="text-2xl font-bold text-violet-400 mb-2">${place} –º–µ—Å—Ç–æ</div>
                <div class="text-sm text-gray-300 mb-3">
                  ${username ? `<span class="font-semibold text-violet-400">${username}</span> ` : ''}
                  <span class="text-gray-400">(ID: ${userId})</span>
                </div>
                <div class="mb-3">
                  <img src="${imageUrl}" alt="–†–∞–±–æ—Ç–∞ ${result.work_number}" class="w-full rounded-lg max-h-64 object-contain" />
                </div>
                <div class="text-sm text-gray-400 mb-3">
                  –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: <span class="text-violet-400 font-semibold">${averageScore.toFixed(2)}</span> (${votesCount} ${votesCount === 1 ? '–æ—Ü–µ–Ω–∫–∞' : votesCount < 5 ? '–æ—Ü–µ–Ω–∫–∏' : '–æ—Ü–µ–Ω–æ–∫'})
                </div>
                ${prizeLink ? `
                  <div class="text-sm">
                    <a href="${prizeLink.startsWith('http') ? prizeLink : 'https://' + prizeLink}" target="_blank" class="text-pink-400 hover:underline font-semibold">üéÅ –ü—Ä–∏–∑</a>
                  </div>
                ` : ''}
              </div>
            `;
          }
          
          resultsHtml += '</div>';
          resultsContent.innerHTML = resultsHtml;
          openModal(resultsModal);
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Ç–æ–≥–æ–≤:', e);
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Ç–æ–≥–æ–≤: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
      };
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –∏—Ç–æ–≥–æ–≤ –∫–æ–Ω–∫—É—Ä—Å–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–π
      window.calculateCollectionResults = async function(contestId) {
        const btn = document.getElementById(`calculate-collection-results-btn-${contestId}`);
        if (btn) {
          btn.disabled = true;
          btn.textContent = '‚è≥ –ü–æ–¥—Å—á–µ—Ç...';
        }
        
        try {
          const response = await fetchJSON(`/api/contests/${contestId}/calculate-collection-results?current_user_id=${currentUserId}`, {
            method: 'POST'
          });
          
          if (response.success) {
            alert('‚úÖ –ò—Ç–æ–≥–∏ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Å—á–∏—Ç–∞–Ω—ã!');
            await loadContests();
          } else {
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å—á–µ—Ç–µ –∏—Ç–æ–≥–æ–≤: ' + (response.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            if (btn) {
              btn.disabled = false;
              btn.textContent = 'üìä –ü–æ–¥—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤';
            }
          }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –∏—Ç–æ–≥–æ–≤ –∫–æ–Ω–∫—É—Ä—Å–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–π:', e);
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å—á–µ—Ç–µ –∏—Ç–æ–≥–æ–≤: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          if (btn) {
            btn.disabled = false;
            btn.textContent = 'üìä –ü–æ–¥—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤';
          }
        }
      };
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤ –∫–æ–Ω–∫—É—Ä—Å–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–π
      window.showCollectionResults = async function(contestId) {
        try {
          const response = await fetchJSON(`/api/contests/${contestId}/collection-results`);
          
          if (!response.results_calculated) {
            alert('–ò—Ç–æ–≥–∏ –µ—â–µ –Ω–µ –ø–æ–¥—Å—á–∏—Ç–∞–Ω—ã');
            return;
          }
          
          const results = response.results || [];
          const resultsModal = document.getElementById('collection-results-modal');
          const resultsContent = document.getElementById('collection-results-content');
          
          if (!resultsModal || !resultsContent) {
            alert('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            return;
          }
          
          // –§–æ—Ä–º–∏—Ä—É–µ–º HTML —Å –∏—Ç–æ–≥–∞–º–∏
          let resultsHtml = '<div class="space-y-4">';
          
          for (const result of results) {
            const place = result.place;
            const username = result.username || '';
            const userId = result.participant_user_id;
            const userDisplay = username ? `${username} (ID: ${userId})` : `ID: ${userId}`;
            const nftLinks = result.nft_links || [];
            const prizeLink = result.prize_link;
            const averageScore = result.average_score || 0;
            const votesCount = result.votes_count || 0;
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–µ—Ç–∫—É 3x3 –¥–ª—è NFT
            let nftGridHtml = '<div class="grid grid-cols-3 gap-2 mb-3">';
            for (let i = 0; i < 9; i++) {
              const nftLink = nftLinks[i] || '';
              const normalizedLink = nftLink.startsWith('http') ? nftLink : (nftLink ? 'https://' + nftLink : '');
              nftGridHtml += `
                <div class="aspect-square rounded-lg overflow-hidden border border-violet-400/30 bg-black/20">
                  ${nftLink ? `
                    <img 
                      src="/api/nft-preview?nft_link=${encodeURIComponent(normalizedLink)}" 
                      alt="NFT ${i + 1}"
                      class="w-full h-full object-cover"
                      onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');"
                    />
                    <div class="hidden w-full h-full flex items-center justify-center bg-black/50">
                      <div class="text-2xl opacity-70">üñºÔ∏è</div>
                    </div>
                  ` : `
                    <div class="w-full h-full flex items-center justify-center bg-black/50">
                      <div class="text-2xl opacity-70">üñºÔ∏è</div>
                    </div>
                  `}
                </div>
              `;
            }
            nftGridHtml += '</div>';
            
            resultsHtml += `
              <div class="rounded-lg border border-violet-400/30 p-4 bg-black/30">
                <div class="text-2xl font-bold text-violet-400 mb-2">${place} –º–µ—Å—Ç–æ</div>
                <div class="text-sm text-gray-300 mb-3">
                  ${username ? `<span class="font-semibold text-violet-400">${username}</span> ` : ''}
                  <span class="text-gray-400">(ID: ${userId})</span>
                </div>
                ${nftGridHtml}
                <div class="text-sm text-gray-400 mb-3">
                  –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: <span class="text-violet-400 font-semibold">${averageScore.toFixed(2)}</span> (${votesCount} ${votesCount === 1 ? '–æ—Ü–µ–Ω–∫–∞' : votesCount < 5 ? '–æ—Ü–µ–Ω–∫–∏' : '–æ—Ü–µ–Ω–æ–∫'})
                </div>
                ${prizeLink ? `
                  <div class="text-sm">
                    <a href="${prizeLink.startsWith('http') ? prizeLink : 'https://' + prizeLink}" target="_blank" class="text-pink-400 hover:underline font-semibold">üéÅ –ü—Ä–∏–∑</a>
                  </div>
                ` : ''}
              </div>
            `;
          }
          
          resultsHtml += '</div>';
          resultsContent.innerHTML = resultsHtml;
          resultsModal.classList.remove('hidden');
          document.body.classList.add('modal-open');
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Ç–æ–≥–æ–≤ –∫–æ–Ω–∫—É—Ä—Å–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–π:', e);
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Ç–æ–≥–æ–≤: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
      };
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞ —Ä–∏—Å—É–Ω–∫–æ–≤
      window.openEditDrawingContestModal = async function(contest) {
        const drawingContestModal = document.getElementById('drawing-contest-modal');
        if (!drawingContestModal) {
          console.error('‚ùå –ú–æ–¥–∞–ª–∫–∞ –∫–æ–Ω–∫—É—Ä—Å–∞ —Ä–∏—Å—É–Ω–∫–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
          alert('‚ö†Ô∏è –û—à–∏–±–∫–∞: –º–æ–¥–∞–ª–∫–∞ –∫–æ–Ω–∫—É—Ä—Å–∞ —Ä–∏—Å—É–Ω–∫–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
          return;
        }
        
        // –ò–∑–º–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª–∫–∏
        const modalTitle = document.getElementById('drawing-contest-modal-title');
        if (modalTitle) {
          modalTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—É—Ä—Å —Ä–∏—Å—É–Ω–∫–æ–≤';
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        const submitBtn = document.getElementById('submit-drawing-contest');
        const updateBtn = document.getElementById('update-drawing-contest');
        if (submitBtn) submitBtn.classList.add('hidden');
        if (updateBtn) updateBtn.classList.remove('hidden');
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–º—É –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞ (—Ñ–æ—Ä–º–∞—Ç: "–ö–æ–Ω–∫—É—Ä—Å —Ä–∏—Å—É–Ω–∫–æ–≤: –¢–µ–º–∞")
        const contestName = contest.title || contest.name || '';
        const themeMatch = contestName.match(/–ö–æ–Ω–∫—É—Ä—Å —Ä–∏—Å—É–Ω–∫–æ–≤:\s*(.+)/i);
        const theme = themeMatch ? themeMatch[1].trim() : contestName.replace(/–ö–æ–Ω–∫—É—Ä—Å —Ä–∏—Å—É–Ω–∫–æ–≤:\s*/i, '').trim();
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
        const themeInput = document.getElementById('drawing-contest-theme');
        if (themeInput) themeInput.value = theme;
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —É—Å–ª–æ–≤–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞
        const conditions = contest.conditions || '';
        
        // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
        let additionalConditions = '';
        const baseConditionsEndPattern = /–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫ –Ω–∞ –∑–∞–¥–∞–Ω–Ω—É—é —Ç–µ–º—É[\s\n]*/i;
        const match = conditions.search(baseConditionsEndPattern);
        if (match !== -1) {
          const baseEndPos = match + conditions.substring(match).match(baseConditionsEndPattern)[0].length;
          additionalConditions = conditions.substring(baseEndPos).trim();
          additionalConditions = additionalConditions.replace(/^[\n\r\s\-\.]+/, '').trim();
        }
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –±–∞–∑–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è (readonly)
        const baseConditionsInput = document.getElementById('drawing-contest-conditions-base');
        if (baseConditionsInput) {
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –ø–æ–¥–ø–∏—Å–∫–∏
          try {
            const profileResponse = await fetchJSON(`/api/profile?tg_id=${currentUserId}`);
            const adminChannelLink = profileResponse.channel_link || '';
            const adminChatLink = profileResponse.chat_link || '';
            const creatorChannelLink = 't.me/monkeys_giveaways';
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –±–∞–∑–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è —É—á–∞—Å—Ç–∏—è
            let baseConditionsText = '–î–ª—è —É—á–∞—Å—Ç–∏—è –≤ –∫–æ–Ω–∫—É—Ä—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:\n';
            baseConditionsText += `- –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª –∞–¥–º–∏–Ω–∞: ${adminChannelLink}\n`;
            baseConditionsText += `- –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —á–∞—Ç –∞–¥–º–∏–Ω–∞: ${adminChatLink}\n`;
            baseConditionsText += `- –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª —Å–æ–∑–¥–∞—Ç–µ–ª—è: ${creatorChannelLink}\n`;
            baseConditionsText += '- –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫ –Ω–∞ –∑–∞–¥–∞–Ω–Ω—É—é —Ç–µ–º—É';
            
            baseConditionsInput.value = baseConditionsText;
            originalBaseValue = baseConditionsText;
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∑–∞—â–∏—Ç—É –±–∞–∑–æ–≤—ã—Ö —É—Å–ª–æ–≤–∏–π
            if (typeof window.setupBaseConditionsProtection === 'function') {
              window.setupBaseConditionsProtection();
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è:', error);
            const fallbackConditions = '–î–ª—è —É—á–∞—Å—Ç–∏—è –≤ –∫–æ–Ω–∫—É—Ä—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:\n- –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª —Å–æ–∑–¥–∞—Ç–µ–ª—è: t.me/monkeys_giveaways\n- –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫ –Ω–∞ –∑–∞–¥–∞–Ω–Ω—É—é —Ç–µ–º—É';
            baseConditionsInput.value = fallbackConditions;
            originalBaseValue = fallbackConditions;
            
            if (typeof window.setupBaseConditionsProtection === 'function') {
              window.setupBaseConditionsProtection();
            }
          }
        }
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
        const additionalConditionsInput = document.getElementById('drawing-contest-conditions-additional');
        if (additionalConditionsInput) {
          additionalConditionsInput.value = additionalConditions;
        }
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
        const winnersCount = contest.winners_count || 1;
        const winnersCountValueEl = document.getElementById('drawing-winners-count-value');
        const winnersCountInputEl = document.getElementById('drawing-contest-winners-count');
        if (winnersCountValueEl) winnersCountValueEl.textContent = winnersCount;
        if (winnersCountInputEl) winnersCountInputEl.value = winnersCount;
        currentDrawingWinnersCount = winnersCount;
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞—Ç—ã
        if (contest.submission_end_date) {
          const submissionEndInput = document.getElementById('drawing-contest-submission-end');
          if (submissionEndInput) {
            try {
              const submissionEndDate = new Date(contest.submission_end_date);
              if (!isNaN(submissionEndDate.getTime())) {
                const submissionEndLocal = new Date(submissionEndDate.getTime() - submissionEndDate.getTimezoneOffset() * 60000);
                submissionEndInput.value = submissionEndLocal.toISOString().slice(0, 16);
              }
            } catch (e) {
              console.error('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç:', e);
            }
          }
        }
        
        if (contest.end_date || contest.end_at) {
          const votingEndInput = document.getElementById('drawing-contest-voting-end');
          if (votingEndInput) {
            try {
              const votingEndDate = new Date(contest.end_date || contest.end_at);
              if (!isNaN(votingEndDate.getTime())) {
                const votingEndLocal = new Date(votingEndDate.getTime() - votingEndDate.getTimezoneOffset() * 60000);
                votingEndInput.value = votingEndLocal.toISOString().slice(0, 16);
              }
            } catch (e) {
              console.error('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:', e);
            }
          }
        }
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
        openModal(drawingContestModal);
      };
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞ (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –∏ –≤—ã–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é)
      window.openEditContestModal = async function(contestId) {
        console.log('üîß –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞, ID:', contestId);
        currentEditContestId = contestId;
        
        try {
          const id = typeof contestId === 'string' ? parseInt(contestId) : contestId;
          const contests = await fetchJSON('/api/contests');
          const contest = contests.find(c => parseInt(c.id) === parseInt(id) || c.id === id);
          
          if (!contest) {
            alert(`‚ö†Ô∏è –ö–æ–Ω–∫—É—Ä—Å —Å ID ${id} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
            return;
          }
          
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–æ–Ω–∫—É—Ä—Å–∞
          let contestType = contest.contest_type || 'random_comment';
          if (!contestType || contestType === 'random_comment') {
            if (contest.submission_end_date) {
              contestType = 'drawing';
            } else if (contest.title && contest.title.includes('–ö–æ–Ω–∫—É—Ä—Å —Ä–∏—Å—É–Ω–∫–æ–≤')) {
              contestType = 'drawing';
            }
          }
          
          if (contestType === 'drawing') {
            await window.openEditDrawingContestModal(contest);
          } else {
            alert('‚ö†Ô∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ –∫–æ–Ω–∫—É—Ä—Å–∞ –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
          }
        } catch (e) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä—Å–∞:', e);
          alert('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä—Å–∞: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
      };

      // Profile and Assets
      async function loadProfile() {
        try {
          const params = new URLSearchParams(window.location.search);
          const tgId = params.get('tg_id');
          const p = await fetchJSON(`/api/profile?tg_id=${tgId || ''}`);
          
          const usernameEl = document.getElementById('profile-username');
          if (usernameEl) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º username –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ —Ä–æ–ª—å
            if (p.username) {
              usernameEl.textContent = p.username;
            } else {
              const role = p.status || p.role || 'admin';
              usernameEl.textContent = role === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : role;
            }
          }
          const profileIdEl = document.getElementById('profile-id');
          if (profileIdEl && p.id) profileIdEl.textContent = p.id;
          if (p.first_login) document.getElementById('profile-first-login').textContent = toMoscowDateTime(p.first_login);
          if (p.status) document.getElementById('profile-status').textContent = p.status;

          // Load assets (channel and chat links)
          await loadAssets(p.channel_link, p.chat_link);
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª –∏ —á–∞—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å—Ç–æ–≤ –∏ —É—Å–ª–æ–≤–∏–π
          adminChannelLink = p.channel_link;
          adminChatLink = p.chat_link;
          
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø—ã—Ç –∏ —É—Ä–æ–≤–Ω–∏ –¥–ª—è –∞–¥–º–∏–Ω–∞
          await loadAdminExperience(currentUserId);
          
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å Monkey Coins
          await updateCoinsDisplay();
          
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø–æ–∫—É–ø–∫–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
          if (p.purchased_items) {
            try {
              localStorage.setItem('purchasedItems', JSON.stringify(p.purchased_items));
              console.log('‚úÖ –ü–æ–∫—É–ø–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è:', p.purchased_items);
            } catch (e) {
              console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∫—É–ø–∫–∏ –≤ localStorage:', e);
            }
          }
        } catch (e) {
          // Fallback: read params
          const params = new URLSearchParams(window.location.search);
          const pid = params.get('tg_id');
          const puser = params.get('username');
          const prole = params.get('role');
          
          if (pid && !document.getElementById('profile-id').textContent) {
            document.getElementById('profile-id').textContent = pid;
          }
          const usernameEl = document.getElementById('profile-username');
          if (usernameEl && !usernameEl.textContent) {
            if (puser) {
              usernameEl.textContent = puser;
            } else {
              const role = prole || 'admin';
              usernameEl.textContent = role === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : role;
            }
          }
          if (prole) {
            document.getElementById('profile-status').textContent = prole;
          }
        }
      }

      // Rating - –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞
      let currentRatingRole = 'user';
      
      window.loadRating = async function(role = 'user') {
        try {
          currentRatingRole = role;
          const ratingList = document.getElementById('rating-list');
          if (!ratingList) return;
          
          ratingList.innerHTML = '<div class="text-center text-gray-400 py-8">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</div>';
          
          const response = await fetchJSON(`/api/rating?role=${role}`);
          
          if (!response.success || !response.ratings) {
            ratingList.innerHTML = '<div class="text-center text-red-400 py-8">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞</div>';
            return;
          }
          
          const ratings = response.ratings;
          if (ratings.length === 0) {
            ratingList.innerHTML = '<div class="text-center text-gray-400 py-8">–†–µ–π—Ç–∏–Ω–≥ –ø—É—Å—Ç</div>';
            return;
          }
          
          let html = '';
          ratings.forEach((item) => {
            const avatarHtml = item.avatar_url 
              ? `<img src="${item.avatar_url}" alt="${item.username}" class="w-10 h-10 rounded-full object-cover" />`
              : `<div class="w-10 h-10 rounded-full bg-gradient-to-br from-violet-500 to-pink-500 flex items-center justify-center text-lg font-bold">${item.username ? item.username.charAt(0).toUpperCase() : '?'}</div>`;
            
            html += `
              <div class="rounded-lg border border-violet-400/30 p-4 bg-black/30 flex items-center gap-3">
                <div class="text-2xl font-bold text-violet-400 w-10 text-center flex-shrink-0">${item.place}</div>
                <div class="w-10 h-10 flex-shrink-0 flex items-center justify-center">${avatarHtml}</div>
                <div class="flex-1 min-w-0">
                  <div class="font-semibold text-white truncate">${item.username || `User_${item.telegram_id}`}</div>
                  <div class="text-sm text-gray-400 whitespace-nowrap">–ü–æ–±–µ–¥: ${item.wins} | –£—á–∞—Å—Ç–∏–π: ${item.participations}</div>
                </div>
                <div class="text-right flex-shrink-0 w-20">
                  <div class="text-xl font-bold text-violet-400">${item.rating}</div>
                  <div class="text-xs text-gray-400">—Ä–µ–π—Ç–∏–Ω–≥</div>
                </div>
              </div>
            `;
          });
          
          ratingList.innerHTML = html;
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞:', e);
          const ratingList = document.getElementById('rating-list');
          if (ratingList) {
            ratingList.innerHTML = '<div class="text-center text-red-400 py-8">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞</div>';
          }
        }
      };
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞
      setTimeout(function() {
        const usersBtn = document.getElementById('rating-users-btn');
        const adminsBtn = document.getElementById('rating-admins-btn');
        
        if (usersBtn) {
          usersBtn.addEventListener('click', () => {
            usersBtn.classList.add('active');
            if (adminsBtn) adminsBtn.classList.remove('active');
            window.loadRating('user');
          });
        }
        
        if (adminsBtn) {
          adminsBtn.addEventListener('click', () => {
            adminsBtn.classList.add('active');
            if (usersBtn) usersBtn.classList.remove('active');
            window.loadRating('admin');
          });
        }
      }, 1000);

      async function loadAssets(channelLink, chatLink) {
        const channelAsset = document.getElementById('channel-asset');
        const chatAsset = document.getElementById('chat-asset');
        const channelLinkEl = document.getElementById('channel-link');
        const chatLinkEl = document.getElementById('chat-link');
        const noAssets = document.getElementById('no-assets');

        let hasAssets = false;

        if (channelLink) {
          channelAsset.classList.remove('hidden');
          channelLinkEl.href = channelLink;
          // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –≤–º–µ—Å—Ç–æ —Å—Å—ã–ª–∫–∏
          const channelTitle = await getChatTitle(channelLink);
          channelLinkEl.textContent = channelTitle;
          hasAssets = true;
        } else {
          channelAsset.classList.add('hidden');
        }

        if (chatLink) {
          chatAsset.classList.remove('hidden');
          chatLinkEl.href = chatLink;
          // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞ –≤–º–µ—Å—Ç–æ —Å—Å—ã–ª–∫–∏
          const chatTitle = await getChatTitle(chatLink);
          chatLinkEl.textContent = chatTitle;
          hasAssets = true;
        } else {
          chatAsset.classList.add('hidden');
        }

        if (hasAssets) {
          noAssets.classList.add('hidden');
        } else {
          noAssets.classList.remove('hidden');
        }
      }

      // ‚≠ê –°–∏—Å—Ç–µ–º–∞ –æ–ø—ã—Ç–∞ –∏ —É—Ä–æ–≤–Ω–µ–π
      // –£—Ä–æ–≤–Ω–∏: 1 (0-100), 2 (100-300), 3 (300-600), 4 (600-1000), 5 (1000+)
      function getLevelInfo(experience) {
        const levels = [
          { level: 1, minExp: 0, maxExp: 100 },
          { level: 2, minExp: 100, maxExp: 300 },
          { level: 3, minExp: 300, maxExp: 600 },
          { level: 4, minExp: 600, maxExp: 1000 },
          { level: 5, minExp: 1000, maxExp: Infinity }
        ];
        
        for (const levelInfo of levels) {
          if (experience >= levelInfo.minExp && experience < levelInfo.maxExp) {
            return {
              level: levelInfo.level,
              currentExp: experience - levelInfo.minExp,
              maxExp: levelInfo.maxExp === Infinity ? experience : levelInfo.maxExp - levelInfo.minExp,
              nextLevelExp: levelInfo.maxExp
            };
          }
        }
        
        // –ï—Å–ª–∏ –æ–ø—ã—Ç –±–æ–ª—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –¥–ª—è —É—Ä–æ–≤–Ω—è 5
        return {
          level: 5,
          currentExp: experience - 1000,
          maxExp: experience - 1000,
          nextLevelExp: experience
        };
      }

      function updateExperienceUI(experience, contestsCreated) {
        const levelInfo = getLevelInfo(experience);
        const progressPercent = levelInfo.maxExp > 0 
          ? Math.min(100, (levelInfo.currentExp / levelInfo.maxExp) * 100)
          : 0;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ —É—Ä–æ–≤–Ω—è
        const levelBadge = document.getElementById('level-badge');
        if (levelBadge) {
          levelBadge.textContent = `–£—Ä–æ–≤–µ–Ω—å ${levelInfo.level}`;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –æ–ø—ã—Ç
        const currentExpEl = document.getElementById('current-experience');
        if (currentExpEl) {
          currentExpEl.textContent = experience;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–æ—Å–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        const progressBar = document.getElementById('experience-progress-bar');
        if (progressBar) {
          progressBar.style.width = `${progressPercent}%`;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã —É—Ä–æ–≤–Ω—è
        const currentLevelExp = document.getElementById('current-level-exp');
        const nextLevelExp = document.getElementById('next-level-exp');
        if (currentLevelExp) {
          currentLevelExp.textContent = levelInfo.currentExp;
        }
        if (nextLevelExp) {
          nextLevelExp.textContent = levelInfo.nextLevelExp === Infinity ? '‚àû' : levelInfo.nextLevelExp;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        const contestsCreatedEl = document.getElementById('contests-created');
        if (contestsCreatedEl) {
          contestsCreatedEl.textContent = contestsCreated;
        }
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø—ã—Ç–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞ (–∑–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω–∫—É—Ä—Å–æ–≤)
      async function loadAdminExperience(userId) {
        try {
          // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–æ–Ω–∫—É—Ä—Å—ã, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —ç—Ç–∏–º –∞–¥–º–∏–Ω–æ–º
          const url = userId 
            ? `/api/contests?admin_id=${userId}`
            : '/api/contests';
          const contests = await fetchJSON(url);
          
          // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—É—Ä—Å—ã, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —ç—Ç–∏–º –∞–¥–º–∏–Ω–æ–º
          const userContests = contests.filter(c => {
            const createdBy = c.created_by || c.createdBy;
            return createdBy && parseInt(createdBy) === parseInt(userId);
          });
          
          // –ê–¥–º–∏–Ω—ã –ø–æ–ª—É—á–∞—é—Ç 30 –æ–ø—ã—Ç–∞ –∑–∞ –∫–∞–∂–¥—ã–π —Å–æ–∑–¥–∞–Ω–Ω—ã–π –∫–æ–Ω–∫—É—Ä—Å
          const experience = userContests.length * 30;
          const contestsCreated = userContests.length;
          
          updateExperienceUI(experience, contestsCreated);
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø—ã—Ç–∞ –∞–¥–º–∏–Ω–∞:', e);
          updateExperienceUI(0, 0);
        }
      }

      // First-login marker
      try {
        if (!localStorage.getItem('first_login_ts')) {
          const ts = new Date().toISOString();
          localStorage.setItem('first_login_ts', ts);
          fetch('/api/profile/first_login', { method: 'POST' }).catch(() => {});
        }
        const stored = localStorage.getItem('first_login_ts');
        if (stored) document.getElementById('profile-first-login').textContent = toMoscowDateTime(stored);
      } catch (e) {}

      // Long press handlers –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–æ–≤
      let longPressTimer = null;

      function setupLongPress(element, itemId, type, itemName) {
        let longPressTimer = null;

        const startLongPress = (e) => {
          // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ –¥–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ (1 —Å–µ–∫—É–Ω–¥–∞)
          longPressTimer = setTimeout(() => {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å—Ä–∞–∑—É
            showDeleteConfirm(itemId, type, itemName);
            longPressTimer = null;
          }, 1000); // 1 —Å–µ–∫—É–Ω–¥–∞ –¥–ª—è long press
        };

        const cancelLongPress = () => {
          if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
          }
        };

        const handleRelease = (e) => {
          cancelLongPress();
        };
        
        // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const handleDoubleClick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          cancelLongPress();
          if (type === 'contest') {
            if (window.openEditContestModal) {
              window.openEditContestModal(itemId);
            } else {
              alert('‚ö†Ô∏è –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
            }
          }
        };
        
        // –î–ª—è touch —É—Å—Ç—Ä–æ–π—Å—Ç–≤ - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–≤–æ–π–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ
        let lastTapTime = 0;
        const handleTouchEnd = (e) => {
          const currentTime = Date.now();
          const tapLength = currentTime - lastTapTime;
          if (tapLength < 300 && tapLength > 0) {
            e.preventDefault();
            cancelLongPress();
            if (type === 'contest') {
              if (window.openEditContestModal) {
                window.openEditContestModal(itemId);
              } else {
                alert('‚ö†Ô∏è –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
              }
            }
          }
          lastTapTime = currentTime;
        };

        // Touch events
        element.addEventListener('touchstart', startLongPress, { passive: true });
        element.addEventListener('touchend', (e) => {
          handleRelease(e);
          handleTouchEnd(e);
        });
        element.addEventListener('touchcancel', handleRelease);

        // Mouse events
        element.addEventListener('mousedown', startLongPress);
        element.addEventListener('mouseup', handleRelease);
        element.addEventListener('mouseleave', handleRelease);
        // –ù–∞—Ç–∏–≤–Ω—ã–π –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫
        element.addEventListener('dblclick', handleDoubleClick);
      }

      function triggerEvaporation(element) {
        if (!element) return;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∏—Å–ø–∞—Ä–µ–Ω–∏—è –∫—Ä–∞—Å–Ω—ã–º —Ü–≤–µ—Ç–æ–º
        element.classList.add('evaporating-item', 'evaporating-now');
      }

      function showDeleteConfirm(itemId, type, itemName) {
        const modal = document.getElementById('delete-confirm-modal');
        const text = document.getElementById('delete-confirm-text');
        const cancelBtn = document.getElementById('delete-confirm-cancel');
        const okBtn = document.getElementById('delete-confirm-ok');

        const itemType = type === 'contest' ? '–∫–æ–Ω–∫—É—Ä—Å' : '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞';
        text.textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${itemType} "${itemName}"?`;

        const cleanup = () => {
          modal.classList.add('hidden');
          cancelBtn.onclick = null;
          okBtn.onclick = null;
        };

        cancelBtn.onclick = cleanup; // –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
        okBtn.onclick = async () => {
          // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å—Ä–∞–∑—É
          cleanup();
          
          // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
          const targetElement = document.querySelector(`[data-contest-id="${itemId}"]`);
          
          // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ - –ø—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å
          try {
            // –ü—Ä–æ–±—É–µ–º —É–¥–∞–ª–∏—Ç—å (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
            await fetchJSON(`/api/contests/${itemId}?current_user_id=${currentUserId}`, { method: 'DELETE' });
            
            // –ï—Å–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ - –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            if (targetElement) {
              // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∏—Å–ø–∞—Ä–µ–Ω–∏—è –∫—Ä–∞—Å–Ω—ã–º —Ü–≤–µ—Ç–æ–º
              triggerEvaporation(targetElement);
              
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
              setTimeout(async () => {
                await loadContests();
              }, 1500); // –í—Ä–µ–º—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∏—Å–ø–∞—Ä–µ–Ω–∏—è
            } else {
              // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
              await loadContests();
            }
          } catch (e) {
            // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏
            let errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏';
            if (e.message) {
              errorMessage = e.message;
            } else if (e.response) {
              try {
                const errorData = await e.response.clone().json();
                errorMessage = errorData.detail || errorData.message || errorMessage;
              } catch {
                errorMessage = e.message || errorMessage;
              }
            }
            alert('‚ùå ' + errorMessage);
          }
        };

        modal.classList.remove('hidden');
      }

      // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω–∫—É—Ä—Å–∞
      if (submitContest) {
        submitContest.addEventListener('click', async () => {
          const contestType = currentContestType || "–†–∞–Ω–¥–æ–º–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π";
          // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ç–∏–ø –¥–ª—è API
          const apiContestType = contestType === "–†–∞–Ω–¥–æ–º–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" ? "random_comment" : contestType;
          
          // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä—Å–æ–≤
          const postLink = document.getElementById('contest-post-link').value.trim();
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Å—Ç –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –∫–∞–Ω–∞–ª—É –∞–¥–º–∏–Ω–∞
          if (!adminChannelLink) {
            alert('‚ö†Ô∏è –£ –≤–∞—Å –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω –∫–∞–Ω–∞–ª! –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Å–æ–∑–¥–∞—Ç–µ–ª—é –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞.');
            return;
          }
          
          if (postLink && !validatePostLink(postLink, adminChannelLink)) {
            postLinkError.classList.remove('hidden');
            alert('‚ö†Ô∏è –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å—Ç –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∏–∑ –≤–∞—à–µ–≥–æ –∫–∞–Ω–∞–ª–∞!\n–ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º–∞—Ç–∞: https://t.me/–≤–∞—à_–∫–∞–Ω–∞–ª/19');
            return;
          }
          
          const winnersCount = parseInt(document.getElementById('contest-winners-count').value) || 1;
          const payload = {
            title: document.getElementById('contest-title').value.trim(),
            contest_type: apiContestType,
            post_link: postLink,
            conditions: document.getElementById('contest-conditions').value.trim(),
            prize: '', // –ü—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ –ø—Ä–∏–∑—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –æ—Ç–¥–µ–ª—å–Ω–æ
            start_at: null,
            end_at: null,
            winners_count: winnersCount,
            created_by: currentUserId  // ID –∞–¥–º–∏–Ω–∞, —Å–æ–∑–¥–∞–≤—à–µ–≥–æ –∫–æ–Ω–∫—É—Ä—Å
          };
          
          try {
            const response = await fetchJSON('/api/contests', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (!response || response.success === false || !response.id) {
              const msg = (response && (response.message || response.detail)) || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω–∫—É—Ä—Å';
              alert('‚ö†Ô∏è ' + msg);
              return;
            }

            closeModal(contestModal);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω–∫—É—Ä—Å–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–∑–æ–≤
            window.currentContestId = response.id;
            window.currentWinnersCount = winnersCount;
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –¥–ª—è –≤–≤–æ–¥–∞ –ø—Ä–∏–∑–æ–≤
            openPrizesModal();
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–Ω–∫—É—Ä—Å–∞:', e);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–Ω–∫—É—Ä—Å–∞: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          }
        });
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª–∫–∏ –∫–æ–Ω–∫—É—Ä—Å–∞ —Ä–∏—Å—É–Ω–∫–æ–≤
      const drawingContestModal = document.getElementById('drawing-contest-modal');
      const closeDrawingContestModal = document.getElementById('close-drawing-contest-modal');
      const submitDrawingContest = document.getElementById('submit-drawing-contest');
      const updateDrawingContest = document.getElementById('update-drawing-contest');
      const drawingWinnersCountDecrease = document.getElementById('drawing-winners-count-decrease');
      const drawingWinnersCountIncrease = document.getElementById('drawing-winners-count-increase');
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –≤ –∫–æ–Ω–∫—É—Ä—Å–µ —Ä–∏—Å—É–Ω–∫–æ–≤
      function updateDrawingWinnersCount(newValue, direction) {
        const minCount = 1;
        const maxCount = 50;
        if (newValue < minCount) newValue = minCount;
        if (newValue > maxCount) newValue = maxCount;
        
        if (newValue !== currentDrawingWinnersCount) {
          currentDrawingWinnersCount = newValue;
          
          const drawingWinnersCountValueEl = document.getElementById('drawing-winners-count-value');
          const drawingWinnersCountInputEl = document.getElementById('drawing-contest-winners-count');
          
          if (drawingWinnersCountValueEl) {
            drawingWinnersCountValueEl.classList.remove('number-spin-up', 'number-spin-down');
            void drawingWinnersCountValueEl.offsetWidth;
            
            if (direction === 'up') {
              drawingWinnersCountValueEl.classList.add('number-spin-up');
            } else if (direction === 'down') {
              drawingWinnersCountValueEl.classList.add('number-spin-down');
            }
            
            drawingWinnersCountValueEl.textContent = currentDrawingWinnersCount;
          }
          
          if (drawingWinnersCountInputEl) {
            drawingWinnersCountInputEl.value = currentDrawingWinnersCount;
          }
        }
      }
      
      if (drawingWinnersCountDecrease) {
        drawingWinnersCountDecrease.addEventListener('click', () => {
          updateDrawingWinnersCount(currentDrawingWinnersCount - 1, 'down');
        });
      }
      
      if (drawingWinnersCountIncrease) {
        drawingWinnersCountIncrease.addEventListener('click', () => {
          updateDrawingWinnersCount(currentDrawingWinnersCount + 1, 'up');
        });
      }
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∂—é—Ä–∏
      let currentJuryCount = 1;
      const juryEnabledCheckbox = document.getElementById('drawing-contest-jury-enabled');
      const jurySettingsDiv = document.getElementById('drawing-contest-jury-settings');
      const juryCountDecrease = document.getElementById('drawing-jury-count-decrease');
      const juryCountIncrease = document.getElementById('drawing-jury-count-increase');
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —á–ª–µ–Ω–æ–≤ –∂—é—Ä–∏ (–±–µ–∑ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞)
      function updateJuryMembers(count) {
        const minCount = 1;
        const maxCount = 20;
        if (count < minCount) count = minCount;
        if (count > maxCount) count = maxCount;
        
        currentJuryCount = count;
        const countInput = document.getElementById('drawing-contest-jury-count');
        if (countInput) countInput.value = count;
        
        const countValueEl = document.getElementById('drawing-jury-count-value');
        if (countValueEl) countValueEl.textContent = count;
      }
      
      // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∂—é—Ä–∏
      if (juryEnabledCheckbox && jurySettingsDiv) {
        juryEnabledCheckbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            jurySettingsDiv.classList.remove('hidden');
            updateJuryMembers(currentJuryCount);
          } else {
            jurySettingsDiv.classList.add('hidden');
          }
        });
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∂—é—Ä–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      updateJuryMembers(currentJuryCount);
      
      // –ö–Ω–æ–ø–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —á–ª–µ–Ω–æ–≤ –∂—é—Ä–∏
      if (juryCountDecrease) {
        juryCountDecrease.addEventListener('click', () => {
          updateJuryMembers(currentJuryCount - 1);
        });
      }
      
      if (juryCountIncrease) {
        juryCountIncrease.addEventListener('click', () => {
          updateJuryMembers(currentJuryCount + 1);
        });
      }
      
      if (closeDrawingContestModal && drawingContestModal) {
        closeDrawingContestModal.addEventListener('click', () => {
          currentEditContestId = null;
          const submitBtn = document.getElementById('submit-drawing-contest');
          const updateBtn = document.getElementById('update-drawing-contest');
          if (submitBtn) submitBtn.classList.remove('hidden');
          if (updateBtn) updateBtn.classList.add('hidden');
          const modalTitle = document.getElementById('drawing-contest-modal-title');
          if (modalTitle) modalTitle.textContent = '–°–æ–∑–¥–∞—Ç—å –∫–æ–Ω–∫—É—Ä—Å —Ä–∏—Å—É–Ω–∫–æ–≤';
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∂—é—Ä–∏
          if (juryEnabledCheckbox) juryEnabledCheckbox.checked = false;
          if (jurySettingsDiv) jurySettingsDiv.classList.add('hidden');
          currentJuryCount = 1;
          updateJuryMembers(1);
          closeModal(drawingContestModal);
        });
      }
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞ —Ä–∏—Å—É–Ω–∫–æ–≤
      if (submitDrawingContest) {
        submitDrawingContest.addEventListener('click', async () => {
          const theme = document.getElementById('drawing-contest-theme')?.value.trim();
          const baseConditions = document.getElementById('drawing-contest-conditions-base')?.value.trim() || '';
          const additionalConditions = document.getElementById('drawing-contest-conditions-additional')?.value.trim() || '';
          const winnersCount = parseInt(document.getElementById('drawing-contest-winners-count')?.value) || 1;
          const submissionEndDate = document.getElementById('drawing-contest-submission-end')?.value;
          const votingEndDate = document.getElementById('drawing-contest-voting-end')?.value;
          
          // –û–±—ä–µ–¥–∏–Ω—è–µ–º –±–∞–∑–æ–≤—ã–µ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
          let conditions = baseConditions;
          if (additionalConditions) {
            conditions += (conditions ? '\n\n' : '') + additionalConditions;
          }
          
          if (!theme || !baseConditions || !submissionEndDate || !votingEndDate) {
            alert('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
            return;
          }
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –∞–¥–º–∏–Ω–∞ –µ—Å—Ç—å –∫–∞–Ω–∞–ª –∏ —á–∞—Ç
          if (!adminChannelLink || !adminChatLink) {
            alert('‚ö†Ô∏è –£ –≤–∞—Å –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –∫–∞–Ω–∞–ª –∏/–∏–ª–∏ —á–∞—Ç! –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Å–æ–∑–¥–∞—Ç–µ–ª—é –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–æ–≤.');
            return;
          }
          
          // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏: –º–∏–Ω–∏–º—É–º 10 –º–∏–Ω—É—Ç –º–µ–∂–¥—É –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º –ø—Ä–∏–µ–º–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
          const submissionEnd = new Date(submissionEndDate);
          const votingEnd = new Date(votingEndDate);
          const timeDiff = (votingEnd - submissionEnd) / 1000 / 60; // —Ä–∞–∑–Ω–∏—Ü–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö
          
          if (timeDiff < 10) {
            alert('‚ö†Ô∏è –ú–µ–∂–¥—É –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –∏ –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 10 –º–∏–Ω—É—Ç');
            return;
          }
          
          if (submissionEnd >= votingEnd) {
            alert('‚ö†Ô∏è –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è');
            return;
          }
          
          // –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—É—Ä—Å–∞
          const contestTitle = `–ö–æ–Ω–∫—É—Ä—Å —Ä–∏—Å—É–Ω–∫–æ–≤: ${theme}`;
          
          // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –ú–°–ö –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞
          const now = new Date();
          const mskTimeString = now.toLocaleString('sv-SE', { timeZone: 'Europe/Moscow' }).slice(0, 16).replace(' ', 'T');
          
          // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∂—é—Ä–∏ (—Ç–æ–ª—å–∫–æ –≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –¥–∞–Ω–Ω—ã–µ –≤–≤–µ–¥–µ–º –ø–æ–∑–∂–µ)
          let juryData = null;
          const juryEnabled = juryEnabledCheckbox && juryEnabledCheckbox.checked;
          const juryCount = parseInt(document.getElementById('drawing-contest-jury-count')?.value) || 1;
          
          if (juryEnabled) {
            juryData = {
              enabled: true,
              members_count: juryCount,
              members: [] // –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –≤–≤–µ–¥–µ–Ω—ã –≤ –º–æ–¥–∞–ª–∫–µ –ø—Ä–∏–∑–æ–≤
            };
          } else {
            juryData = {
              enabled: false,
              members: []
            };
          }
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∂—é—Ä–∏ –¥–ª—è –º–æ–¥–∞–ª–∫–∏ –ø—Ä–∏–∑–æ–≤
          window.currentJuryEnabled = juryEnabled;
          window.currentJuryCount = juryCount;
          
          const payload = {
            title: contestTitle,
            name: contestTitle,
            conditions: conditions,
            prize: '',
            start_at: mskTimeString,
            end_at: votingEndDate,
            submission_end_date: submissionEndDate,
            winners_count: winnersCount,
            created_by: currentUserId,
            contest_type: 'drawing',
            post_link: '',
            channel_link: adminChannelLink,
            discussion_group_link: adminChatLink,
            jury: juryData
          };
          
          try {
            const response = await fetchJSON('/api/contests', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            
            if (response.success && response.id) {
              closeModal(drawingContestModal);
              window.currentContestId = response.id;
              window.currentWinnersCount = winnersCount;
              
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –¥–ª—è –≤–≤–æ–¥–∞ –ø—Ä–∏–∑–æ–≤ (—á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é openPrizesModal)
              if (typeof openPrizesModal === 'function') {
                openPrizesModal();
              } else {
                // Fallback: –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –Ω–∞–ø—Ä—è–º—É—é
                const prizesModal = document.getElementById('prizes-modal');
                if (prizesModal) {
                  const prizesList = document.getElementById('prizes-list');
                  if (prizesList) {
                    prizesList.innerHTML = '';
                    for (let i = 0; i < winnersCount; i++) {
                      const prizeDiv = document.createElement('div');
                      prizeDiv.className = 'flex gap-2 items-center';
                      prizeDiv.style.pointerEvents = 'auto';
                      prizeDiv.innerHTML = `
                        <label class="text-sm text-gray-400 w-20">–ü—Ä–∏–∑ ${i + 1}:</label>
                        <input type="text" class="prize-input input-field flex-1 p-2 rounded" placeholder="t.me/nft/–Ω–∞–∑–≤–∞–Ω–∏–µ-–Ω–æ–º–µ—Ä" data-index="${i + 1}" style="pointer-events: auto; position: relative; z-index: 1;" />
                      `;
                      prizesList.appendChild(prizeDiv);
                    }
                    openModal(prizesModal);
                  }
                }
              }
            } else {
              alert('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–Ω–∫—É—Ä—Å–∞: ' + (response.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞ —Ä–∏—Å—É–Ω–∫–æ–≤:', e);
            alert('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–Ω–∫—É—Ä—Å–∞: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          }
        });
      }
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞ —Ä–∏—Å—É–Ω–∫–æ–≤
      if (updateDrawingContest) {
        updateDrawingContest.addEventListener('click', async () => {
          if (!currentEditContestId) {
            alert('‚ö†Ô∏è –û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω ID –∫–æ–Ω–∫—É—Ä—Å–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
            return;
          }
          
          const theme = document.getElementById('drawing-contest-theme')?.value.trim();
          const baseConditions = document.getElementById('drawing-contest-conditions-base')?.value.trim() || '';
          const additionalConditions = document.getElementById('drawing-contest-conditions-additional')?.value.trim() || '';
          const winnersCount = parseInt(document.getElementById('drawing-contest-winners-count')?.value) || 1;
          const submissionEndDate = document.getElementById('drawing-contest-submission-end')?.value;
          const votingEndDate = document.getElementById('drawing-contest-voting-end')?.value;
          
          // –û–±—ä–µ–¥–∏–Ω—è–µ–º –±–∞–∑–æ–≤—ã–µ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
          let conditions = baseConditions;
          if (additionalConditions) {
            conditions += (conditions ? '\n\n' : '') + additionalConditions;
          }
          
          if (!theme || !baseConditions || !submissionEndDate || !votingEndDate) {
            alert('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
            return;
          }
          
          // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏: –º–∏–Ω–∏–º—É–º 10 –º–∏–Ω—É—Ç –º–µ–∂–¥—É –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º –ø—Ä–∏–µ–º–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
          const submissionEnd = new Date(submissionEndDate);
          const votingEnd = new Date(votingEndDate);
          const timeDiff = (votingEnd - submissionEnd) / 1000 / 60;
          
          if (timeDiff < 10) {
            alert('‚ö†Ô∏è –ú–µ–∂–¥—É –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –∏ –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 10 –º–∏–Ω—É—Ç');
            return;
          }
          
          if (submissionEnd >= votingEnd) {
            alert('‚ö†Ô∏è –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è');
            return;
          }
          
          // –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—É—Ä—Å–∞
          const contestTitle = `–ö–æ–Ω–∫—É—Ä—Å —Ä–∏—Å—É–Ω–∫–æ–≤: ${theme}`;
          
          try {
            const now = new Date();
            const mskTimeString = now.toLocaleString('sv-SE', { timeZone: 'Europe/Moscow' }).slice(0, 16).replace(' ', 'T');
            
            const payload = {
              title: contestTitle,
              name: contestTitle,
              conditions: conditions,
              prize: '',
              start_at: mskTimeString,
              end_at: votingEndDate,
              submission_end_date: submissionEndDate,
              winners_count: winnersCount,
              created_by: currentUserId,
              contest_type: 'drawing',
              current_user_id: currentUserId
            };
            
            const response = await fetchJSON(`/api/contests/${currentEditContestId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            
            if (response.success) {
              alert('‚úÖ –ö–æ–Ω–∫—É—Ä—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
              closeModal(drawingContestModal);
              
              // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
              currentEditContestId = null;
              const submitBtn = document.getElementById('submit-drawing-contest');
              const updateBtn = document.getElementById('update-drawing-contest');
              if (submitBtn) submitBtn.classList.remove('hidden');
              if (updateBtn) updateBtn.classList.add('hidden');
              const modalTitle = document.getElementById('drawing-contest-modal-title');
              if (modalTitle) modalTitle.textContent = '–°–æ–∑–¥–∞—Ç—å –∫–æ–Ω–∫—É—Ä—Å —Ä–∏—Å—É–Ω–∫–æ–≤';
              
              await loadContests();
            } else {
              alert('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω–∫—É—Ä—Å–∞: ' + (response.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞ —Ä–∏—Å—É–Ω–∫–æ–≤:', e);
            alert('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω–∫—É—Ä—Å–∞: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          }
        });
      }
      
      // –ó–∞—â–∏—Ç–∞ –±–∞–∑–æ–≤–æ–≥–æ –ø–æ–ª—è —É—Å–ª–æ–≤–∏–π –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
      window.setupBaseConditionsProtection = function() {
        const baseConditionsField = document.getElementById('drawing-contest-conditions-base');
        if (!baseConditionsField) return;
        
        originalBaseValue = baseConditionsField.value;
        
        const protectionHandlers = {
          input: function(e) {
            if (this.value !== originalBaseValue) {
              this.value = originalBaseValue;
            }
          },
          keydown: function(e) {
            if (e.ctrlKey && (e.key === 'a' || e.key === 'c')) {
              return;
            }
            if (!e.ctrlKey && !e.metaKey && e.key !== 'Tab' && e.key !== 'Escape' && e.key !== 'F5') {
              e.preventDefault();
            }
          },
          paste: function(e) {
            e.preventDefault();
          }
        };
        
        baseConditionsField.addEventListener('input', protectionHandlers.input);
        baseConditionsField.addEventListener('keydown', protectionHandlers.keydown);
        baseConditionsField.addEventListener('paste', protectionHandlers.paste);
      };
      
      // Contact owner functionality
      const contactOwnerBtn = document.getElementById('contact-owner-btn');
      const contactOwnerModal = document.getElementById('contact-owner-modal');
      const closeContactModal = document.getElementById('close-contact-modal');
      const sendContactMessage = document.getElementById('send-contact-message');

      if (contactOwnerBtn) {
        contactOwnerBtn.addEventListener('click', () => {
          openModal(contactOwnerModal);
        });
      }

      if (closeContactModal) {
        closeContactModal.addEventListener('click', () => {
          closeModal(contactOwnerModal);
          document.getElementById('contact-message-text').value = '';
        });
      }

      if (sendContactMessage) {
        sendContactMessage.addEventListener('click', async () => {
          const messageText = document.getElementById('contact-message-text').value.trim();
          if (!messageText) {
            alert('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
            return;
          }

          try {
            await fetchJSON('/api/messages', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                from_user_id: currentUserId,
                message_text: messageText
              })
            });
            alert('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤–ª–∞–¥–µ–ª—å—Ü—É!');
            closeModal(contactOwnerModal);
            document.getElementById('contact-message-text').value = '';
          } catch (e) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
          }
        });
      }
      
      // –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–∑–æ–≤
      const prizesModal = document.getElementById('prizes-modal');
      const closePrizesModal = document.getElementById('close-prizes-modal');
      const addPrizeBtn = document.getElementById('add-prize-btn');
      const submitPrizesBtn = document.getElementById('submit-prizes');
      const prizesList = document.getElementById('prizes-list');
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é openPrizesModal
      openPrizesModal = function() {
        if (!prizesList) {
          console.error('prizesList –Ω–µ –Ω–∞–π–¥–µ–Ω!');
          return;
        }
        prizesList.innerHTML = '';
        const winnersCount = window.currentWinnersCount || 1;
        console.log('–û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –ø—Ä–∏–∑–æ–≤ –¥–ª—è', winnersCount, '–ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π');
        for (let i = 0; i < winnersCount; i++) {
          addPrizeInput(i + 1);
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –∂—é—Ä–∏, –µ—Å–ª–∏ –∂—é—Ä–∏ –±—ã–ª–æ –≤–∫–ª—é—á–µ–Ω–æ
        const jurySection = document.getElementById('prizes-modal-jury-section');
        const juryMembersDiv = document.getElementById('prizes-modal-jury-members');
        const juryEnabled = window.currentJuryEnabled || false;
        const juryCount = window.currentJuryCount || 1;
        
        if (jurySection && juryMembersDiv) {
          if (juryEnabled) {
            jurySection.classList.remove('hidden');
            juryMembersDiv.innerHTML = '';
            for (let i = 0; i < juryCount; i++) {
              const memberDiv = document.createElement('div');
              memberDiv.className = 'space-y-2 p-3 bg-gray-800/50 rounded border border-violet-500/20';
              memberDiv.innerHTML = `
                <label class="block text-xs text-gray-400 mb-1">–ß–ª–µ–Ω –∂—é—Ä–∏ ${i + 1}</label>
                <input type="text" class="jury-member-id input-field w-full p-2 rounded text-sm" placeholder="Telegram ID –∏–ª–∏ @username" data-index="${i}" style="pointer-events: auto;" />
                <input type="text" class="jury-member-channel input-field w-full p-2 rounded text-sm" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª (t.me/...)" data-index="${i}" style="pointer-events: auto;" />
              `;
              juryMembersDiv.appendChild(memberDiv);
            }
          } else {
            jurySection.classList.add('hidden');
          }
        }
        
        if (prizesModal) {
          openModal(prizesModal);
        } else {
          console.error('prizesModal –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        }
      }
      
      function addPrizeInput(index) {
        const prizeDiv = document.createElement('div');
        prizeDiv.className = 'flex gap-2 items-center';
        prizeDiv.style.pointerEvents = 'auto';
        prizeDiv.innerHTML = `
          <label class="text-sm text-gray-400 w-20">–ü—Ä–∏–∑ ${index}:</label>
          <input type="text" class="prize-input input-field flex-1 p-2 rounded" placeholder="t.me/nft/–Ω–∞–∑–≤–∞–Ω–∏–µ-–Ω–æ–º–µ—Ä" data-index="${index}" style="pointer-events: auto; position: relative; z-index: 1;" />
        `;
        prizesList.appendChild(prizeDiv);
      }
      
      if (closePrizesModal) {
        closePrizesModal.addEventListener('click', () => closeModal(prizesModal));
      }
      
      if (addPrizeBtn) {
        addPrizeBtn.addEventListener('click', () => {
          const currentCount = prizesList.querySelectorAll('.prize-input').length;
          addPrizeInput(currentCount + 1);
        });
      }
      
      if (submitPrizesBtn) {
        submitPrizesBtn.addEventListener('click', async () => {
          const prizeInputs = prizesList.querySelectorAll('.prize-input');
          const prizeLinks = [];
          
          for (const input of prizeInputs) {
            const link = input.value.trim();
            if (link) {
              // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ —Å—Å—ã–ª–∫–∏
              if (!/^t\.me\/nft\/[a-zA-Z0-9_-]+$/.test(link)) {
                alert(`‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–∏–∑!\n\n–ü—Ä–∏–º–µ—Ä: t.me/nft/SnoopDogg-119754\n\n–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞: ${link}`);
                return;
              }
              prizeLinks.push(link);
            }
          }
          
          if (prizeLinks.length === 0) {
            alert('‚ö†Ô∏è –î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–∏–∑!');
            return;
          }
          
          if (prizeLinks.length !== window.currentWinnersCount) {
            if (!confirm(`‚ö†Ô∏è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–∑–æ–≤ (${prizeLinks.length}) –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π (${window.currentWinnersCount}). –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`)) {
              return;
            }
          }
          
          // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∂—é—Ä–∏, –µ—Å–ª–∏ –∂—é—Ä–∏ –≤–∫–ª—é—á–µ–Ω–æ
          let juryData = null;
          const juryEnabled = window.currentJuryEnabled || false;
          if (juryEnabled) {
            const juryMembersDiv = document.getElementById('prizes-modal-jury-members');
            if (juryMembersDiv) {
              const members = [];
              const memberIdInputs = juryMembersDiv.querySelectorAll('.jury-member-id');
              const memberChannelInputs = juryMembersDiv.querySelectorAll('.jury-member-channel');
              
              for (let i = 0; i < memberIdInputs.length; i++) {
                const userIdOrUsername = memberIdInputs[i]?.value.trim();
                const channelLink = memberChannelInputs[i]?.value.trim();
                
                if (userIdOrUsername && channelLink) {
                  // –ü–∞—Ä—Å–∏–º ID –∏–ª–∏ username
                  let userId = null;
                  if (userIdOrUsername.startsWith('@')) {
                    // –≠—Ç–æ username, –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–ª—É—á–∏—Ç—å ID —á–µ—Ä–µ–∑ API –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å
                    // –ü–æ–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ username
                    userId = userIdOrUsername;
                  } else {
                    try {
                      userId = parseInt(userIdOrUsername);
                      if (isNaN(userId)) {
                        alert(`‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Telegram ID –¥–ª—è —á–ª–µ–Ω–∞ –∂—é—Ä–∏ ${i + 1}. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —á–∏—Å–ª–æ–≤–æ–π ID –∏–ª–∏ @username`);
                        return;
                      }
                    } catch (e) {
                      alert(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ ID —á–ª–µ–Ω–∞ –∂—é—Ä–∏ ${i + 1}: ${e.message}`);
                      return;
                    }
                  }
                  
                  members.push({
                    user_id: userId,
                    channel_link: channelLink
                  });
                } else if (userIdOrUsername || channelLink) {
                  alert(`‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –¥–ª—è —á–ª–µ–Ω–∞ –∂—é—Ä–∏ ${i + 1}`);
                  return;
                }
              }
              
              if (members.length > 0) {
                juryData = {
                  enabled: true,
                  members: members
                };
              } else {
                alert('‚ö†Ô∏è –ï—Å–ª–∏ –∂—é—Ä–∏ –≤–∫–ª—é—á–µ–Ω–æ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ö–æ—Ç—è –±—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ —á–ª–µ–Ω–∞ –∂—é—Ä–∏');
                return;
              }
            }
          }
          
          try {
            const updateData = { 
              prize_links: prizeLinks,
              current_user_id: currentUserId
            };
            if (juryData) {
              updateData.jury = juryData;
            }
            
            await fetchJSON(`/api/contests/${window.currentContestId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(updateData)
            });
            closeModal(prizesModal);
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('contest-title').value = '';
            document.getElementById('contest-post-link').value = '';
            document.getElementById('contest-conditions').value = '';
            postLinkError.classList.add('hidden');
            await loadContests();
            showSection('contests-section');
            window.currentContestId = null;
            window.currentWinnersCount = null;
            window.currentJuryEnabled = null;
            window.currentJuryCount = null;
          } catch (e) {
            let errorMsg = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–∏–∑–æ–≤';
            if (e.message) {
              errorMsg += ': ' + e.message;
            } else if (e.status) {
              errorMsg += `: HTTP ${e.status}`;
            } else {
              errorMsg += ': –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            }
            alert(errorMsg);
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏–∑–æ–≤:', e);
          }
        });
      }
    })();
  </script>

  <!-- üé® –°–∏—Å—Ç–µ–º–∞ —Ç–µ–º -->
  <script>
    (function() {
      const themes = {
        default: {
          name: '–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é',
          id: 'default',
          icon: 'üü£',
          description: '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—Ä–æ–∑–æ–≤–∞—è —Ç–µ–º–∞'
        },
        kitty: {
          name: 'Kitty',
          id: 'kitty',
          icon: 'üê±',
          description: '–ú–∏–ª—ã–µ —Ä–æ–∑–æ–≤—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏'
        },
        mario: {
          name: 'Mario',
          id: 'mario',
          icon: 'üçÑ',
          description: '–†–µ—Ç—Ä–æ —Å—Ç–∏–ª—å Super Mario Bros'
        },
        aot: {
          name: 'Attack on Titan',
          id: 'aot',
          icon: '‚öîÔ∏è',
          description: '–°–µ–ø–∏—è, –ø–µ—Ä–≥–∞–º–µ–Ω—Ç, –≥–æ—Ç–∏—á–µ—Å–∫–∏–π —Å—Ç–∏–ª—å'
        }
      };

      function loadTheme() {
        const savedTheme = localStorage.getItem('selectedTheme') || 'default';
        applyTheme(savedTheme);
        setTimeout(() => {
          updateIconsForTheme(savedTheme);
        }, 300);
      }

      function applyTheme(themeId) {
        const body = document.body;
        body.classList.remove('theme-kitty', 'theme-mario', 'theme-aot');
        
        if (themeId !== 'default') {
          body.classList.add(`theme-${themeId}`);
        }
        
        updateIconsForTheme(themeId);
        localStorage.setItem('selectedTheme', themeId);
        console.log('‚úÖ –¢–µ–º–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞:', themeId);
      }

      function clearAllThemeIcons() {
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∏—Ç–∞–Ω–∞
        const titanImage = document.getElementById('aot-titan-image');
        if (titanImage) {
          titanImage.classList.add('hidden');
        }

        const profileBtn = document.querySelector('[data-section="profile-section"]');
        if (profileBtn) {
          const text = profileBtn.textContent.replace(/[üçÑüê±üë§üë®üë©]/g, '').trim();
          profileBtn.innerHTML = text || '–ü—Ä–æ—Ñ–∏–ª—å';
        }

        const contestsBtn = document.querySelector('[data-section="contests-section"]');
        if (contestsBtn) {
          const text = contestsBtn.textContent.replace(/[‚≠êüéÅüèÜüéØ]/g, '').trim();
          contestsBtn.innerHTML = text || '–ö–æ–Ω–∫—É—Ä—Å—ã';
        }

        const ratingBtn = document.querySelector('[data-section="rating-section"]');
        if (ratingBtn) {
          const text = ratingBtn.textContent.replace(/[ü™ôüíñ‚≠êüåü]/g, '').trim();
          ratingBtn.innerHTML = text || '–†–µ–π—Ç–∏–Ω–≥';
        }

        const changeThemeBtn = document.getElementById('change-theme-btn');
        if (changeThemeBtn) {
          const text = changeThemeBtn.textContent.replace(/[üéÆüíùüé®]/g, '').trim();
          changeThemeBtn.innerHTML = text || '–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É';
        }

        const contactBtn = document.getElementById('contact-owner-btn');
        if (contactBtn) {
          const text = contactBtn.textContent.replace(/[üìÆüíåüì®]/g, '').trim();
          contactBtn.innerHTML = text || '–°–≤—è–∑—å —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º';
        }

        const profileSection = document.querySelector('#profile-section h2');
        if (profileSection) {
          const text = profileSection.textContent.replace(/[üçÑüê±üë§üë®üë©]/g, '').trim();
          profileSection.innerHTML = text || '–ü—Ä–æ—Ñ–∏–ª—å';
        }

        const contestsSection = document.querySelector('#contests-section h2');
        if (contestsSection) {
          const text = contestsSection.textContent.replace(/[‚≠êüéÅüèÜüéØ]/g, '').trim();
          contestsSection.innerHTML = text || '–ö–æ–Ω–∫—É—Ä—Å—ã';
        }

        const ratingSection = document.querySelector('#rating-section h2');
        if (ratingSection) {
          const text = ratingSection.textContent.replace(/[ü™ôüíñ‚≠êüåü]/g, '').trim();
          ratingSection.innerHTML = text || '–†–µ–π—Ç–∏–Ω–≥';
        }
      }

      function updateIconsForTheme(themeId) {
        clearAllThemeIcons();

        if (themeId === 'mario') {
          const profileBtn = document.querySelector('[data-section="profile-section"]');
          if (profileBtn) profileBtn.innerHTML = 'üçÑ –ü—Ä–æ—Ñ–∏–ª—å';

          const contestsBtn = document.querySelector('[data-section="contests-section"]');
          if (contestsBtn) contestsBtn.innerHTML = '‚≠ê –ö–æ–Ω–∫—É—Ä—Å—ã';

          const ratingBtn = document.querySelector('[data-section="rating-section"]');
          if (ratingBtn) ratingBtn.innerHTML = 'ü™ô –†–µ–π—Ç–∏–Ω–≥';

          const changeThemeBtn = document.getElementById('change-theme-btn');
          if (changeThemeBtn) changeThemeBtn.innerHTML = 'üéÆ –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É';

          const contactBtn = document.getElementById('contact-owner-btn');
          if (contactBtn) contactBtn.innerHTML = 'üìÆ –°–≤—è–∑—å —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º';

          const profileSection = document.querySelector('#profile-section h2');
          if (profileSection) profileSection.innerHTML = 'üçÑ –ü—Ä–æ—Ñ–∏–ª—å';

          const contestsSection = document.querySelector('#contests-section h2');
          if (contestsSection) contestsSection.innerHTML = '‚≠ê –ö–æ–Ω–∫—É—Ä—Å—ã';

          const ratingSection = document.querySelector('#rating-section h2');
          if (ratingSection) ratingSection.innerHTML = 'ü™ô –†–µ–π—Ç–∏–Ω–≥';

        } else if (themeId === 'kitty') {
          const profileBtn = document.querySelector('[data-section="profile-section"]');
          if (profileBtn) profileBtn.innerHTML = 'üê± –ü—Ä–æ—Ñ–∏–ª—å';

          const contestsBtn = document.querySelector('[data-section="contests-section"]');
          if (contestsBtn) contestsBtn.innerHTML = 'üéÅ –ö–æ–Ω–∫—É—Ä—Å—ã';

          const ratingBtn = document.querySelector('[data-section="rating-section"]');
          if (ratingBtn) ratingBtn.innerHTML = 'üíñ –†–µ–π—Ç–∏–Ω–≥';

          const changeThemeBtn = document.getElementById('change-theme-btn');
          if (changeThemeBtn) changeThemeBtn.innerHTML = '<span class="kitty-btn-icon">üíù</span> –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É';

          const contactBtn = document.getElementById('contact-owner-btn');
          if (contactBtn) contactBtn.innerHTML = '<span class="kitty-btn-icon">üíå</span> –°–≤—è–∑—å —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º';

          const profileSection = document.querySelector('#profile-section h2');
          if (profileSection) profileSection.innerHTML = 'üê± –ü—Ä–æ—Ñ–∏–ª—å';

          const contestsSection = document.querySelector('#contests-section h2');
          if (contestsSection) contestsSection.innerHTML = 'üéÅ –ö–æ–Ω–∫—É—Ä—Å—ã';

          const ratingSection = document.querySelector('#rating-section h2');
          if (ratingSection) ratingSection.innerHTML = 'üíñ –†–µ–π—Ç–∏–Ω–≥';

        } else if (themeId === 'aot') {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∏—Ç–∞–Ω–∞
          const titanImage = document.getElementById('aot-titan-image');
          if (titanImage) {
            titanImage.classList.remove('hidden');
          }

          const profileBtn = document.querySelector('[data-section="profile-section"]');
          if (profileBtn) profileBtn.innerHTML = '‚öîÔ∏è –ü—Ä–æ—Ñ–∏–ª—å';

          const contestsBtn = document.querySelector('[data-section="contests-section"]');
          if (contestsBtn) contestsBtn.innerHTML = 'üõ°Ô∏è –ö–æ–Ω–∫—É—Ä—Å—ã';

          const ratingBtn = document.querySelector('[data-section="rating-section"]');
          if (ratingBtn) ratingBtn.innerHTML = 'üèÜ –†–µ–π—Ç–∏–Ω–≥';

          const changeThemeBtn = document.getElementById('change-theme-btn');
          if (changeThemeBtn) changeThemeBtn.innerHTML = '‚öîÔ∏è –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É';

          const profileSection = document.querySelector('#profile-section h2');
          if (profileSection) profileSection.innerHTML = '‚öîÔ∏è –ü—Ä–æ—Ñ–∏–ª—å';

          const contestsSection = document.querySelector('#contests-section h2');
          if (contestsSection) contestsSection.innerHTML = 'üõ°Ô∏è –ö–æ–Ω–∫—É—Ä—Å—ã';

          const ratingSection = document.querySelector('#rating-section h2');
          if (ratingSection) ratingSection.innerHTML = 'üèÜ –†–µ–π—Ç–∏–Ω–≥';

        } else {
          // –°–∫—Ä—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∏—Ç–∞–Ω–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–µ–º
          const titanImage = document.getElementById('aot-titan-image');
          if (titanImage) {
            titanImage.classList.add('hidden');
          }

          const profileBtn = document.querySelector('[data-section="profile-section"]');
          if (profileBtn) profileBtn.innerHTML = 'üë§ –ü—Ä–æ—Ñ–∏–ª—å';

          const contestsBtn = document.querySelector('[data-section="contests-section"]');
          if (contestsBtn) contestsBtn.innerHTML = 'üèÜ –ö–æ–Ω–∫—É—Ä—Å—ã';

          const ratingBtn = document.querySelector('[data-section="rating-section"]');
          if (ratingBtn) ratingBtn.innerHTML = '‚≠ê –†–µ–π—Ç–∏–Ω–≥';

          const changeThemeBtn = document.getElementById('change-theme-btn');
          if (changeThemeBtn) changeThemeBtn.innerHTML = '<span class="kitty-btn-icon">üé®</span> –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É';

          const contactBtn = document.getElementById('contact-owner-btn');
          if (contactBtn) contactBtn.innerHTML = 'üì® –°–≤—è–∑—å —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º';

          const profileSection = document.querySelector('#profile-section h2');
          if (profileSection) profileSection.innerHTML = 'üë§ –ü—Ä–æ—Ñ–∏–ª—å';

          const contestsSection = document.querySelector('#contests-section h2');
          if (contestsSection) contestsSection.innerHTML = 'üèÜ –ö–æ–Ω–∫—É—Ä—Å—ã';

          const ratingSection = document.querySelector('#rating-section h2');
          if (ratingSection) ratingSection.innerHTML = '‚≠ê –†–µ–π—Ç–∏–Ω–≥';
        }
      }

      function initThemeSelector() {
        const themeModal = document.getElementById('theme-selector-modal');
        const changeThemeBtn = document.getElementById('change-theme-btn');
        const closeThemeModal = document.getElementById('close-theme-modal');
        const themesList = document.getElementById('themes-list');

        if (!themeModal || !changeThemeBtn || !closeThemeModal || !themesList) {
          console.error('–≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ç–µ–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
          return;
        }

        function renderThemes() {
          updateThemeSelector();
        }

        changeThemeBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          renderThemes();
          themeModal.classList.remove('hidden');
          document.body.classList.add('modal-open');
        });

        closeThemeModal.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          themeModal.classList.add('hidden');
          document.body.classList.remove('modal-open');
        });

        themeModal.addEventListener('click', (e) => {
          if (e.target === themeModal) {
            themeModal.classList.add('hidden');
            document.body.classList.remove('modal-open');
          }
        });
      }

      // üõí –°–∏—Å—Ç–µ–º–∞ –º–∞–≥–∞–∑–∏–Ω–∞
      const shopItems = {
        avatarStars: [
          { id: 'star-gold', icon: '‚≠ê', name: '–ó–æ–ª–æ—Ç–∞—è –∑–≤–µ–∑–¥–∞', price: 10, priceType: 'stars' },
          { id: 'star-silver', icon: '‚ú®', name: '–°–µ—Ä–µ–±—Ä—è–Ω–∞—è –∑–≤–µ–∑–¥–∞', price: 5, priceType: 'stars' },
          { id: 'star-rainbow', icon: 'üåü', name: '–†–∞–¥—É–∂–Ω–∞—è –∑–≤–µ–∑–¥–∞', price: 20, priceType: 'stars' },
          { id: 'star-diamond', icon: 'üíé', name: '–ê–ª–º–∞–∑–Ω–∞—è –∑–≤–µ–∑–¥–∞', price: 50, priceType: 'stars' },
          { id: 'star-fire', icon: 'üî•', name: '–û–≥–Ω–µ–Ω–Ω–∞—è –∑–≤–µ–∑–¥–∞', price: 30, priceType: 'stars' },
          { id: 'star-ice', icon: '‚ùÑÔ∏è', name: '–õ–µ–¥—è–Ω–∞—è –∑–≤–µ–∑–¥–∞', price: 25, priceType: 'stars' }
        ],
        themes: [
          { 
            id: 'kitty', 
            name: 'Kitty', 
            icon: 'üê±', 
            priceMonkeyCoins: 150, 
            description: '–ú–∏–ª—ã–µ –∫–æ—Ç–∏–∫–∏ –∏ –ª–∞–ø–∫–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥—É' 
          },
          { 
            id: 'mario', 
            name: 'Mario', 
            icon: 'üçÑ', 
            priceMonkeyCoins: 250, 
            description: '–†–µ—Ç—Ä–æ —Å—Ç–∏–ª—å Super Mario Bros —Å –ø–∏–∫—Å–µ–ª—å–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫–æ–π' 
          }
        ],
        nftGifts: [
          { id: 'nft-gift-1', icon: 'üéÅ', name: 'NFT –ü–æ–¥–∞—Ä–æ–∫ 1', price: 200, priceType: 'stars', nftLink: '' },
          { id: 'nft-gift-2', icon: 'üéÅ', name: 'NFT –ü–æ–¥–∞—Ä–æ–∫ 2', price: 300, priceType: 'stars', nftLink: '' },
          { id: 'nft-gift-3', icon: 'üéÅ', name: 'NFT –ü–æ–¥–∞—Ä–æ–∫ 3', price: 500, priceType: 'stars', nftLink: '' }
        ]
      };

      // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
      async function getPurchasedItems() {
        const currentUserId = window.currentUserId || 0;
        if (!currentUserId) {
          return { avatarStars: [], themes: [], nftGifts: [] };
        }
        
        try {
          // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ API
          const response = await window.fetchJSON(`/api/payment/purchased-items?tg_id=${currentUserId}`);
          if (response && response.purchased_items) {
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å localStorage –¥–ª—è –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–∞
            try {
              localStorage.setItem('purchasedItems', JSON.stringify(response.purchased_items));
            } catch (e) {
              console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage:', e);
            }
            return response.purchased_items;
          }
        } catch (e) {
          console.warn('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–∫—É–ø–æ–∫ –∏–∑ API, –∏—Å–ø–æ–ª—å–∑—É–µ–º localStorage:', e);
        }
        
        // Fallback –Ω–∞ localStorage
        try {
          const purchased = localStorage.getItem('purchasedItems');
          return purchased ? JSON.parse(purchased) : { avatarStars: [], themes: [], nftGifts: [] };
        } catch (e) {
          return { avatarStars: [], themes: [], nftGifts: [] };
        }
      }

      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
      async function savePurchasedItems(items) {
        const currentUserId = window.currentUserId || 0;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
        try {
          localStorage.setItem('purchasedItems', JSON.stringify(items));
        } catch (e) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage:', e);
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ API
        if (currentUserId) {
          // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –Ω–æ–≤—ã–µ –ø–æ–∫—É–ø–∫–∏ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö
          // –≠—Ç–æ –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–π –ø–æ–∫—É–ø–∫–∏ —á–µ—Ä–µ–∑ addPurchasedItem
        }
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞, –∫—É–ø–ª–µ–Ω –ª–∏ —Ç–æ–≤–∞—Ä
      async function isItemPurchased(category, itemId) {
        const purchased = await getPurchasedItems();
        return purchased[category] && purchased[category].includes(itemId);
      }

      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫—É–ø–ª–µ–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
      async function addPurchasedItem(category, itemId) {
        const currentUserId = window.currentUserId || 0;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
        const purchased = await getPurchasedItems();
        if (!purchased[category]) {
          purchased[category] = [];
        }
        if (!purchased[category].includes(itemId)) {
          purchased[category].push(itemId);
          await savePurchasedItems(purchased);
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ API
          if (currentUserId) {
            try {
              await window.fetchJSON('/api/payment/add-purchase', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  tg_id: currentUserId,
                  category: category,
                  item_id: itemId
                })
              });
              console.log(`‚úÖ –ü–æ–∫—É–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –ë–î: ${category}/${itemId}`);
            } catch (e) {
              console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏ –≤ –ë–î:', e);
              // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É –¥–∞–∂–µ –µ—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î –Ω–µ —É–¥–∞–ª–æ—Å—å
            }
          }
        }
      }

      // –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä –¥–ª—è –ø–æ–∫—É–ø–∫–∏
      let currentPurchaseItem = null;

      // –ü–æ–∫—É–ø–∫–∞ —Ç–æ–≤–∞—Ä–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
      async function purchaseItem(category, itemId) {
        const item = shopItems[category]?.find(i => i.id === itemId);
        if (!item) {
          alert('‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
          return;
        }

        if (await isItemPurchased(category, itemId)) {
          alert('‚úÖ –≠—Ç–æ—Ç —Ç–æ–≤–∞—Ä —É–∂–µ –∫—É–ø–ª–µ–Ω!');
          return;
        }

        // –î–ª—è —Ç–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ Monkey Coins
        if (category === 'themes') {
          const price = item.priceMonkeyCoins || 0;
          if (price <= 0) {
            alert('‚ùå –¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞');
            return;
          }

          try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å Monkey Coins
            const balanceResponse = await window.fetchJSON(`/api/profile/monkey-coins?tg_id=${currentUserId}`);
            const balance = balanceResponse?.monkey_coins || 0;

            if (balance < price) {
              alert(`‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Monkey Coins!\n\n–£ –≤–∞—Å: ${balance}\n–ù—É–∂–Ω–æ: ${price}\n\n–ü–æ–ø–æ–ª–Ω–∏—Ç–µ —Å—á–µ—Ç —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "+" –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É.`);
              return;
            }

            // –°–ø–∏—Å—ã–≤–∞–µ–º Monkey Coins –∏ –ø–æ–∫—É–ø–∞–µ–º —Ç–µ–º—É
            const purchaseResponse = await window.fetchJSON('/api/shop/purchase-theme', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                user_id: currentUserId,
                theme_id: itemId,
                price: price
              })
            });

            if (purchaseResponse?.success) {
              // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
              await renderShop();
              // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –º–æ–Ω–µ—Ç–æ–∫
              await updateCoinsDisplay();
              alert(`‚úÖ –¢–µ–º–∞ "${item.name}" —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω–∞!\n\n–°–ø–∏—Å–∞–Ω–æ: ${price} Monkey Coins`);
            } else {
              const errorMsg = purchaseResponse?.detail || purchaseResponse?.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ';
              alert(`‚ùå ${errorMsg}`);
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ —Ç–µ–º—ã:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ —Ç–µ–º—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
          }
          return;
        }

        // –î–ª—è –¥—Ä—É–≥–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π (avatarStars, nftGifts) –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Telegram WebApp –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –æ–ø–ª–∞—Ç—ã
        const isWebAppAvailable = window.Telegram?.WebApp?.initDataUnsafe;
        if (!isWebAppAvailable) {
          console.warn('‚ö†Ô∏è Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –≤ Telegram –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –æ–ø–ª–∞—Ç—ã.');
          console.warn('üì± –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (—Ç–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –æ–ø–ª–∞—Ç—ã).');
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ç–æ–≤–∞—Ä
        currentPurchaseItem = { category, itemId, item };

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
        showPaymentMethodModal();
      }

      // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª–∫–∏ –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
      function showPaymentMethodModal() {
        if (!currentPurchaseItem) return;

        const modal = document.getElementById('payment-method-modal');
        const methodsList = document.getElementById('payment-methods-list');
        
        if (!modal || !methodsList) return;

        const { item } = currentPurchaseItem;

        // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã
        let priceStars = item.priceStars || item.price || 0;
        let priceTON = item.priceTON || 0;
        let priceGifts = item.priceGifts;

        // –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã
        const paymentMethods = [
          {
            id: 'stars',
            name: 'Telegram Stars',
            icon: '‚≠ê',
            description: priceStars > 0 ? `${priceStars} ‚≠ê` : '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ',
            available: priceStars > 0,
            price: priceStars
          },
          {
            id: 'ton',
            name: 'CryptoBot',
            icon: 'ü§ñ',
            description: priceTON > 0 ? `${priceTON} TON` : '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ',
            available: priceTON > 0,
            price: priceTON
          },
          {
            id: 'gifts',
            name: 'NFT Gifts',
            icon: 'üéÅ',
            description: priceGifts !== null ? (typeof priceGifts === 'number' ? `${priceGifts} ‚≠ê` : priceGifts) : '–°–∫–æ—Ä–æ',
            available: priceGifts !== null && typeof priceGifts === 'number',
            price: priceGifts
          }
        ];

        methodsList.innerHTML = paymentMethods.map(method => `
          <div class="rounded-lg border ${method.available ? 'border-violet-400/30 bg-black/30 cursor-pointer hover:border-violet-400/50 hover:bg-black/40' : 'border-gray-600/30 bg-black/20 cursor-not-allowed opacity-60'} p-4 transition-all" 
               ${method.available ? `onclick="window.selectPaymentMethod('${method.id}')"` : ''}>
            <div class="flex items-center gap-3">
              <div class="text-3xl">${method.icon}</div>
              <div class="flex-1">
                <div class="font-semibold text-white">${method.name}</div>
                <div class="text-sm ${method.available ? 'text-gray-400' : 'text-gray-500'}">${method.description}</div>
              </div>
              ${method.available ? '<div class="text-violet-400 text-xl">‚Üí</div>' : '<div class="text-gray-500 text-sm">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</div>'}
            </div>
          </div>
        `).join('');

        modal.classList.remove('hidden');
        document.body.classList.add('modal-open');
      }

      // –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
      async function selectPaymentMethod(methodId) {
        if (!currentPurchaseItem) return;

        const { category, itemId, item } = currentPurchaseItem;
        const paymentModal = document.getElementById('payment-method-modal');

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
        if (paymentModal) {
          paymentModal.classList.add('hidden');
          document.body.classList.remove('modal-open');
        }

        try {
          if (methodId === 'stars') {
            await processStarsPayment(category, itemId, item);
          } else if (methodId === 'ton') {
            await processTONPayment(category, itemId, item);
          } else if (methodId === 'gifts') {
            await processGiftsPayment(category, itemId, item);
          }
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–ø–ª–∞—Ç—ã:', error);
          // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â—É—é –æ—à–∏–±–∫—É, –µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª–æ –∏–∑ processStarsPayment
          // (—Ç–∞–º —É–∂–µ –µ—Å—Ç—å —Å–≤–æ—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫)
          if (error && error.message && !error.message.includes('–°—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω')) {
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–ø–ª–∞—Ç—ã: ' + String(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          }
        }
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ Telegram Stars
      async function processStarsPayment(category, itemId, item) {
        const currentUserId = window.currentUserId || 0;
        
        // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –≤ Stars
        const price = item.priceStars || item.price || 0;
        if (price <= 0) {
          alert('‚ùå –¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞');
          return;
        }
        
          // –°–æ–∑–¥–∞–µ–º invoice —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ –±–æ—Ç–∞
        try {
          console.log(`üìã –°–æ–∑–¥–∞–Ω–∏–µ —Å—á–µ—Ç–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏: ${item.name}, —Ü–µ–Ω–∞: ${price} ‚≠ê`);
          const response = await window.fetchJSON('/api/payment/create-stars-invoice', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              title: item.name,
              description: `–ü–æ–∫—É–ø–∫–∞: ${item.name}`,
              amount: price,
              user_id: currentUserId,
              category: category,
              item_id: itemId
            })
          });
          
          // –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
          console.log('üìã –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ–ª—É—á–µ–Ω (—Å—ã—Ä–æ–π):', response);
          console.log('üìã –¢–∏–ø response:', typeof response);
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
          if (!response) {
            console.error('‚ùå –ù–µ –ø–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞: –Ω–µ –ø–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.');
            return;
          }
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ response - –æ–±—ä–µ–∫—Ç
          if (typeof response !== 'object') {
            console.error('‚ùå –û—Ç–≤–µ—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º:', response);
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.');
            return;
          }
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º success (–º–æ–∂–µ—Ç –±—ã—Ç—å true, 'true', 1, –∏ —Ç.–¥.)
          const isSuccess = response.success === true || 
                           response.success === 'true' || 
                           response.success === 1 ||
                           (typeof response.success === 'string' && response.success.toLowerCase() === 'true');
          
          console.log('üìã response.success:', response.success);
          console.log('üìã response.success === true:', response.success === true);
          console.log('üìã isSuccess (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞):', isSuccess);
          console.log('üìã JSON –æ—Ç–≤–µ—Ç–∞:', JSON.stringify(response));
          
          if (isSuccess) {
            // –°—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –±–æ—Ç–∞, —É–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            console.log('‚úÖ –°—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω! –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.');
            alert('‚úÖ –°—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É ' + price + ' ‚≠ê –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –±–æ—Ç–∞!\n\n–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º, —á—Ç–æ–±—ã –æ–ø–ª–∞—Ç–∏—Ç—å –ø–æ–∫—É–ø–∫—É. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Ç–æ–≤–∞—Ä –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.');
            return;
          }
          
          // –ï—Å–ª–∏ success –Ω–µ true, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
          const errorMsg = response.message || response.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á–µ—Ç–∞. –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response);
          console.error('‚ùå response.success =', response.success, '(—Ç–∏–ø:', typeof response.success, ')');
          console.error('‚ùå –ü–æ–ª–Ω—ã–π response:', JSON.stringify(response, null, 2));
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞: ' + String(errorMsg));
          return;
          
        } catch (error) {
          console.error('‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ invoice:', error);
          console.error('‚ùå –¢–∏–ø –æ—à–∏–±–∫–∏:', typeof error);
          console.error('‚ùå error.message:', error.message);
          console.error('‚ùå error.response:', error.response);
          console.error('‚ùå –ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:', JSON.stringify(error, Object.getOwnPropertyNames(error)));
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ (–±–µ–∑–æ–ø–∞—Å–Ω–æ, –±–µ–∑ eval)
          let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
          
          if (error && typeof error === 'object') {
            if (error.message && typeof error.message === 'string') {
              errorMessage = error.message;
            } else if (error.response && typeof error.response === 'object') {
              // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∏–∑ response
              if (error.response.detail && typeof error.response.detail === 'string') {
                errorMessage = error.response.detail;
              } else if (error.response.message && typeof error.response.message === 'string') {
                errorMessage = error.response.message;
              }
            } else if (error.detail && typeof error.detail === 'string') {
              errorMessage = error.detail;
            }
          }
          
          // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞
          if (!errorMessage.includes('–°—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω') && !errorMessage.includes('—É—Å–ø–µ—à–Ω–æ')) {
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞: ' + String(errorMessage));
          }
        }
        
        // Fallback –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∫–æ–≥–¥–∞ WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
        if (!window.Telegram?.WebApp?.openInvoice) {
          // Fallback: —Å–∏–º—É–ª–∏—Ä—É–µ–º –ø–æ–∫—É–ø–∫—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∫–æ–≥–¥–∞ WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
          if (confirm(`–ö—É–ø–∏—Ç—å "${item.name}" –∑–∞ ${price} ‚≠ê?\n\n(–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º: Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)`)) {
            // –í —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ —Å—Ä–∞–∑—É –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã
            await addPurchasedItem(category, itemId);
            await renderShop();
            await updateThemeSelector();
            alert(`‚úÖ ${item.name} —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω! (–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)`);
          }
        }
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ TON
      async function processTONPayment(category, itemId, item) {
        const currentUserId = window.currentUserId || 0;
        
        // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –≤ TON
        const tonAmount = item.priceTON || 0;
        if (tonAmount <= 0) {
          alert('‚ùå –¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞');
          return;
        }
        
        // –°–æ–∑–¥–∞–µ–º —Å—á–µ—Ç —á–µ—Ä–µ–∑ CryptoBot API
        try {
          const response = await window.fetchJSON('/api/payment/create-invoice', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              amount: tonAmount,
              currency: 'TON',
              description: `–ü–æ–∫—É–ø–∫–∞: ${item.name}`,
              user_id: currentUserId,
              category: category,
              item_id: itemId
            })
          });
          
          if (!response.success || !response.invoice_url) {
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            return;
          }
          
          // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ Telegram WebApp
          if (window.Telegram?.WebApp?.openLink) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Telegram WebApp API –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å—Å—ã–ª–∫–∏
            window.Telegram.WebApp.openLink(response.invoice_url);
          } else {
            // Fallback –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞
            window.open(response.invoice_url, '_blank');
          }
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
          alert(`‚úÖ –°—á–µ—Ç —Å–æ–∑–¥–∞–Ω!\n\nüí≥ –°—É–º–º–∞: ${tonAmount} TON\nüë§ –°—á–µ—Ç –¥–ª—è –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ (ID: ${currentUserId})\n\n–û—Ç–∫—Ä–æ–π—Ç–µ CryptoBot –¥–ª—è –æ–ø–ª–∞—Ç—ã.\n–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Ç–æ–≤–∞—Ä –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.`);
          
          // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã
          const invoiceId = response.invoice_id;
          let checkCount = 0;
          const maxChecks = 60; // –ü—Ä–æ–≤–µ—Ä—è–µ–º 60 —Ä–∞–∑ (5 –º–∏–Ω—É—Ç)
          
          const checkInterval = setInterval(async () => {
            checkCount++;
            
            try {
              const verifyResponse = await window.fetchJSON('/api/payment/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  invoice_id: invoiceId,
                  category: category,
                  itemId: itemId,
                  userId: currentUserId
                })
              });
              
              if (verifyResponse.verified) {
                clearInterval(checkInterval);
                await addPurchasedItem(category, itemId);
                await renderShop();
                await updateThemeSelector();
                alert(`‚úÖ ${item.name} —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω!`);
              } else if (checkCount >= maxChecks) {
                clearInterval(checkInterval);
                alert('‚è± –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ–ø–ª–∞—Ç—ã –∏—Å—Ç–µ–∫–ª–æ. –ï—Å–ª–∏ –≤—ã –æ–ø–ª–∞—Ç–∏–ª–∏, —Ç–æ–≤–∞—Ä –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.');
              }
            } catch (error) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã:', error);
              if (checkCount >= maxChecks) {
                clearInterval(checkInterval);
              }
            }
          }, 5000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
          
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á–µ—Ç–∞:', error);
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ NFT Gifts
      async function processGiftsPayment(category, itemId, item) {
        const currentUserId = window.currentUserId || 0;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–Ω—ã –ª–∏ Gifts –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
        if (item.priceGifts === null || typeof item.priceGifts !== 'number') {
          alert('‚ùå –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ NFT Gifts –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞');
          return;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º ID –∫—Ä–µ–∞—Ç–æ—Ä–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–¥–∞—Ä–∫–∞
        try {
          const response = await window.fetchJSON('/api/payment/get-creator-id');
          const creatorId = response.creator_id || '';
          
          if (!creatorId) {
            alert('‚ùå ID –∫—Ä–µ–∞—Ç–æ—Ä–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.');
            return;
          }

          // –î–ª—è Gifts –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π API Telegram
          // –°–æ–∑–¥–∞–µ–º invoice –¥–ª—è Gifts
          const invoice = {
            title: item.name,
            description: `–ü–æ–∫—É–ø–∫–∞: ${item.name} (NFT –ø–æ–¥–∞—Ä–æ–∫)`,
            payload: JSON.stringify({ category, itemId, userId: currentUserId, paymentMethod: 'gifts', creatorId: creatorId }),
            provider_token: '', // –î–ª—è Gifts
            currency: 'XTR', // Gifts –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ Stars
            prices: [{ label: item.name, amount: item.priceGifts * 100 }], // –í –∫–æ–ø–µ–π–∫–∞—Ö Stars
            max_tip_amount: 0,
            suggested_tip_amounts: [],
            start_parameter: `shop_${category}_${itemId}_gifts`,
            provider_data: JSON.stringify({ category, itemId, paymentMethod: 'gifts', creatorId: creatorId })
          };

          // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–ª–∞—Ç–µ–∂–Ω–æ–µ –æ–∫–Ω–æ Telegram –¥–ª—è Gifts
          if (window.Telegram?.WebApp?.openInvoice) {
            window.Telegram.WebApp.openInvoice(invoice, async (status) => {
              if (status === 'paid') {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–ª–∞—Ç—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                const verified = await verifyPayment(category, itemId, 'gifts', invoice.payload);
                if (verified) {
                  await addPurchasedItem(category, itemId);
                  await renderShop();
                  await updateThemeSelector();
                  alert(`‚úÖ ${item.name} —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω! –ü–æ–¥–∞—Ä–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫—Ä–µ–∞—Ç–æ—Ä—É.`);
                } else {
                  alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –æ–ø–ª–∞—Ç—ã. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.');
                }
              } else if (status === 'failed') {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ');
              }
            });
          } else {
            // Fallback: —Å–∏–º—É–ª–∏—Ä—É–µ–º –ø–æ–∫—É–ø–∫—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∫–æ–≥–¥–∞ WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
            if (confirm(`–ö—É–ø–∏—Ç—å "${item.name}" –∑–∞ ${item.priceGifts} ‚≠ê (NFT Gifts)?\n\n(–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º: Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)`)) {
              // –í —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ —Å—Ä–∞–∑—É –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã
              await addPurchasedItem(category, itemId);
              await renderShop();
              await updateThemeSelector();
              alert(`‚úÖ ${item.name} —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω! (–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)`);
            }
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è ID –∫—Ä–µ–∞—Ç–æ—Ä–∞:', error);
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–ø–ª–∞—Ç—ã');
        }
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
      async function verifyPayment(invoiceId, category, itemId, userId) {
        try {
          const response = await window.fetchJSON('/api/payment/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              invoice_id: invoiceId,
              category: category,
              itemId: itemId,
              userId: userId
            })
          });
          return response.verified === true;
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã:', error);
          return false;
        }
      }

      // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –º–∞–≥–∞–∑–∏–Ω–∞
      async function renderShop() {
        const purchased = await getPurchasedItems();

        // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–µ–º—ã
        const themesContainer = document.getElementById('themes-shop');
        if (themesContainer) {
          themesContainer.innerHTML = await Promise.all(shopItems.themes.map(async item => {
            const isPurchased = await isItemPurchased('themes', item.id);
            return `
              <div class="rounded-lg border ${isPurchased ? 'border-green-400/50 bg-green-900/20' : 'border-violet-400/30 bg-black/30'} p-4">
                <div class="flex items-center gap-4">
                  <div class="text-4xl">${item.icon}</div>
                  <div class="flex-1">
                    <div class="font-semibold text-white mb-1">${item.name}</div>
                    <div class="text-sm text-gray-400 mb-2">${item.description}</div>
                    <div class="text-xs text-violet-400">
                      ${item.priceMonkeyCoins ? `${item.priceMonkeyCoins} Monkey Coins` : ''}
                    </div>
                  </div>
                  <button 
                    onclick="window.purchaseItem('themes', '${item.id}')"
                    class="px-4 py-2 rounded-lg text-sm font-semibold ${isPurchased ? 'bg-green-600/50 text-green-200 cursor-not-allowed' : 'neon-button'}"
                    ${isPurchased ? 'disabled' : ''}
                  >
                    ${isPurchased ? '‚úì –ö—É–ø–ª–µ–Ω–æ' : '–ö—É–ø–∏—Ç—å'}
                  </button>
                </div>
              </div>
            `;
          })).then(results => results.join(''));
        }
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ Monkey Coins
      async function updateCoinsDisplay() {
        try {
          const balanceResponse = await window.fetchJSON(`/api/profile/monkey-coins?tg_id=${currentUserId}`);
          const balance = balanceResponse?.monkey_coins || 0;
          const coinsCountEl = document.getElementById('coins-count');
          if (coinsCountEl) {
            coinsCountEl.textContent = balance;
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞ Monkey Coins:', error);
          const coinsCountEl = document.getElementById('coins-count');
          if (coinsCountEl) {
            coinsCountEl.textContent = '0';
          }
        }
      }
      
      // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ
      window.updateCoinsDisplay = updateCoinsDisplay;

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ —Ç–µ–º —Å –∫—É–ø–ª–µ–Ω–Ω—ã–º–∏ —Ç–µ–º–∞–º–∏
      async function updateThemeSelector() {
        const purchased = await getPurchasedItems();
        const purchasedThemes = purchased.themes || [];

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–Ω–¥–µ—Ä —Ç–µ–º –≤ –º–æ–¥–∞–ª–∫–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–º—ã
        const themesList = document.getElementById('themes-list');
        if (themesList) {
          const currentTheme = localStorage.getItem('selectedTheme') || 'default';
          themesList.innerHTML = '';
          
          // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–º—É "–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é"
          const defaultTheme = themes.default;
          if (defaultTheme) {
            const isActive = 'default' === currentTheme;
            const themeCard = document.createElement('div');
            themeCard.className = `rounded-lg border p-4 cursor-pointer transition-all ${
              isActive 
                ? 'border-violet-400 bg-violet-500/20' 
                : 'border-violet-400/30 bg-black/30 hover:border-violet-400/50 hover:bg-black/40'
            }`;
            themeCard.innerHTML = `
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="text-3xl">${defaultTheme.icon}</div>
                  <div>
                    <div class="font-semibold text-white">${defaultTheme.name}</div>
                    <div class="text-sm text-gray-400">${defaultTheme.description}</div>
                  </div>
                </div>
                ${isActive ? '<div class="text-violet-400 text-xl">‚úì</div>' : ''}
              </div>
            `;
            
            themeCard.addEventListener('click', () => {
              applyTheme('default');
              updateThemeSelector();
              const themeModal = document.getElementById('theme-selector-modal');
              if (themeModal) {
                setTimeout(() => {
                  themeModal.classList.add('hidden');
                  document.body.classList.remove('modal-open');
                }, 300);
              }
            });
            
            themesList.appendChild(themeCard);
          }
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫—É–ø–ª–µ–Ω–Ω—ã–µ —Ç–µ–º—ã
          purchasedThemes.forEach(themeId => {
            const theme = shopItems.themes.find(t => t.id === themeId);
            if (theme) {
              const isActive = themeId === currentTheme;
              const themeCard = document.createElement('div');
              themeCard.className = `rounded-lg border p-4 cursor-pointer transition-all ${
                isActive 
                  ? 'border-violet-400 bg-violet-500/20' 
                  : 'border-violet-400/30 bg-black/30 hover:border-violet-400/50 hover:bg-black/40'
              }`;
              themeCard.innerHTML = `
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="text-3xl">${theme.icon}</div>
                    <div>
                      <div class="font-semibold text-white">${theme.name}</div>
                      <div class="text-sm text-gray-400">${theme.description}</div>
                    </div>
                  </div>
                  ${isActive ? '<div class="text-violet-400 text-xl">‚úì</div>' : ''}
                </div>
              `;
              
              themeCard.addEventListener('click', () => {
                applyTheme(themeId);
                updateThemeSelector();
                const themeModal = document.getElementById('theme-selector-modal');
                if (themeModal) {
                  setTimeout(() => {
                    themeModal.classList.add('hidden');
                    document.body.classList.remove('modal-open');
                  }, 300);
                }
              });
              
              themesList.appendChild(themeCard);
            }
          });
        }
      }

      // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
      window.purchaseItem = purchaseItem;
      window.selectPaymentMethod = selectPaymentMethod;
      window.renderShop = renderShop;
      window.updateThemeSelector = updateThemeSelector;

      // üí∞ –°–∏—Å—Ç–µ–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ Monkey Coins
      let currentTopupMethod = null;

      function openTopupModal() {
        const modal = document.getElementById('topup-coins-modal');
        const nav = document.getElementById('admin-nav');
        if (modal) {
          modal.classList.remove('hidden');
          document.body.classList.add('modal-open');
          // –°–∫—Ä—ã–≤–∞–µ–º –Ω–∏–∂–Ω—é—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é - –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
          if (nav) {
            nav.classList.add('hidden');
            nav.style.display = 'none';
            nav.style.visibility = 'hidden';
            nav.style.opacity = '0';
            nav.style.pointerEvents = 'none';
          }
          currentTopupMethod = null;
          document.getElementById('topup-amount-section').classList.add('hidden');
          document.getElementById('topup-amount-input').value = '';
        }
      }

      function closeTopupModal() {
        const modal = document.getElementById('topup-coins-modal');
        const nav = document.getElementById('admin-nav');
        if (modal) {
          modal.classList.add('hidden');
          document.body.classList.remove('modal-open');
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∏–∂–Ω—é—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é –æ–±—Ä–∞—Ç–Ω–æ
          if (nav) {
            nav.classList.remove('hidden');
            nav.style.display = 'flex';
            nav.style.visibility = 'visible';
            nav.style.opacity = '1';
            nav.style.pointerEvents = 'auto';
          }
          currentTopupMethod = null;
          document.getElementById('topup-amount-section').classList.add('hidden');
          document.getElementById('topup-amount-input').value = '';
        }
      }

      function selectTopupMethod(method) {
        currentTopupMethod = method;
        const amountSection = document.getElementById('topup-amount-section');
        const amountInput = document.getElementById('topup-amount-input');
        const amountLabel = document.getElementById('topup-amount-label');
        const conversionInfo = document.getElementById('topup-conversion-info');
        
        document.querySelectorAll('[id^="topup-method-"]').forEach(el => {
          el.classList.remove('border-violet-400', 'bg-violet-500/20', 'ring-2', 'ring-violet-400');
          el.classList.add('border-violet-400/30', 'bg-black/30');
        });
        
        const selectedMethod = document.getElementById(`topup-method-${method}`);
        if (selectedMethod) {
          selectedMethod.classList.add('border-violet-400', 'bg-violet-500/20', 'ring-2', 'ring-violet-400');
          selectedMethod.classList.remove('border-violet-400/30', 'bg-black/30');
        }
        
        amountSection.classList.remove('hidden');
        amountInput.value = '';
        amountInput.focus();
        
        if (method === 'stars') {
          amountLabel.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥:';
          amountInput.placeholder = '–ù–∞–ø—Ä–∏–º–µ—Ä: 100';
          conversionInfo.textContent = '1 ‚≠ê = 1 Monkey Coin';
        } else if (method === 'cryptobot') {
          amountLabel.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ TON:';
          amountInput.placeholder = '–ù–∞–ø—Ä–∏–º–µ—Ä: 1';
          conversionInfo.textContent = '1 TON = 100 Monkey Coins';
        }
        
        amountInput.oninput = function() {
          const amount = parseFloat(this.value) || 0;
          if (method === 'stars') {
            conversionInfo.textContent = `${amount} ‚≠ê = ${amount} Monkey Coins`;
          } else if (method === 'cryptobot') {
            conversionInfo.textContent = `${amount} TON = ${amount * 100} Monkey Coins`;
          }
        };
      }

      async function processTopupPayment() {
        if (!currentTopupMethod) {
          alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã');
          return;
        }

        const amountInput = document.getElementById('topup-amount-input');
        const amount = parseFloat(amountInput.value) || 0;

        if (amount <= 0) {
          alert('‚ùå –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –±–æ–ª—å—à–µ 0');
          return;
        }

        try {
          if (currentTopupMethod === 'stars') {
            const response = await window.fetchJSON('/api/topup/create-stars-invoice', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                amount: amount,
                user_id: currentUserId
              })
            });

            if (response?.success) {
              closeTopupModal();
              setTimeout(async () => {
                await updateCoinsDisplay();
              }, 5000);
              alert(`‚úÖ –°—á–µ—Ç –Ω–∞ ${amount} ‚≠ê –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –±–æ—Ç–∞!\n\n–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º, —á—Ç–æ–±—ã –æ–ø–ª–∞—Ç–∏—Ç—å. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –±–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.`);
            } else {
              const errorMsg = response?.detail || response?.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞';
              alert(`‚ùå ${errorMsg}`);
            }
          } else if (currentTopupMethod === 'cryptobot') {
            const monkeyCoinsAmount = amount * 100;
            
            const response = await window.fetchJSON('/api/topup/create-invoice', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                amount: amount,
                currency: 'TON',
                user_id: currentUserId,
                monkey_coins: monkeyCoinsAmount
              })
            });

            if (response?.success) {
              closeTopupModal();
              setTimeout(async () => {
                await updateCoinsDisplay();
              }, 5000);
              if (response.invoice_url) {
                window.open(response.invoice_url, '_blank');
                alert(`‚úÖ –°—á–µ—Ç –Ω–∞ ${amount} TON —Å–æ–∑–¥–∞–Ω!\n\n–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –±–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.`);
              } else {
                alert(`‚úÖ –°—á–µ—Ç –Ω–∞ ${amount} TON —Å–æ–∑–¥–∞–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–æ—Ç–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã.`);
              }
            } else {
              const errorMsg = response?.detail || response?.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞';
              alert(`‚ùå ${errorMsg}`);
            }
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞:', error);
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
        }
      }

      (function initTopupHandlers() {
        const addCoinsBtn = document.getElementById('add-coins-btn');
        const closeTopupModalBtn = document.getElementById('close-topup-modal');
        const topupPayBtn = document.getElementById('topup-pay-btn');

        if (addCoinsBtn) {
          addCoinsBtn.addEventListener('click', openTopupModal);
        }

        if (closeTopupModalBtn) {
          closeTopupModalBtn.addEventListener('click', closeTopupModal);
        }

        if (topupPayBtn) {
          topupPayBtn.addEventListener('click', processTopupPayment);
        }

        const topupModal = document.getElementById('topup-coins-modal');
        if (topupModal) {
          topupModal.addEventListener('click', function(e) {
            if (e.target === topupModal) {
              closeTopupModal();
            }
          });
        }
      })();

      window.openTopupModal = openTopupModal;
      window.closeTopupModal = closeTopupModal;
      window.selectTopupMethod = selectTopupMethod;
      window.processTopupPayment = processTopupPayment;

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª–∫–∏ –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
      function initPaymentMethodModal() {
        const modal = document.getElementById('payment-method-modal');
        const closeBtn = document.getElementById('close-payment-modal');
        
        if (closeBtn) {
          closeBtn.addEventListener('click', () => {
            if (modal) {
              modal.classList.add('hidden');
              document.body.classList.remove('modal-open');
            }
            currentPurchaseItem = null;
          });
        }

        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.classList.add('hidden');
              document.body.classList.remove('modal-open');
              currentPurchaseItem = null;
            }
          });
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞–≥–∞–∑–∏–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–µ–∫—Ü–∏–∏
      function initShop() {
        renderShop();
        initPaymentMethodModal();
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          loadTheme();
          setTimeout(initThemeSelector, 100);
          setTimeout(initShop, 200);
        });
      } else {
        loadTheme();
        setTimeout(initThemeSelector, 100);
        setTimeout(initShop, 200);
      }
    })();
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–ø–∏—Å–∫–∞ —Ä–∞–±–æ—Ç –∫–æ–Ω–∫—É—Ä—Å–∞
    window.showContestWorks = async function(contestId) {
      const modal = document.getElementById('contest-works-modal');
      const list = document.getElementById('contest-works-list');
      const currentUserId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || window.currentUserId;
      
      modal.classList.remove('hidden');
      list.innerHTML = '<div class="text-center text-gray-400 py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
      
      try {
        const response = await fetchJSON(`/api/contests/${contestId}/works?current_user_id=${currentUserId}`);
        
        console.log('–û—Ç–≤–µ—Ç API –¥–ª—è —Ä–∞–±–æ—Ç:', response);
        
        if (!response || !response.success) {
          const errorMsg = response?.detail || response?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
          list.innerHTML = `<div class="text-center text-red-400 py-4">–û—à–∏–±–∫–∞: ${errorMsg}</div>`;
          return;
        }
        
        if (!response.works || response.works.length === 0) {
          list.innerHTML = '<div class="text-center text-gray-400 py-4">–†–∞–±–æ—Ç –ø–æ–∫–∞ –Ω–µ—Ç</div>';
          return;
        }
        
        list.innerHTML = response.works.map(work => `
          <div class="flex items-center gap-3 p-3 rounded-lg bg-black/20 border border-violet-400/20">
            <div class="flex-1">
              <div class="font-semibold text-white">–†–∞–±–æ—Ç–∞ #${work.work_number}</div>
              <div class="text-sm text-gray-400">–£—á–∞—Å—Ç–Ω–∏–∫: ${work.username}</div>
              ${work.image_url ? `
                <img src="${work.image_url}" alt="–†–∞–±–æ—Ç–∞ #${work.work_number}" class="mt-2 w-full max-w-[200px] rounded-lg" />
              ` : ''}
            </div>
            <button 
              onclick="openCancelWorkModal(${contestId}, ${work.work_number}, '${work.username.replace(/'/g, "\\'")}')"
              class="bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg"
              title="–ê–Ω–Ω—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É"
            >
              üóëÔ∏è
            </button>
          </div>
        `).join('');
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–±–æ—Ç:', error);
        let errorMsg = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
        if (error.message) {
          errorMsg = error.message;
        } else if (error.detail) {
          errorMsg = error.detail;
        } else if (typeof error === 'string') {
          errorMsg = error;
        }
        list.innerHTML = `<div class="text-center text-red-400 py-4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–±–æ—Ç: ${errorMsg}</div>`;
      }
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è
    window.openCancelWorkModal = function(contestId, workNumber, username) {
      const modal = document.getElementById('cancel-work-modal');
      const reasonSelect = document.getElementById('cancel-reason-select');
      const customReasonDiv = document.getElementById('custom-reason-div');
      const customReasonText = document.getElementById('custom-reason-text');
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏
      window.currentCancelData = { contestId, workNumber, username };
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
      reasonSelect.value = '';
      customReasonDiv.classList.add('hidden');
      customReasonText.value = '';
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω—ã
      reasonSelect.onchange = function() {
        if (this.value === '–î—Ä—É–≥–∞—è –ø—Ä–∏—á–∏–Ω–∞') {
          customReasonDiv.classList.remove('hidden');
        } else {
          customReasonDiv.classList.add('hidden');
        }
      };
      
      modal.classList.remove('hidden');
    };
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    document.getElementById('close-contest-works-modal')?.addEventListener('click', () => {
      document.getElementById('contest-works-modal').classList.add('hidden');
    });
    
    document.getElementById('close-cancel-work-modal')?.addEventListener('click', () => {
      document.getElementById('cancel-work-modal').classList.add('hidden');
    });
    
    document.getElementById('cancel-work-cancel-btn')?.addEventListener('click', () => {
      document.getElementById('cancel-work-modal').classList.add('hidden');
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è
    document.getElementById('cancel-work-confirm-btn')?.addEventListener('click', async () => {
      const reasonSelect = document.getElementById('cancel-reason-select');
      const customReasonText = document.getElementById('custom-reason-text');
      const { contestId, workNumber, username } = window.currentCancelData || {};
      
      if (!contestId || !workNumber) {
        alert('–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –æ —Ä–∞–±–æ—Ç–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
        return;
      }
      
      let reason = reasonSelect.value;
      if (reason === '–î—Ä—É–≥–∞—è –ø—Ä–∏—á–∏–Ω–∞') {
        reason = customReasonText.value.trim();
        if (!reason) {
          alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è');
          return;
        }
      }
      
      if (!reason) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è');
        return;
      }
      
      const currentUserId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || window.currentUserId;
      
      try {
        const response = await fetchJSON(`/api/contests/${contestId}/works/${workNumber}/cancel`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: currentUserId,
            reason: reason
          })
        });
        
        if (response.success) {
          alert(`‚úÖ –†–∞–±–æ—Ç–∞ #${workNumber} –æ—Ç ${username} —É—Å–ø–µ—à–Ω–æ –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∞`);
          document.getElementById('cancel-work-modal').classList.add('hidden');
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç
          await window.showContestWorks(contestId);
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—É—Ä—Å–æ–≤ (–µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞)
          if (typeof loadContests === 'function') {
            await loadContests();
          } else if (typeof window.loadContests === 'function') {
            await window.loadContests();
          }
        } else {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      }
    });
  </script>
</body>
</html>
