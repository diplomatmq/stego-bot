<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://telegram.org https://fonts.googleapis.com https://fonts.gstatic.com https://cdn4.telesco.pe data:; img-src 'self' data: https: http: blob: https://cdn4.telesco.pe; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://telegram.org; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com;">
  <title>üéÅ –ü–∞–Ω–µ–ª—å –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- –®—Ä–∏—Ñ—Ç –¥–ª—è —Ç–µ–º—ã Mario -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <!-- –ì–æ—Ç–∏—á–µ—Å–∫–∏–π —à—Ä–∏—Ñ—Ç –¥–ª—è —Ç–µ–º—ã Attack on Titan -->
  <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Nosifer&family=UnifrakturMaguntia&display=swap" rel="stylesheet">

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    console.log('‚úÖ JavaScript —Ä–∞–±–æ—Ç–∞–µ—Ç! –°–∫—Ä–∏–ø—Ç –≤ head –∑–∞–≥—Ä—É–∂–µ–Ω.');
    console.log('‚úÖ Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω:', typeof window.Telegram !== 'undefined');
    
    document.addEventListener("DOMContentLoaded", () => {
      console.log('‚úÖ DOMContentLoaded –≤ head —Å–∫—Ä–∏–ø—Ç–µ');
      if (window.Telegram?.WebApp) {
        console.log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp');
        Telegram.WebApp.expand();
        Telegram.WebApp.ready();
        console.log('‚úÖ Telegram WebApp –≥–æ—Ç–æ–≤');
        console.log('üì± –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:', Telegram.WebApp.platform);
        console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', Telegram.WebApp.initDataUnsafe?.user);
      } else {
        console.warn('‚ö†Ô∏è Telegram.WebApp –Ω–µ –Ω–∞–π–¥–µ–Ω');
        console.warn('üí° –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –æ–ø–ª–∞—Ç—ã –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –≤ Telegram');
        console.warn('üí° –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç–µ —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º');
      }
    });
  </script>

  <style>
    /* üíß Ripple —ç—Ñ—Ñ–µ–∫—Ç */
    .ripple {
      position: absolute;
      border-radius: 50%;
      transform: scale(0);
      animation: ripple 0.6s linear;
      background: rgba(255, 255, 255, 0.4);
      pointer-events: none;
    }

    @keyframes ripple {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }

    /* üü£ Black + Neon Purple global theme */
    :root {
      --neon-purple-1: #7c3aed; /* violet-600 */
      --neon-purple-2: #8b5cf6; /* violet-500 */
      --neon-purple-3: #a78bfa; /* violet-400 */
      --neon-pink: #ec4899;     /* pink-500 */
      --neon-white: #ffffff;
      --neon-bg: #000000;
      --text-primary: #e5e7eb;
    }

    .page-dark { background-color: var(--neon-bg); color: var(--text-primary); }

    /* –°–∫—Ä—ã—Ç–∏–µ —Å–ø–∏–Ω–Ω–µ—Ä–∞ —É input[type="number"] */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      appearance: none;
      margin: 0;
    }
    
    input[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    @keyframes neonFlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Liquid flow animations */
    @keyframes liquidHorizontal {
      0%   { background-position: 0% center, 100% center, 50% center; }
      50%  { background-position: 100% center, 0% center, 0% center; }
      100% { background-position: 0% center, 100% center, 50% center; }
    }

    /* Text-flow like gradient for side bars */
    @keyframes sideflow {
      from { background-position: center 0%; }
      to { background-position: center 200%; }
    }
    @keyframes sideflowReverse {
      from { background-position: center 200%; }
      to { background-position: center 0%; }
    }

    /* ‚ú® Neon side stripes */
    .neon-sides::before,
    .neon-sides::after {
      content: "";
      position: fixed;
      top: 3vh;
      bottom: 96px;
      width: 4px;
      border-radius: 9999px;
      background: linear-gradient(180deg,
        var(--neon-purple-1) 0%,
        var(--neon-purple-1) 25%,
        var(--neon-pink) 55%,
        var(--neon-white) 85%,
        var(--neon-purple-1) 100%
      );
      background-size: 100% 250%;
      box-shadow:
        0 0 12px rgba(167, 139, 250, 0.6),
        0 0 28px rgba(139, 92, 246, 0.45),
        inset 0 0 16px rgba(167, 139, 250, 0.35);
      z-index: 5;
      pointer-events: none;
    }

    .neon-sides::before { left: 10px; animation: sideflow 5s linear infinite; }
    .neon-sides::after { right: 10px; animation: sideflowReverse 5s linear infinite; }

    /* üîª Bottom neon shimmer bar */
    .neon-bottom {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 86px;
      display: flex;
      align-items: center;
      justify-content: center;
      background:
        radial-gradient(60% 140% at 50% 100%, rgba(139, 92, 246, 0.16), rgba(0, 0, 0, 0) 60%),
        radial-gradient(25% 100% at 0% 100%, rgba(236, 72, 153, 0.18), transparent 70%),
        radial-gradient(25% 100% at 100% 100%, rgba(255, 255, 255, 0.08), transparent 70%);
      z-index: 4;
      pointer-events: none;
    }

    .neon-bottom::before {
      content: "";
      position: absolute;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      width: min(560px, 92vw);
      height: 13px;
      border-radius: 9999px;
      background:
        repeating-linear-gradient(to right,
          rgba(255,255,255,0.85) 0 18px,
          transparent 18px 34px
        ),
        repeating-linear-gradient(to right,
          rgba(236,72,153,0.6) 0 14px,
          transparent 14px 30px
        ),
        repeating-linear-gradient(to right,
          rgba(139,92,246,0.6) 0 16px,
          transparent 16px 32px
        );
      background-blend-mode: screen;
      animation: liquidHorizontal 9s linear infinite;
      box-shadow:
        0 0 22px rgba(167, 139, 250, 0.75),
        0 0 44px rgba(139, 92, 246, 0.65),
        inset 0 0 10px rgba(167, 139, 250, 0.55);
    }

    .neon-bottom::after {
      content: "";
      position: absolute;
      bottom: 24px;
      left: 10px;
      right: 10px;
      height: 18px;
      border-bottom-left-radius: 9999px;
      border-bottom-right-radius: 9999px;
      background: linear-gradient(90deg, transparent, rgba(167,139,250,0.25), rgba(236,72,153,0.25), rgba(255,255,255,0.18), rgba(167,139,250,0.25), transparent);
      filter: blur(8px);
      pointer-events: none;
    }

    /* üß≠ Neon nav */
    .neon-nav {
      background: rgba(10, 10, 16, 0.85) !important;
      backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(167, 139, 250, 0.25);
      box-shadow: 0 0 24px rgba(139, 92, 246, 0.25);
      pointer-events: auto !important;
      z-index: 1000 !important;
    }

    .nav-button {
      color: var(--text-primary);
      padding: 0.35rem 0.5rem;
      border-radius: 0.5rem;
      transition: transform .15s ease, box-shadow .2s ease;
      box-shadow: inset 0 0 0 1px rgba(167, 139, 250, 0.35);
      font-size: 0.875rem;
      cursor: pointer !important;
      pointer-events: auto !important;
      position: relative !important;
      z-index: 1001 !important;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    .nav-button.active,
    .nav-button:hover {
      box-shadow:
        0 0 12px rgba(167, 139, 250, 0.55),
        inset 0 0 0 1px rgba(167, 139, 250, 0.65);
      transform: translateY(-1px);
    }

    /* üîò Neon buttons */
    .neon-button {
      position: relative;
      background: #0b0b0f !important;
      color: #ffffff !important;
      border: 1px solid rgba(167, 139, 250, 0.45) !important;
      box-shadow:
        0 0 16px rgba(139, 92, 246, 0.35),
        inset 0 0 18px rgba(139, 92, 246, 0.2);
      transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
      overflow: hidden;
    }

    .neon-button::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      background: linear-gradient(120deg, transparent 0%, rgba(167, 139, 250, 0.35) 40%, rgba(167, 139, 250, 0.6) 50%, rgba(167, 139, 250, 0.35) 60%, transparent 100%);
      background-size: 300% 100%;
      animation: neonFlow 6s linear infinite;
      z-index: 0;
      pointer-events: none;
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
              mask-composite: exclude;
      padding: 1px;
    }

    .neon-button > * { position: relative; z-index: 1; }

    .neon-button:hover {
      box-shadow:
        0 0 22px rgba(139, 92, 246, 0.55),
        inset 0 0 24px rgba(139, 92, 246, 0.28);
      transform: translateY(-1px);
      border-color: rgba(167, 139, 250, 0.75) !important;
    }

    .neon-button:active { transform: translateY(0); }

    /* Prevent text selection on buttons */
    .neon-button,
    .nav-button,
    button {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      -webkit-touch-callout: none;
    }

    /* ‚ú® Shimmer animation for experience bar */
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .animate-shimmer {
      animation: shimmer 2s infinite;
    }

    /* üéØ Level badge glow */
    #level-badge {
      background: linear-gradient(135deg, 
        #000000 0%, 
        #4c1d95 25%, 
        #7c3aed 50%, 
        #ec4899 75%, 
        #dc2626 100%
      );
      background-size: 200% 200%;
      color: #ffffff;
      border: 1px solid rgba(167, 139, 250, 0.5);
      box-shadow: 
        0 0 15px rgba(124, 58, 237, 0.6),
        0 0 30px rgba(236, 72, 153, 0.4),
        inset 0 0 10px rgba(0, 0, 0, 0.5);
      animation: level-badge-flow 3s ease-in-out infinite, level-badge-pulse 2s ease-in-out infinite;
      text-shadow: 0 0 10px rgba(167, 139, 250, 0.8);
    }

    @keyframes level-badge-flow {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    @keyframes level-badge-pulse {
      0%, 100% {
      box-shadow: 
        0 0 15px rgba(124, 58, 237, 0.6),
        0 0 30px rgba(236, 72, 153, 0.4),
        inset 0 0 10px rgba(0, 0, 0, 0.5);
      }
      50% {
      box-shadow: 
        0 0 25px rgba(124, 58, 237, 0.9),
        0 0 50px rgba(236, 72, 153, 0.7),
        0 0 20px rgba(220, 38, 38, 0.5),
        inset 0 0 15px rgba(0, 0, 0, 0.7);
      }
    }

    /* üìù Inputs */
    .input-field {
      background: #0f0f16 !important;
      border: 1px solid rgba(148, 163, 184, 0.15);
      color: var(--text-primary) !important;
      box-shadow: inset 0 0 0 1px rgba(167, 139, 250, 0.15);
      transition: box-shadow .2s ease, border-color .2s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: rgba(167, 139, 250, 0.55);
      box-shadow:
        0 0 0 3px rgba(167, 139, 250, 0.25),
        inset 0 0 0 1px rgba(167, 139, 250, 0.55);
    }

    /* –°–∫—Ä—ã—Ç–∏–µ —Å–ø–∏–Ω–Ω–µ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
    .loading-spinner.hidden {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      z-index: -9999 !important;
      pointer-events: none !important;
    }

    /* üì± –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
    #contact-owner-modal,
    #subscription-modal {
      /* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª –¥–∞–∂–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ */
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      /* –ó–∞–ø—Ä–µ—â–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
      overflow-x: hidden !important;
      overflow-y: auto !important;
      /* –†–∞–∑—Ä–µ—à–∞–µ–º –∫–ª–∏–∫–∏ –∏ –∂–µ—Å—Ç—ã */
      pointer-events: auto !important;
      touch-action: pan-y pinch-zoom;
      /* –§–∏–∫—Å–∏—Ä—É–µ–º —à–∏—Ä–∏–Ω—É –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ */
      max-width: 100vw;
      width: 100%;
      z-index: 30 !important;
    }
    
    #contact-owner-modal > div,
    #subscription-modal > div {
      /* –ü–æ–∑–≤–æ–ª—è–µ–º —Å–∫—Ä–æ–ª–ª–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏ —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ */
      overscroll-behavior: contain;
      overflow-x: hidden !important;
      overflow-y: auto !important;
      /* –†–∞–∑—Ä–µ—à–∞–µ–º –∫–ª–∏–∫–∏ */
      pointer-events: auto !important;
      touch-action: pan-y pinch-zoom;
      /* –§–∏–∫—Å–∏—Ä—É–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É */
      max-width: 100%;
      width: 100%;
      position: relative;
      z-index: 1;
    }
    
    /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–æ–∫ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã */
    #contact-owner-modal button,
    #contact-owner-modal input,
    #contact-owner-modal textarea,
    #contact-owner-modal select,
    #subscription-modal button,
    #subscription-modal input,
    #subscription-modal textarea {
      pointer-events: auto !important;
      cursor: pointer;
      position: relative;
      z-index: 10;
    }
    
    /* –ó–∞–ø—Ä–µ—Ç zoom –¥–ª—è –≤—Å–µ–≥–æ body –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –º–æ–¥–∞–ª–∫–∞—Ö */
    body.modal-open {
      overflow: hidden;
      overflow-x: hidden !important;
      touch-action: pan-y;
      position: fixed;
      width: 100%;
      height: 100%;
      max-width: 100vw;
    }

    /* üñºÔ∏è Drag and Drop —Å—Ç–∏–ª–∏ –¥–ª—è NFT –∫–æ–ª–ª–µ–∫—Ü–∏–π */
    #collection-grid > div {
      transition: all 0.2s ease;
    }

    #collection-grid > div:hover {
      transform: scale(1.05);
      border-color: rgba(167, 139, 250, 0.6);
      box-shadow: 0 0 15px rgba(124, 58, 237, 0.5);
    }

    #collection-grid > div.dragging {
      opacity: 0.5;
      transform: scale(0.95);
      cursor: grabbing;
    }

    #collection-grid > div.drag-over {
      border-color: rgba(236, 72, 153, 0.8);
      background-color: rgba(236, 72, 153, 0.1);
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(236, 72, 153, 0.7);
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è NFT –≤ —Å–µ—Ç–∫–µ */
    #collection-grid > div img {
      transition: transform 0.3s ease;
    }

    #collection-grid > div:hover img {
      transform: scale(1.1);
    }

    /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ */
    #collection-grid > div[draggable="true"] {
      cursor: grab;
    }

    #collection-grid > div[draggable="true"]:active {
      cursor: grabbing;
    }

    /* –ó–∞–ø—Ä–µ—Ç –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –¥–ª—è NFT */
    #collection-grid > div,
    #collection-grid > div img,
    #collection-grid > div video {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      pointer-events: auto;
    }

    #collection-grid > div img,
    #collection-grid > div video {
      pointer-events: none; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º/–≤–∏–¥–µ–æ –Ω–∞–ø—Ä—è–º—É—é */
      -webkit-user-drag: none;
      -khtml-user-drag: none;
      -moz-user-drag: none;
      -o-user-drag: none;
      user-drag: none;
    }

    /* –ó–∞–ø—Ä–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é */
    #collection-grid {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    /* –ó–∞–ø—Ä–µ—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤ –º–æ–¥–∞–ª–∫–µ –∫–æ–ª–ª–µ–∫—Ü–∏–π */
    #collection-arrange-modal {
      overflow-x: hidden !important;
      overflow-y: auto;
      width: 100%;
      max-width: 100vw;
      position: fixed;
      left: 0;
      right: 0;
    }

    #collection-arrange-modal > div {
      overflow-x: hidden !important;
      overflow-y: auto;
      max-width: 100%;
      width: calc(100% - 2rem);
      box-sizing: border-box;
      margin: 0 auto;
    }

    #collection-grid {
      overflow-x: hidden !important;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
    }

    #collection-grid > div {
      max-width: 100%;
      box-sizing: border-box;
      width: 100%;
      aspect-ratio: 1;
      min-width: 0;
    }

    /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –≤—ã—Ö–æ–¥—è—Ç –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã */
    #collection-grid img,
    #collection-grid video {
      max-width: 100%;
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    /* –ó–∞–ø—Ä–µ—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏ */
    #collection-arrange-modal * {
      max-width: 100%;
      box-sizing: border-box;
    }

    /* üê± Kitty theme - —Ä–æ–∑–æ–≤–∞—è —Ç–µ–º–∞ */
    body.theme-kitty {
      --neon-purple-1: #ff6b9d; /* —Ä–æ–∑–æ–≤—ã–π */
      --neon-purple-2: #ff8cc8; /* —Å–≤–µ—Ç–ª–æ-—Ä–æ–∑–æ–≤—ã–π */
      --neon-purple-3: #ffb3d9; /* –æ—á–µ–Ω—å —Å–≤–µ—Ç–ª–æ-—Ä–æ–∑–æ–≤—ã–π */
      --neon-pink: #ff1493;     /* –≥–ª—É–±–æ–∫–∏–π —Ä–æ–∑–æ–≤—ã–π */
      --neon-white: #ffffff;
      --neon-bg: #fff0f5;       /* –æ—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π —Ä–æ–∑–æ–≤—ã–π —Ñ–æ–Ω (–ø–æ—á—Ç–∏ –±–µ–ª—ã–π) */
      --text-primary: #8b4a6b;  /* —Ç–µ–º–Ω–æ-—Ä–æ–∑–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ */
      --card-bg: #ffe6f2;       /* —Å–≤–µ—Ç–ª—ã–π —Ä–æ–∑–æ–≤—ã–π –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
      --border-color: #ffb3d9;  /* —Å–≤–µ—Ç–ª–æ-—Ä–æ–∑–æ–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ */
    }

    body.theme-kitty.page-dark {
      background-color: var(--neon-bg) !important;
      color: var(--text-primary) !important;
    }

    body.theme-kitty .rounded-lg.border,
    body.theme-kitty .bg-black\/30,
    body.theme-kitty main {
      background-color: var(--card-bg) !important;
      border-color: var(--border-color) !important;
      color: var(--text-primary) !important;
    }

    body.theme-kitty .text-white {
      color: var(--text-primary) !important;
    }

    body.theme-kitty .text-gray-300,
    body.theme-kitty .text-gray-400 {
      color: #b87a9d !important;
    }

    body.theme-kitty .text-gray-500 {
      color: #a06a8a !important;
    }

    body.theme-kitty .nav-button {
      color: var(--text-primary) !important;
      box-shadow: inset 0 0 0 1px rgba(255, 107, 157, 0.4) !important;
    }

    body.theme-kitty .nav-button.active,
    body.theme-kitty .nav-button:hover {
      box-shadow:
        0 0 12px rgba(255, 107, 157, 0.6),
        inset 0 0 0 1px rgba(255, 107, 157, 0.7) !important;
    }

    body.theme-kitty .neon-button {
      background: #ffe6f2 !important;
      color: var(--text-primary) !important;
      border: 1px solid rgba(255, 107, 157, 0.5) !important;
      box-shadow:
        0 0 16px rgba(255, 107, 157, 0.4),
        inset 0 0 18px rgba(255, 140, 200, 0.3) !important;
    }

    body.theme-kitty .neon-button:hover {
      box-shadow:
        0 0 22px rgba(255, 107, 157, 0.6),
        inset 0 0 24px rgba(255, 140, 200, 0.4) !important;
      border-color: rgba(255, 107, 157, 0.8) !important;
    }

    body.theme-kitty .neon-sides::before,
    body.theme-kitty .neon-sides::after {
      background: linear-gradient(180deg,
        #ff6b9d 0%,
        #ff6b9d 25%,
        #ff1493 55%,
        #ffffff 85%,
        #ff8cc8 100%
      );
      box-shadow:
        0 0 12px rgba(255, 140, 200, 0.7),
        0 0 28px rgba(255, 107, 157, 0.5),
        inset 0 0 16px rgba(255, 179, 217, 0.4);
    }

    body.theme-kitty .neon-bottom {
      background:
        radial-gradient(60% 140% at 50% 100%, rgba(255, 107, 157, 0.2), rgba(255, 240, 245, 0) 60%),
        radial-gradient(25% 100% at 0% 100%, rgba(255, 20, 147, 0.22), transparent 70%),
        radial-gradient(25% 100% at 100% 100%, rgba(255, 255, 255, 0.1), transparent 70%);
    }

    body.theme-kitty .neon-bottom::before {
      background:
        repeating-linear-gradient(to right,
          rgba(255,255,255,0.9) 0 18px,
          transparent 18px 34px
        ),
        repeating-linear-gradient(to right,
          rgba(255,20,147,0.7) 0 14px,
          transparent 14px 30px
        ),
        repeating-linear-gradient(to right,
          rgba(255,107,157,0.7) 0 16px,
          transparent 16px 32px
        );
      box-shadow:
        0 0 22px rgba(255, 140, 200, 0.8),
        0 0 44px rgba(255, 107, 157, 0.7),
        inset 0 0 10px rgba(255, 179, 217, 0.6);
    }

    body.theme-kitty .neon-bottom::after {
      background: linear-gradient(90deg, transparent, rgba(255,107,157,0.3), rgba(255,20,147,0.3), rgba(255,255,255,0.22), rgba(255,140,200,0.3), transparent);
    }

    body.theme-kitty #level-badge {
      position: relative;
      background: linear-gradient(135deg,
        #ffe6f2 0%,
        #ff8cc8 25%,
        #ff6b9d 50%,
        #ff1493 75%,
        #ff69b4 100%
      );
      color: #ffffff !important;
      border: 1px solid rgba(255, 107, 157, 0.6) !important;
      box-shadow: 
        0 0 15px rgba(255, 107, 157, 0.7),
        0 0 30px rgba(255, 20, 147, 0.5),
        inset 0 0 10px rgba(255, 255, 255, 0.3) !important;
      overflow: visible !important;
    }

    body.theme-kitty #profile-section .rounded-lg.border.border-violet-400\/30 {
      position: relative;
      overflow: visible !important;
    }

    body.theme-kitty #profile-section h3.flex.items-center.gap-2 {
      position: relative;
      overflow: visible !important;
      z-index: 1;
    }

    body.theme-kitty .text-violet-400 {
      color: #ff6b9d !important;
    }

    body.theme-kitty .text-pink-400 {
      color: #ff1493 !important;
    }

    body.theme-kitty .text-blue-400 {
      color: #ff8cc8 !important;
    }

    body.theme-kitty .text-green-400 {
      color: #4ade80 !important;
    }

    body.theme-kitty .border-violet-400\/30,
    body.theme-kitty .border-violet-400\/20 {
      border-color: rgba(255, 179, 217, 0.5) !important;
    }

    body.theme-kitty .neon-nav {
      background: rgba(255, 230, 242, 0.9) !important;
      border-bottom: 1px solid rgba(255, 179, 217, 0.3) !important;
      box-shadow: 0 0 24px rgba(255, 107, 157, 0.3) !important;
    }

    body.theme-kitty #theme-selector-modal,
    body.theme-kitty #contact-owner-modal,
    body.theme-kitty #subscription-modal {
      background: rgba(255, 240, 245, 0.95) !important;
    }

    body.theme-kitty #theme-selector-modal > div,
    body.theme-kitty #contact-owner-modal > div {
      background: var(--card-bg) !important;
      border-color: var(--border-color) !important;
    }

    body.theme-kitty .input-field {
      background: #ffffff !important;
      border: 1px solid rgba(255, 179, 217, 0.3) !important;
      color: var(--text-primary) !important;
    }

    body.theme-kitty .input-field:focus {
      border-color: rgba(255, 107, 157, 0.7) !important;
      box-shadow:
        0 0 0 3px rgba(255, 107, 157, 0.3),
        inset 0 0 0 1px rgba(255, 107, 157, 0.7) !important;
    }

    body.theme-kitty .bg-gray-800 {
      background-color: rgba(255, 255, 255, 0.5) !important;
    }

    body.theme-kitty #progress-bar-container {
      overflow: visible !important;
    }

    body.theme-kitty #experience-progress-bar {
      background: linear-gradient(to right, #ff6b9d, #ff1493, #ff6b9d) !important;
      position: relative;
    }

    @keyframes kitty-bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes kitty-float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-15px) rotate(5deg); }
    }

    @keyframes kitty-heart {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    /* üçÑ Mario theme - —Ä–µ—Ç—Ä–æ —Å—Ç–∏–ª—å Super Mario Bros */
    body.theme-mario {
      font-family: 'Press Start 2P', cursive, monospace !important;
      --mario-sky: #5C94FC;
      --mario-cloud: #FFFFFF;
      --mario-hill: #00C000;
      --mario-brick: #B85C00;
      --mario-orange: #FF8C00;
      --mario-yellow: #FFD700;
      --mario-brown: #8B4513;
      --mario-blue: #0066FF;
      --mario-green: #00AA00;
      --mario-red: #FF0000;
      --mario-text: #000000;
      --mario-white: #FFFFFF;
    }

    body.theme-mario.page-dark {
      position: relative;
      background: 
        radial-gradient(ellipse 120px 60px at 30% 25%, #FFFFFF 0%, #FFFFFF 70%, rgba(135, 206, 235, 0.2) 70%, transparent 100%),
        radial-gradient(ellipse 120px 60px at 75% 20%, #FFFFFF 0%, #FFFFFF 70%, rgba(135, 206, 235, 0.2) 70%, transparent 100%),
        repeating-linear-gradient(0deg, #B85C00 0px, #B85C00 16px, #8B4513 16px, #8B4513 20px),
        repeating-linear-gradient(90deg, transparent 0px, transparent 31px, rgba(0, 0, 0, 0.4) 31px, rgba(0, 0, 0, 0.4) 32px),
        #87CEEB;
      background-size: 120px 60px, 120px 60px, 32px 32px, 32px 32px, 100% 100%;
      background-position: 30% 25%, 75% 20%, 0 67%, 0 67%, 0 0;
      background-repeat: no-repeat;
      color: var(--mario-text) !important;
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
      min-height: 100vh;
    }

    body.theme-mario.page-dark::after {
      content: '?';
      position: fixed;
      right: 5%;
      bottom: 15%;
      width: 40px;
      height: 40px;
      background: var(--mario-yellow);
      border: 3px solid #000000;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: #000000;
      z-index: 0;
      box-shadow: 
        inset 0 -3px 0 rgba(0, 0, 0, 0.3),
        0 3px 0 rgba(0, 0, 0, 0.2);
      font-family: 'Press Start 2P', cursive, monospace;
      pointer-events: none;
    }

    body.theme-mario main,
    body.theme-mario #profile-section {
      position: relative;
      z-index: 1;
    }

    @keyframes mario-clouds {
      0% { 
        background-position: 30% 25%, 75% 20%, 0 67%, 0 67%, 0 0; 
      }
      100% { 
        background-position: 32% 25%, 77% 20%, 32px 67%, 32px 67%, 0 0; 
      }
    }

    body.theme-mario.page-dark {
      animation: mario-clouds 30s linear infinite;
    }

    body.theme-mario h2 {
      background: rgba(255, 140, 0, 0.85) !important;
      color: var(--mario-white) !important;
      padding: 16px 20px !important;
      border-radius: 12px !important;
      border: 3px solid #CC7000 !important;
      box-shadow: 
        inset 0 -4px 0 rgba(0, 0, 0, 0.3),
        0 4px 0 rgba(0, 0, 0, 0.2) !important;
      text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.5) !important;
      font-size: 0.8rem !important;
      letter-spacing: 1px !important;
      text-align: center !important;
      margin-bottom: 20px !important;
      width: 100% !important;
      backdrop-filter: blur(2px);
    }

    body.theme-mario h3 {
      background: var(--mario-orange) !important;
      color: var(--mario-white) !important;
      padding: 12px 16px !important;
      border-radius: 8px !important;
      border: 3px solid #CC7000 !important;
      box-shadow: 
        inset 0 -4px 0 rgba(0, 0, 0, 0.3),
        0 4px 0 rgba(0, 0, 0, 0.2) !important;
      text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.5) !important;
      font-size: 0.7rem !important;
      letter-spacing: 1px !important;
      text-transform: uppercase !important;
    }

    body.theme-mario #profile-section .rounded-lg.border.border-violet-400\/30:first-of-type {
      background: rgba(255, 215, 0, 0.85) !important;
      border: 3px solid #CCAA00 !important;
      border-radius: 12px !important;
      box-shadow: 
        inset 0 -4px 0 rgba(0, 0, 0, 0.2),
        0 4px 0 rgba(0, 0, 0, 0.15) !important;
      color: var(--mario-text) !important;
      padding: 20px !important;
      backdrop-filter: blur(2px);
    }

    body.theme-mario .rounded-lg.border,
    body.theme-mario .bg-black\/30 {
      background: rgba(255, 215, 0, 0.85) !important;
      border: 3px solid #CCAA00 !important;
      border-radius: 8px !important;
      box-shadow: 
        inset 0 -4px 0 rgba(0, 0, 0, 0.2),
        0 4px 0 rgba(0, 0, 0, 0.15) !important;
      color: var(--mario-text) !important;
      backdrop-filter: blur(2px);
    }

    body.theme-mario main {
      background: transparent !important;
    }

    body.theme-mario #profile-section .rounded-lg.border.border-violet-400\/30:nth-of-type(2) {
      background: 
        repeating-linear-gradient(0deg, rgba(184, 92, 0, 0.9) 0px, rgba(184, 92, 0, 0.9) 8px, rgba(139, 69, 19, 0.9) 8px, rgba(139, 69, 19, 0.9) 16px),
        repeating-linear-gradient(90deg, transparent 0px, transparent 15px, rgba(0, 0, 0, 0.1) 15px, rgba(0, 0, 0, 0.1) 16px),
        rgba(184, 92, 0, 0.85) !important;
      border: 3px solid #8B4513 !important;
      box-shadow: 
        inset 0 -4px 0 rgba(0, 0, 0, 0.3),
        0 4px 0 rgba(0, 0, 0, 0.2) !important;
      background-size: 100% 16px, 16px 100%, 100% 100% !important;
      border-radius: 12px !important;
      padding: 20px !important;
      backdrop-filter: blur(2px);
    }

    body.theme-mario #level-badge {
      background: var(--mario-blue) !important;
      color: var(--mario-white) !important;
      border: 3px solid #0044AA !important;
      border-radius: 8px !important;
      padding: 10px 16px !important;
      box-shadow: 
        inset 0 -3px 0 rgba(0, 0, 0, 0.3),
        0 3px 0 rgba(0, 0, 0, 0.2) !important;
      text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.5) !important;
      font-size: 0.65rem !important;
      display: inline-block !important;
      white-space: nowrap !important;
    }

    body.theme-mario #current-experience {
      background: #8B5CF6 !important;
      color: var(--mario-white) !important;
      border-radius: 50% !important;
      width: 40px !important;
      height: 40px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      border: 2px solid #6D28D9 !important;
      box-shadow: 
        inset 0 -2px 0 rgba(0, 0, 0, 0.3),
        0 2px 0 rgba(0, 0, 0, 0.2) !important;
      font-size: 0.7rem !important;
      text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.5) !important;
    }

    body.theme-mario #profile-section .rounded-lg.border.border-violet-400\/30:nth-of-type(2) .text-gray-400 {
      color: var(--mario-white) !important;
    }

    body.theme-mario #profile-section .text-lg,
    body.theme-mario #profile-section .text-sm,
    body.theme-mario #profile-section .text-gray-400:not(.text-xs) {
      color: var(--mario-text) !important;
    }

    body.theme-mario #profile-username {
      color: var(--mario-text) !important;
      font-weight: bold !important;
    }

    body.theme-mario #profile-id {
      color: var(--mario-blue) !important;
    }

    body.theme-mario #profile-first-login {
      color: var(--mario-blue) !important;
    }

    body.theme-mario #profile-status {
      color: var(--mario-green) !important;
    }

    body.theme-mario .nav-button {
      background: var(--mario-green) !important;
      color: var(--mario-white) !important;
      border: 3px solid #008800 !important;
      box-shadow: 
        inset 0 -3px 0 rgba(0, 0, 0, 0.3),
        0 3px 0 rgba(0, 0, 0, 0.2) !important;
      text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.5) !important;
      font-size: 0.6rem !important;
      transition: transform 0.1s !important;
    }

    body.theme-mario .nav-button:active {
      transform: translateY(2px) !important;
      box-shadow: 
        inset 0 -1px 0 rgba(0, 0, 0, 0.3),
        0 1px 0 rgba(0, 0, 0, 0.2) !important;
    }

    body.theme-mario #contact-owner-btn {
      background: rgba(255, 215, 0, 0.85) !important;
      color: var(--mario-text) !important;
      border: 3px solid #CCAA00 !important;
      border-radius: 12px !important;
      box-shadow: 
        inset 0 -4px 0 rgba(0, 0, 0, 0.3),
        0 4px 0 rgba(0, 0, 0, 0.2) !important;
      text-shadow: 1px 1px 0 rgba(255, 255, 255, 0.5) !important;
      font-size: 0.65rem !important;
      font-weight: bold !important;
      padding: 14px !important;
      margin-top: 20px !important;
      backdrop-filter: blur(2px);
    }

    body.theme-mario #contact-owner-btn:active {
      transform: translateY(2px) !important;
      box-shadow: 
        inset 0 -2px 0 rgba(0, 0, 0, 0.3),
        0 2px 0 rgba(0, 0, 0, 0.2) !important;
    }

    body.theme-mario #change-theme-btn {
      background: rgba(255, 140, 0, 0.85) !important;
      color: var(--mario-white) !important;
      border: 3px solid #CC7000 !important;
      border-radius: 12px !important;
      box-shadow: 
        inset 0 -3px 0 rgba(0, 0, 0, 0.3),
        0 3px 0 rgba(0, 0, 0, 0.2) !important;
      text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.5) !important;
      font-size: 0.65rem !important;
      padding: 14px !important;
      margin-bottom: 12px !important;
      backdrop-filter: blur(2px);
    }

    body.theme-mario .text-white {
      color: var(--mario-white) !important;
    }

    body.theme-mario .text-gray-300,
    body.theme-mario .text-gray-400 {
      color: #333333 !important;
    }

    body.theme-mario .text-violet-400 {
      color: var(--mario-blue) !important;
    }

    body.theme-mario #profile-section .grid.grid-cols-2 > div {
      background: rgba(0, 170, 0, 0.85) !important;
      border: 3px solid #008800 !important;
      border-radius: 12px !important;
      padding: 16px !important;
      box-shadow: 
        inset 0 -4px 0 rgba(0, 0, 0, 0.3),
        0 4px 0 rgba(0, 0, 0, 0.2) !important;
      backdrop-filter: blur(2px);
    }

    body.theme-mario #profile-section .grid.grid-cols-2 .text-2xl {
      color: var(--mario-white) !important;
      text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.5) !important;
    }

    body.theme-mario #profile-section .grid.grid-cols-2 .text-xs {
      color: var(--mario-white) !important;
      text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.5) !important;
    }

    body.theme-mario #contests-won {
      color: #8B5CF6 !important;
    }

    @keyframes mario-jump {
      0%, 100% { transform: translateY(0) scale(1); }
      25% { transform: translateY(-5px) scale(1.05); }
      50% { transform: translateY(-8px) scale(1.1); }
      75% { transform: translateY(-5px) scale(1.05); }
    }

    body.theme-mario button:hover {
      animation: mario-jump 0.3s ease-in-out;
    }

    @keyframes mario-coin {
      0% { transform: rotateY(0deg) scale(1); }
      50% { transform: rotateY(180deg) scale(1.1); }
      100% { transform: rotateY(360deg) scale(1); }
    }

    body.theme-mario .text-violet-400 {
      animation: mario-coin 2s ease-in-out infinite;
    }

    body.theme-mario #contests-participated {
      animation: none !important;
    }

    body.theme-mario * {
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }

    body.theme-mario .w-16.h-16.rounded-full {
      background: var(--mario-blue) !important;
      border: 3px solid #0044AA !important;
      border-radius: 8px !important;
      box-shadow: 
        inset 0 -3px 0 rgba(0, 0, 0, 0.3),
        0 3px 0 rgba(0, 0, 0, 0.2) !important;
      width: 64px !important;
      height: 64px !important;
    }

    body.theme-mario #profile-avatar {
      animation: mario-jump 2s ease-in-out infinite;
      display: inline-block;
      color: var(--mario-white) !important;
      font-size: 1.5rem !important;
    }

    body.theme-mario #progress-bar-container {
      display: block !important;
      background: rgba(0, 0, 0, 0.3) !important;
      border: 3px solid #8B4513 !important;
      border-radius: 8px !important;
    }

    @keyframes mario-progress-flow {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }

    body.theme-mario #experience-progress-bar {
      background: linear-gradient(90deg, #0066FF 0%, #4A90E2 50%, #0066FF 100%) !important;
      background-size: 200% 100% !important;
      animation: mario-progress-flow 2s linear infinite !important;
    }

    /* ‚öîÔ∏è Attack on Titan theme */
    body.theme-aot {
      font-family: 'UnifrakturMaguntia', 'Creepster', serif !important;
      --aot-parchment: #f4e4bc;
      --aot-sepia: #8b6f47;
      --aot-blood: #8b0000;
      --aot-text: #3d2817;
      --aot-border: #5c4a2f;
    }

    body.theme-aot.page-dark {
      background: repeating-linear-gradient(0deg, rgba(139, 111, 71, 0.03) 0px, rgba(139, 111, 71, 0.03) 1px, transparent 1px, transparent 2px),
        repeating-linear-gradient(90deg, rgba(139, 111, 71, 0.03) 0px, rgba(139, 111, 71, 0.03) 1px, transparent 1px, transparent 2px),
        radial-gradient(ellipse at top, #e8d5b7 0%, #d4c4a4 50%, #c9b99b 100%), #f4e4bc;
      background-size: 20px 20px, 20px 20px, 100% 60%, 100% 100%;
      color: var(--aot-text) !important;
    }

    body.theme-aot #aot-titan-image {
      display: block !important;
      position: relative !important;
      width: 100% !important;
      margin-bottom: 20px !important;
    }

    body.theme-aot #aot-titan-image img {
      width: 100% !important;
      height: auto !important;
      max-height: 300px !important;
      object-fit: contain !important;
    }

    @media (max-width: 640px) {
      body.theme-aot #aot-titan-image img { max-height: 200px !important; }
    }

    body.theme-aot .rounded-lg.border,
    body.theme-aot .bg-black\/30 {
      background: repeating-linear-gradient(0deg, rgba(139, 111, 71, 0.05) 0px, rgba(139, 111, 71, 0.05) 1px, transparent 1px, transparent 2px),
        linear-gradient(135deg, #f4e4bc 0%, #e8d5b7 100%) !important;
      border: 2px solid var(--aot-border) !important;
      color: var(--aot-text) !important;
    }

    body.theme-aot #profile-section .rounded-lg.border:first-of-type {
      background: radial-gradient(ellipse 20px 25px at 96% 15%, rgba(139, 0, 0, 0.5) 0%, transparent 70%),
        radial-gradient(ellipse 15px 20px at 98% 35%, rgba(139, 0, 0, 0.45) 0%, transparent 70%),
        radial-gradient(ellipse 12px 18px at 94% 50%, rgba(139, 0, 0, 0.4) 0%, transparent 70%),
        repeating-linear-gradient(0deg, rgba(139, 111, 71, 0.05) 0px, rgba(139, 111, 71, 0.05) 1px, transparent 1px, transparent 2px),
        linear-gradient(135deg, #f4e4bc 0%, #e8d5b7 100%) !important;
    }

    body.theme-aot #profile-section .rounded-lg.border:nth-of-type(2) {
      background: radial-gradient(ellipse 18px 22px at 3% 12%, rgba(139, 0, 0, 0.5) 0%, transparent 70%),
        radial-gradient(ellipse 16px 20px at 97% 18%, rgba(139, 0, 0, 0.5) 0%, transparent 70%),
        repeating-linear-gradient(0deg, rgba(139, 111, 71, 0.05) 0px, rgba(139, 111, 71, 0.05) 1px, transparent 1px, transparent 2px),
        linear-gradient(135deg, #f4e4bc 0%, #e8d5b7 100%) !important;
    }

    body.theme-aot h2 {
      font-family: 'UnifrakturMaguntia', serif !important;
      color: var(--aot-text) !important;
      font-size: 2rem !important;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3) !important;
    }

    body.theme-aot #profile-username {
      font-family: 'UnifrakturMaguntia', serif !important;
      color: var(--aot-text) !important;
    }

    body.theme-aot #profile-id,
    body.theme-aot #profile-first-login,
    body.theme-aot #profile-status,
    body.theme-aot .text-gray-400 {
      color: var(--aot-sepia) !important;
    }

    body.theme-aot #level-badge {
      background: linear-gradient(135deg, #8b6f47 0%, #5c4a2f 100%) !important;
      color: #f4e4bc !important;
      border: 2px solid var(--aot-border) !important;
      font-family: 'UnifrakturMaguntia', serif !important;
    }

    body.theme-aot #progress-bar-container {
      background: rgba(139, 111, 71, 0.3) !important;
      border: 2px solid var(--aot-border) !important;
    }

    body.theme-aot #experience-progress-bar {
      background: linear-gradient(90deg, #8b6f47 0%, #5c4a2f 50%, #8b6f47 100%) !important;
      background-size: 200% 100% !important;
      animation: aot-progress-flow 2s linear infinite !important;
    }

    @keyframes aot-progress-flow {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }

    /* üí∞ –°—Ç–∏–ª–∏ –¥–ª—è –±–ª–æ–∫–∞ –º–æ–Ω–µ—Ç–æ–∫ */
    #coins-header {
      transition: all 0.3s ease;
    }
    
    #add-coins-btn:hover {
      transform: scale(1.1);
    }
    
    body.theme-kitty #coins-header {
      background: rgba(255, 107, 157, 0.9) !important;
      border-color: rgba(255, 20, 147, 0.6);
      box-shadow: 0 0 24px rgba(255, 20, 147, 0.4);
    }
    
    body.theme-kitty #add-coins-btn {
      background: #ff1493;
    }
    
    body.theme-kitty #add-coins-btn:hover {
      background: #ff6b9d;
    }
    
    body.theme-mario #coins-header {
      background: rgba(220, 38, 38, 0.9) !important;
      border-color: rgba(255, 193, 7, 0.6);
      box-shadow: 0 0 24px rgba(255, 193, 7, 0.4);
    }
    
    body.theme-mario #add-coins-btn {
      background: #dc2626;
    }
    
    body.theme-mario #add-coins-btn:hover {
      background: #ef4444;
    }
    
    body.theme-aot #coins-header {
      background: rgba(92, 74, 47, 0.9) !important;
      border-color: rgba(139, 111, 71, 0.6);
      box-shadow: 0 0 24px rgba(139, 111, 71, 0.4);
    }
    
    body.theme-aot #add-coins-btn {
      background: #5c4a2f;
    }
    
    body.theme-aot #add-coins-btn:hover {
      background: #8b6f47;
    }

    body.theme-aot .nav-button,
    body.theme-aot .neon-button {
      background: linear-gradient(135deg, #8b6f47 0%, #5c4a2f 100%) !important;
      color: #f4e4bc !important;
      border: 2px solid var(--aot-border) !important;
      font-family: 'UnifrakturMaguntia', serif !important;
    }

    body.theme-aot .text-white,
    body.theme-aot .text-gray-300,
    body.theme-aot .text-violet-400,
    body.theme-aot .text-pink-400,
    body.theme-aot .text-blue-400,
    body.theme-aot .text-green-400 {
      color: var(--aot-sepia) !important;
    }
  </style>
</head>
<body class="page-dark text-white min-h-screen flex flex-col neon-sides">

  <!-- üí∞ –ë–ª–æ–∫ –º–æ–Ω–µ—Ç–æ–∫ —Å–ø—Ä–∞–≤–∞ —Å–≤–µ—Ä—Ö—É -->
  <div id="coins-header" class="fixed top-2 right-4 z-50 flex items-center gap-2 bg-black/80 backdrop-blur-sm rounded-full px-3 py-2 border border-purple-500/50 shadow-lg shadow-purple-500/30">
    <button id="add-coins-btn" class="w-8 h-8 flex items-center justify-center rounded-full bg-purple-600 hover:bg-purple-500 transition-colors text-white font-bold text-lg leading-none" style="line-height: 1;">+</button>
    <div class="flex items-center gap-1">
      <span id="coins-count" class="text-white font-semibold text-sm">0</span>
      <img src="monkeyscoin.png" alt="Monkey Coin" class="w-10 h-10 object-contain">
    </div>
  </div>

  <!-- üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ -->
  <div id="loading-spinner" class="loading-spinner relative w-full h-screen flex flex-col items-center justify-center" style="background: #000; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; pointer-events: auto;">
    <div class="flex flex-col items-center">
      <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-white mb-4"></div>
      <p class="text-white text-lg font-semibold">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞–Ω–µ–ª–∏...</p>
    </div>
  </div>

  <!-- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Å–∫—Ä—ã—Ç–∏—è —Å–ø–∏–Ω–Ω–µ—Ä–∞ -->
  <script>
    (function() {
      // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä —á–µ—Ä–µ–∑ 100ms –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
      function forceHideSpinner() {
        var spinner = document.getElementById('loading-spinner');
        var nav = document.getElementById('user-nav');
        var main = document.querySelector('main');
        
        if (spinner) {
          spinner.style.display = 'none';
          spinner.style.visibility = 'hidden';
          spinner.style.opacity = '0';
          spinner.style.pointerEvents = 'none'; // –ö–†–ò–¢–ò–ß–ù–û: –æ—Ç–∫–ª—é—á–∞–µ–º pointer events
          spinner.style.zIndex = '-1'; // –£–±–∏—Ä–∞–µ–º –≤—ã—Å–æ–∫–∏–π z-index
          spinner.classList.add('hidden');
        }
        if (nav) {
          nav.style.display = 'flex';
          nav.style.pointerEvents = 'auto'; // –í–∫–ª—é—á–∞–µ–º –∫–ª–∏–∫–∏ –Ω–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏—é
          nav.style.zIndex = '10';
          nav.classList.remove('hidden');
        }
        if (main) {
          main.style.display = 'block';
          main.style.pointerEvents = 'auto'; // –í–∫–ª—é—á–∞–µ–º –∫–ª–∏–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
          main.classList.remove('hidden');
        }
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(forceHideSpinner, 100);
        });
      } else {
        setTimeout(forceHideSpinner, 100);
      }
    })();
  </script>

  <!-- üöÄ –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
  <nav id="user-nav" class="neon-nav fixed left-0 right-0 z-10 flex justify-around items-center px-2 pb-2 pt-3 hidden" style="bottom: 18px;">
    <button class="nav-button active relative" data-section="contests-section">üèÜ –ö–æ–Ω–∫—É—Ä—Å—ã</button>
    <button class="nav-button relative" data-section="rating-section">‚≠ê –†–µ–π—Ç–∏–Ω–≥</button>
    <button class="nav-button relative" data-section="profile-section">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
    <button class="nav-button relative" data-section="shop-section">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
  </nav>

  <!-- üì¶ –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
  <main class="flex-1 p-6 space-y-6 pb-24 hidden">

    <!-- üèÜ –ö–æ–Ω–∫—É—Ä—Å—ã -->
    <section id="contests-section" class="content-section" style="padding-top: 40px;">
      <h2 class="text-xl font-bold mb-4">–ö–æ–Ω–∫—É—Ä—Å—ã</h2>
      
      <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –º–µ–∂–¥—É –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º–∏ -->
      <div class="flex gap-2 mb-4">
        <button id="contests-active-btn" class="nav-button active px-4 py-2 rounded-lg" data-contest-type="active">‚ú® –ê–∫—Ç–∏–≤–Ω—ã–µ</button>
        <button id="contests-completed-btn" class="nav-button px-4 py-2 rounded-lg" data-contest-type="completed">üèÅ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</button>
      </div>
      
      <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞ –¥–ª—è Pro –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
      <button id="user-create-contest-btn" class="neon-button w-full py-3 rounded-lg mb-6 hidden">‚ûï –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω–∫—É—Ä—Å</button>
      
      <div id="contest-list" class="space-y-4 mb-6"></div>
    </section>

    <!-- ‚≠ê –†–µ–π—Ç–∏–Ω–≥ -->
    <section id="rating-section" class="content-section hidden">
      <h2 class="text-xl font-bold mb-4">–†–µ–π—Ç–∏–Ω–≥</h2>
      
      <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –∞–¥–º–∏–Ω–∞–º–∏ -->
      <div class="flex gap-2 mb-4">
        <button id="rating-users-btn" class="nav-button active px-4 py-2 rounded-lg" data-role="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
        <button id="rating-admins-btn" class="nav-button px-4 py-2 rounded-lg" data-role="admin">–ê–¥–º–∏–Ω—ã</button>
      </div>
      
      <!-- –°–ø–∏—Å–æ–∫ —Ä–µ–π—Ç–∏–Ω–≥–∞ -->
      <div id="rating-list" class="space-y-2">
        <div class="text-center text-gray-400 py-8">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</div>
      </div>
    </section>

    <!-- üë§ –ü—Ä–æ—Ñ–∏–ª—å -->
    <section id="profile-section" class="content-section hidden">
      <!-- Attack Titan –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ–º—ã AoT -->
      <div id="aot-titan-image" class="hidden absolute top-0 left-0 right-0 -mt-8 mb-4 z-0 pointer-events-none" style="border: 3px solid #5c4a2f; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); min-height: 200px; max-height: 300px; height: auto;">
        <img src="AoT.jpg" 
             alt="Attack Titan" 
             class="w-full h-auto opacity-95"
             style="filter: sepia(70%) contrast(1.5) brightness(0.75) saturate(0.6) hue-rotate(-10deg); object-fit: contain; display: block; max-height: 300px; width: 100%; height: auto;">
        <div class="absolute inset-0 pointer-events-none" style="background: repeating-linear-gradient(0deg, rgba(139,111,71,0.03) 0px, transparent 1px, transparent 2px), repeating-linear-gradient(90deg, rgba(139,111,71,0.03) 0px, transparent 1px, transparent 2px); mix-blend-mode: overlay;"></div>
      </div>
      <h2 class="text-xl font-bold mb-6">–ü—Ä–æ—Ñ–∏–ª—å</h2>
      
      <div class="rounded-lg border border-violet-400/30 p-6 bg-black/30 space-y-4 mb-6">
        <div class="flex items-center gap-3">
          <div class="w-16 h-16 rounded-full bg-gradient-to-br from-violet-500 to-pink-500 flex items-center justify-center text-2xl font-bold">
            <span id="profile-avatar">üë§</span>
          </div>
          <div>
            <div class="text-lg font-semibold" id="profile-username">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
            <div class="text-sm text-gray-400">ID: <span id="profile-id" class="text-violet-400"></span></div>
          </div>
        </div>
        
        <div class="pt-4 border-t border-violet-400/20 space-y-3">
          <div class="flex justify-between items-center">
            <span class="text-gray-400">–ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥:</span>
            <span id="profile-first-login" class="text-blue-400"></span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-400">–°—Ç–∞—Ç—É—Å:</span>
            <span id="profile-status" class="text-green-400 font-semibold"></span>
          </div>
        </div>
      </div>

      <!-- ‚≠ê Pro –ü–æ–¥–ø–∏—Å–∫–∞ -->
      <div class="rounded-lg border border-violet-400/30 p-6 bg-black/30 space-y-4 mb-6">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold mb-1">‚≠ê Pro –ü–æ–¥–ø–∏—Å–∫–∞</h3>
            <p class="text-sm text-gray-400" id="pro-subscription-status">–ù–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞</p>
          </div>
          <button id="activate-pro-btn" class="neon-button px-4 py-2 rounded-lg">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <div id="pro-subscription-info" class="hidden text-sm text-gray-400 space-y-1">
          <div>–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: <span id="pro-subscription-end" class="text-violet-400"></span></div>
          <div>–°–æ–∑–¥–∞–Ω–æ –∫–æ–Ω–∫—É—Ä—Å–æ–≤: <span id="pro-contests-count" class="text-violet-400">0</span></div>
        </div>
      </div>

      <!-- ‚≠ê –°–∏—Å—Ç–µ–º–∞ —É—Ä–æ–≤–Ω–µ–π –∏ –æ–ø—ã—Ç–∞ -->
      <div class="mb-6">
        <div class="rounded-lg border border-violet-400/30 p-6 bg-black/30 space-y-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold flex items-center gap-2">
              <span id="level-badge" class="px-3 py-1 rounded-full text-sm font-bold">–£—Ä–æ–≤–µ–Ω—å 1</span>
              <span class="text-violet-400">‚≠ê</span>
            </h3>
            <div class="text-right">
              <div class="text-2xl font-bold text-violet-400" id="current-experience">0</div>
              <div class="text-xs text-gray-400">–æ–ø—ã—Ç–∞</div>
            </div>
          </div>
          
          <!-- –ü–æ–ª–æ—Å–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
          <div class="relative">
            <div class="w-full h-6 bg-gray-800 rounded-full overflow-hidden border border-violet-400/20">
              <div id="experience-progress-bar" class="h-full bg-gradient-to-r from-violet-500 via-pink-500 to-violet-500 rounded-full transition-all duration-500 ease-out relative overflow-hidden" style="width: 0%; background-size: 200% 100%; animation: neonFlow 3s linear infinite;">
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent animate-shimmer"></div>
              </div>
            </div>
            <div class="flex justify-between items-center mt-2 text-xs text-gray-400">
              <span id="current-level-exp">0</span>
              <span id="next-level-exp">100</span>
            </div>
          </div>
          
          <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
          <div class="pt-3 border-t border-violet-400/20 grid grid-cols-2 gap-3">
            <div class="text-center p-3 rounded-lg bg-black/40 border border-violet-400/20">
              <div class="text-2xl font-bold text-violet-400" id="contests-participated">0</div>
              <div class="text-xs text-gray-400 mt-1">–£—á–∞—Å—Ç–∏–π</div>
            </div>
            <div class="text-center p-3 rounded-lg bg-black/40 border border-violet-400/20">
              <div class="text-2xl font-bold text-pink-400" id="contests-won">0</div>
              <div class="text-xs text-gray-400 mt-1">–ü–æ–±–µ–¥</div>
            </div>
          </div>
        </div>
      </div>

      <!-- üé® –°–º–µ–Ω–∞ —Ç–µ–º—ã -->
      <button id="change-theme-btn" class="neon-button w-full py-3 rounded-lg mb-3 relative">
        <span class="kitty-btn-icon">üé®</span> –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É
      </button>

      <!-- üì® –°–≤—è–∑—å —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º -->
      <button id="contact-owner-btn" class="neon-button w-full py-3 rounded-lg">
        üì® –°–≤—è–∑—å —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º
      </button>
    </section>

    <!-- üõí –ú–∞–≥–∞–∑–∏–Ω -->
    <section id="shop-section" class="content-section hidden">
      <h2 class="text-xl font-bold mb-6">üõí –ú–∞–≥–∞–∑–∏–Ω</h2>
      
      <div class="space-y-4">
        <div class="rounded-lg border border-violet-400/30 p-6 bg-black/30">
          <h3 class="text-lg font-semibold mb-4">üé® –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–º—ã</h3>
          <div id="themes-shop" class="grid grid-cols-1 gap-3">
            <!-- –¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
          </div>
        </div>
      </div>
    </section>
    
    <!-- ‚≠ê –ú–æ–¥–∞–ª–∫–∞: –ê–∫—Ç–∏–≤–∞—Ü–∏—è Pro –ø–æ–¥–ø–∏—Å–∫–∏ -->
    <div id="pro-subscription-modal" class="hidden fixed inset-0 z-30 flex items-center justify-center bg-black/70 backdrop-blur-sm">
      <div class="relative w-full sm:w-[450px] bg-[#0b0b10] rounded-2xl border border-violet-500/30 shadow-2xl p-4 mx-4">
        <button id="close-pro-modal" class="absolute -top-3 -right-3 bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        <h3 class="text-base font-semibold mb-3">‚≠ê –ê–∫—Ç–∏–≤–∞—Ü–∏—è Pro –ø–æ–¥–ø–∏—Å–∫–∏</h3>
        
        <div class="mb-4 p-3 rounded-lg bg-violet-500/10 border border-violet-400/30">
          <p class="text-sm text-gray-300 mb-2">–î–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ Pro –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:</p>
          <ul class="text-sm text-gray-400 space-y-1 list-disc list-inside">
            <li>–ë–∞–ª–∞–Ω—Å –º–∏–Ω–∏–º—É–º 50 Monkey Coins</li>
            <li>–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞—à –∫–∞–Ω–∞–ª (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</li>
            <li>–°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</li>
          </ul>
        </div>
        
        <div class="space-y-3">
          <div>
            <label class="block text-sm text-gray-400 mb-1">üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª *</label>
            <input type="text" id="pro-channel-link" class="input-field w-full p-2 rounded" placeholder="https://t.me/your_channel" />
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">üí¨ –°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <input type="text" id="pro-chat-link" class="input-field w-full p-2 rounded" placeholder="https://t.me/your_chat" />
          </div>
        </div>
        
        <button id="confirm-pro-activation" class="neon-button w-full mt-4 py-3 rounded-lg">‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
      </div>
    </div>

    <!-- üéØ –ú–æ–¥–∞–ª–∫–∞: –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∫–æ–Ω–∫—É—Ä—Å–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div id="user-contest-type-selection-modal" class="hidden fixed inset-0 z-25 flex items-end sm:items-center justify-center bg-black/60 p-4" style="pointer-events: auto;">
      <div class="relative w-full max-w-[520px] max-h-[90vh] sm:max-h-[85vh] bg-[#0b0b10] rounded-t-2xl sm:rounded-2xl border border-violet-500/30 shadow-2xl p-5 my-auto" style="pointer-events: auto;">
        <button id="close-user-contest-type-selection-modal" class="absolute -top-3 -right-3 bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button z-10" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        <h3 class="text-lg font-semibold mb-4 sticky top-0 bg-[#0b0b10] pb-2 z-0">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–æ–Ω–∫—É—Ä—Å–∞</h3>
        <div id="user-contest-type-selection-balance" class="mb-4 p-3 rounded-lg bg-violet-500/10 border border-violet-400/30 hidden">
          <div class="flex items-center justify-between">
            <span class="text-sm text-gray-400">–í–∞—à –±–∞–ª–∞–Ω—Å:</span>
            <span id="user-contest-type-selection-balance-value" class="text-lg font-semibold text-violet-400">0</span>
          </div>
        </div>
        <div class="space-y-3" style="pointer-events: auto;">
          <button id="user-select-random-comment-contest" class="w-full neon-button py-4 rounded-lg text-left px-4 flex items-center justify-between relative">
            <div class="flex-1">
              <div class="font-semibold text-lg flex items-center gap-2">
                üé≤ –†–∞–Ω–¥–æ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π(10<img src="monkeyscoin.png" alt="Monkey Coin" class="w-4 h-4 object-contain">)
              </div>
              <div class="text-sm text-gray-400 mt-1">–ö–æ–Ω–∫—É—Ä—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–∑ –ø–æ—Å—Ç–∞</div>
            </div>
            <span class="text-2xl">‚Üí</span>
          </button>
          <button id="user-select-drawing-contest" class="w-full neon-button py-4 rounded-lg text-left px-4 flex items-center justify-between relative">
            <div class="flex-1">
              <div class="font-semibold text-lg flex items-center gap-2">
                üé® –ö–æ–Ω–∫—É—Ä—Å —Ä–∏—Å—É–Ω–∫–æ–≤(20<img src="monkeyscoin.png" alt="Monkey Coin" class="w-4 h-4 object-contain">)
              </div>
              <div class="text-sm text-gray-400 mt-1">–ö–æ–Ω–∫—É—Ä—Å –Ω–∞ –ª—É—á—à–∏–π —Ä–∏—Å—É–Ω–æ–∫ –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ</div>
            </div>
            <span class="text-2xl">‚Üí</span>
          </button>
          <button id="user-select-collection-contest" class="w-full neon-button py-4 rounded-lg text-left px-4 flex items-center justify-between relative">
            <div class="flex-1">
              <div class="font-semibold text-lg flex items-center gap-2">
                üñºÔ∏è –ö–æ–Ω–∫—É—Ä—Å –∫–æ–ª–ª–µ–∫—Ü–∏–π(15<img src="monkeyscoin.png" alt="Monkey Coin" class="w-4 h-4 object-contain">)
              </div>
              <div class="text-sm text-gray-400 mt-1">–ö–æ–Ω–∫—É—Ä—Å –Ω–∞ –ª—É—á—à—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é NFT (9 —à—Ç—É–∫)</div>
            </div>
            <span class="text-2xl">‚Üí</span>
          </button>
        </div>
      </div>
    </div>

    <!-- üé® –ú–æ–¥–∞–ª–∫–∞: –í—ã–±–æ—Ä —Ç–µ–º—ã -->
    <div id="theme-selector-modal" class="hidden fixed inset-0 z-30 flex items-center justify-center bg-black/70 backdrop-blur-sm">
      <div class="relative w-full sm:w-[500px] bg-[#0b0b10] rounded-2xl border border-violet-500/30 shadow-2xl p-6 mx-4 max-h-[90vh] overflow-y-auto">
        <button id="close-theme-modal" class="absolute top-4 right-4 bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button z-10" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        <h3 class="text-lg font-semibold mb-4">üé® –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É</h3>
        <div id="themes-list" class="space-y-3">
          <!-- –¢–µ–º—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
      </div>
    </div>

    <!-- üí≥ –ú–æ–¥–∞–ª–∫–∞: –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã -->
    <div id="payment-method-modal" class="hidden fixed inset-0 z-30 flex items-center justify-center bg-black/70 backdrop-blur-sm">
      <div class="relative w-full sm:w-[500px] bg-[#0b0b10] rounded-2xl border border-violet-500/30 shadow-2xl p-6 mx-4">
        <button id="close-payment-modal" class="absolute -top-3 -right-3 bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        <h3 class="text-lg font-semibold mb-4">üí≥ –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h3>
        <div id="payment-methods-list" class="space-y-3">
          <!-- –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
      </div>
    </div>

    <!-- üí∞ –ú–æ–¥–∞–ª–∫–∞: –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ Monkey Coins -->
    <div id="topup-coins-modal" class="hidden fixed inset-0 z-30 flex items-center justify-center bg-black/70 backdrop-blur-sm">
      <div class="relative w-full sm:w-[450px] bg-[#0b0b10] rounded-2xl border border-violet-500/30 shadow-2xl p-4 mx-4">
        <button id="close-topup-modal" class="absolute -top-3 -right-3 bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        <h3 class="text-base font-semibold mb-3">üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</h3>
        
        <!-- –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã - –≤ —Ä—è–¥ -->
        <div id="topup-payment-methods" class="grid grid-cols-2 gap-2 mb-3">
          <!-- NFT (Soon) -->
          <div class="rounded-lg border border-gray-600/30 bg-black/20 cursor-not-allowed opacity-60 p-3 text-center">
            <div class="text-2xl mb-1">üéÅ</div>
            <div class="font-semibold text-gray-500 text-xs">NFT</div>
            <div class="text-xs text-gray-500">–°–∫–æ—Ä–æ</div>
          </div>
          
          <!-- TON (Soon) -->
          <div class="rounded-lg border border-gray-600/30 bg-black/20 cursor-not-allowed opacity-60 p-3 text-center">
            <div class="text-2xl mb-1">üíé</div>
            <div class="font-semibold text-gray-500 text-xs">TON</div>
            <div class="text-xs text-gray-500">–°–∫–æ—Ä–æ</div>
          </div>
          
          <!-- CryptoBot (TON) -->
          <div id="topup-method-cryptobot" class="rounded-lg border border-violet-400/30 bg-black/30 cursor-pointer hover:border-violet-400/50 hover:bg-black/40 p-3 text-center transition-all" onclick="window.selectTopupMethod('cryptobot')">
            <div class="text-2xl mb-1">ü§ñ</div>
            <div class="font-semibold text-white text-xs">CryptoBot</div>
            <div class="text-xs text-gray-400">1 TON = 100</div>
          </div>
          
          <!-- Telegram Stars -->
          <div id="topup-method-stars" class="rounded-lg border border-violet-400/30 bg-black/30 cursor-pointer hover:border-violet-400/50 hover:bg-black/40 p-3 text-center transition-all" onclick="window.selectTopupMethod('stars')">
            <div class="text-2xl mb-1">‚≠ê</div>
            <div class="font-semibold text-white text-xs">‚≠ê</div>
            <div class="text-xs text-gray-400">1 ‚≠ê = 1</div>
          </div>
        </div>
        
        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å—É–º–º—ã (—Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div id="topup-amount-section" class="hidden space-y-3">
          <div>
            <label id="topup-amount-label" class="block text-xs text-gray-400 mb-1">–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É:</label>
            <input 
              type="number" 
              id="topup-amount-input" 
              min="1" 
              step="1" 
              class="input-field w-full p-2 rounded bg-black/50 border border-violet-400/30 text-white focus:border-violet-400 focus:outline-none text-sm" 
              placeholder="0"
              style="-moz-appearance: textfield; appearance: textfield;"
            />
            <div id="topup-conversion-info" class="text-xs text-violet-400 mt-1"></div>
          </div>
          <button id="topup-pay-btn" class="neon-button w-full py-2 rounded-lg font-semibold text-sm">
            üí≥ –û–ø–ª–∞—Ç–∏—Ç—å
          </button>
        </div>
      </div>
    </div>

    <!-- üì® –ú–æ–¥–∞–ª–∫–∞: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É -->
    <div id="contact-owner-modal" class="hidden fixed inset-0 z-30 flex items-center justify-center bg-black/70 backdrop-blur-sm">
      <div class="relative w-full sm:w-[500px] bg-[#0b0b10] rounded-2xl border border-violet-500/30 shadow-2xl p-6 mx-4">
        <button id="close-contact-modal" class="absolute -top-3 -right-3 bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        <h3 class="text-lg font-semibold mb-4">üì® –°–≤—è–∑—å —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-gray-400 mb-2">–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</label>
            <textarea id="contact-message-text" class="input-field w-full p-3 rounded" rows="6" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
          </div>
          <button id="send-contact-message" class="neon-button w-full py-3 rounded-lg">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>

  </main>

  <!-- üü£ Bottom neon shimmer backdrop for buttons -->
  <div class="neon-bottom"></div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª—ã/—á–∞—Ç—ã -->
  <div id="subscription-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
    <div id="subscription-modal-content" class="bg-gradient-to-br from-gray-900 via-purple-900/30 to-gray-900 rounded-xl border-2 border-violet-400/40 p-6 max-w-md w-full max-h-[90vh] overflow-y-auto shadow-2xl">
      <div class="text-center mb-4">
        <h2 class="text-2xl font-bold text-white mb-2">‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞</h2>
        <p class="text-gray-300 text-sm">–î–ª—è —É—á–∞—Å—Ç–∏—è –≤ –∫–æ–Ω–∫—É—Ä—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ –∫–∞–Ω–∞–ª—ã –∏ —á–∞—Ç—ã:</p>
      </div>
      <div id="subscription-list" class="space-y-3 mb-4"></div>
      <div class="flex flex-col gap-2">
        <button id="verify-subscription-btn" class="neon-button px-6 py-3 rounded-lg font-semibold text-white w-full">
          ‚úì –í—ã–ø–æ–ª–Ω–∏–ª
        </button>
        <button id="close-subscription-modal" class="px-6 py-2 rounded-lg font-semibold text-gray-300 bg-gray-800 hover:bg-gray-700 w-full">
          –û—Ç–º–µ–Ω–∞
        </button>
      </div>
    </div>
  </div>

  <!-- üèÜ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏—Ç–æ–≥–æ–≤ –∫–æ–Ω–∫—É—Ä—Å–∞ —Ä–∏—Å—É–Ω–∫–æ–≤ -->
  <div id="drawing-results-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="relative w-full max-w-2xl bg-gradient-to-br from-gray-900 via-purple-900/20 to-gray-900 border border-violet-400/40 rounded-2xl shadow-2xl p-6 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-white">üèÜ –ò—Ç–æ–≥–∏ –∫–æ–Ω–∫—É—Ä—Å–∞</h2>
        <button onclick="document.getElementById('drawing-results-modal').classList.add('hidden')" class="bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button flex items-center justify-center" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      <div id="drawing-results-tabs" class="mb-4"></div>
      <div id="drawing-results-content" class="space-y-4">
        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
    </div>
  </div>

  <!-- üó≥Ô∏è –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –∑–∞ —Ä–∞–±–æ—Ç—ã -->
  <div id="voting-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="relative w-full max-w-xl bg-gradient-to-br from-gray-900 via-purple-900/20 to-gray-900 border border-violet-400/40 rounded-2xl shadow-2xl p-6">
      <button id="voting-modal-close" class="absolute -top-3 -right-3 bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      <div id="voting-modal-progress" class="text-sm text-gray-300 text-center mb-3"></div>
      <div class="w-full rounded-xl overflow-hidden bg-black/40 mb-4 flex items-center justify-center min-h-[260px]">
        <img id="voting-modal-image" src="" alt="–†–∞–±–æ—Ç–∞ –∫–æ–Ω–∫—É—Ä—Å–∞" class="max-h-[360px] object-contain w-full transition-opacity duration-300 hidden" />
        <div id="voting-modal-loader" class="text-gray-400 text-sm">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
      <div id="voting-modal-info" class="text-sm text-gray-400 text-center mb-4"></div>
      <div class="flex justify-center gap-2 flex-wrap">
        <button class="voting-score-btn neon-button px-4 py-2 rounded-lg text-sm font-semibold bg-violet-500/40 border border-violet-500/20" data-score="1">1</button>
        <button class="voting-score-btn neon-button px-4 py-2 rounded-lg text-sm font-semibold bg-violet-500/40 border border-violet-500/20" data-score="2">2</button>
        <button class="voting-score-btn neon-button px-4 py-2 rounded-lg text-sm font-semibold bg-violet-500/40 border border-violet-500/20" data-score="3">3</button>
        <button class="voting-score-btn neon-button px-4 py-2 rounded-lg text-sm font-semibold bg-violet-500/40 border border-violet-500/20" data-score="4">4</button>
        <button class="voting-score-btn neon-button px-4 py-2 rounded-lg text-sm font-semibold bg-violet-500/40 border border-violet-500/20" data-score="5">5</button>
      </div>
    </div>
  </div>

  <!-- üñºÔ∏è –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ —Å—Å—ã–ª–æ–∫ –Ω–∞ NFT (—à–∞–≥ 1) -->
  <div id="collection-links-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="relative w-full max-w-2xl bg-gradient-to-br from-gray-900 via-purple-900/20 to-gray-900 border border-violet-400/40 rounded-2xl shadow-2xl p-6 max-h-[90vh] overflow-y-auto">
      <button id="collection-links-modal-close" class="absolute -top-3 -right-3 bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button flex items-center justify-center" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      <h2 class="text-2xl font-bold text-white mb-4">üñºÔ∏è –í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ NFT</h2>
      <p class="text-gray-300 text-sm mb-4">–í–≤–µ–¥–∏—Ç–µ 9 —Å—Å—ã–ª–æ–∫ –Ω–∞ NFT –≤ —Ñ–æ—Ä–º–∞—Ç–µ <code class="bg-black/40 px-2 py-1 rounded">t.me/nft/–Ω–∞–∑–≤–∞–Ω–∏–µ-–Ω–æ–º–µ—Ä</code></p>
      
      <div id="collection-links-inputs" class="space-y-3 mb-4">
        <!-- –ü–æ–ª—è –≤–≤–æ–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
      
      <div class="flex items-center justify-between mb-4">
        <div id="collection-links-count" class="text-sm text-gray-400">
          –í–≤–µ–¥–µ–Ω–æ: <span id="collection-links-entered">0</span> / 9
        </div>
        <div id="collection-links-error" class="text-sm text-red-400 hidden"></div>
      </div>
      
      <div class="flex gap-3">
        <button id="collection-links-continue" class="neon-button px-6 py-3 rounded-lg font-semibold text-white flex-1 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        </button>
        <button id="collection-links-cancel" class="px-6 py-3 rounded-lg font-semibold text-gray-300 bg-gray-800 hover:bg-gray-700">
          –û—Ç–º–µ–Ω–∞
        </button>
      </div>
    </div>
  </div>

  <!-- üñºÔ∏è –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏ NFT (—à–∞–≥ 2) -->
  <div id="collection-arrange-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4" style="overflow-x: hidden !important; overflow-y: auto; left: 0; right: 0; width: 100vw; max-width: 100vw; box-sizing: border-box; position: fixed;">
    <div class="relative w-full max-w-4xl bg-gradient-to-br from-gray-900 via-purple-900/20 to-gray-900 border border-violet-400/40 rounded-2xl shadow-2xl p-6 max-h-[90vh] overflow-y-auto" style="overflow-x: hidden !important; max-width: calc(100% - 2rem); width: calc(100% - 2rem); box-sizing: border-box; margin: 0 auto; position: relative;">
      <button id="collection-arrange-modal-close" class="absolute -top-3 -right-3 bg-black text-white border border-violet-400/50 rounded-full w-9 h-9 neon-button flex items-center justify-center" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      <h2 class="text-2xl font-bold text-white mb-4" style="word-wrap: break-word; overflow-wrap: break-word; max-width: 100%; box-sizing: border-box; overflow-x: hidden;">üñºÔ∏è –†–∞—Å—Å—Ç–∞–≤—å—Ç–µ NFT –≤ –Ω—É–∂–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ</h2>
      <p class="text-gray-300 text-sm mb-4" style="word-wrap: break-word; overflow-wrap: break-word; max-width: 100%; box-sizing: border-box; overflow-x: hidden;">–ó–∞–∂–º–∏—Ç–µ –∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ NFT –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—Ö —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è</p>
      
      <div id="collection-grid" class="grid grid-cols-3 gap-3 mb-6 w-full" oncontextmenu="return false;" style="-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none; overflow-x: hidden !important; width: 100%; max-width: 100%; box-sizing: border-box; min-width: 0;">
        <!-- –°–µ—Ç–∫–∞ 3x3 –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
      
      <div class="flex gap-3" style="max-width: 100%; box-sizing: border-box; width: 100%; overflow-x: hidden;">
        <button id="collection-arrange-submit" class="neon-button px-6 py-3 rounded-lg font-semibold text-white flex-1" style="min-width: 0; max-width: 100%; box-sizing: border-box;">
          –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é
        </button>
        <button id="collection-arrange-back" class="px-6 py-3 rounded-lg font-semibold text-gray-300 bg-gray-800 hover:bg-gray-700" style="min-width: 0; max-width: 100%; box-sizing: border-box;">
          –ù–∞–∑–∞–¥
        </button>
      </div>
    </div>
  </div>

  <!-- üß† –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ UI/–∑–∞–≥—Ä—É–∑–∫–∞ -->
  <script>
    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞
    console.log('üöÄ ========== –°–ö–†–ò–ü–¢ USER.HTML –ó–ê–ì–†–£–ñ–ï–ù ==========');
    console.log('üöÄ –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏:', new Date().toISOString());
    console.log('üöÄ URL:', window.location.href);
    console.log('üöÄ User Agent:', navigator.userAgent);
    
    (function() {
      console.log('üöÄ IIFE —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞');
      let currentUserId = null;
      window.currentUserId = null; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
      let spinner, topNav, main, contentSections, navButtons;
      
      // –°–ù–ê–ß–ê–õ–ê –û–ü–†–ï–î–ï–õ–Ø–ï–ú –í–°–ï –§–£–ù–ö–¶–ò–ò, –ü–û–¢–û–ú –í–´–ó–´–í–ê–ï–ú initUserPage
      
      // Utilities
      function toMoscowDateTime(value) {
        if (!value) return '';
        const d = (value instanceof Date) ? value : new Date(value);
        if (Number.isNaN(d.getTime())) return '';
        return new Intl.DateTimeFormat('ru-RU', {
          timeZone: 'Europe/Moscow',
          year: 'numeric', month: '2-digit', day: '2-digit',
          hour: '2-digit', minute: '2-digit'
        }).format(d);
      }

      // –î–µ–ª–∞–µ–º fetchJSON –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ –°–†–ê–ó–£
      window.fetchJSON = async function(url, options) {
        const res = await fetch(url, options);
        if (!res.ok) {
          const error = new Error(`HTTP error! status: ${res.status}`);
          error.response = res;
          throw error;
        }
        
        // –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç
        const jsonData = await res.json();
        console.log('üìã fetchJSON: –û—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω:', jsonData);
        return jsonData;
      };

      // Extract channel username from post link
      function extractChannelFromPostLink(postLink) {
        if (!postLink) return null;
        const match = postLink.match(/(?:t\.me|telegram\.me)\/([a-zA-Z0-9_]+)\/(\d+)/);
        return match ? match[1] : null;
      }

      // Contests - –¥–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –°–†–ê–ó–£
      let contestList;
      
      function initContestList() {
        if (!contestList) {
          contestList = document.getElementById('contest-list');
        }
        return contestList;
      }

      const votingState = {
        contestId: null,
        works: [],
        currentIndex: 0
      };
      let votingModal;
      let votingModalImage;
      let votingModalProgress;
      let votingModalLoader;
      let votingModalInfo;
      let votingModalCloseBtn;
      let votingScoreButtons = [];

      function resetVotingState() {
        votingState.contestId = null;
        votingState.works = [];
        votingState.currentIndex = 0;
      }

      function closeVotingModal() {
        if (votingModal) {
          votingModal.classList.add('hidden');
        }
        resetVotingState();
      }

      function initVotingModalElements() {
        if (votingModal) {
          return;
        }

        votingModal = document.getElementById('voting-modal');
        votingModalImage = document.getElementById('voting-modal-image');
        votingModalProgress = document.getElementById('voting-modal-progress');
        votingModalLoader = document.getElementById('voting-modal-loader');
        votingModalInfo = document.getElementById('voting-modal-info');
        votingModalCloseBtn = document.getElementById('voting-modal-close');
        votingScoreButtons = Array.from(document.querySelectorAll('.voting-score-btn'));

        if (votingModalCloseBtn) {
          votingModalCloseBtn.addEventListener('click', closeVotingModal);
        }

        if (votingModal) {
          votingModal.addEventListener('click', (event) => {
            if (event.target === votingModal) {
              closeVotingModal();
            }
          });
        }

        votingScoreButtons.forEach((btn) => {
          btn.addEventListener('click', async () => {
            const score = parseInt(btn.dataset.score, 10);
            if (!Number.isNaN(score)) {
              await handleVoteClick(score);
            }
          });
        });
      }

      function showVotingLoader(show) {
        initVotingModalElements();
        if (votingModalLoader) {
          votingModalLoader.classList.toggle('hidden', !show);
        }
        if (votingModalImage && show) {
          votingModalImage.classList.add('hidden');
        }
        votingScoreButtons.forEach((btn) => {
          btn.disabled = show;
        });
      }

      function renderVotingWork() {
        initVotingModalElements();
        if (!votingState.works.length) {
          if (votingModalInfo) {
            votingModalInfo.textContent = '–ù–µ—Ç —Ä–∞–±–æ—Ç –¥–ª—è –æ—Ü–µ–Ω–∫–∏';
          }
          votingScoreButtons.forEach((btn) => {
            btn.disabled = true;
          });
          if (votingModalImage) {
            votingModalImage.src = '';
            votingModalImage.classList.add('hidden');
          }
          return;
        }

        const work = votingState.works[votingState.currentIndex];
        if (!work) {
          goToNextWork();
          return;
        }

        if (votingModalProgress) {
          votingModalProgress.textContent = `–†–∞–±–æ—Ç–∞ ${votingState.currentIndex + 1} –∏–∑ ${votingState.works.length}`;
        }
        if (votingModalInfo) {
          votingModalInfo.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É –æ—Ç 1 –¥–æ 5';
        }

        if (votingModalImage) {
          votingModalImage.classList.add('hidden');
          votingModalImage.onload = () => votingModalImage.classList.remove('hidden');
          votingModalImage.onerror = () => {
            if (votingModalInfo) {
              votingModalInfo.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
            }
          };
          votingModalImage.src = `${work.image_url}?t=${Date.now()}`;
        }

        votingScoreButtons.forEach((btn) => {
          const btnScore = Number(btn.dataset.score);
          const isSelected = work.rating === btnScore;
          if (isSelected) {
            btn.classList.add('bg-violet-600');
            btn.classList.remove('bg-violet-500/40');
          } else {
            btn.classList.remove('bg-violet-600');
            btn.classList.add('bg-violet-500/40');
          }
          btn.disabled = false;
        });
      }

      function goToNextWork() {
        const works = votingState.works;
        if (!works.length) {
          closeVotingModal();
          return;
        }

        const nextIndex = works.findIndex((work, index) => index > votingState.currentIndex && !work.already_rated);
        if (nextIndex !== -1) {
          votingState.currentIndex = nextIndex;
          renderVotingWork();
          return;
        }

        const firstUnrated = works.findIndex((work) => !work.already_rated);
        if (firstUnrated !== -1) {
          votingState.currentIndex = firstUnrated;
          renderVotingWork();
          return;
        }

        alert('–°–ø–∞—Å–∏–±–æ! –í—ã –æ—Ü–µ–Ω–∏–ª–∏ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–∞–±–æ—Ç—ã.');
        closeVotingModal();
        if (typeof window.loadContests === 'function') {
          window.loadContests(true);
        }
      }

      async function handleVoteClick(score) {
        initVotingModalElements();
        if (!votingState.contestId || !votingState.works.length) {
          return;
        }

        const currentWork = votingState.works[votingState.currentIndex];
        if (!currentWork || currentWork.already_rated) {
          goToNextWork();
          return;
        }

        showVotingLoader(true);
        if (votingModalInfo) {
          votingModalInfo.textContent = '–°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∞—à—É –æ—Ü–µ–Ω–∫—É...';
        }

        try {
          await window.fetchJSON(`/api/contests/${votingState.contestId}/vote`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              user_id: currentUserId,
              work_number: currentWork.work_number,
              score: score
            })
          });

          currentWork.already_rated = true;
          currentWork.rating = score;
          showVotingLoader(false);
          goToNextWork();
        } catch (error) {
          showVotingLoader(false);
          let message = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ü–µ–Ω–∫—É';
          if (error.response) {
            try {
              const errData = await error.response.clone().json();
              message = errData.detail || errData.message || message;
            } catch (e) {
              // ignore JSON parse errors
            }
          } else if (error.message) {
            message = error.message;
          }
          alert('‚ùå ' + message);
        }
      }

      async function openVotingModal(contestId) {
        if (!currentUserId) {
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
          return;
        }

        initVotingModalElements();
        resetVotingState();
        votingState.contestId = contestId;

        if (votingModal) {
          votingModal.classList.remove('hidden');
        }

        showVotingLoader(true);
        if (votingModalInfo) {
          votingModalInfo.textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞–±–æ—Ç—ã –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è...';
        }

        try {
          const response = await window.fetchJSON(`/api/contests/${contestId}/voting-queue?user_id=${currentUserId}`);
          // –†–∞–±–æ—Ç—ã —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (—Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã –∏—Å–∫–ª—é—á–µ–Ω—ã)
          const works = response?.works || [];
          const canVote = response?.can_vote !== false; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é true, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ

          if (!canVote) {
            alert('–û—Ü–µ–Ω–∏–≤–∞—Ç—å —Ä–∞–±–æ—Ç—ã –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ —á–ª–µ–Ω—ã –∂—é—Ä–∏ –∏ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ–Ω–∫—É—Ä—Å–∞.');
            closeVotingModal();
            return;
          }

          if (!works.length) {
            alert('–ù–µ—Ç —Ä–∞–±–æ—Ç –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∏–ª–∏ –≤—Å–µ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç –≤–∞–º.');
            closeVotingModal();
            return;
          }

          const firstUnratedIndex = works.findIndex((work) => !work.already_rated);
          if (firstUnratedIndex === -1) {
            alert('–í—ã —É–∂–µ –æ—Ü–µ–Ω–∏–ª–∏ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–∞–±–æ—Ç—ã. –°–ø–∞—Å–∏–±–æ!');
            closeVotingModal();
            return;
          }

          votingState.works = works;
          votingState.currentIndex = firstUnratedIndex;
          showVotingLoader(false);
          renderVotingWork();
        } catch (error) {
          showVotingLoader(false);
          let message = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç';
          if (error.response) {
            try {
              const errData = await error.response.clone().json();
              message = errData.detail || errData.message || message;
            } catch (e) {
              // ignore JSON parse errors
            }
          } else if (error.message) {
            message = error.message;
          }
          alert('‚ùå ' + message);
          closeVotingModal();
        }
      }

      window.openVotingModal = openVotingModal;
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –∏—Ç–æ–≥–æ–≤ –∫–æ–Ω–∫—É—Ä—Å–∞ —Ä–∏—Å—É–Ω–∫–æ–≤ (–¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è)
      window.calculateDrawingResults = async function(contestId) {
        const btn = document.getElementById(`calculate-results-btn-${contestId}`);
        if (btn) {
          btn.disabled = true;
          btn.textContent = '‚è≥ –ü–æ–¥—Å—á–µ—Ç...';
        }
        
        try {
          const currentUserId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || window.currentUserId;
          const response = await window.fetchJSON(`/api/contests/${contestId}/calculate-results?current_user_id=${currentUserId}`, {
            method: 'POST'
          });
          
          if (response.success) {
            alert('‚úÖ –ò—Ç–æ–≥–∏ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Å—á–∏—Ç–∞–Ω—ã!');
            await window.loadContests(true);
          } else {
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å—á–µ—Ç–µ –∏—Ç–æ–≥–æ–≤: ' + (response.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            if (btn) {
              btn.disabled = false;
              btn.textContent = 'üìä –ü–æ–¥—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤';
            }
          }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –∏—Ç–æ–≥–æ–≤:', e);
          let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
          if (e.response) {
            try {
              const errData = await e.response.clone().json();
              errorMessage = errData.detail || errData.message || errorMessage;
            } catch (parseError) {
              if (e.message) errorMessage = e.message;
            }
          } else if (e.message) {
            errorMessage = e.message;
          }
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å—á–µ—Ç–µ –∏—Ç–æ–≥–æ–≤: ' + errorMessage);
          if (btn) {
            btn.disabled = false;
            btn.textContent = 'üìä –ü–æ–¥—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤';
          }
        }
      };
      
      // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      let currentResultsData = {
        contestId: null,
        juryResults: [],
        audienceResults: [],
        juryEnabled: false,
        audienceVotingEnabled: false
      };
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      function renderResultsTable(results, contestId) {
        if (!results || results.length === 0) {
          return '<div class="text-center text-gray-400 py-8">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
        }
        
        let tableHtml = '<div class="space-y-4">';
        
        for (const result of results) {
          const place = result.place;
          const username = result.username || '';
          const userId = result.participant_user_id;
          const imageUrl = `/api/drawing-contests/${contestId}/works/${result.work_number}/image`;
          const prizeLink = result.prize_link;
          const averageScore = result.average_score || 0;
          const votesCount = result.votes_count || 0;
          
          tableHtml += `
            <div class="rounded-lg border border-violet-400/30 p-4 bg-black/30">
              <div class="text-2xl font-bold text-violet-400 mb-2">${place} –º–µ—Å—Ç–æ</div>
              <div class="text-sm text-gray-300 mb-3">
                ${username ? `<span class="font-semibold text-violet-400">${username}</span> ` : ''}
                <span class="text-gray-400">(ID: ${userId})</span>
              </div>
              <div class="mb-3">
                <img src="${imageUrl}" alt="–†–∞–±–æ—Ç–∞ ${result.work_number}" class="w-full rounded-lg max-h-64 object-contain" />
              </div>
              <div class="text-sm text-gray-400 mb-3">
                –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: <span class="text-violet-400 font-semibold">${averageScore.toFixed(2)}</span> (${votesCount} ${votesCount === 1 ? '–æ—Ü–µ–Ω–∫–∞' : votesCount < 5 ? '–æ—Ü–µ–Ω–∫–∏' : '–æ—Ü–µ–Ω–æ–∫'})
              </div>
              ${prizeLink ? `
                <div class="text-sm">
                  <a href="${prizeLink.startsWith('http') ? prizeLink : 'https://' + prizeLink}" target="_blank" class="text-pink-400 hover:underline font-semibold">üéÅ –ü—Ä–∏–∑</a>
                </div>
              ` : ''}
            </div>
          `;
        }
        
        tableHtml += '</div>';
        return tableHtml;
      }
      
      // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è)
      window.switchResultsTable = function(type) {
        const resultsContent = document.getElementById('drawing-results-content');
        const juryTabBtn = document.getElementById('results-jury-tab');
        const audienceTabBtn = document.getElementById('results-audience-tab');
        
        if (!resultsContent) return;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        if (juryTabBtn && audienceTabBtn) {
          if (type === 'jury') {
            juryTabBtn.classList.add('bg-violet-600', 'text-white');
            juryTabBtn.classList.remove('bg-violet-500/40', 'text-gray-300');
            audienceTabBtn.classList.remove('bg-violet-600', 'text-white');
            audienceTabBtn.classList.add('bg-violet-500/40', 'text-gray-300');
          } else {
            audienceTabBtn.classList.add('bg-violet-600', 'text-white');
            audienceTabBtn.classList.remove('bg-violet-500/40', 'text-gray-300');
            juryTabBtn.classList.remove('bg-violet-600', 'text-white');
            juryTabBtn.classList.add('bg-violet-500/40', 'text-gray-300');
          }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ç–∞–±–ª–∏—Ü—É
        if (type === 'jury') {
          resultsContent.innerHTML = renderResultsTable(currentResultsData.juryResults, currentResultsData.contestId);
        } else {
          resultsContent.innerHTML = renderResultsTable(currentResultsData.audienceResults, currentResultsData.contestId);
        }
      }
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤ –∫–æ–Ω–∫—É—Ä—Å–∞ —Ä–∏—Å—É–Ω–∫–æ–≤
      window.showDrawingResults = async function(contestId) {
        try {
          const response = await window.fetchJSON(`/api/contests/${contestId}/results`);
          
          if (!response.results_calculated) {
            alert('–ò—Ç–æ–≥–∏ –µ—â–µ –Ω–µ –ø–æ–¥—Å—á–∏—Ç–∞–Ω—ã');
            return;
          }
          
          const resultsModal = document.getElementById('drawing-results-modal');
          const resultsContent = document.getElementById('drawing-results-content');
          const resultsTabs = document.getElementById('drawing-results-tabs');
          
          if (!resultsModal || !resultsContent) {
            alert('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            return;
          }
          
          const juryEnabled = response.jury_enabled || false;
          const audienceVotingEnabled = response.audience_voting_enabled || false;
          const juryResults = response.jury_results || [];
          const audienceResults = response.audience_results || [];
          
          // –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
          console.log('DEBUG showDrawingResults:', {
            contestId,
            juryEnabled,
            audienceVotingEnabled,
            juryResultsCount: juryResults.length,
            audienceResultsCount: audienceResults.length,
            response: response
          });
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
          currentResultsData = {
            contestId: contestId,
            juryResults: juryResults,
            audienceResults: audienceResults,
            juryEnabled: juryEnabled,
            audienceVotingEnabled: audienceVotingEnabled
          };
          
          // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏-—Ç–∞–±—ã
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã –∏ –∂—é—Ä–∏, –∏ –∑—Ä–∏—Ç–µ–ª—å—Å–∫–∏–µ —Å–∏–º–ø–∞—Ç–∏–∏
          let tabsHtml = '';
          const shouldShowTabs = juryEnabled && audienceVotingEnabled;
          console.log('DEBUG: shouldShowTabs =', shouldShowTabs, 'juryEnabled =', juryEnabled, 'audienceVotingEnabled =', audienceVotingEnabled);
          
          if (shouldShowTabs) {
            // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã –∏ –∂—é—Ä–∏, –∏ –∑—Ä–∏—Ç–µ–ª—å—Å–∫–∏–µ —Å–∏–º–ø–∞—Ç–∏–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–µ –∫–Ω–æ–ø–∫–∏
            tabsHtml = `
              <div class="flex gap-2 mb-4">
                <button id="results-jury-tab" onclick="switchResultsTable('jury')" class="flex-1 py-2 px-4 rounded-lg text-sm font-semibold bg-violet-600 text-white neon-button border border-violet-400/50">
                  üèÜ –¢–∞–±–ª–∏—Ü–∞ –∂—é—Ä–∏
                </button>
                <button id="results-audience-tab" onclick="switchResultsTable('audience')" class="flex-1 py-2 px-4 rounded-lg text-sm font-semibold bg-violet-500/40 text-gray-300 neon-button border border-violet-400/30">
                  üë• –¢–∞–±–ª–∏—Ü–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                </button>
              </div>
            `;
            console.log('DEBUG: –ö–Ω–æ–ø–∫–∏-—Ç–∞–±—ã —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã, –¥–ª–∏–Ω–∞ HTML:', tabsHtml.length);
          } else {
            console.log('DEBUG: –ö–Ω–æ–ø–∫–∏-—Ç–∞–±—ã –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è, –ø–æ—Ç–æ–º—É —á—Ç–æ:', {
              juryEnabled,
              audienceVotingEnabled,
              condition: juryEnabled && audienceVotingEnabled
            });
          }
          
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫—É—é —Ç–∞–±–ª–∏—Ü—É –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
          let defaultTable = '';
          if (juryEnabled) {
            defaultTable = renderResultsTable(juryResults, contestId);
          } else if (audienceVotingEnabled) {
            defaultTable = renderResultsTable(audienceResults, contestId);
          } else {
            const results = response.results || [];
            defaultTable = renderResultsTable(results, contestId);
          }
          
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º HTML
          const resultsTabsContainer = document.getElementById('drawing-results-tabs');
          console.log('DEBUG: resultsTabsContainer –Ω–∞–π–¥–µ–Ω:', !!resultsTabsContainer);
          
          if (resultsTabsContainer) {
            resultsTabsContainer.innerHTML = tabsHtml;
            resultsContent.innerHTML = defaultTable;
            console.log('DEBUG: HTML —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã');
          } else {
            // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–∞–±–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º —Ç–∞–±—ã –ø–µ—Ä–µ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
            console.log('DEBUG: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–∞–±–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º —Ç–∞–±—ã –≤ –∫–æ–Ω—Ç–µ–Ω—Ç');
            resultsContent.innerHTML = tabsHtml + defaultTable;
          }
          
          // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
          resultsModal.classList.remove('hidden');
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Ç–æ–≥–æ–≤:', e);
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Ç–æ–≥–æ–≤: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
      };
      window.closeVotingModal = closeVotingModal;

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
      function initElements() {
        spinner = document.getElementById('loading-spinner');
        topNav = document.getElementById('user-nav');
        main = document.querySelector('main');
        contentSections = document.querySelectorAll('.content-section');
        navButtons = topNav ? topNav.querySelectorAll('.nav-button') : [];
        
        console.log('üîß –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã:', {
          spinner: !!spinner,
          topNav: !!topNav,
          main: !!main,
          contentSections: contentSections.length,
          navButtons: navButtons.length
        });
      }

      function showSection(id) {
        console.log('üîß showSection –≤—ã–∑–≤–∞–Ω–∞ —Å id:', id);
        
        // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–ø—Ä—è–º—É—é –∏–∑ DOM
        const sections = document.querySelectorAll('.content-section');
        const nav = document.getElementById('user-nav');
        const buttons = nav ? nav.querySelectorAll('.nav-button') : [];
        
        if (sections.length === 0) {
          console.error('‚ùå –°–µ–∫—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!');
          return;
        }
        
        console.log('üîß –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é:', id);
        sections.forEach(s => {
          const shouldShow = s.id === id;
          console.log(`üîß –°–µ–∫—Ü–∏—è ${s.id}: ${shouldShow ? '–ø–æ–∫–∞–∑—ã–≤–∞–µ–º' : '—Å–∫—Ä—ã–≤–∞–µ–º'}`);
          if (shouldShow) {
            s.classList.remove('hidden');
          } else {
            s.classList.add('hidden');
          }
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        buttons.forEach(b => {
          const isActive = b.dataset.section === id;
          if (isActive) {
            b.classList.add('active');
          } else {
            b.classList.remove('active');
          }
        });
        
        console.log('‚úÖ showSection –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
      }

      function hideSpinnerAndShowPanel() {
        console.log('üîÑ –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å');
        
        try {
          // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∑–∞–Ω–æ–≤–æ, –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –æ–Ω–∏ –µ—â–µ –Ω–µ –±—ã–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
          if (!spinner) spinner = document.getElementById('loading-spinner');
          if (!topNav) topNav = document.getElementById('user-nav');
          if (!main) main = document.querySelector('main');
          
          if (spinner) {
            spinner.classList.add('hidden');
            spinner.style.display = 'none';
            spinner.style.visibility = 'hidden';
            spinner.style.opacity = '0';
            spinner.style.pointerEvents = 'none'; // –ö–†–ò–¢–ò–ß–ù–û: –æ—Ç–∫–ª—é—á–∞–µ–º pointer events
            spinner.style.zIndex = '-1'; // –£–±–∏—Ä–∞–µ–º –≤—ã—Å–æ–∫–∏–π z-index
            console.log('‚úÖ –°–ø–∏–Ω–Ω–µ—Ä —Å–∫—Ä—ã—Ç –∏ pointer-events –æ—Ç–∫–ª—é—á–µ–Ω—ã');
          } else {
            console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç spinner –Ω–µ –Ω–∞–π–¥–µ–Ω!');
          }
          
          if (topNav) {
            topNav.classList.remove('hidden');
            topNav.style.display = 'flex';
            topNav.style.visibility = 'visible';
            topNav.style.pointerEvents = 'auto'; // –í–∫–ª—é—á–∞–µ–º –∫–ª–∏–∫–∏
            topNav.style.zIndex = '10';
            console.log('‚úÖ –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ–∫–∞–∑–∞–Ω–∞, pointer-events –≤–∫–ª—é—á–µ–Ω—ã');
          } else {
            console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç topNav –Ω–µ –Ω–∞–π–¥–µ–Ω!');
          }
          
          if (main) {
            main.classList.remove('hidden');
            main.style.display = 'block';
            main.style.visibility = 'visible';
            main.style.pointerEvents = 'auto'; // –í–∫–ª—é—á–∞–µ–º –∫–ª–∏–∫–∏
            console.log('‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–∫–∞–∑–∞–Ω, pointer-events –≤–∫–ª—é—á–µ–Ω—ã');
          } else {
            console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç main –Ω–µ –Ω–∞–π–¥–µ–Ω!');
          }
          
          console.log('‚úÖ –ü–∞–Ω–µ–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–∫–∞–∑–∞–Ω–∞');
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ —Å–ø–∏–Ω–Ω–µ—Ä–∞:', error);
          // –ü—ã—Ç–∞–µ–º—Å—è —Å–∫—Ä—ã—Ç—å —Å–ø–∏–Ω–Ω–µ—Ä –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ style, –µ—Å–ª–∏ –∫–ª–∞—Å—Å—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç
          if (spinner) {
            spinner.style.display = 'none';
            spinner.style.visibility = 'hidden';
            spinner.style.opacity = '0';
            spinner.style.pointerEvents = 'none';
          }
        }
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ DOM —Å—Ä–∞–∑—É
      console.log('üöÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è DOM –¥–æ DOMContentLoaded:', {
        readyState: document.readyState,
        bodyExists: !!document.body,
        spinnerExists: !!document.getElementById('loading-spinner')
      });
      
      // –í–ê–ñ–ù–û: initUserPage –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–∞ –ü–û–°–õ–ï –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
      // –§—É–Ω–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –ø–æ—ç—Ç–æ–º—É –º—ã –º–æ–∂–µ–º –≤—ã–∑–≤–∞—Ç—å initUserPage —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∏—Ö –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
      // –ù–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –¥–æ–±–∞–≤–∏–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
      function startInit() {
        if (document.readyState === 'loading') {
          console.log('üöÄ DOM –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –∂–¥–µ–º DOMContentLoaded');
          document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initUserPage, 50); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏
          });
        } else {
          console.log('üöÄ DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º —Å—Ä–∞–∑—É');
          setTimeout(initUserPage, 50); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏
        }
      }
      
      function initUserPage() {
        console.log('üöÄ ========== –ù–ê–ß–ê–õ–û –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò USER.HTML ==========');
        console.log('üöÄ DOMContentLoaded - –Ω–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ user.html');
        
        // –ü–†–û–í–ï–†–Ø–ï–ú –î–û–°–¢–£–ü–ù–û–°–¢–¨ –§–£–ù–ö–¶–ò–ô
        console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–π:', {
          'window.fetchJSON': typeof window.fetchJSON,
          'window.loadContests': typeof window.loadContests,
          'window.loadProfile': typeof window.loadProfile,
          'initContestList': typeof initContestList,
          'extractChannelFromPostLink': typeof extractChannelFromPostLink
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –î–û –≤—Å–µ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ
        initElements();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º contestList
        if (typeof initContestList === 'function') {
          initContestList();
        } else {
          contestList = document.getElementById('contest-list');
        }
        
        console.log('–≠–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã:', {
          spinner: !!spinner,
          topNav: !!topNav,
          main: !!main,
          contentSections: contentSections.length,
          navButtons: navButtons.length,
          contestList: !!contestList
        });
        
        // –ü–æ–ª—É—á–∞–µ–º tg_id –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ URL
        const params = new URLSearchParams(window.location.search);
        const tgId = params.get('tg_id');

        if (!tgId) {
          console.error('‚ùå tg_id –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ URL');
          if (spinner) {
            spinner.innerHTML = '<div class="text-red-500 text-lg font-semibold">‚ùå –û—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç tg_id</div>';
          }
          return;
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º currentUserId —Å—Ä–∞–∑—É –∏–∑ URL
        currentUserId = parseInt(tgId);
        window.currentUserId = currentUserId;
        console.log('‚úÖ currentUserId —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', currentUserId);
        
        // –ù–ê–°–¢–û–Ø–©–ï–ï –°–ö–†–´–¢–ò–ï –°–ü–ò–ù–ù–ï–†–ê - –í–´–ü–û–õ–ù–Ø–ï–ú –°–†–ê–ó–£
        console.log('üîÑ –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –ù–ï–ú–ï–î–õ–ï–ù–ù–û');
        hideSpinnerAndShowPanel();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é - –ü–†–û–°–¢–ê–Ø –õ–û–ì–ò–ö–ê
        console.log('üîò –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏');
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        function setupNavigation() {
          const nav = document.getElementById('user-nav');
          if (!nav) {
            console.error('‚ùå –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
            return;
          }
          
          const buttons = nav.querySelectorAll('.nav-button');
          const sections = document.querySelectorAll('.content-section');
          
          console.log('üîò –ù–∞–π–¥–µ–Ω–æ –∫–Ω–æ–ø–æ–∫:', buttons.length, '—Å–µ–∫—Ü–∏–π:', sections.length);
          
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–Ω–æ–ø–∫–∏
          buttons.forEach((btn) => {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —á–µ—Ä–µ–∑ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            console.log('üîò –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É:', newBtn.dataset.section);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
            newBtn.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              
              const sectionId = this.dataset.section;
              console.log('‚úÖ‚úÖ‚úÖ –ö–õ–ò–ö –ü–û –ö–ù–û–ü–ö–ï:', sectionId);
              
              // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É (–∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –∏–∑ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏)
              const allButtons = nav.querySelectorAll('.nav-button');
              allButtons.forEach(b => {
                if (b.dataset.section === sectionId) {
                  b.classList.add('active');
                } else {
                  b.classList.remove('active');
                }
              });
              
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏–∏
              sections.forEach(sec => {
                if (sec.id === sectionId) {
                  console.log('‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é:', sec.id);
                  sec.classList.remove('hidden');
                  
                  // –ï—Å–ª–∏ —ç—Ç–æ —Å–µ–∫—Ü–∏—è –∫–æ–Ω–∫—É—Ä—Å–æ–≤, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                  if (sec.id === 'contests-section') {
                    setTimeout(async () => {
                      console.log('üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω–∫—É—Ä—Å—ã –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ —Å–µ–∫—Ü–∏—é');
                      if (typeof window.loadContests === 'function') {
                        await window.loadContests(true);
                      } else {
                        console.error('‚ùå window.loadContests –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                      }
                    }, 100);
                  }
                  
                  // –ï—Å–ª–∏ —ç—Ç–æ —Å–µ–∫—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è, –∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
                  if (sec.id === 'profile-section') {
                    setTimeout(async () => {
                      console.log('üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ —Å–µ–∫—Ü–∏—é');
                      if (typeof window.loadProfile === 'function') {
                        await window.loadProfile();
                      } else {
                        console.error('‚ùå window.loadProfile –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                      }
                    }, 100);
                  }
                  
                  // –ï—Å–ª–∏ —ç—Ç–æ —Å–µ–∫—Ü–∏—è –º–∞–≥–∞–∑–∏–Ω–∞, —Ä–µ–Ω–¥–µ—Ä–∏–º –º–∞–≥–∞–∑–∏–Ω
                  if (sec.id === 'shop-section') {
                    setTimeout(() => {
                      console.log('üõí –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞–≥–∞–∑–∏–Ω –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ —Å–µ–∫—Ü–∏—é');
                      if (typeof window.renderShop === 'function') {
                        window.renderShop();
                      }
                    }, 100);
                  }
                } else {
                  console.log('‚ùå –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é:', sec.id);
                  sec.classList.add('hidden');
                }
              });
              
              console.log('‚úÖ –°–µ–∫—Ü–∏—è', sectionId, '–ø–æ–∫–∞–∑–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
            });
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–Ω–æ–ø–∫–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã
            newBtn.style.pointerEvents = 'auto';
            newBtn.style.cursor = 'pointer';
          });
          
          console.log('‚úÖ –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –ø–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞ –ø–∞–Ω–µ–ª–∏ (–Ω–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏)
        setTimeout(() => {
          setupNavigation();
          setupContactOwnerHandlers();
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –∫–æ–Ω–∫—É—Ä—Å–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
          console.log('üîò –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –∫–æ–Ω–∫—É—Ä—Å–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –Ω–∞–ø—Ä—è–º—É—é
          const contestsSection = document.getElementById('contests-section');
          const profileSection = document.getElementById('profile-section');
          if (contestsSection) {
            contestsSection.classList.remove('hidden');
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω–∫—É—Ä—Å—ã
            setTimeout(async () => {
              if (typeof window.loadContests === 'function') {
                await window.loadContests();
              }
            }, 100);
          }
          if (profileSection) {
            profileSection.classList.add('hidden');
          }
        }, 100);
        
        // Telegram WebApp initialization
        if (window.Telegram?.WebApp) {
          Telegram.WebApp.ready();
          const tgUser = window.Telegram.WebApp.initDataUnsafe?.user;
          if (tgUser) {
            currentUserId = tgUser.id || parseInt(tgId);
            window.currentUserId = currentUserId;
            const usernameEl = document.getElementById('profile-username');
            if (usernameEl) {
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º username –∏–∑ Telegram WebApp –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ first_name, –∏–Ω–∞—á–µ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
              const displayName = tgUser.username || tgUser.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
              usernameEl.textContent = displayName;
              
              // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º username –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
              if (tgUser.username) {
                fetch(`/api/profile/update-username?tg_id=${currentUserId}&username=${encodeURIComponent(tgUser.username)}`, {
                  method: 'POST'
                }).catch(() => {});
              }
            }
            const profileIdEl = document.getElementById('profile-id');
            if (profileIdEl) {
              profileIdEl.textContent = tgUser.id || tgId;
            }
          }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω–∫—É—Ä—Å—ã —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (–∫–∞–∫ –≤ creator.html)
        console.log('üì• –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∫–æ–Ω–∫—É—Ä—Å–æ–≤...');
        setTimeout(async () => {
          try {
            if (typeof window.loadContests === 'function') {
              console.log('üì• –í—ã–∑—ã–≤–∞–µ–º window.loadContests()...');
              await window.loadContests();
              console.log('‚úÖ –ö–æ–Ω–∫—É—Ä—Å—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
            } else {
              console.error('‚ùå –§—É–Ω–∫—Ü–∏—è window.loadContests –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
            }
          } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω–∫—É—Ä—Å–æ–≤:', error);
          }
        }, 200);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        setTimeout(async () => {
          try {
            if (typeof window.loadProfile === 'function') {
              await window.loadProfile();
              console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω');
            } else {
              console.error('‚ùå –§—É–Ω–∫—Ü–∏—è window.loadProfile –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
            }
          } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
          }
        }, 200);
        
        console.log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π fallback - —Å–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä —á–µ—Ä–µ–∑ 500ms –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
        setTimeout(() => {
          if (spinner && spinner.style.display !== 'none') {
            console.warn('‚ö†Ô∏è Fallback: –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä');
            hideSpinnerAndShowPanel();
          }
        }, 500);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ —Ñ–æ–∫—É—Å–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
        let lastVisibilityChange = Date.now();
        document.addEventListener('visibilitychange', async () => {
          if (!document.hidden) {
            const now = Date.now();
            if (now - lastVisibilityChange > 5000) {
              const contestsSection = document.getElementById('contests-section');
              if (contestsSection && !contestsSection.classList.contains('hidden')) {
                if (typeof window.loadContests === 'function') {
                  await window.loadContests(true);
                }
              }
              lastVisibilityChange = now;
            }
          }
        });
        
        // –õ–µ–≥–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–æ–Ω–∫—É—Ä—Å–æ–≤
        let lastContestIds = null;
        const checkForChanges = async () => {
          try {
            const contestsSection = document.getElementById('contests-section');
            if (!contestsSection || contestsSection.classList.contains('hidden')) {
              return;
            }
            const items = await window.fetchJSON('/api/contests');
            const currentIds = items.map(c => c.id.toString()).sort().join(',');
            if (lastContestIds !== null && lastContestIds !== currentIds) {
              if (typeof window.loadContests === 'function') {
                await window.loadContests(true);
              }
            }
            lastContestIds = currentIds;
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–æ–Ω–∫—É—Ä—Å–æ–≤:', error);
          }
        };
        setInterval(checkForChanges, 10000);
      }
      
      // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      window.initUserPage = initUserPage;
      
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è (fallback)
    setTimeout(() => {
      console.log('üöÄ Fallback –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞');
      const spinner = document.getElementById('loading-spinner');
      const nav = document.getElementById('user-nav');
      const main = document.querySelector('main');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∏–¥–µ–Ω –ª–∏ —Å–ø–∏–Ω–Ω–µ—Ä (—á–µ—Ä–µ–∑ computed style)
      if (spinner) {
        const spinnerStyle = window.getComputedStyle(spinner);
        const isSpinnerVisible = spinnerStyle.display !== 'none' && 
                                 spinnerStyle.visibility !== 'hidden' && 
                                 spinner.offsetParent !== null;
        
        if (isSpinnerVisible) {
          console.warn('‚ö†Ô∏è –°–ø–∏–Ω–Ω–µ—Ä –≤—Å–µ –µ—â–µ –≤–∏–¥–µ–Ω —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ fallback');
          spinner.style.setProperty('display', 'none', 'important');
          spinner.style.setProperty('visibility', 'hidden', 'important');
          spinner.style.setProperty('opacity', '0', 'important');
          spinner.style.setProperty('z-index', '-1', 'important');
          spinner.classList.add('hidden');
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –∏ –∫–æ–Ω—Ç–µ–Ω—Ç
          if (nav) {
            nav.classList.remove('hidden');
            nav.style.setProperty('display', 'flex', 'important');
            nav.style.setProperty('visibility', 'visible', 'important');
            nav.style.setProperty('opacity', '1', 'important');
            nav.style.setProperty('pointer-events', 'auto', 'important');
          }
          if (main) {
            main.classList.remove('hidden');
            main.style.setProperty('display', 'block', 'important');
            main.style.setProperty('visibility', 'visible', 'important');
            main.style.setProperty('opacity', '1', 'important');
            main.style.setProperty('pointer-events', 'auto', 'important');
          }
          
          console.log('‚úÖ –°–ø–∏–Ω–Ω–µ—Ä –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä—ã—Ç —á–µ—Ä–µ–∑ fallback –ø—Ä–æ–≤–µ—Ä–∫—É');
          console.log('‚ö†Ô∏è –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É');
        } else {
          console.log('‚úÖ –°–ø–∏–Ω–Ω–µ—Ä —É–∂–µ —Å–∫—Ä—ã—Ç, –≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ');
        }
      }
    }, 2000);
    
    console.log('üöÄ ========== –ö–û–ù–ï–¶ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò –°–ö–†–ò–ü–¢–ê ==========');

    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Ç–∏–ø–∞ –∫–æ–Ω–∫—É—Ä—Å–æ–≤
    let currentContestType = 'active';
    
    window.loadContests = async function(silentUpdate = false, contestType = null) {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞ –¥–ª—è Pro –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      const createContestBtn = document.getElementById('user-create-contest-btn');
      if (createContestBtn) {
        if (window.proSubscriptionActive) {
          createContestBtn.classList.remove('hidden');
        } else {
          createContestBtn.classList.add('hidden');
        }
      }
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π —Ç–∏–ø –∏–ª–∏ —Ç–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π
      if (contestType) {
        currentContestType = contestType;
      }
      
      // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ contestList –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
      if (!contestList) {
        contestList = initContestList();
      }
      
      if (!contestList) {
        console.error('‚ùå contestList –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
      }
      try {
        const items = await window.fetchJSON('/api/contests');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—É—Å—Ç –ª–∏ —Å–ø–∏—Å–æ–∫ (–ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)
        const isFirstLoad = contestList.children.length === 0 || 
                           contestList.innerHTML.includes('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä—Å–æ–≤') ||
                           contestList.innerHTML.includes('–û—à–∏–±–∫–∞');
        
        // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞, –æ—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é
        if (isFirstLoad && !silentUpdate) {
          contestList.innerHTML = '';
        }
        
        // –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω–∫—É—Ä—Å–æ–≤ –∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (items.length === 0) {
          // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
          const allCards = Array.from(contestList.children);
          allCards.forEach(card => {
            if (card.dataset.contestId) {
              card.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
              card.style.opacity = '0';
              card.style.transform = 'translateX(-100%)';
              setTimeout(() => {
                if (card.parentNode) {
                  card.parentNode.removeChild(card);
                }
              }, 500);
            }
          });
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è
          setTimeout(() => {
            if (contestList.children.length === 0) {
              contestList.innerHTML = '<div class="text-gray-500 text-center py-4">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä—Å–æ–≤</div>';
            }
          }, 600);
          return;
        }
        
        // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –±—ã–ª –ø—É—Å—Ç, –æ—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (contestList.innerHTML.includes('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä—Å–æ–≤')) {
          contestList.innerHTML = '';
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ ID –∫–æ–Ω–∫—É—Ä—Å–æ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        const currentContestIds = new Set(
          Array.from(contestList.children)
            .map(card => card.dataset.contestId)
            .filter(id => id)
        );
        
        const newContestIds = new Set(items.map(c => c.id.toString()));
        
        // –£–¥–∞–ª—è–µ–º –∫–æ–Ω–∫—É—Ä—Å—ã, –∫–æ—Ç–æ—Ä—ã—Ö –±–æ–ª—å—à–µ –Ω–µ—Ç (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)
        if (!isFirstLoad) {
          const contestsToRemove = Array.from(contestList.children).filter(card => {
            const contestId = card.dataset.contestId;
            return contestId && !newContestIds.has(contestId);
          });
          
          // –ê–Ω–∏–º–∏—Ä—É–µ–º —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—É—Ä—Å–æ–≤
          contestsToRemove.forEach(card => {
            card.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
            card.style.opacity = '0';
            card.style.transform = 'translateX(-100%)';
            setTimeout(() => {
              if (card.parentNode) {
                card.parentNode.removeChild(card);
              }
            }, 500);
          });
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω–∫—É—Ä—Å–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
        const participantsPromises = items.map(c => 
          window.fetchJSON(`/api/contests/${c.id}/participants-count`).catch(e => {
            console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞ ${c.id}:`, e);
            return { count: 0 };
          })
        );
        const participantsResults = await Promise.all(participantsPromises);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω–∫—É—Ä—Å–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
        const winnersPromises = items.map(c => 
          window.fetchJSON(`/api/contests/${c.id}/winners`).catch(e => {
            console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞ ${c.id}:`, e);
            return { winners: [], is_confirmed: false };
          })
        );
        const winnersResults = await Promise.all(winnersPromises);
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω–∫—É—Ä—Å–∞ (–∞–∫—Ç–∏–≤–Ω—ã–π/–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π)
        const contestsWithStatus = items.map((c, index) => {
          const winnersData = winnersResults[index];
          let isEnded = false;
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω –ª–∏ –∫–æ–Ω–∫—É—Ä—Å
          if (c.end_at || c.end_date) {
            try {
              const endDate = new Date(c.end_at || c.end_date);
              const now = new Date();
              isEnded = endDate < now;
            } catch (e) {
              console.error(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞ ${c.id}:`, e);
            }
          }
          
          // –ö–æ–Ω–∫—É—Ä—Å —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º, –µ—Å–ª–∏:
          // 1. –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–æ—à–ª–∞
          // 2. –ò–ª–∏ –µ—Å—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª–∏
          // 3. –ò–ª–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω—ã
          const isConfirmed = winnersData?.is_confirmed || false;
          const hasWinners = winnersData?.winners && winnersData.winners.length > 0;
          const isCompleted = isEnded || isConfirmed || hasWinners;
          
          return {
            contest: c,
            index: index,
            isCompleted: isCompleted,
            winnersData: winnersData
          };
        });
        
        // –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ
        const activeContests = contestsWithStatus.filter(item => !item.isCompleted);
        const completedContests = contestsWithStatus.filter(item => item.isCompleted);
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –∫–æ–Ω–∫—É—Ä—Å—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–∏–ø—É
        const contestsToShow = currentContestType === 'active' ? activeContests : completedContests;
        
        // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
        if (!silentUpdate) {
          contestList.innerHTML = '';
        }
        
        // –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω–∫—É—Ä—Å–æ–≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (contestsToShow.length === 0) {
          contestList.innerHTML = `<div class="text-gray-500 text-center py-4">–ù–µ—Ç ${currentContestType === 'active' ? '–∞–∫—Ç–∏–≤–Ω—ã—Ö' : '–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö'} –∫–æ–Ω–∫—É—Ä—Å–æ–≤</div>`;
          return;
        }
        
        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –∫–æ–Ω–∫—É—Ä—Å–æ–≤
        contestsToShow.forEach(({ contest: c, index, winnersData }) => {
          const participantsCount = participantsResults[index]?.count || 0;
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–Ω–∫—É—Ä—Å–∞
          const existingCard = contestList.querySelector(`[data-contest-id="${c.id}"]`);
          if (existingCard && silentUpdate) {
            // –ï—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —ç—Ç–æ —Ç–∏—Ö–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            return;
          }
          
          // –ï—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ —ç—Ç–æ –Ω–µ —Ç–∏—Ö–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, —É–¥–∞–ª—è–µ–º –µ—ë –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          if (existingCard) {
            existingCard.remove();
          }
          
          const card = document.createElement('div');
          card.className = 'rounded-lg border border-violet-400/30 p-4 bg-black/30';
          card.dataset.contestId = c.id; // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
          card.style.opacity = '0';
          card.style.transform = 'translateY(-20px)';
          card.style.transition = 'opacity 0.3s ease-in, transform 0.3s ease-in';
          
          const postLink = c.post_link || '';
          const channelUsername = extractChannelFromPostLink(postLink);
          const channelDisplay = channelUsername ? `@${channelUsername}` : '–ù–µ —É–∫–∞–∑–∞–Ω';
          
          // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—É—Ä—Å–∞
          const contestTitle = c.title || c.name || '–ö–æ–Ω–∫—É—Ä—Å';
          
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–æ–Ω–∫—É—Ä—Å–∞
          const contestType = c.contest_type || 'random_comment';
          const isDrawingContest = contestType === 'drawing';
          const isCollectionContest = contestType === 'collection';
          
          // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–∏–∑—ã (–º–∞–∫—Å–∏–º—É–º 3, –Ω–æ –µ—Å–ª–∏ –º–µ–Ω—å—à–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ)
          let prizesHtml = '';
          // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º prize_links: —É–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ —ç—Ç–æ –º–∞—Å—Å–∏–≤
          let prizeLinks = c.prize_links;
          if (!prizeLinks) {
            prizeLinks = [];
          } else if (typeof prizeLinks === 'string') {
            // –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞, –ø—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON
            try {
              prizeLinks = JSON.parse(prizeLinks);
            } catch (e) {
              console.warn(`–ö–æ–Ω–∫—É—Ä—Å ${c.id}: –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å prize_links –∫–∞–∫ JSON:`, prizeLinks);
              prizeLinks = [];
            }
          } else if (!Array.isArray(prizeLinks)) {
            console.warn(`–ö–æ–Ω–∫—É—Ä—Å ${c.id}: prize_links –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º:`, typeof prizeLinks, prizeLinks);
            prizeLinks = [];
          }
          
          if (prizeLinks && Array.isArray(prizeLinks) && prizeLinks.length > 0) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º 3 –ø—Ä–∏–∑–∞ (–∑–∞ –ø–µ—Ä–≤—ã–µ 3 –º–µ—Å—Ç–∞)
            const prizesToShow = prizeLinks.slice(0, Math.min(3, prizeLinks.length));
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–∏–∑
            function normalizePrizeLink(link) {
              if (!link) return '';
              link = link.trim();
              // –ï—Å–ª–∏ —É–∂–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å https:// –∏–ª–∏ http://, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
              if (link.startsWith('http://') || link.startsWith('https://')) {
                return link;
              }
              // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å t.me/, –¥–æ–±–∞–≤–ª—è–µ–º https://
              if (link.startsWith('t.me/')) {
                return 'https://' + link;
              }
              // –ò–Ω–∞—á–µ –¥–æ–±–∞–≤–ª—è–µ–º https://
              return 'https://' + link;
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è NFT - –∏—Å–ø–æ–ª—å–∑—É–µ–º img —Å –∑–∞–≥—Ä—É–∑–∫–æ–π —á–µ—Ä–µ–∑ API
            function getNFTImageHtml(link, idx) {
              const normalizedLink = normalizePrizeLink(link);
              // –ò—Å–ø–æ–ª—å–∑—É–µ–º img —Å src, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ API endpoint
              return `
                <img 
                  src="/api/nft-preview?nft_link=${encodeURIComponent(normalizedLink)}" 
                  alt="–ü—Ä–∏–∑ ${idx + 1}"
                  class="w-full h-full object-cover rounded-lg prize-image"
                  onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');"
                  loading="lazy"
                />
              `;
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è grid
            const gridCols = prizesToShow.length === 1 ? 'grid-cols-1' : prizesToShow.length === 2 ? 'grid-cols-2' : 'grid-cols-3';
            
            prizesHtml = `
              <div class="mb-4">
                <div class="grid ${gridCols} gap-3 mb-3">
                  ${prizesToShow.map((prizeLink, idx) => {
                    const normalizedLink = normalizePrizeLink(prizeLink);
                    return `
                    <div class="relative rounded-xl overflow-hidden border-2 border-violet-400/40 bg-gradient-to-br from-violet-600/30 via-pink-600/30 to-purple-600/30 aspect-square group hover:scale-105 transition-transform shadow-lg cursor-pointer">
                      <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48cGF0dGVybiBpZD0iZ3JpZCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiBwYXR0ZXJuVW5pdHM9InVzZXJTcGFjZU9uVXNlIj48Y2lyY2xlIGN4PSIxMCIgY3k9IjEwIiByPSIxLjUiIGZpbGw9IiNmZmYiIG9wYWNpdHk9IjAuMSIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9InVybCgjZ3JpZCkiLz48L3N2Zz4=')] opacity-20"></div>
                      <a href="${normalizedLink}" target="_blank" class="absolute inset-0 z-10 block">
                        <div class="w-full h-full relative">
                          ${getNFTImageHtml(prizeLink, idx)}
                          <div class="absolute inset-0 flex items-center justify-center bg-black/30 rounded-lg fallback-prize hidden">
                            <div class="text-5xl opacity-70">üéÅ</div>
                          </div>
                        </div>
                      </a>
                      <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 via-black/70 to-transparent p-2 z-20 pointer-events-none">
                        <div class="text-xs text-white font-semibold text-center">${idx + 1} –º–µ—Å—Ç–æ</div>
                      </div>
                    </div>
                  `;
                  }).join('')}
                </div>
                ${prizeLinks.length > 3 ? `<div class="text-xs text-gray-400 text-center">+${prizeLinks.length - 3} –µ—â–µ –ø—Ä–∏–∑–æ–≤</div>` : ''}
              </div>
            `;
          }
          
          card.innerHTML = `
            ${prizesHtml}
            
            <div class="flex items-center justify-between mb-3">
              <div class="font-bold text-xl text-white">${contestTitle}</div>
            </div>
            
            ${c.post_link ? `
              <div class="mt-3 pt-3 border-t border-violet-400/20">
                <div class="text-xs text-gray-500 mb-1">üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å—Ç:</div>
                <a href="${c.post_link}" target="_blank" class="text-blue-400 hover:underline text-sm break-all">${c.post_link}</a>
              </div>
            ` : ''}
            
            ${c.conditions ? `
              <div class="mt-3 pt-3 border-t border-violet-400/20">
                <div class="text-xs text-gray-500 mb-1">üìã –£—Å–ª–æ–≤–∏—è —É—á–∞—Å—Ç–∏—è:</div>
                <div class="text-sm text-gray-300">${c.conditions}</div>
              </div>
            ` : ''}
          `;
          
          // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
          let winnersHtml = '';
          try {
            const winners = winnersData?.winners || [];
            const isConfirmed = winnersData?.is_confirmed || false;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –≤—ã–±—Ä–∞–Ω—ã (–¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã)
            if (winners && winners.length > 0) {
              winnersHtml = `<div class="mt-3 pt-3 border-t border-violet-400/20">
                <div class="text-xs text-gray-500 mb-2">üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ (${winners.length}):</div>
                <div class="space-y-2">
                  ${winners.map((w, idx) => {
                    const place = w.place || (idx + 1);
                    const userDisplay = w.user_username ? `@${w.user_username}` : (w.user_id ? `ID: ${w.user_id}` : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');
                    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø—Ä–∏–∑
                    let prizeLink = w.prize_link;
                    if (prizeLink && !prizeLink.startsWith('http://') && !prizeLink.startsWith('https://')) {
                      prizeLink = 'https://' + prizeLink;
                    }
                    const prizeDisplay = prizeLink ? `<a href="${prizeLink}" target="_blank" class="text-pink-400 hover:underline font-semibold">üéÅ –ü—Ä–∏–∑ ${place} –º–µ—Å—Ç–∞</a>` : '<span class="text-gray-500">–ù–µ—Ç –ø—Ä–∏–∑–∞</span>';
                    return `
                    <div class="flex flex-col gap-1 text-sm p-2 rounded-lg bg-black/20 border border-violet-400/20">
                      <div class="flex items-center gap-2">
                        <span class="text-violet-400 font-bold flex-shrink-0">${place} –º–µ—Å—Ç–æ</span>
                        <span class="text-gray-300">${userDisplay}</span>
                      </div>
                      <div class="flex items-center gap-2 text-xs">
                        <a href="${w.comment_link}" target="_blank" class="text-blue-400 hover:underline break-all flex-1 min-w-0">${w.comment_link}</a>
                      </div>
                      <div class="text-xs text-gray-400">
                        –ü—Ä–∏–∑: ${prizeDisplay}
                      </div>
                    </div>
                  `;
                  }).join('')}
                </div>
              </div>`;
            }
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π:', e);
          }
          
          // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –≤ –∫–∞—Ä—Ç–æ—á–∫—É
          if (winnersHtml) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = winnersHtml;
            card.appendChild(tempDiv.firstElementChild);
          }
          
          // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω–∫—É—Ä—Å–æ–≤
          const participantsCountHtml = `
            <div class="mt-3 pt-3 border-t border-violet-400/20">
              <div class="text-xs text-gray-500 mb-1">üë• –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: <span class="text-violet-400 font-semibold" id="participants-count-${c.id}">${participantsCount}</span></div>
            </div>
          `;
          const tempParticipantsDiv = document.createElement('div');
          tempParticipantsDiv.innerHTML = participantsCountHtml;
          card.appendChild(tempParticipantsDiv.firstElementChild);
          
          // –î–ª—è –∫–æ–Ω–∫—É—Ä—Å–æ–≤ —Ä–∏—Å—É–Ω–∫–æ–≤ –∏ –∫–æ–ª–ª–µ–∫—Ü–∏–π –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É—á–∞—Å—Ç–∏—è
          // –ö–Ω–æ–ø–∫–∞ "–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–æ–≤ —Ä–∏—Å—É–Ω–∫–æ–≤/–∫–æ–ª–ª–µ–∫—Ü–∏–π –∏ –¢–û–õ–¨–ö–û –ø–æ–∫–∞ –Ω–µ –∏—Å—Ç–µ–∫–ª–æ –≤—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç
          if (isDrawingContest || isCollectionContest) {
            const photoSection = document.createElement('div');
            photoSection.className = 'mt-3 pt-3 border-t border-violet-400/20';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º UI
            (async () => {
              try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—á–∞—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ª–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è/–∫–æ–ª–ª–µ–∫—Ü–∏—è
                let participantResponse = null;
                try {
                  participantResponse = await window.fetchJSON(`/api/contests/${c.id}/participant-status?user_id=${currentUserId}`);
                  console.log(`‚úÖ –°—Ç–∞—Ç—É—Å —É—á–∞—Å—Ç–Ω–∏–∫–∞ –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞ ${c.id}:`, participantResponse);
                } catch (error) {
                  console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞ ${c.id}:`, error);
                  // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ —É–¥–∞–ª—Å—è, –Ω–æ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                  // –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏, –µ—Å–ª–∏ –∫–æ–Ω–∫—É—Ä—Å –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω –∏–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é
                  participantResponse = {
                    is_participating: false,
                    has_photo: false,
                    has_collection: false
                  };
                }
                
                const hasPhoto = isDrawingContest ? (participantResponse?.has_photo || false) : false;
                const hasCollection = isCollectionContest ? (participantResponse?.has_collection || false) : false;
                const isParticipating = participantResponse?.is_participating || false;
                const submissionEndDate = c.submission_end_date;
                const votingEndDate = c.end_at || c.end_date || c.voting_end_date;
                
                // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –æ—Ü–µ–Ω–∏–≤–∞–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–∞
                let canVote = false;
                if (isDrawingContest) {
                  try {
                    const canVoteResponse = await window.fetchJSON(`/api/contests/${c.id}/can-vote?user_id=${currentUserId}`);
                    canVote = canVoteResponse?.can_vote || false;
                  } catch (error) {
                    console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–∞–≤ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞ ${c.id}:`, error);
                    canVote = false;
                  }
                }
                
                const now = new Date();
                const submissionEnd = submissionEndDate ? new Date(submissionEndDate) : null;
                const votingEnd = votingEndDate ? new Date(votingEndDate) : null;
                
                let canUpload = false;
                let canParticipate = false;
                let timeMessage = '';
                let isSubmissionPeriodActive = false;
                let isVotingPeriodActive = false;
                let hasVotingEnded = false;
                let votingMessage = '';
                
                if (submissionEnd) {
                  if (now.getTime() <= submissionEnd.getTime()) {
                    isSubmissionPeriodActive = true;
                    canUpload = true;
                    canParticipate = true;
                    timeMessage = `‚è∞ –ü—Ä–∏–µ–º —Ä–∞–±–æ—Ç –¥–æ: ${toMoscowDateTime(submissionEnd)}`;
                  } else {
                    timeMessage = `‚è∞ –ü—Ä–∏–µ–º —Ä–∞–±–æ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω: ${toMoscowDateTime(submissionEnd)}`;
                  }
                } else {
                  timeMessage = '‚è∞ –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –Ω–µ —É–∫–∞–∑–∞–Ω–∞';
                }
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–∏–æ–¥ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
                const afterSubmission = submissionEnd ? now.getTime() > submissionEnd.getTime() : true;
                if (votingEnd) {
                  const votingDisplay = toMoscowDateTime(votingEnd);
                  if (!afterSubmission) {
                    votingMessage = `üó≥Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –¥–æ: ${votingDisplay}`;
                  } else if (now.getTime() <= votingEnd.getTime()) {
                    isVotingPeriodActive = true;
                    votingMessage = `üó≥Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –¥–æ: ${votingDisplay}`;
                  } else {
                    hasVotingEnded = true;
                    votingMessage = `üó≥Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: ${votingDisplay}`;
                  }
                } else if (afterSubmission) {
                  // –ï—Å–ª–∏ –≤—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –∏—Å—Ç–µ–∫–ª–æ, –Ω–æ –≤—Ä–µ–º—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ, —Å—á–∏—Ç–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–º
                  isVotingPeriodActive = true;
                  votingMessage = `üó≥Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ`;
                } else if (afterSubmission) {
                  // –ï—Å–ª–∏ –≤—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –∏—Å—Ç–µ–∫–ª–æ, –Ω–æ –≤—Ä–µ–º—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ, —Å—á–∏—Ç–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–º
                  isVotingPeriodActive = true;
                  votingMessage = `üó≥Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ`;
                }
                
                if (!submissionEnd) {
                  canUpload = false;
                  canParticipate = false;
                  isSubmissionPeriodActive = false;
                } else if (!isSubmissionPeriodActive) {
                  canUpload = false;
                  canParticipate = false;
                }
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                // –ö–Ω–æ–ø–∫–∞ "–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏:
                // 1. –≠—Ç–æ –∫–æ–Ω–∫—É—Ä—Å —Ä–∏—Å—É–Ω–∫–æ–≤ –∏–ª–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–π (—É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤—ã—à–µ)
                // 2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï —É—á–∞—Å—Ç–≤—É–µ—Ç
                // 3. –í—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –µ—â–µ –Ω–µ –∏—Å—Ç–µ–∫–ª–æ
                const hasSubmitted = isDrawingContest ? hasPhoto : hasCollection;
                
                console.log(`–ö–æ–Ω–∫—É—Ä—Å ${c.id}: canParticipate=${canParticipate}, canUpload=${canUpload}, isParticipating=${isParticipating}, hasPhoto=${hasPhoto}, hasCollection=${hasCollection}, hasSubmitted=${hasSubmitted}, isSubmissionPeriodActive=${isSubmissionPeriodActive}, isVotingPeriodActive=${isVotingPeriodActive}, canVote=${canVote}, submissionEnd=${submissionEndDate}, votingEnd=${votingEndDate}, audienceVoting=${c.audience_voting ? JSON.stringify(c.audience_voting) : 'null'}`);
                
                let photoHtml = '';
                
                // –ü–†–ò–û–†–ò–¢–ï–¢: –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–∏–æ–¥ –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç
                // –í–æ –≤—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–±–æ—Ç
                if (hasSubmitted && isSubmissionPeriodActive) {
                  // –†–∞–±–æ—Ç–∞ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–æ –≤—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –µ—â–µ –Ω–µ –∏—Å—Ç–µ–∫–ª–æ
                  const submittedText = isDrawingContest ? '‚úÖ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞' : '‚úÖ –ö–æ–ª–ª–µ–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞';
                  photoHtml = `
                    <div class="text-sm text-green-400 mb-2">${submittedText}</div>
                    ${timeMessage ? `<div class="text-xs text-gray-500 mb-2">${timeMessage}</div>` : ''}
                  `;
                } else if (isParticipating === true && canUpload && isSubmissionPeriodActive && !hasSubmitted) {
                  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—á–∞—Å—Ç–≤—É–µ—Ç, –Ω–æ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª —Ä–∞–±–æ—Ç—É, –∏ –≤—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –µ—â–µ –Ω–µ –∏—Å—Ç–µ–∫–ª–æ
                  if (isDrawingContest) {
                    photoHtml = `
                      <div class="text-sm text-gray-300 mb-2">üì∏ –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é</div>
                      ${timeMessage ? `<div class="text-xs text-gray-500 mb-2">${timeMessage}</div>` : ''}
                      <input type="file" id="photo-input-${c.id}" accept="image/*" class="hidden" />
                      <label for="photo-input-${c.id}" id="upload-photo-btn-${c.id}" class="neon-button w-full py-2 rounded-lg text-sm cursor-pointer inline-block text-center">
                        üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é
                      </label>
                    `;
                  } else if (isCollectionContest) {
                    photoHtml = `
                      <div class="text-sm text-gray-300 mb-2">üñºÔ∏è –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é –∏–∑ 9 NFT</div>
                      ${timeMessage ? `<div class="text-xs text-gray-500 mb-2">${timeMessage}</div>` : ''}
                      <button id="submit-collection-btn-${c.id}" class="neon-button w-full py-2 rounded-lg text-sm">
                        üñºÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é
                      </button>
                    `;
                  }
                } else if (!isParticipating && canParticipate && isSubmissionPeriodActive) {
                  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï —É—á–∞—Å—Ç–≤—É–µ—Ç, –≤—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –µ—â–µ –Ω–µ –∏—Å—Ç–µ–∫–ª–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å"
                  // –≠–¢–ê –ö–ù–û–ü–ö–ê –ü–û–ö–ê–ó–´–í–ê–ï–¢–°–Ø –¢–û–õ–¨–ö–û –î–õ–Ø –ö–û–ù–ö–£–†–°–û–í –†–ò–°–£–ù–ö–û–í –ò –¢–û–õ–¨–ö–û –ü–û–ö–ê –ù–ï –ò–°–¢–ï–ö–õ–û –í–†–ï–ú–Ø –ü–†–ò–ï–ú–ê –†–ê–ë–û–¢
                  photoHtml = `
                    ${timeMessage ? `<div class="text-xs text-gray-500 mb-2">${timeMessage}</div>` : ''}
                    <button id="participate-btn-${c.id}" class="neon-button w-full py-2 rounded-lg text-sm font-semibold">
                      ‚ú® –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å
                    </button>
                  `;
                } else if (!isSubmissionPeriodActive && canVote && !hasVotingEnded && isDrawingContest) {
                  // –í—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –∏—Å—Ç–µ–∫–ª–æ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ì–æ–ª–æ—Å–æ–≤–∞—Ç—å"
                  const submittedText = (isParticipating && hasSubmitted) 
                    ? (isDrawingContest ? '‚úÖ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞' : '‚úÖ –ö–æ–ª–ª–µ–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞')
                    : '';
                  photoHtml = `
                    ${submittedText ? `<div class="text-sm text-green-400 mb-2">${submittedText}</div>` : ''}
                    <div class="text-sm text-gray-400 mb-2">‚è∞ –í—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –∏—Å—Ç–µ–∫–ª–æ</div>
                    ${timeMessage ? `<div class="text-xs text-gray-500 mb-2">${timeMessage}</div>` : ''}
                    <button id="vote-btn-${c.id}" class="neon-button w-full py-2 rounded-lg text-sm font-semibold">
                      üó≥Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞—Ç—å
                    </button>
                  `;
                } else if (!isSubmissionPeriodActive) {
                  // –í—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –∏—Å—Ç–µ–∫–ª–æ, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å
                  const submittedText = (isParticipating && hasSubmitted) 
                    ? (isDrawingContest ? '‚úÖ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞' : '‚úÖ –ö–æ–ª–ª–µ–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞')
                    : '';
                  photoHtml = `
                    ${submittedText ? `<div class="text-sm text-green-400 mb-2">${submittedText}</div>` : ''}
                    <div class="text-sm text-gray-400 mb-2">‚è∞ –í—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –∏—Å—Ç–µ–∫–ª–æ</div>
                    ${timeMessage ? `<div class="text-xs text-gray-500 mb-2">${timeMessage}</div>` : ''}
                  `;
                } else {
                  // –î—Ä—É–≥–∏–µ —Å–ª—É—á–∞–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—á–∞—Å—Ç–≤—É–µ—Ç, –Ω–æ –≤—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ)
                  photoHtml = `
                    <div class="text-sm text-gray-400 mb-2">${timeMessage || '–ö–æ–Ω–∫—É—Ä—Å –∞–∫—Ç–∏–≤–µ–Ω'}</div>
                  `;
                }
                
                if (votingMessage && (!isSubmissionPeriodActive || isVotingPeriodActive || hasVotingEnded)) {
                  const votingClass = isVotingPeriodActive ? 'text-pink-400' : 'text-gray-500';
                  photoHtml += `
                    <div class="text-xs ${votingClass} mb-2">${votingMessage}</div>
                  `;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ì–æ–ª–æ—Å–æ–≤–∞—Ç—å" —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
                // –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö, –∫—Ç–æ –º–æ–∂–µ—Ç –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å (—Å–æ–∑–¥–∞—Ç–µ–ª—å, –∂—é—Ä–∏, —É—á–∞—Å—Ç–Ω–∏–∫–∏, –∑—Ä–∏—Ç–µ–ª–∏ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∑—Ä–∏—Ç–µ–ª—å—Å–∫–∏—Ö —Å–∏–º–ø–∞—Ç–∏—è—Ö)
                // –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç
                if (canVote && !hasVotingEnded && !isSubmissionPeriodActive && isDrawingContest) {
                  setTimeout(() => {
                    const voteBtn = document.getElementById(`vote-btn-${c.id}`);
                    if (voteBtn) {
                      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –µ—Å—Ç—å
                      const newBtn = voteBtn.cloneNode(true);
                      voteBtn.parentNode.replaceChild(newBtn, voteBtn);
                      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                      newBtn.addEventListener('click', () => {
                        window.openVotingModal(c.id);
                      });
                    }
                  }, 100);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∏—Ç–æ–≥–æ–≤ –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–æ–≤ —Ä–∏—Å—É–Ω–∫–æ–≤
                let resultsButtonHtml = '';
                if (hasVotingEnded || (!isSubmissionPeriodActive && !isVotingPeriodActive)) {
                  try {
                    const resultsResponse = await window.fetchJSON(`/api/contests/${c.id}/results`).catch(() => ({ results_calculated: false }));
                    const resultsCalculated = resultsResponse?.results_calculated || false;
                    
                    if (!resultsCalculated) {
                      // –î–ª—è user –∫–Ω–æ–ø–∫–∞ "–ü–æ–¥—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤" –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤–æ–æ–±—â–µ
                      // –û–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è –≤ creator.html
                    } else {
                      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Ç–æ–≥–∏" –¥–ª—è –≤—Å–µ—Ö –ø–æ—Å–ª–µ –ø–æ–¥—Å—á–µ—Ç–∞
                      resultsButtonHtml = `
                        <button id="view-results-btn-${c.id}" class="neon-button w-full py-2 rounded-lg text-sm font-semibold mt-2">
                          üèÜ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Ç–æ–≥–∏
                        </button>
                      `;
                    }
                  } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∏—Ç–æ–≥–æ–≤:', e);
                  }
                }
                
                photoSection.innerHTML = photoHtml + resultsButtonHtml;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
                if (resultsButtonHtml) {
                  setTimeout(() => {
                    const viewResultsBtn = document.getElementById(`view-results-btn-${c.id}`);
                    if (viewResultsBtn) {
                      viewResultsBtn.addEventListener('click', () => {
                        window.showDrawingResults(c.id);
                      });
                    }
                    
                    const calculateResultsBtn = document.getElementById(`calculate-results-btn-${c.id}`);
                    if (calculateResultsBtn) {
                      calculateResultsBtn.addEventListener('click', () => {
                        window.calculateDrawingResults(c.id);
                      });
                    }
                  }, 100);
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å"
                // –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏: !isParticipating && canParticipate && isSubmissionPeriodActive
                if (!isParticipating && canParticipate && isSubmissionPeriodActive) {
                  // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ DOM
                  setTimeout(() => {
                    const participateBtn = document.getElementById(`participate-btn-${c.id}`);
                    if (participateBtn) {
                      participateBtn.addEventListener('click', async () => {
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø–µ—Ä–µ–¥ —É—á–∞—Å—Ç–∏–µ–º
                        const submissionEndDate = c.submission_end_date;
                        if (submissionEndDate) {
                          const now = new Date();
                          const endDate = new Date(submissionEndDate);
                          
                          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å—Ç–µ–∫–ª–æ –ª–∏ –≤—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç
                          if (now.getTime() > endDate.getTime()) {
                            alert('‚ùå –í—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –∏—Å—Ç–µ–∫–ª–æ. –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–Ω–∫—É—Ä—Å—É.');
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—É—Ä—Å–æ–≤, —á—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É
                            await window.loadContests(true);
                            return;
                          }
                        }
                        
                        participateBtn.disabled = true;
                        participateBtn.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
                        
                        try {
                          const username = window.Telegram?.WebApp?.initDataUnsafe?.user?.username || '';
                          const response = await window.fetchJSON(`/api/contests/${c.id}/participate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                              user_id: currentUserId,
                              username: username
                            })
                          });
                          
                          if (response.success) {
                            // –£—Å–ø–µ—à–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–Ω–∫—É—Ä—Å—É —Ä–∏—Å—É–Ω–∫–æ–≤
                            // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert, —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º UI, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                            const participantsCountEl = document.getElementById(`participants-count-${c.id}`);
                            if (participantsCountEl) {
                              const newCount = parseInt(participantsCountEl.textContent) + 1;
                              participantsCountEl.textContent = newCount;
                            }
                            
                            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—É—Ä—Å–æ–≤, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —É—á–∞—Å—Ç–Ω–∏–∫–∞
                            await window.loadContests();
                          } else if (response.requires_subscription && response.not_subscribed) {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –Ω–µ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏/—á–∞—Ç–∞–º–∏
                            window.showSubscriptionModal(c.id, response.not_subscribed, currentUserId, username);
                            participateBtn.disabled = false;
                            participateBtn.textContent = '‚ú® –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å';
                          } else {
                            alert('‚ùå ' + (response.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ –∫ –∫–æ–Ω–∫—É—Ä—Å—É'));
                            participateBtn.disabled = false;
                            participateBtn.textContent = '‚ú® –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å';
                          }
                        } catch (error) {
                          console.error('–û—à–∏–±–∫–∞ —É—á–∞—Å—Ç–∏—è –≤ –∫–æ–Ω–∫—É—Ä—Å–µ:', error);
                          let errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ –∫ –∫–æ–Ω–∫—É—Ä—Å—É';
                          let shouldReload = false;
                          
                          try {
                            const errorResponse = await error.response?.json();
                            if (errorResponse?.detail) {
                              errorMessage = errorResponse.detail;
                              // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –∏—Å—Ç–µ–∫—à–∏–º deadline, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—É—Ä—Å–æ–≤
                              if (errorResponse.detail.includes('–í—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –∏—Å—Ç–µ–∫–ª–æ') || 
                                  errorResponse.detail.includes('–∏—Å—Ç–µ–∫–ª–æ')) {
                                shouldReload = true;
                              }
                            } else if (errorResponse?.message) {
                              errorMessage = errorResponse.message;
                            }
                          } catch (e) {
                            if (error.message) {
                              errorMessage = error.message;
                            }
                          }
                          
                          alert('‚ùå ' + errorMessage);
                          
                          // –ï—Å–ª–∏ deadline –∏—Å—Ç–µ–∫, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—É—Ä—Å–æ–≤, —á—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É
                          if (shouldReload) {
                            await window.loadContests();
                          } else {
                            participateBtn.disabled = false;
                            participateBtn.textContent = '‚ú® –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å';
                          }
                        }
                      });
                    }
                  }, 100);
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç)
                // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–∑–º–æ–∂–Ω–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –µ—â–µ –Ω–µ –∏—Å—Ç–µ–∫–ª–æ
                console.log(`[DEBUG] –ö–æ–Ω–∫—É—Ä—Å ${c.id}: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ - isParticipating=${isParticipating}, canUpload=${canUpload}, hasSubmitted=${hasSubmitted}, isSubmissionPeriodActive=${isSubmissionPeriodActive}, isDrawingContest=${isDrawingContest}`);
                if (isParticipating === true && canUpload && !hasSubmitted && isSubmissionPeriodActive && isDrawingContest) {
                  console.log(`[DEBUG] –ö–æ–Ω–∫—É—Ä—Å ${c.id}: –£—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ`);
                  // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ DOM
                  setTimeout(() => {
                    const photoInput = document.getElementById(`photo-input-${c.id}`);
                    const uploadBtn = document.getElementById(`upload-photo-btn-${c.id}`);
                    
                    console.log(`[DEBUG] –ö–æ–Ω–∫—É—Ä—Å ${c.id}: photoInput=${!!photoInput}, uploadBtn=${!!uploadBtn}`);
                    
                    if (uploadBtn && photoInput) {
                      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞)
                      const newUploadBtn = uploadBtn.cloneNode(true);
                      uploadBtn.parentNode.replaceChild(newUploadBtn, uploadBtn);
                      const newPhotoInput = photoInput.cloneNode(true);
                      photoInput.parentNode.replaceChild(newPhotoInput, photoInput);
                      
                      // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                      const freshUploadBtn = document.getElementById(`upload-photo-btn-${c.id}`);
                      const freshPhotoInput = document.getElementById(`photo-input-${c.id}`);
                      
                      // label –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç input –ø—Ä–∏ –∫–ª–∏–∫–µ, –ø–æ—ç—Ç–æ–º—É –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫–µ –Ω–µ –Ω—É–∂–µ–Ω
                      // –ù–æ –¥–æ–±–∞–≤–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
                      if (freshUploadBtn) {
                        freshUploadBtn.addEventListener('click', () => {
                          console.log(`[DEBUG] –ö–ª–∏–∫ –ø–æ label/–∫–Ω–æ–ø–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞ ${c.id}`);
                        });
                      }
                      
                      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ input
                      freshPhotoInput.addEventListener('change', async (e) => {
                        console.log(`[DEBUG] –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞ ${c.id}`);
                        const file = e.target.files[0];
                        if (!file) {
                          console.log(`[DEBUG] –§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω`);
                          return;
                        }
                        
                        console.log(`[DEBUG] –í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${file.name}, —Ç–∏–ø: ${file.type}, —Ä–∞–∑–º–µ—Ä: ${file.size}`);
                        
                        if (!file.type.startsWith('image/')) {
                          alert('‚ö†Ô∏è –§–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º');
                          return;
                        }
                        
                        if (file.size > 10 * 1024 * 1024) {
                          alert('‚ö†Ô∏è –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 10 –ú–ë');
                          return;
                        }
                        
                        freshUploadBtn.disabled = true;
                        freshUploadBtn.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
                        
                        try {
                          // –ü–æ–ª—É—á–∞–µ–º currentUserId –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∏–ª–∏ Telegram WebApp
                          const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || window.currentUserId;
                          if (!userId) {
                            alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                            return;
                          }
                          
                          console.log(`[DEBUG] –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ñ–æ—Ç–æ –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞ ${c.id}, user_id=${userId}`);
                          const formData = new FormData();
                          formData.append('file', file);
                          formData.append('user_id', userId);
                          formData.append('user_username', window.Telegram?.WebApp?.initDataUnsafe?.user?.username || '');
                          
                          console.log(`[DEBUG] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ /api/contests/${c.id}/upload-photo`);
                          const response = await fetch(`/api/contests/${c.id}/upload-photo`, {
                            method: 'POST',
                            body: formData
                          });
                          
                          console.log(`[DEBUG] –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç: status=${response.status}, ok=${response.ok}`);
                          
                          let result;
                          // –ö–ª–æ–Ω–∏—Ä—É–µ–º response –ø–µ—Ä–µ–¥ —á—Ç–µ–Ω–∏–µ–º, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ
                          const responseClone = response.clone();
                          
                          if (!response.ok) {
                            // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ OK, —á–∏—Ç–∞–µ–º —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –∏–∑ –∫–ª–æ–Ω–∞
                            try {
                              const errorText = await responseClone.text();
                              throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}. ${errorText}`);
                            } catch (textError) {
                              throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`);
                            }
                          }
                          
                          try {
                            result = await response.json();
                            console.log(`[DEBUG] –†–µ–∑—É–ª—å—Ç–∞—Ç:`, result);
                          } catch (jsonError) {
                            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', jsonError);
                            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –ø—Ä–æ–±—É–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç –∏–∑ –∫–ª–æ–Ω–∞
                            try {
                              const text = await responseClone.text();
                              throw new Error(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞: ${text}`);
                            } catch (textError) {
                              throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`);
                            }
                          }
                          
                          if (response.ok && result.success) {
                            alert('‚úÖ ' + result.message);
                            await window.loadContests(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—É—Ä—Å–æ–≤
                          } else {
                            const errorMsg = result.detail || result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏';
                            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ:', result);
                            alert('‚ùå ' + errorMsg);
                          }
                        } catch (error) {
                          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏:', error);
                          alert('‚ùå ' + (error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏'));
                        } finally {
                          freshUploadBtn.disabled = false;
                          freshUploadBtn.textContent = 'üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é';
                          freshPhotoInput.value = '';
                        }
                      });
                    } else {
                      console.error(`[DEBUG] –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞ ${c.id}: photoInput=${!!photoInput}, uploadBtn=${!!uploadBtn}`);
                    }
                  }, 200);
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç)
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–æ–∑–º–æ–∂–Ω–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –µ—â–µ –Ω–µ –∏—Å—Ç–µ–∫–ª–æ
                if (isParticipating === true && canUpload && !hasCollection && isSubmissionPeriodActive && isCollectionContest) {
                  setTimeout(() => {
                    const submitCollectionBtn = document.getElementById(`submit-collection-btn-${c.id}`);
                    if (submitCollectionBtn) {
                      submitCollectionBtn.addEventListener('click', () => {
                        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (–±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ)
                        window.openCollectionSubmissionModal(c.id);
                      });
                    }
                  }, 100);
                }
              } catch (error) {
                console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞:', error);
                // –í —Å–ª—É—á–∞–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏ (–Ω–µ —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å API) –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                // –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å", –µ—Å–ª–∏ –≤—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –µ—â–µ –Ω–µ –∏—Å—Ç–µ–∫–ª–æ
                try {
                  const submissionEndDate = c.submission_end_date;
                  const now = new Date();
                  let errorHtml = '';
                  
                  if (submissionEndDate) {
                    const endDate = new Date(submissionEndDate);
                    
                    if (now.getTime() <= endDate.getTime()) {
                      // –í—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –µ—â–µ –Ω–µ –∏—Å—Ç–µ–∫–ª–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
                      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç
                      const timeMessage = `‚è∞ –ü—Ä–∏–µ–º —Ä–∞–±–æ—Ç –¥–æ: ${toMoscowDateTime(endDate)}`;
                      errorHtml = `
                        ${timeMessage ? `<div class="text-xs text-gray-500 mb-2">${timeMessage}</div>` : ''}
                        <button id="participate-btn-${c.id}" class="neon-button w-full py-2 rounded-lg text-sm font-semibold">
                          ‚ú® –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å
                        </button>
                      `;
                    } else {
                      // –í—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –∏—Å—Ç–µ–∫–ª–æ
                      errorHtml = `
                        <div class="text-sm text-gray-400 mb-2">‚è∞ –í—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –∏—Å—Ç–µ–∫–ª–æ</div>
                        <div class="text-xs text-gray-500 mb-2">‚è∞ –ü—Ä–∏–µ–º —Ä–∞–±–æ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω: ${toMoscowDateTime(endDate)}</div>
                      `;
                    }
                  } else {
                    // –ï—Å–ª–∏ deadline –Ω–µ —É–∫–∞–∑–∞–Ω, –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                    errorHtml = `
                      <div class="text-sm text-gray-400 mb-2">‚è∞ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</div>
                    `;
                  }
                  
                  photoSection.innerHTML = errorHtml;
                  
                  // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                  if (submissionEndDate) {
                    const now = new Date();
                    const endDate = new Date(submissionEndDate);
                    if (now.getTime() <= endDate.getTime()) {
                      setTimeout(() => {
                        const participateBtn = document.getElementById(`participate-btn-${c.id}`);
                        if (participateBtn) {
                          participateBtn.addEventListener('click', async () => {
                            participateBtn.disabled = true;
                            participateBtn.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
                            
                            try {
                              const username = window.Telegram?.WebApp?.initDataUnsafe?.user?.username || '';
                              const response = await window.fetchJSON(`/api/contests/${c.id}/participate`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                  user_id: currentUserId,
                                  username: username
                                })
                              });
                              
                              if (response.success) {
                                // –£—Å–ø–µ—à–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–Ω–∫—É—Ä—Å—É —Ä–∏—Å—É–Ω–∫–æ–≤
                                // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert, —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º UI, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
                                const participantsCountEl = document.getElementById(`participants-count-${c.id}`);
                                if (participantsCountEl) {
                                  const newCount = parseInt(participantsCountEl.textContent) + 1;
                                  participantsCountEl.textContent = newCount;
                                }
                                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—É—Ä—Å–æ–≤, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
                                await window.loadContests();
                              } else if (response.requires_subscription && response.not_subscribed) {
                                window.showSubscriptionModal(c.id, response.not_subscribed, currentUserId, username);
                                participateBtn.disabled = false;
                                participateBtn.textContent = '‚ú® –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å';
                              } else {
                                alert('‚ùå ' + (response.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ –∫ –∫–æ–Ω–∫—É—Ä—Å—É'));
                                participateBtn.disabled = false;
                                participateBtn.textContent = '‚ú® –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å';
                              }
                            } catch (error) {
                              console.error('–û—à–∏–±–∫–∞ —É—á–∞—Å—Ç–∏—è –≤ –∫–æ–Ω–∫—É—Ä—Å–µ:', error);
                              let errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ –∫ –∫–æ–Ω–∫—É—Ä—Å—É';
                              let shouldReload = false;
                              
                              try {
                                const errorResponse = await error.response?.json();
                                if (errorResponse?.detail) {
                                  errorMessage = errorResponse.detail;
                                  // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –∏—Å—Ç–µ–∫—à–∏–º deadline, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—É—Ä—Å–æ–≤
                                  if (errorResponse.detail.includes('–í—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ä–∞–±–æ—Ç –∏—Å—Ç–µ–∫–ª–æ') || 
                                      errorResponse.detail.includes('–∏—Å—Ç–µ–∫–ª–æ')) {
                                    shouldReload = true;
                                  }
                                } else if (errorResponse?.message) {
                                  errorMessage = errorResponse.message;
                                }
                              } catch (e) {
                                if (error.message) {
                                  errorMessage = error.message;
                                }
                              }
                              
                              alert('‚ùå ' + errorMessage);
                              
                              // –ï—Å–ª–∏ deadline –∏—Å—Ç–µ–∫, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—É—Ä—Å–æ–≤, —á—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É
                              if (shouldReload) {
                                await window.loadContests();
                              } else {
                                participateBtn.disabled = false;
                                participateBtn.textContent = '‚ú® –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å';
                              }
                            }
                          });
                        }
                      }, 100);
                    }
                  }
                } catch (innerError) {
                  console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—à–∏–±–∫–∏:', innerError);
                  // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
                  photoSection.innerHTML = `
                    <button id="participate-btn-${c.id}" class="neon-button w-full py-2 rounded-lg text-sm font-semibold">
                      ‚ú® –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å
                    </button>
                  `;
                }
              }
            })();
            
            card.appendChild(photoSection);
          }
          
          contestList.appendChild(card);
          
          // –ê–Ω–∏–º–∏—Ä—É–µ–º –ø–æ—è–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
          setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
          }, 10);
        });
        } catch (e) {
          contestList.innerHTML = '<div class="text-red-400 text-center py-4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω–∫—É—Ä—Å–æ–≤</div>';
        }
      }

      // ‚≠ê –°–∏—Å—Ç–µ–º–∞ –æ–ø—ã—Ç–∞ –∏ —É—Ä–æ–≤–Ω–µ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      // –£—Ä–æ–≤–Ω–∏: 1 (0-100), 2 (100-300), 3 (300-600), 4 (600-1000), 5 (1000+)
      function getLevelInfo(experience) {
        const levels = [
          { level: 1, minExp: 0, maxExp: 100 },
          { level: 2, minExp: 100, maxExp: 300 },
          { level: 3, minExp: 300, maxExp: 600 },
          { level: 4, minExp: 600, maxExp: 1000 },
          { level: 5, minExp: 1000, maxExp: Infinity }
        ];
        
        for (const levelInfo of levels) {
          if (experience >= levelInfo.minExp && experience < levelInfo.maxExp) {
            return {
              level: levelInfo.level,
              currentExp: experience - levelInfo.minExp,
              maxExp: levelInfo.maxExp === Infinity ? experience : levelInfo.maxExp - levelInfo.minExp,
              nextLevelExp: levelInfo.maxExp
            };
          }
        }
        
        // –ï—Å–ª–∏ –æ–ø—ã—Ç –±–æ–ª—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –¥–ª—è —É—Ä–æ–≤–Ω—è 5
        return {
          level: 5,
          currentExp: experience - 1000,
          maxExp: experience - 1000,
          nextLevelExp: experience
        };
      }

      function updateUserExperienceUI(experience, contestsParticipated, contestsWon) {
        const levelInfo = getLevelInfo(experience);
        const progressPercent = levelInfo.maxExp > 0 
          ? Math.min(100, (levelInfo.currentExp / levelInfo.maxExp) * 100)
          : 0;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ —É—Ä–æ–≤–Ω—è
        const levelBadge = document.getElementById('level-badge');
        if (levelBadge) {
          levelBadge.textContent = `–£—Ä–æ–≤–µ–Ω—å ${levelInfo.level}`;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –æ–ø—ã—Ç
        const currentExpEl = document.getElementById('current-experience');
        if (currentExpEl) {
          currentExpEl.textContent = experience;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–æ—Å–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        const progressBar = document.getElementById('experience-progress-bar');
        if (progressBar) {
          progressBar.style.width = `${progressPercent}%`;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã —É—Ä–æ–≤–Ω—è
        const currentLevelExp = document.getElementById('current-level-exp');
        const nextLevelExp = document.getElementById('next-level-exp');
        if (currentLevelExp) {
          currentLevelExp.textContent = levelInfo.currentExp;
        }
        if (nextLevelExp) {
          nextLevelExp.textContent = levelInfo.nextLevelExp === Infinity ? '‚àû' : levelInfo.nextLevelExp;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        const contestsParticipatedEl = document.getElementById('contests-participated');
        const contestsWonEl = document.getElementById('contests-won');
        if (contestsParticipatedEl) {
          contestsParticipatedEl.textContent = contestsParticipated;
        }
        if (contestsWonEl) {
          contestsWonEl.textContent = contestsWon;
        }
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø—ã—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
      async function loadUserExperience(userId) {
        try {
          // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Å –æ–ø—ã—Ç–æ–º –∏–∑ API
          const profile = await window.fetchJSON(`/api/profile?tg_id=${userId}`);
          
          const experience = profile.experience || 0;
          const contestsParticipated = profile.contests_participated || 0;
          const contestsWon = profile.contests_won || 0;
          
          updateUserExperienceUI(experience, contestsParticipated, contestsWon);
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø—ã—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
          updateUserExperienceUI(0, 0, 0);
        }
      }

      // Profile - –¥–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ
      window.loadProfile = async function() {
        try {
          const params = new URLSearchParams(window.location.search);
          const tgId = params.get('tg_id');
          const p = await window.fetchJSON(`/api/profile?tg_id=${tgId || ''}`);
          
          const usernameEl = document.getElementById('profile-username');
          if (usernameEl) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º username –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ —Ä–æ–ª—å
            if (p.username) {
              usernameEl.textContent = p.username;
            } else {
              const role = p.status || p.role || 'user';
              usernameEl.textContent = role === 'user' ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' : role;
            }
          }
          const profileIdEl = document.getElementById('profile-id');
          if (profileIdEl && p.id) profileIdEl.textContent = p.id;
          if (p.first_login) document.getElementById('profile-first-login').textContent = toMoscowDateTime(p.first_login);
          if (p.status) document.getElementById('profile-status').textContent = p.status;
          
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø—ã—Ç –∏ —É—Ä–æ–≤–Ω–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          if (tgId) {
            await loadUserExperience(parseInt(tgId));
          }
          
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å Monkey Coins
          await updateCoinsDisplay();
          
          // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å Pro –ø–æ–¥–ø–∏—Å–∫–∏
          await loadProSubscriptionStatus();
        } catch (e) {
          const params = new URLSearchParams(window.location.search);
          const pid = params.get('tg_id');
          const puser = params.get('username');
          const prole = params.get('role');
          
          if (pid && !document.getElementById('profile-id').textContent) {
            document.getElementById('profile-id').textContent = pid;
          }
          const usernameEl = document.getElementById('profile-username');
          if (usernameEl && !usernameEl.textContent) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º username –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–ª–∏ —Ä–æ–ª—å
            if (puser) {
              usernameEl.textContent = puser;
            } else {
              const role = prole || 'user';
              usernameEl.textContent = role === 'user' ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' : role;
            }
          }
          if (prole) {
            document.getElementById('profile-status').textContent = prole;
          }
        }
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Pro –ø–æ–¥–ø–∏—Å–∫–∏
      async function loadProSubscriptionStatus() {
        try {
          const params = new URLSearchParams(window.location.search);
          const tgId = params.get('tg_id');
          
          if (!tgId) return;
          
          const subscription = await window.fetchJSON(`/api/profile/pro-subscription?tg_id=${tgId}`);
          
          const statusEl = document.getElementById('pro-subscription-status');
          const infoEl = document.getElementById('pro-subscription-info');
          const activateBtn = document.getElementById('activate-pro-btn');
          const endDateEl = document.getElementById('pro-subscription-end');
          const contestsCountEl = document.getElementById('pro-contests-count');
          
          if (subscription.active) {
            if (statusEl) statusEl.textContent = '–ê–∫—Ç–∏–≤–Ω–∞';
            if (infoEl) infoEl.classList.remove('hidden');
            if (activateBtn) activateBtn.textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
            if (endDateEl && subscription.end_date) {
              const endDate = new Date(subscription.end_date);
              endDateEl.textContent = endDate.toLocaleDateString('ru-RU', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              });
            }
            if (contestsCountEl) {
              contestsCountEl.textContent = subscription.contests_created || 0;
            }
          } else {
            if (statusEl) statusEl.textContent = subscription.has_subscription ? '–ò—Å—Ç–µ–∫–ª–∞' : '–ù–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞';
            if (infoEl) infoEl.classList.add('hidden');
            if (activateBtn) activateBtn.textContent = '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å';
          }
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö
          window.proSubscriptionActive = subscription.active;
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏:', e);
        }
      }

      // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω –∫–æ–Ω–∫—É—Ä—Å–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      async function updateUserContestTypePrices() {
        try {
          const params = new URLSearchParams(window.location.search);
          const tgId = params.get('tg_id');
          
          if (!tgId) return;
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å Pro –ø–æ–¥–ø–∏—Å–∫–∏
          const subscription = await window.fetchJSON(`/api/profile/pro-subscription?tg_id=${tgId}`);
          const isProActive = subscription.active || false;
          
          const balanceEl = document.getElementById('user-contest-type-selection-balance');
          const balanceValueEl = document.getElementById('user-contest-type-selection-balance-value');
          
          if (isProActive) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–ª–∞–Ω—Å –¥–ª—è Pro –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            if (balanceEl) balanceEl.classList.remove('hidden');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å
            try {
              const balanceResponse = await window.fetchJSON(`/api/profile/monkey-coins?tg_id=${tgId}`);
              const balance = balanceResponse?.monkey_coins || 0;
              if (balanceValueEl) {
                balanceValueEl.innerHTML = `${balance} <img src="monkeyscoin.png" alt="Monkey Coin" class="w-4 h-4 object-contain inline">`;
              }
            } catch (error) {
              console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –º–æ–¥–∞–ª–∫–∏:', error);
            }
          } else {
            if (balanceEl) balanceEl.classList.add('hidden');
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω –∫–æ–Ω–∫—É—Ä—Å–æ–≤:', error);
        }
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      const userCreateContestBtn = document.getElementById('user-create-contest-btn');
      if (userCreateContestBtn) {
        userCreateContestBtn.addEventListener('click', () => {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –∫–æ–Ω–∫—É—Ä—Å–∞
          const contestTypeModal = document.getElementById('user-contest-type-selection-modal');
          if (contestTypeModal) {
            contestTypeModal.classList.remove('hidden');
            document.body.classList.add('modal-open');
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—ã –¥–ª—è Pro –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            updateUserContestTypePrices();
          }
        });
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –∫–æ–Ω–∫—É—Ä—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      const userContestTypeModal = document.getElementById('user-contest-type-selection-modal');
      const closeUserContestTypeModal = document.getElementById('close-user-contest-type-selection-modal');
      
      if (closeUserContestTypeModal && userContestTypeModal) {
        closeUserContestTypeModal.addEventListener('click', () => {
          userContestTypeModal.classList.add('hidden');
          document.body.classList.remove('modal-open');
        });
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –∫–æ–Ω–∫—É—Ä—Å–∞ - –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –º–æ–¥–∞–ª–∫–∏
      // (–ú–æ–¥–∞–ª–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–æ–≤ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –∏–∑ admin.html)
      const userSelectRandomContest = document.getElementById('user-select-random-comment-contest');
      const userSelectDrawingContest = document.getElementById('user-select-drawing-contest');
      const userSelectCollectionContest = document.getElementById('user-select-collection-contest');
      
      if (userSelectRandomContest) {
        userSelectRandomContest.addEventListener('click', () => {
          // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞
          if (userContestTypeModal) {
            userContestTypeModal.classList.add('hidden');
          }
          // TODO: –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞ —Ä–∞–Ω–¥–æ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
          // (–ù—É–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–∞–ª–∫—É contest-modal –∏–∑ admin.html)
          alert('–ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞');
        });
      }
      
      if (userSelectDrawingContest) {
        userSelectDrawingContest.addEventListener('click', () => {
          // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞
          if (userContestTypeModal) {
            userContestTypeModal.classList.add('hidden');
          }
          // TODO: –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞ —Ä–∏—Å—É–Ω–∫–æ–≤
          // (–ù—É–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–∞–ª–∫—É drawing-contest-modal –∏–∑ admin.html)
          alert('–ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞');
        });
      }
      
      if (userSelectCollectionContest) {
        userSelectCollectionContest.addEventListener('click', () => {
          // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞
          if (userContestTypeModal) {
            userContestTypeModal.classList.add('hidden');
          }
          // TODO: –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–π
          // (–ù—É–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–∞–ª–∫—É collection-contest-modal –∏–∑ admin.html)
          alert('–ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞');
        });
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è Pro –ø–æ–¥–ø–∏—Å–∫–∏
      const activateProBtn = document.getElementById('activate-pro-btn');
      const proModal = document.getElementById('pro-subscription-modal');
      const closeProModal = document.getElementById('close-pro-modal');
      const confirmProActivation = document.getElementById('confirm-pro-activation');
      
      if (activateProBtn) {
        activateProBtn.addEventListener('click', () => {
          if (proModal) {
            proModal.classList.remove('hidden');
            document.body.classList.add('modal-open');
          }
        });
      }
      
      if (closeProModal && proModal) {
        closeProModal.addEventListener('click', () => {
          proModal.classList.add('hidden');
          document.body.classList.remove('modal-open');
        });
      }
      
      if (confirmProActivation) {
        confirmProActivation.addEventListener('click', async () => {
          const params = new URLSearchParams(window.location.search);
          const tgId = params.get('tg_id');
          
          if (!tgId) {
            alert('‚ùå –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            return;
          }
          
          const channelLink = document.getElementById('pro-channel-link')?.value.trim();
          const chatLink = document.getElementById('pro-chat-link')?.value.trim();
          
          if (!channelLink) {
            alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞–Ω–∞–ª');
            return;
          }
          
          try {
            const response = await window.fetchJSON('/api/profile/activate-pro-subscription', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                tg_id: parseInt(tgId),
                channel_link: channelLink,
                chat_link: chatLink || ''
              })
            });
            
            if (response.success) {
              alert(response.message);
              if (proModal) {
                proModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
              }
              // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
              document.getElementById('pro-channel-link').value = '';
              document.getElementById('pro-chat-link').value = '';
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
              await loadProSubscriptionStatus();
              await updateCoinsDisplay();
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—É—Ä—Å–æ–≤ (—á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è)
              if (typeof window.loadContests === 'function') {
                await window.loadContests();
              }
            } else {
              alert(response.message || '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏');
            }
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏:', e);
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          }
        });
      }

      // Rating - –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞
      let currentRatingRole = 'user';
      
      window.loadRating = async function(role = 'user') {
        try {
          currentRatingRole = role;
          const ratingList = document.getElementById('rating-list');
          if (!ratingList) return;
          
          ratingList.innerHTML = '<div class="text-center text-gray-400 py-8">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</div>';
          
          const response = await window.fetchJSON(`/api/rating?role=${role}`);
          
          if (!response.success || !response.ratings) {
            ratingList.innerHTML = '<div class="text-center text-red-400 py-8">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞</div>';
            return;
          }
          
          const ratings = response.ratings;
          if (ratings.length === 0) {
            ratingList.innerHTML = '<div class="text-center text-gray-400 py-8">–†–µ–π—Ç–∏–Ω–≥ –ø—É—Å—Ç</div>';
            return;
          }
          
          let html = '';
          ratings.forEach((item) => {
            const avatarHtml = item.avatar_url 
              ? `<img src="${item.avatar_url}" alt="${item.username}" class="w-10 h-10 rounded-full object-cover" />`
              : `<div class="w-10 h-10 rounded-full bg-gradient-to-br from-violet-500 to-pink-500 flex items-center justify-center text-lg font-bold">${item.username ? item.username.charAt(0).toUpperCase() : '?'}</div>`;
            
            html += `
              <div class="rounded-lg border border-violet-400/30 p-4 bg-black/30 flex items-center gap-3">
                <div class="text-2xl font-bold text-violet-400 w-10 text-center flex-shrink-0">${item.place}</div>
                <div class="w-10 h-10 flex-shrink-0 flex items-center justify-center">${avatarHtml}</div>
                <div class="flex-1 min-w-0">
                  <div class="font-semibold text-white truncate">${item.username || `User_${item.telegram_id}`}</div>
                  <div class="text-sm text-gray-400 whitespace-nowrap">–ü–æ–±–µ–¥: ${item.wins} | –£—á–∞—Å—Ç–∏–π: ${item.participations}</div>
                </div>
                <div class="text-right flex-shrink-0 w-20">
                  <div class="text-xl font-bold text-violet-400">${item.rating}</div>
                  <div class="text-xs text-gray-400">—Ä–µ–π—Ç–∏–Ω–≥</div>
                </div>
              </div>
            `;
          });
          
          ratingList.innerHTML = html;
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞:', e);
          const ratingList = document.getElementById('rating-list');
          if (ratingList) {
            ratingList.innerHTML = '<div class="text-center text-red-400 py-8">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞</div>';
          }
        }
      };
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞
      setTimeout(function() {
        const usersBtn = document.getElementById('rating-users-btn');
        const adminsBtn = document.getElementById('rating-admins-btn');
        
        if (usersBtn) {
          usersBtn.addEventListener('click', () => {
            usersBtn.classList.add('active');
            if (adminsBtn) adminsBtn.classList.remove('active');
            window.loadRating('user');
          });
        }
        
        if (adminsBtn) {
          adminsBtn.addEventListener('click', () => {
            adminsBtn.classList.add('active');
            if (usersBtn) usersBtn.classList.remove('active');
            window.loadRating('admin');
          });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º–∏ –∫–æ–Ω–∫—É—Ä—Å–∞–º–∏
        const activeContestsBtn = document.getElementById('contests-active-btn');
        const completedContestsBtn = document.getElementById('contests-completed-btn');
        
        if (activeContestsBtn) {
          activeContestsBtn.addEventListener('click', () => {
            activeContestsBtn.classList.add('active');
            if (completedContestsBtn) completedContestsBtn.classList.remove('active');
            window.loadContests(false, 'active');
          });
        }
        
        if (completedContestsBtn) {
          completedContestsBtn.addEventListener('click', () => {
            completedContestsBtn.classList.add('active');
            if (activeContestsBtn) activeContestsBtn.classList.remove('active');
            window.loadContests(false, 'completed');
          });
        }
      }, 1000);

      // First-login marker
      try {
        if (!localStorage.getItem('first_login_ts')) {
          const ts = new Date().toISOString();
          localStorage.setItem('first_login_ts', ts);
          fetch('/api/profile/first_login', { method: 'POST' }).catch(() => {});
        }
        const stored = localStorage.getItem('first_login_ts');
        if (stored) document.getElementById('profile-first-login').textContent = toMoscowDateTime(stored);
      } catch (e) {}

      // Contact owner functionality - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞ –ø–∞–Ω–µ–ª–∏
      function setupContactOwnerHandlers() {
        const contactOwnerBtn = document.getElementById('contact-owner-btn');
        const contactOwnerModal = document.getElementById('contact-owner-modal');
        const closeContactModal = document.getElementById('close-contact-modal');
        const sendContactMessage = document.getElementById('send-contact-message');

        function openModal(el) { 
          if (!el) return;
          el.classList.remove('hidden');
          // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –º–æ–¥–∞–ª–∫–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞
          el.style.pointerEvents = 'auto';
          el.style.zIndex = '30';
          // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã
          const clickableElements = el.querySelectorAll('button, input, textarea, a, select');
          clickableElements.forEach(elem => {
            elem.style.pointerEvents = 'auto';
            elem.style.zIndex = '1';
          });
          // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª body
          document.body.classList.add('modal-open');
        }
        function closeModal(el) { 
          if (!el) return;
          el.classList.add('hidden');
          // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª body
          document.body.classList.remove('modal-open');
        }

        if (contactOwnerBtn) {
          // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
          const newBtn = contactOwnerBtn.cloneNode(true);
          contactOwnerBtn.parentNode.replaceChild(newBtn, contactOwnerBtn);
          
          newBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('‚úÖ –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ "–°–≤—è–∑—å —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º"');
            if (contactOwnerModal) {
              openModal(contactOwnerModal);
            }
          });
        }

        if (closeContactModal) {
          // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
          const newCloseBtn = closeContactModal.cloneNode(true);
          closeContactModal.parentNode.replaceChild(newCloseBtn, closeContactModal);
          
          newCloseBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeModal(contactOwnerModal);
            const messageInput = document.getElementById('contact-message-text');
            if (messageInput) messageInput.value = '';
          });
        }

        if (sendContactMessage) {
          // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
          const newSendBtn = sendContactMessage.cloneNode(true);
          sendContactMessage.parentNode.replaceChild(newSendBtn, sendContactMessage);
          
          newSendBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            const messageInput = document.getElementById('contact-message-text');
            if (!messageInput) return;
            
            const messageText = messageInput.value.trim();
            if (!messageText) {
              alert('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
              return;
            }

            if (!currentUserId) {
              alert('‚ö†Ô∏è –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
              return;
            }

            try {
              await window.fetchJSON('/api/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  from_user_id: currentUserId,
                  message_text: messageText
                })
              });
              alert('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤–ª–∞–¥–µ–ª—å—Ü—É!');
              closeModal(contactOwnerModal);
              messageInput.value = '';
            } catch (e) {
              console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', e);
              alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
            }
          });
        }
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –Ω–µ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏/—á–∞—Ç–∞–º–∏
      // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ
      window.showSubscriptionModal = function(contestId, notSubscribed, userId, username) {
        const modalEl = document.getElementById('subscription-modal');
        const listEl = document.getElementById('subscription-list');
        const verifyBtn = document.getElementById('verify-subscription-btn');
        const closeBtn = document.getElementById('close-subscription-modal');
        
        if (!modalEl || !listEl || !verifyBtn || !closeBtn) {
          console.error('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
          return;
        }
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤/—á–∞—Ç–æ–≤
        listEl.innerHTML = notSubscribed.map(sub => {
          const link = sub.link.startsWith('http') ? sub.link : `https://${sub.link}`;
          return `
            <div class="subscription-item p-3 rounded-lg border border-violet-400/30 bg-black/30" data-username="${sub.username}">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-white font-semibold">${sub.name}</div>
                  <div class="text-gray-400 text-sm">${sub.type === 'channel' ? 'üì¢ –ö–∞–Ω–∞–ª' : 'üí¨ –ß–∞—Ç'}</div>
                </div>
                <a href="${link}" target="_blank" class="neon-button px-4 py-2 rounded-lg text-sm font-semibold text-white">
                  –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                </a>
              </div>
            </div>
          `;
        }).join('');
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –∑–∞–º–µ–Ω—è—è –∫–Ω–æ–ø–∫–∏
        const newVerifyBtn = verifyBtn.cloneNode(true);
        verifyBtn.parentNode.replaceChild(newVerifyBtn, verifyBtn);
        const newCloseBtn = closeBtn.cloneNode(true);
        closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–í—ã–ø–æ–ª–Ω–∏–ª"
        newVerifyBtn.onclick = async () => {
          newVerifyBtn.disabled = true;
          newVerifyBtn.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
          
          try {
            const response = await window.fetchJSON(`/api/contests/${contestId}/verify-subscription`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                user_id: userId,
                username: username
              })
            });
            
            if (response.success) {
              // –£—Å–ø–µ—à–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–Ω–∫—É—Ä—Å—É —Ä–∏—Å—É–Ω–∫–æ–≤
              // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
              modalEl.classList.add('hidden');
              
              // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞ —Ä–∏—Å—É–Ω–∫–æ–≤
              const participantsCountEl = document.getElementById(`participants-count-${contestId}`);
              if (participantsCountEl) {
                const currentCount = parseInt(participantsCountEl.textContent) || 0;
                participantsCountEl.textContent = currentCount + 1;
              }
              
              // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—É—Ä—Å–æ–≤, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
              // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —É—á–∞—Å—Ç–Ω–∏–∫–∞
              await window.loadContests();
            } else {
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–µ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤/—á–∞—Ç–æ–≤, –≤—ã–¥–µ–ª—è—è –∏—Ö –∫—Ä–∞—Å–Ω—ã–º
              const items = listEl.querySelectorAll('.subscription-item');
              items.forEach(item => {
                item.classList.remove('border-red-500', 'bg-red-900/20');
                const nameEl = item.querySelector('.text-white');
                if (nameEl) {
                  nameEl.classList.remove('text-red-400');
                }
              });
              
              if (response.not_subscribed && response.not_subscribed.length > 0) {
                response.not_subscribed.forEach(notSub => {
                  const item = Array.from(items).find(el => el.dataset.username === notSub.username);
                  if (item) {
                    item.classList.add('border-red-500', 'bg-red-900/20');
                    const nameEl = item.querySelector('.text-white');
                    if (nameEl) {
                      nameEl.classList.add('text-red-400');
                    }
                  }
                });
                alert('‚ùå –í—ã –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–∞–Ω–∞–ª—ã –∏ —á–∞—Ç—ã. –û–Ω–∏ –≤—ã–¥–µ–ª–µ–Ω—ã –∫—Ä–∞—Å–Ω—ã–º —Ü–≤–µ—Ç–æ–º.');
              } else {
                alert('‚ùå ' + (response.message || '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏'));
              }
            }
          } catch (e) {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (e.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É'));
          } finally {
            newVerifyBtn.disabled = false;
            newVerifyBtn.textContent = '‚úì –í—ã–ø–æ–ª–Ω–∏–ª';
          }
        };
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û—Ç–º–µ–Ω–∞"
        newCloseBtn.onclick = () => {
          modalEl.classList.add('hidden');
        };
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        modalEl.classList.remove('hidden');
      }
      
      // üñºÔ∏è –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª–æ–∫ –∫–æ–ª–ª–µ–∫—Ü–∏–π NFT
      let currentCollectionContestId = null;
      let collectionNftLinks = [];
      let collectionNftOrder = [0, 1, 2, 3, 4, 5, 6, 7, 8]; // –ü–æ—Ä—è–¥–æ–∫ NFT –≤ —Å–µ—Ç–∫–µ
      let draggedElement = null;
      let draggedIndex = null;
      
      // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è touch —Å–æ–±—ã—Ç–∏–π (–º–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)
      let touchStartElement = null;
      let touchStartIndex = null;
      let touchStartX = null;
      let touchStartY = null;
      let touchCurrentElement = null;
      let touchGhostElement = null;

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ –≤–≤–æ–¥–∞ —Å—Å—ã–ª–æ–∫ –Ω–∞ NFT
      window.openCollectionSubmissionModal = function(contestId) {
        currentCollectionContestId = contestId;
        collectionNftLinks = [];
        collectionNftOrder = [0, 1, 2, 3, 4, 5, 6, 7, 8];
        
        const linksModal = document.getElementById('collection-links-modal');
        const inputsContainer = document.getElementById('collection-links-inputs');
        const continueBtn = document.getElementById('collection-links-continue');
        const enteredCount = document.getElementById('collection-links-entered');
        const errorEl = document.getElementById('collection-links-error');
        
        if (!linksModal || !inputsContainer) {
          console.error('–ú–æ–¥–∞–ª–∫–∞ –≤–≤–æ–¥–∞ —Å—Å—ã–ª–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
          return;
        }
        
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø–æ–ª—è –≤–≤–æ–¥–∞
        inputsContainer.innerHTML = '';
        errorEl.classList.add('hidden');
        errorEl.textContent = '';
        
        // –°–æ–∑–¥–∞–µ–º 9 –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
        for (let i = 0; i < 9; i++) {
          const inputWrapper = document.createElement('div');
          inputWrapper.className = 'flex items-center gap-2';
          inputWrapper.innerHTML = `
            <label class="text-sm text-gray-400 w-8 flex-shrink-0">${i + 1}.</label>
            <input 
              type="text" 
              id="nft-link-${i}" 
              class="flex-1 bg-black/40 border border-violet-400/30 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:border-violet-400 focus:outline-none"
              placeholder="t.me/nft/–Ω–∞–∑–≤–∞–Ω–∏–µ-–Ω–æ–º–µ—Ä"
              data-index="${i}"
            />
            <div id="nft-link-status-${i}" class="w-6 h-6 flex items-center justify-center"></div>
          `;
          inputsContainer.appendChild(inputWrapper);
          
          // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
          const input = inputWrapper.querySelector(`#nft-link-${i}`);
          const statusEl = inputWrapper.querySelector(`#nft-link-status-${i}`);
          
          input.addEventListener('input', function() {
            validateNftLink(i);
            updateContinueButton();
          });
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
        enteredCount.textContent = '0';
        continueBtn.disabled = true;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
        linksModal.classList.remove('hidden');
        document.body.classList.add('modal-open');
      };

      // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ NFT
      function validateNftLink(index) {
        const input = document.getElementById(`nft-link-${index}`);
        const statusEl = document.getElementById(`nft-link-status-${index}`);
        const errorEl = document.getElementById('collection-links-error');
        
        if (!input || !statusEl) return;
        
        const link = input.value.trim();
        const nftLinkPattern = /^t\.me\/nft\/[a-zA-Z0-9_-]+$/;
        
        if (!link) {
          statusEl.innerHTML = '';
          collectionNftLinks[index] = null;
          errorEl.classList.add('hidden');
          return;
        }
        
        if (nftLinkPattern.test(link)) {
          statusEl.innerHTML = '<span class="text-green-400 text-xl">‚úì</span>';
          collectionNftLinks[index] = link;
          errorEl.classList.add('hidden');
          input.classList.remove('border-red-400');
          input.classList.add('border-green-400/50');
        } else {
          statusEl.innerHTML = '<span class="text-red-400 text-xl">‚úï</span>';
          collectionNftLinks[index] = null;
          errorEl.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—Å—ã–ª–∫–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: t.me/nft/–Ω–∞–∑–≤–∞–Ω–∏–µ-–Ω–æ–º–µ—Ä';
          errorEl.classList.remove('hidden');
          input.classList.remove('border-green-400/50');
          input.classList.add('border-red-400');
        }
        
        updateLinkCount();
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
      function updateLinkCount() {
        const enteredCount = document.getElementById('collection-links-entered');
        const validLinks = collectionNftLinks.filter(link => link !== null && link !== undefined);
        if (enteredCount) {
          enteredCount.textContent = validLinks.length;
        }
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
      function updateContinueButton() {
        const continueBtn = document.getElementById('collection-links-continue');
        const validLinks = collectionNftLinks.filter(link => link !== null && link !== undefined);
        
        if (continueBtn) {
          if (validLinks.length === 9) {
            continueBtn.disabled = false;
          } else {
            continueBtn.disabled = true;
          }
        }
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏ NFT
      function openCollectionArrangeModal() {
        const linksModal = document.getElementById('collection-links-modal');
        const arrangeModal = document.getElementById('collection-arrange-modal');
        const gridContainer = document.getElementById('collection-grid');
        
        if (!arrangeModal || !gridContainer) {
          console.error('–ú–æ–¥–∞–ª–∫–∞ —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
          return;
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –≤–≤–æ–¥–∞ —Å—Å—ã–ª–æ–∫
        if (linksModal) {
          linksModal.classList.add('hidden');
        }
        
        // –û—á–∏—â–∞–µ–º —Å–µ—Ç–∫—É
        gridContainer.innerHTML = '';
        
        // –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É 3x3 —Å NFT
        const validLinks = collectionNftLinks.filter(link => link !== null && link !== undefined);
        if (validLinks.length !== 9) {
          alert('–û—à–∏–±–∫–∞: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 9 —Å—Å—ã–ª–æ–∫ –Ω–∞ NFT');
          return;
        }
        
        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Å–µ—Ç–∫–∏
        for (let i = 0; i < 9; i++) {
          const gridItem = document.createElement('div');
          const linkIndex = collectionNftOrder[i];
          const nftLink = collectionNftLinks[linkIndex];
          
          gridItem.className = 'aspect-square rounded-lg overflow-hidden border-2 border-violet-400/30 bg-black/40 cursor-move relative group';
          gridItem.draggable = true;
          gridItem.dataset.index = i;
          gridItem.dataset.linkIndex = linkIndex;
          gridItem.style.width = '100%';
          gridItem.style.maxWidth = '100%';
          gridItem.style.boxSizing = 'border-box';
          gridItem.style.minWidth = '0';
          gridItem.style.overflow = 'hidden';
          
          // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å—Å—ã–ª–∫—É
          const normalizedLink = nftLink.startsWith('http') ? nftLink : (nftLink ? 'https://' + nftLink : '');
          const previewUrl = `/api/nft-preview?nft_link=${encodeURIComponent(normalizedLink)}`;
          
          gridItem.innerHTML = `
            <div class="w-full h-full flex items-center justify-center bg-black/50 relative" style="width: 100%; height: 100%; max-width: 100%; box-sizing: border-box; overflow: hidden;">
              <img 
                src="${previewUrl}" 
                alt="NFT ${i + 1}"
                class="w-full h-full object-cover"
                draggable="false"
                style="width: 100%; height: 100%; max-width: 100%; object-fit: cover; display: block;"
                onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');"
                onload="this.parentElement.querySelector('.nft-loading').classList.add('hidden');"
                oncontextmenu="return false;"
              />
              <div class="nft-loading absolute inset-0 flex items-center justify-center bg-black/70" style="width: 100%; height: 100%; box-sizing: border-box;">
                <div class="text-2xl opacity-70 animate-spin">‚è≥</div>
              </div>
              <div class="hidden w-full h-full flex items-center justify-center bg-black/50" style="width: 100%; height: 100%; box-sizing: border-box;">
                <div class="text-2xl opacity-70">üñºÔ∏è</div>
              </div>
              <div class="absolute top-2 left-2 bg-black/70 text-white text-xs px-2 py-1 rounded pointer-events-none" style="box-sizing: border-box;">
                ${i + 1}
              </div>
            </div>
          `;
          
          // –ó–∞–ø—Ä–µ—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é (–ø—Ä–∞–≤—ã–π –∫–ª–∏–∫)
          gridItem.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
          });
          
          // –ó–∞–ø—Ä–µ—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–º –Ω–∞–∂–∞—Ç–∏–∏
          gridItem.addEventListener('selectstart', function(e) {
            e.preventDefault();
            return false;
          });
          
          // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ drag and drop (–¥–ª—è –ü–ö)
          gridItem.addEventListener('dragstart', handleDragStart);
          gridItem.addEventListener('dragover', handleDragOver);
          gridItem.addEventListener('dragleave', handleDragLeave);
          gridItem.addEventListener('drop', handleDrop);
          gridItem.addEventListener('dragend', handleDragEnd);
          
          // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ touch —Å–æ–±—ã—Ç–∏–π (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
          gridItem.addEventListener('touchstart', handleTouchStart, { passive: false });
          gridItem.addEventListener('touchmove', handleTouchMove, { passive: false });
          gridItem.addEventListener('touchend', handleTouchEnd, { passive: false });
          gridItem.addEventListener('touchcancel', handleTouchCancel, { passive: false });
          
          gridContainer.appendChild(gridItem);
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏
        arrangeModal.classList.remove('hidden');
        document.body.classList.add('modal-open');
      }

      // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–º–µ–Ω—ã –¥–≤—É—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –º–µ—Å—Ç–∞–º–∏
      function swapElements(el1, el2) {
        const parent1 = el1.parentNode;
        const parent2 = el2.parentNode;
        
        if (parent1 !== parent2) return false; // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –æ–¥–Ω–æ–º —Ä–æ–¥–∏—Ç–µ–ª–µ
        
        const next1 = el1.nextSibling;
        const next2 = el2.nextSibling;
        
        // –í—Å—Ç–∞–≤–ª—è–µ–º el2 –Ω–∞ –º–µ—Å—Ç–æ el1
        parent1.insertBefore(el2, next1);
        
        // –í—Å—Ç–∞–≤–ª—è–µ–º el1 –Ω–∞ –º–µ—Å—Ç–æ el2
        // –ï—Å–ª–∏ el2 –±—ã–ª –ø–æ—Å–ª–µ el1, —Ç–æ next2 —É–∂–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è
        // –ü–æ—ç—Ç–æ–º—É –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
        if (next2 && next2 !== el1) {
          parent2.insertBefore(el1, next2);
        } else {
          // –ï—Å–ª–∏ el2 –±—ã–ª –ø–æ—Å–ª–µ–¥–Ω–∏–º –∏–ª–∏ next2 —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ el1 (–∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω)
          // –ù—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
          const allChildren = Array.from(parent2.children);
          const el2Index = allChildren.indexOf(el2);
          if (el2Index < allChildren.length - 1) {
            parent2.insertBefore(el1, allChildren[el2Index + 1]);
          } else {
            parent2.appendChild(el1);
          }
        }
        
        return true;
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ drag and drop
      function handleDragStart(e) {
        draggedElement = this;
        draggedIndex = parseInt(this.dataset.index);
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        // –ù–µ –ø–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
        e.dataTransfer.setData('text/plain', this.dataset.index);
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Å—Ç–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è drag preview
        const dragImage = document.createElement('div');
        dragImage.style.position = 'absolute';
        dragImage.style.top = '-1000px';
        dragImage.innerHTML = this.innerHTML;
        document.body.appendChild(dragImage);
        e.dataTransfer.setDragImage(dragImage, 0, 0);
        setTimeout(() => document.body.removeChild(dragImage), 0);
      }

      function handleDragOver(e) {
        if (e.preventDefault) {
          e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        
        // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        const gridItems = document.querySelectorAll('#collection-grid > div');
        gridItems.forEach(item => {
          if (item !== draggedElement) {
            item.classList.remove('drag-over');
          }
        });
        
        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç, –Ω–∞–¥ –∫–æ—Ç–æ—Ä—ã–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º
        if (this !== draggedElement) {
          this.classList.add('drag-over');
        }
        
        return false;
      }

      function handleDragLeave(e) {
        // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø—Ä–∏ —É—Ö–æ–¥–µ —Å —ç–ª–µ–º–µ–Ω—Ç–∞
        this.classList.remove('drag-over');
      }

      function handleDrop(e) {
        if (e.stopPropagation) {
          e.stopPropagation();
        }
        
        e.preventDefault();
        
        if (draggedElement && draggedElement !== this) {
          const gridContainer = document.getElementById('collection-grid');
          if (!gridContainer) return false;
          
          const sourceElement = draggedElement;
          const targetElement = this;
          
          // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã –¥–æ –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏
          const allItems = Array.from(gridContainer.children);
          const sourceIndex = allItems.indexOf(sourceElement);
          const targetIndex = allItems.indexOf(targetElement);
          
          if (sourceIndex === -1 || targetIndex === -1 || sourceIndex === targetIndex) return false;
          
          // –ü—Ä–æ—Å—Ç–∞—è –∏ –Ω–∞–¥–µ–∂–Ω–∞—è –∑–∞–º–µ–Ω–∞ –¥–≤—É—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –î–û –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
          const sourceNextSibling = sourceElement.nextSibling;
          const targetNextSibling = targetElement.nextSibling;
          
          // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–æ—Å–µ–¥–Ω–∏–µ (–∏–Ω–¥–µ–∫—Å –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –Ω–∞ 1)
          if (Math.abs(sourceIndex - targetIndex) === 1) {
            // –ü—Ä–æ—Å—Ç–∞—è –∑–∞–º–µ–Ω–∞ —Å–æ—Å–µ–¥–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            if (sourceIndex < targetIndex) {
              // source –ø–µ—Ä–µ–¥ target: target -> source, source -> –ø–æ—Å–ª–µ target
              gridContainer.insertBefore(targetElement, sourceElement);
              gridContainer.insertBefore(sourceElement, targetNextSibling);
            } else {
              // target –ø–µ—Ä–µ–¥ source: source -> target, target -> –ø–æ—Å–ª–µ source
              gridContainer.insertBefore(sourceElement, targetElement);
              gridContainer.insertBefore(targetElement, sourceNextSibling);
            }
          } else {
            // –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–µ —Å–æ—Å–µ–¥–Ω–∏–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–≤–∞ —à–∞–≥–∞
            // –®–∞–≥ 1: –ü–µ—Ä–µ–º–µ—â–∞–µ–º target –Ω–∞ –º–µ—Å—Ç–æ source
            if (sourceNextSibling) {
              gridContainer.insertBefore(targetElement, sourceNextSibling);
            } else {
              gridContainer.appendChild(targetElement);
            }
            
            // –®–∞–≥ 2: –ü–µ—Ä–µ–º–µ—â–∞–µ–º source –Ω–∞ –º–µ—Å—Ç–æ target
            // –¢–µ–ø–µ—Ä—å target —É–∂–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω, –Ω–∞—Ö–æ–¥–∏–º –µ–≥–æ –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é
            const allItemsAfterStep1 = Array.from(gridContainer.children);
            const targetNewIndex = allItemsAfterStep1.indexOf(targetElement);
            
            // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –ø–æ—Å–ª–µ target –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ
            const targetOriginalNext = allItems[targetIndex + 1];
            if (targetOriginalNext && targetOriginalNext !== sourceElement) {
              // –í—Å—Ç–∞–≤–ª—è–µ–º source –ø–µ—Ä–µ–¥ —ç–ª–µ–º–µ–Ω—Ç–æ–º, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –ø–æ—Å–ª–µ target
              gridContainer.insertBefore(sourceElement, targetOriginalNext);
            } else if (targetNewIndex < allItemsAfterStep1.length - 1) {
              // target –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ—Å–ª–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è, –≤—Å—Ç–∞–≤–ª—è–µ–º source –ø–æ—Å–ª–µ target
              const afterTarget = allItemsAfterStep1[targetNewIndex + 1];
              if (afterTarget && afterTarget !== sourceElement) {
                gridContainer.insertBefore(sourceElement, afterTarget);
              } else {
                gridContainer.appendChild(sourceElement);
              }
            } else {
              // target –ø–æ—Å–ª–µ–¥–Ω–∏–π, –¥–æ–±–∞–≤–ª—è–µ–º source –≤ –∫–æ–Ω–µ—Ü
              gridContainer.appendChild(sourceElement);
            }
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º data-index –∞—Ç—Ä–∏–±—É—Ç—ã –∏ –Ω–æ–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–π
          const newItems = Array.from(gridContainer.children);
          newItems.forEach((item, idx) => {
            item.dataset.index = idx;
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ –≤ –±–µ–π–¥–∂–µ
            const positionBadge = item.querySelector('.absolute.top-2.left-2');
            if (positionBadge) {
              positionBadge.textContent = idx + 1;
            }
          });
          
          // –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏ –≤ –º–∞—Å—Å–∏–≤–µ order –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞ —Å—Å—ã–ª–æ–∫
          const tempOrder = collectionNftOrder[sourceIndex];
          collectionNftOrder[sourceIndex] = collectionNftOrder[targetIndex];
          collectionNftOrder[targetIndex] = tempOrder;
        }
        
        // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
        const gridItems = document.querySelectorAll('#collection-grid > div');
        gridItems.forEach(item => {
          item.classList.remove('drag-over');
        });
        
        return false;
      }

      function handleDragEnd(e) {
        // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å dragging
        if (this) {
          this.classList.remove('dragging');
        }
        
        // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        const gridItems = document.querySelectorAll('#collection-grid > div');
        gridItems.forEach(item => {
          item.classList.remove('drag-over', 'dragging');
        });
        
        draggedElement = null;
        draggedIndex = null;
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ touch —Å–æ–±—ã—Ç–∏–π –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
      function handleTouchStart(e) {
        if (e.touches.length !== 1) return; // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –∫–∞—Å–∞–Ω–∏–µ
        
        e.preventDefault();
        e.stopPropagation();
        
        touchStartElement = this;
        touchStartIndex = parseInt(this.dataset.index);
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        touchCurrentElement = this;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
        this.classList.add('dragging');
        this.style.opacity = '0.7';
        this.style.transform = 'scale(1.1)';
        this.style.zIndex = '1000';
        this.style.transition = 'none';
        
        // –°–æ–∑–¥–∞–µ–º "–ø—Ä–∏–∑—Ä–∞—á–Ω—ã–π" —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
        const rect = this.getBoundingClientRect();
        touchGhostElement = this.cloneNode(true);
        touchGhostElement.style.position = 'fixed';
        touchGhostElement.style.left = rect.left + 'px';
        touchGhostElement.style.top = rect.top + 'px';
        touchGhostElement.style.width = rect.width + 'px';
        touchGhostElement.style.height = rect.height + 'px';
        touchGhostElement.style.pointerEvents = 'none';
        touchGhostElement.style.zIndex = '10000';
        touchGhostElement.style.opacity = '0.8';
        touchGhostElement.style.transform = 'scale(1.05) rotate(2deg)';
        touchGhostElement.style.boxShadow = '0 10px 40px rgba(124, 58, 237, 0.6), 0 0 60px rgba(236, 72, 153, 0.4)';
        touchGhostElement.style.transition = 'none';
        touchGhostElement.style.border = '2px solid rgba(167, 139, 250, 0.8)';
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∏–∑ –∫–ª–æ–Ω–∞ –∏ –æ—Ç–∫–ª—é—á–∞–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
        const allChildren = touchGhostElement.querySelectorAll('*');
        allChildren.forEach(child => {
          child.style.pointerEvents = 'none';
        });
        document.body.appendChild(touchGhostElement);
        
        // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        const gridItems = document.querySelectorAll('#collection-grid > div');
        gridItems.forEach(item => {
          if (item !== this) {
            item.classList.remove('drag-over');
          }
        });
      }

      function handleTouchMove(e) {
        if (!touchStartElement || e.touches.length !== 1) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        const touch = e.touches[0];
        const currentX = touch.clientX;
        const currentY = touch.clientY;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é "–ø—Ä–∏–∑—Ä–∞—á–Ω–æ–≥–æ" —ç–ª–µ–º–µ–Ω—Ç–∞
        if (touchGhostElement) {
          const rect = touchStartElement.getBoundingClientRect();
          const offsetX = rect.width / 2;
          const offsetY = rect.height / 2;
          touchGhostElement.style.left = (currentX - offsetX) + 'px';
          touchGhostElement.style.top = (currentY - offsetY) + 'px';
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω–∞–¥ –∫–∞–∫–∏–º —ç–ª–µ–º–µ–Ω—Ç–æ–º –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–∞–ª–µ—Ü
        // –í—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–∑—Ä–∞—á–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–æ–¥ –ø–∞–ª—å—Ü–µ–º
        if (touchGhostElement) {
          touchGhostElement.style.pointerEvents = 'none';
          touchGhostElement.style.opacity = '0.5';
        }
        
        const elementBelow = document.elementFromPoint(currentX, currentY);
        let targetGridItem = null;
        
        if (elementBelow) {
          // –ò—â–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å–µ—Ç–∫–∏, –ø–µ—Ä–µ–±–∏—Ä–∞—è —Ä–æ–¥–∏—Ç–µ–ª–µ–π –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å –∫–ª–∞—Å—Å–æ–º 'group'
          let currentElement = elementBelow;
          let depth = 0;
          const maxDepth = 10; // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≥–ª—É–±–∏–Ω—ã –ø–æ–∏—Å–∫–∞
          
          while (currentElement && depth < maxDepth && !targetGridItem) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç–ª–µ–º–µ–Ω—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–º —Å–µ—Ç–∫–∏
            if (currentElement.id === 'collection-grid') {
              break;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç–ª–µ–º–µ–Ω—Ç –ø—Ä—è–º—ã–º –¥–æ—á–µ—Ä–Ω–∏–º —ç–ª–µ–º–µ–Ω—Ç–æ–º —Å–µ—Ç–∫–∏
            if (currentElement.parentElement && currentElement.parentElement.id === 'collection-grid') {
              targetGridItem = currentElement;
              break;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–º–µ–µ—Ç –ª–∏ —ç–ª–µ–º–µ–Ω—Ç –∫–ª–∞—Å—Å 'group' –∏ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ–Ω –¥–æ—á–µ—Ä–Ω–∏–º —ç–ª–µ–º–µ–Ω—Ç–æ–º —Å–µ—Ç–∫–∏
            if (currentElement.classList && currentElement.classList.contains('group')) {
              let parent = currentElement.parentElement;
              while (parent) {
                if (parent.id === 'collection-grid') {
                  targetGridItem = currentElement;
                  break;
                }
                parent = parent.parentElement;
              }
              if (targetGridItem) break;
            }
            
            currentElement = currentElement.parentElement;
            depth++;
          }
          
          // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–±–æ—Ä, –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —á–µ—Ä–µ–∑ closest
          if (!targetGridItem) {
            targetGridItem = elementBelow.closest('#collection-grid > div');
          }
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –ø—Ä–∏–∑—Ä–∞—á–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
        if (touchGhostElement) {
          touchGhostElement.style.pointerEvents = 'none';
          touchGhostElement.style.opacity = '0.8';
        }
        
        if (targetGridItem && targetGridItem !== touchStartElement) {
          // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç, –Ω–∞–¥ –∫–æ—Ç–æ—Ä—ã–º –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–∞–ª–µ—Ü
          const gridItems = document.querySelectorAll('#collection-grid > div');
          gridItems.forEach(item => {
            if (item !== touchStartElement) {
              item.classList.remove('drag-over');
            }
          });
          targetGridItem.classList.add('drag-over');
          touchCurrentElement = targetGridItem;
        } else {
          // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É, –µ—Å–ª–∏ –ø–∞–ª–µ—Ü –Ω–µ –Ω–∞–¥ —ç–ª–µ–º–µ–Ω—Ç–æ–º —Å–µ—Ç–∫–∏
          const gridItems = document.querySelectorAll('#collection-grid > div');
          gridItems.forEach(item => {
            if (item !== touchStartElement) {
              item.classList.remove('drag-over');
            }
          });
          if (!targetGridItem || targetGridItem === touchStartElement) {
            touchCurrentElement = null;
          } else {
            touchCurrentElement = targetGridItem;
          }
        }
      }

      function handleTouchEnd(e) {
        if (!touchStartElement) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        // –£–±–∏—Ä–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
        touchStartElement.classList.remove('dragging');
        touchStartElement.style.opacity = '';
        touchStartElement.style.transform = '';
        touchStartElement.style.zIndex = '';
        touchStartElement.style.transition = '';
        
        // –£–¥–∞–ª—è–µ–º "–ø—Ä–∏–∑—Ä–∞—á–Ω—ã–π" —ç–ª–µ–º–µ–Ω—Ç
        if (touchGhostElement) {
          try {
            document.body.removeChild(touchGhostElement);
          } catch (err) {
            // –≠–ª–µ–º–µ–Ω—Ç —É–∂–µ —É–¥–∞–ª–µ–Ω
          }
          touchGhostElement = null;
        }
        
        // –ï—Å–ª–∏ –ø–∞–ª–µ—Ü –±—ã–ª –æ—Ç–ø—É—â–µ–Ω –Ω–∞–¥ –¥—Ä—É–≥–∏–º —ç–ª–µ–º–µ–Ω—Ç–æ–º, –º–µ–Ω—è–µ–º –∏—Ö –º–µ—Å—Ç–∞–º–∏
        if (touchCurrentElement && touchCurrentElement !== touchStartElement) {
          const gridContainer = document.getElementById('collection-grid');
          if (gridContainer) {
            const allItems = Array.from(gridContainer.children);
            const sourceIndex = allItems.indexOf(touchStartElement);
            const targetIndex = allItems.indexOf(touchCurrentElement);
            
            if (sourceIndex !== -1 && targetIndex !== -1 && sourceIndex !== targetIndex) {
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –î–û –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏
              const sourceNextSibling = touchStartElement.nextSibling;
              const targetNextSibling = touchCurrentElement.nextSibling;
              
              // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–æ—Å–µ–¥–Ω–∏–µ (–∏–Ω–¥–µ–∫—Å –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –Ω–∞ 1)
              if (Math.abs(sourceIndex - targetIndex) === 1) {
                // –ü—Ä–æ—Å—Ç–∞—è –∑–∞–º–µ–Ω–∞ —Å–æ—Å–µ–¥–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                if (sourceIndex < targetIndex) {
                  // source –ø–µ—Ä–µ–¥ target: target -> source, source -> –ø–æ—Å–ª–µ target
                  gridContainer.insertBefore(touchCurrentElement, touchStartElement);
                  gridContainer.insertBefore(touchStartElement, targetNextSibling);
                } else {
                  // target –ø–µ—Ä–µ–¥ source: source -> target, target -> –ø–æ—Å–ª–µ source
                  gridContainer.insertBefore(touchStartElement, touchCurrentElement);
                  gridContainer.insertBefore(touchCurrentElement, sourceNextSibling);
                }
              } else {
                // –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–µ —Å–æ—Å–µ–¥–Ω–∏–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–≤–∞ —à–∞–≥–∞
                // –®–∞–≥ 1: –ü–µ—Ä–µ–º–µ—â–∞–µ–º target –Ω–∞ –º–µ—Å—Ç–æ source
                if (sourceNextSibling) {
                  gridContainer.insertBefore(touchCurrentElement, sourceNextSibling);
                } else {
                  gridContainer.appendChild(touchCurrentElement);
                }
                
                // –®–∞–≥ 2: –ü–µ—Ä–µ–º–µ—â–∞–µ–º source –Ω–∞ –º–µ—Å—Ç–æ target
                const allItemsAfterStep1 = Array.from(gridContainer.children);
                const targetNewIndex = allItemsAfterStep1.indexOf(touchCurrentElement);
                
                // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –ø–æ—Å–ª–µ target –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ
                const targetOriginalNext = allItems[targetIndex + 1];
                if (targetOriginalNext && targetOriginalNext !== touchStartElement) {
                  gridContainer.insertBefore(touchStartElement, targetOriginalNext);
                } else if (targetNewIndex < allItemsAfterStep1.length - 1) {
                  const afterTarget = allItemsAfterStep1[targetNewIndex + 1];
                  if (afterTarget && afterTarget !== touchStartElement) {
                    gridContainer.insertBefore(touchStartElement, afterTarget);
                  } else {
                    gridContainer.appendChild(touchStartElement);
                  }
                } else {
                  gridContainer.appendChild(touchStartElement);
                }
              }
              
              // –û–±–Ω–æ–≤–ª—è–µ–º data-index –∞—Ç—Ä–∏–±—É—Ç—ã –∏ –Ω–æ–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–π
              const newItems = Array.from(gridContainer.children);
              newItems.forEach((item, idx) => {
                item.dataset.index = idx;
                // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ –≤ –±–µ–π–¥–∂–µ
                const positionBadge = item.querySelector('.absolute.top-2.left-2');
                if (positionBadge) {
                  positionBadge.textContent = idx + 1;
                }
              });
              
              // –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏ –≤ –º–∞—Å—Å–∏–≤–µ order –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞ —Å—Å—ã–ª–æ–∫
              const tempOrder = collectionNftOrder[sourceIndex];
              collectionNftOrder[sourceIndex] = collectionNftOrder[targetIndex];
              collectionNftOrder[targetIndex] = tempOrder;
            }
          }
        }
        
        // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        const gridItems = document.querySelectorAll('#collection-grid > div');
        gridItems.forEach(item => {
          item.classList.remove('drag-over', 'dragging');
        });
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        touchStartElement = null;
        touchStartIndex = null;
        touchStartX = null;
        touchStartY = null;
        touchCurrentElement = null;
      }

      function handleTouchCancel(e) {
        if (!touchStartElement) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        // –£–±–∏—Ä–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
        touchStartElement.classList.remove('dragging');
        touchStartElement.style.opacity = '';
        touchStartElement.style.transform = '';
        touchStartElement.style.zIndex = '';
        touchStartElement.style.transition = '';
        
        // –£–¥–∞–ª—è–µ–º "–ø—Ä–∏–∑—Ä–∞—á–Ω—ã–π" —ç–ª–µ–º–µ–Ω—Ç
        if (touchGhostElement) {
          try {
            document.body.removeChild(touchGhostElement);
          } catch (err) {
            // –≠–ª–µ–º–µ–Ω—Ç —É–∂–µ —É–¥–∞–ª–µ–Ω
          }
          touchGhostElement = null;
        }
        
        // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        const gridItems = document.querySelectorAll('#collection-grid > div');
        gridItems.forEach(item => {
          item.classList.remove('drag-over', 'dragging');
        });
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        touchStartElement = null;
        touchStartIndex = null;
        touchStartX = null;
        touchStartY = null;
        touchCurrentElement = null;
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ç–∫–∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞
      function updateCollectionGrid() {
        const gridContainer = document.getElementById('collection-grid');
        if (!gridContainer) return;
        
        const validLinks = collectionNftLinks.filter(link => link !== null && link !== undefined);
        if (validLinks.length !== 9) return;
        
        // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É —Å –Ω–æ–≤—ã–º –ø–æ—Ä—è–¥–∫–æ–º
        gridContainer.innerHTML = '';
        
        for (let i = 0; i < 9; i++) {
          const gridItem = document.createElement('div');
          const linkIndex = collectionNftOrder[i];
          const nftLink = collectionNftLinks[linkIndex];
          
          gridItem.className = 'aspect-square rounded-lg overflow-hidden border-2 border-violet-400/30 bg-black/40 cursor-move relative group';
          gridItem.draggable = true;
          gridItem.dataset.index = i;
          gridItem.dataset.linkIndex = linkIndex;
          gridItem.style.width = '100%';
          gridItem.style.maxWidth = '100%';
          gridItem.style.boxSizing = 'border-box';
          gridItem.style.minWidth = '0';
          gridItem.style.overflow = 'hidden';
          
          const normalizedLink = nftLink.startsWith('http') ? nftLink : (nftLink ? 'https://' + nftLink : '');
          const previewUrl = `/api/nft-preview?nft_link=${encodeURIComponent(normalizedLink)}`;
          
          gridItem.innerHTML = `
            <div class="w-full h-full flex items-center justify-center bg-black/50 relative" style="width: 100%; height: 100%; max-width: 100%; box-sizing: border-box; overflow: hidden;">
              <img 
                src="${previewUrl}" 
                alt="NFT ${i + 1}"
                class="w-full h-full object-cover"
                draggable="false"
                style="width: 100%; height: 100%; max-width: 100%; object-fit: cover; display: block;"
                onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');"
                onload="this.parentElement.querySelector('.nft-loading').classList.add('hidden');"
                oncontextmenu="return false;"
              />
              <div class="nft-loading absolute inset-0 flex items-center justify-center bg-black/70" style="width: 100%; height: 100%; box-sizing: border-box;">
                <div class="text-2xl opacity-70 animate-spin">‚è≥</div>
              </div>
              <div class="hidden w-full h-full flex items-center justify-center bg-black/50" style="width: 100%; height: 100%; box-sizing: border-box;">
                <div class="text-2xl opacity-70">üñºÔ∏è</div>
              </div>
              <div class="absolute top-2 left-2 bg-black/70 text-white text-xs px-2 py-1 rounded pointer-events-none" style="box-sizing: border-box;">
                ${i + 1}
              </div>
            </div>
          `;
          
          // –ó–∞–ø—Ä–µ—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é (–ø—Ä–∞–≤—ã–π –∫–ª–∏–∫)
          gridItem.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
          });
          
          // –ó–∞–ø—Ä–µ—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–º –Ω–∞–∂–∞—Ç–∏–∏
          gridItem.addEventListener('selectstart', function(e) {
            e.preventDefault();
            return false;
          });
          
          // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ drag and drop (–¥–ª—è –ü–ö)
          gridItem.addEventListener('dragstart', handleDragStart);
          gridItem.addEventListener('dragover', handleDragOver);
          gridItem.addEventListener('dragleave', handleDragLeave);
          gridItem.addEventListener('drop', handleDrop);
          gridItem.addEventListener('dragend', handleDragEnd);
          
          // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ touch —Å–æ–±—ã—Ç–∏–π (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
          gridItem.addEventListener('touchstart', handleTouchStart, { passive: false });
          gridItem.addEventListener('touchmove', handleTouchMove, { passive: false });
          gridItem.addEventListener('touchend', handleTouchEnd, { passive: false });
          gridItem.addEventListener('touchcancel', handleTouchCancel, { passive: false });
          
          gridContainer.appendChild(gridItem);
        }
      }

      // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
      async function submitCollection() {
        if (!currentCollectionContestId) {
          alert('–û—à–∏–±–∫–∞: ID –∫–æ–Ω–∫—É—Ä—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
          return;
        }
        
        const validLinks = collectionNftLinks.filter(link => link !== null && link !== undefined);
        if (validLinks.length !== 9) {
          alert('–û—à–∏–±–∫–∞: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 9 —Å—Å—ã–ª–æ–∫ –Ω–∞ NFT');
          return;
        }
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ —Å—Å—ã–ª–æ–∫ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
        const orderedLinks = collectionNftOrder.map(index => collectionNftLinks[index]);
        
        const submitBtn = document.getElementById('collection-arrange-submit');
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
        }
        
        try {
          const username = window.Telegram?.WebApp?.initDataUnsafe?.user?.username || '';
          const response = await window.fetchJSON(`/api/contests/${currentCollectionContestId}/submit-collection`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              user_id: currentUserId,
              username: username,
              nft_links: orderedLinks
            })
          });
          
          if (response.success) {
            alert('‚úÖ –ö–æ–ª–ª–µ–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫–∏
            const arrangeModal = document.getElementById('collection-arrange-modal');
            if (arrangeModal) {
              arrangeModal.classList.add('hidden');
            }
            document.body.classList.remove('modal-open');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—É—Ä—Å–æ–≤
            await loadContests();
          } else {
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏: ' + (response.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é';
            }
          }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏:', e);
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é';
          }
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –º–æ–¥–∞–ª–æ–∫
      function initCollectionModals() {
        // –ú–æ–¥–∞–ª–∫–∞ –≤–≤–æ–¥–∞ —Å—Å—ã–ª–æ–∫
        const linksModal = document.getElementById('collection-links-modal');
        const linksModalClose = document.getElementById('collection-links-modal-close');
        const linksCancel = document.getElementById('collection-links-cancel');
        const linksContinue = document.getElementById('collection-links-continue');
        
        // –ú–æ–¥–∞–ª–∫–∞ —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏
        const arrangeModal = document.getElementById('collection-arrange-modal');
        const arrangeModalClose = document.getElementById('collection-arrange-modal-close');
        const arrangeBack = document.getElementById('collection-arrange-back');
        const arrangeSubmit = document.getElementById('collection-arrange-submit');
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –≤–≤–æ–¥–∞ —Å—Å—ã–ª–æ–∫
        if (linksModalClose) {
          linksModalClose.addEventListener('click', function() {
            if (linksModal) linksModal.classList.add('hidden');
            document.body.classList.remove('modal-open');
          });
        }
        
        if (linksCancel) {
          linksCancel.addEventListener('click', function() {
            if (linksModal) linksModal.classList.add('hidden');
            document.body.classList.remove('modal-open');
          });
        }
        
        // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" –≤ –º–æ–¥–∞–ª–∫–µ –≤–≤–æ–¥–∞ —Å—Å—ã–ª–æ–∫
        if (linksContinue) {
          linksContinue.addEventListener('click', function() {
            const validLinks = collectionNftLinks.filter(link => link !== null && link !== undefined);
            if (validLinks.length === 9) {
              openCollectionArrangeModal();
            }
          });
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏
        if (arrangeModalClose) {
          arrangeModalClose.addEventListener('click', function() {
            if (arrangeModal) arrangeModal.classList.add('hidden');
            document.body.classList.remove('modal-open');
          });
        }
        
        // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –≤ –º–æ–¥–∞–ª–∫–µ —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏
        if (arrangeBack) {
          arrangeBack.addEventListener('click', function() {
            if (arrangeModal) arrangeModal.classList.add('hidden');
            if (linksModal) linksModal.classList.remove('hidden');
          });
        }
        
        // –ö–Ω–æ–ø–∫–∞ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é"
        if (arrangeSubmit) {
          arrangeSubmit.addEventListener('click', submitCollection);
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª–∫–∏
        if (linksModal) {
          linksModal.addEventListener('click', function(e) {
            if (e.target === linksModal) {
              linksModal.classList.add('hidden');
              document.body.classList.remove('modal-open');
            }
          });
        }
        
        if (arrangeModal) {
          arrangeModal.addEventListener('click', function(e) {
            if (e.target === arrangeModal) {
              arrangeModal.classList.add('hidden');
              document.body.classList.remove('modal-open');
            }
          });
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª–æ–∫ —Å—Ä–∞–∑—É
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCollectionModals);
      } else {
        initCollectionModals();
      }

      // üé® –°–∏—Å—Ç–µ–º–∞ —Ç–µ–º
      const themes = {
        default: {
          name: '–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é',
          id: 'default',
          icon: 'üü£',
          description: '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—Ä–æ–∑–æ–≤–∞—è —Ç–µ–º–∞'
        },
        kitty: {
          name: 'Kitty',
          id: 'kitty',
          icon: 'üê±',
          description: '–ú–∏–ª—ã–µ —Ä–æ–∑–æ–≤—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏'
        },
        mario: {
          name: 'Mario',
          id: 'mario',
          icon: 'üçÑ',
          description: '–†–µ—Ç—Ä–æ —Å—Ç–∏–ª—å Super Mario Bros'
        },
        aot: {
          name: 'Attack on Titan',
          id: 'aot',
          icon: '‚öîÔ∏è',
          description: '–°–µ–ø–∏—è, –ø–µ—Ä–≥–∞–º–µ–Ω—Ç, –≥–æ—Ç–∏—á–µ—Å–∫–∏–π —Å—Ç–∏–ª—å'
        }
      };

      // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–µ–π —Ç–µ–º—ã –∏–∑ localStorage
      function loadTheme() {
        const savedTheme = localStorage.getItem('selectedTheme') || 'default';
        applyTheme(savedTheme);
        setTimeout(() => {
          updateIconsForTheme(savedTheme);
        }, 300);
      }

      // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã
      function applyTheme(themeId) {
        const body = document.body;
        body.classList.remove('theme-kitty', 'theme-mario', 'theme-aot');
        
        if (themeId !== 'default') {
          body.classList.add(`theme-${themeId}`);
        }
        
        updateIconsForTheme(themeId);
        localStorage.setItem('selectedTheme', themeId);
        console.log('‚úÖ –¢–µ–º–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞:', themeId);
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤—Å–µ—Ö –∏–∫–æ–Ω–æ–∫ –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –Ω–æ–≤–æ–π —Ç–µ–º—ã
      function clearAllThemeIcons() {
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∏—Ç–∞–Ω–∞
        const titanImage = document.getElementById('aot-titan-image');
        if (titanImage) {
          titanImage.classList.add('hidden');
        }
        const avatarEl = document.getElementById('profile-avatar');
        if (avatarEl) {
          avatarEl.textContent = avatarEl.textContent.replace(/[üçÑ‚≠êü™ôüëëüê±üò∏üòªüôÄüòΩüòæüòøüë§üë®üë©]/g, '');
          if (!avatarEl.textContent.trim()) {
            avatarEl.textContent = 'üë§';
          }
        }

        const profileBtn = document.querySelector('[data-section="profile-section"]');
        if (profileBtn) {
          const text = profileBtn.textContent.replace(/[üçÑüê±üë§üë®üë©]/g, '').trim();
          profileBtn.innerHTML = text || '–ü—Ä–æ—Ñ–∏–ª—å';
        }

        const contestsBtn = document.querySelector('[data-section="contests-section"]');
        if (contestsBtn) {
          const text = contestsBtn.textContent.replace(/[‚≠êüéÅüèÜüéØ]/g, '').trim();
          contestsBtn.innerHTML = text || '–ö–æ–Ω–∫—É—Ä—Å—ã';
        }

        const ratingBtn = document.querySelector('[data-section="rating-section"]');
        if (ratingBtn) {
          const text = ratingBtn.textContent.replace(/[ü™ôüíñ‚≠êüåü]/g, '').trim();
          ratingBtn.innerHTML = text || '–†–µ–π—Ç–∏–Ω–≥';
        }

        const changeThemeBtn = document.getElementById('change-theme-btn');
        if (changeThemeBtn) {
          const text = changeThemeBtn.textContent.replace(/[üéÆüíùüé®]/g, '').trim();
          changeThemeBtn.innerHTML = text || '–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É';
        }

        const contactBtn = document.getElementById('contact-owner-btn');
        if (contactBtn) {
          const text = contactBtn.textContent.replace(/[üìÆüíåüì®]/g, '').trim();
          contactBtn.innerHTML = text || '–°–≤—è–∑—å —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º';
        }

        const levelBadgeSection = document.querySelector('h3.flex.items-center.gap-2');
        if (levelBadgeSection) {
          const starIcon = levelBadgeSection.querySelector('.text-violet-400');
          if (starIcon) {
            starIcon.textContent = starIcon.textContent.replace(/[ü™ôüê±üíñ‚≠êüåü]/g, '');
            starIcon.style.animation = '';
          }
        }

        const profileSection = document.querySelector('#profile-section h2');
        if (profileSection) {
          const text = profileSection.textContent.replace(/[üçÑüê±üë§üë®üë©]/g, '').trim();
          profileSection.innerHTML = text || '–ü—Ä–æ—Ñ–∏–ª—å';
        }

        const contestsSection = document.querySelector('#contests-section h2');
        if (contestsSection) {
          const text = contestsSection.textContent.replace(/[‚≠êüéÅüèÜüéØ]/g, '').trim();
          contestsSection.innerHTML = text || '–ö–æ–Ω–∫—É—Ä—Å—ã';
        }

        const ratingSection = document.querySelector('#rating-section h2');
        if (ratingSection) {
          const text = ratingSection.textContent.replace(/[ü™ôüíñ‚≠êüåü]/g, '').trim();
          ratingSection.innerHTML = text || '–†–µ–π—Ç–∏–Ω–≥';
        }
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–æ–∫ –¥–ª—è —Ç–µ–º—ã
      function updateIconsForTheme(themeId) {
        clearAllThemeIcons();

        if (themeId === 'mario') {
          const avatarEl = document.getElementById('profile-avatar');
          if (avatarEl) {
            const marioIcons = ['üçÑ', '‚≠ê', 'ü™ô', 'üëë'];
            avatarEl.textContent = marioIcons[Math.floor(Math.random() * marioIcons.length)];
          }

          const profileBtn = document.querySelector('[data-section="profile-section"]');
          if (profileBtn) profileBtn.innerHTML = 'üçÑ –ü—Ä–æ—Ñ–∏–ª—å';

          const contestsBtn = document.querySelector('[data-section="contests-section"]');
          if (contestsBtn) contestsBtn.innerHTML = '‚≠ê –ö–æ–Ω–∫—É—Ä—Å—ã';

          const ratingBtn = document.querySelector('[data-section="rating-section"]');
          if (ratingBtn) ratingBtn.innerHTML = 'ü™ô –†–µ–π—Ç–∏–Ω–≥';

          const changeThemeBtn = document.getElementById('change-theme-btn');
          if (changeThemeBtn) changeThemeBtn.innerHTML = 'üéÆ –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É';

          const contactBtn = document.getElementById('contact-owner-btn');
          if (contactBtn) contactBtn.innerHTML = 'üìÆ –°–≤—è–∑—å —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º';

          const levelBadgeSection = document.querySelector('h3.flex.items-center.gap-2');
          if (levelBadgeSection) {
            const starIcon = levelBadgeSection.querySelector('.text-violet-400');
            if (starIcon) {
              starIcon.textContent = 'ü™ô';
              starIcon.style.animation = '';
            }
          }

          const profileSection = document.querySelector('#profile-section h2');
          if (profileSection) profileSection.innerHTML = 'üçÑ –ü—Ä–æ—Ñ–∏–ª—å';

          const contestsSection = document.querySelector('#contests-section h2');
          if (contestsSection) contestsSection.innerHTML = '‚≠ê –ö–æ–Ω–∫—É—Ä—Å—ã';

          const ratingSection = document.querySelector('#rating-section h2');
          if (ratingSection) ratingSection.innerHTML = 'ü™ô –†–µ–π—Ç–∏–Ω–≥';

        } else if (themeId === 'kitty') {
          const avatarEl = document.getElementById('profile-avatar');
          if (avatarEl) {
            const kitties = ['üê±', 'üò∏', 'üòª', 'üôÄ', 'üòΩ', 'üòæ', 'üòø'];
            avatarEl.textContent = kitties[Math.floor(Math.random() * kitties.length)];
          }

          const profileBtn = document.querySelector('[data-section="profile-section"]');
          if (profileBtn) profileBtn.innerHTML = 'üê± –ü—Ä–æ—Ñ–∏–ª—å';

          const contestsBtn = document.querySelector('[data-section="contests-section"]');
          if (contestsBtn) contestsBtn.innerHTML = 'üéÅ –ö–æ–Ω–∫—É—Ä—Å—ã';

          const ratingBtn = document.querySelector('[data-section="rating-section"]');
          if (ratingBtn) ratingBtn.innerHTML = 'üíñ –†–µ–π—Ç–∏–Ω–≥';

          const changeThemeBtn = document.getElementById('change-theme-btn');
          if (changeThemeBtn) changeThemeBtn.innerHTML = '<span class="kitty-btn-icon">üíù</span> –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É';

          const contactBtn = document.getElementById('contact-owner-btn');
          if (contactBtn) contactBtn.innerHTML = '<span class="kitty-btn-icon">üíå</span> –°–≤—è–∑—å —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º';

          const levelBadgeSection = document.querySelector('h3.flex.items-center.gap-2');
          if (levelBadgeSection) {
            const starIcon = levelBadgeSection.querySelector('.text-violet-400');
            if (starIcon) {
              starIcon.textContent = 'üê±';
              starIcon.style.animation = 'kitty-bounce 1.5s ease-in-out infinite';
            }
          }

          const profileSection = document.querySelector('#profile-section h2');
          if (profileSection) profileSection.innerHTML = 'üê± –ü—Ä–æ—Ñ–∏–ª—å';

          const contestsSection = document.querySelector('#contests-section h2');
          if (contestsSection) contestsSection.innerHTML = 'üéÅ –ö–æ–Ω–∫—É—Ä—Å—ã';

          const ratingSection = document.querySelector('#rating-section h2');
          if (ratingSection) ratingSection.innerHTML = 'üíñ –†–µ–π—Ç–∏–Ω–≥';

        } else if (themeId === 'aot') {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∏—Ç–∞–Ω–∞
          const titanImage = document.getElementById('aot-titan-image');
          if (titanImage) {
            titanImage.classList.remove('hidden');
          }

          const avatarEl = document.getElementById('profile-avatar');
          if (avatarEl) avatarEl.textContent = '‚öîÔ∏è';

          const profileBtn = document.querySelector('[data-section="profile-section"]');
          if (profileBtn) profileBtn.innerHTML = '‚öîÔ∏è –ü—Ä–æ—Ñ–∏–ª—å';

          const contestsBtn = document.querySelector('[data-section="contests-section"]');
          if (contestsBtn) contestsBtn.innerHTML = 'üõ°Ô∏è –ö–æ–Ω–∫—É—Ä—Å—ã';

          const ratingBtn = document.querySelector('[data-section="rating-section"]');
          if (ratingBtn) ratingBtn.innerHTML = 'üèÜ –†–µ–π—Ç–∏–Ω–≥';

          const changeThemeBtn = document.getElementById('change-theme-btn');
          if (changeThemeBtn) changeThemeBtn.innerHTML = '‚öîÔ∏è –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É';

          const contactBtn = document.getElementById('contact-owner-btn');
          if (contactBtn) contactBtn.innerHTML = 'üì® –°–≤—è–∑—å —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º';

          const profileSection = document.querySelector('#profile-section h2');
          if (profileSection) profileSection.innerHTML = '‚öîÔ∏è –ü—Ä–æ—Ñ–∏–ª—å';

          const contestsSection = document.querySelector('#contests-section h2');
          if (contestsSection) contestsSection.innerHTML = 'üõ°Ô∏è –ö–æ–Ω–∫—É—Ä—Å—ã';

          const ratingSection = document.querySelector('#rating-section h2');
          if (ratingSection) ratingSection.innerHTML = 'üèÜ –†–µ–π—Ç–∏–Ω–≥';

        } else {
          // –°–∫—Ä—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∏—Ç–∞–Ω–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–µ–º
          const titanImage = document.getElementById('aot-titan-image');
          if (titanImage) {
            titanImage.classList.add('hidden');
          }
          const avatarEl = document.getElementById('profile-avatar');
          if (avatarEl) avatarEl.textContent = 'üë§';

          const profileBtn = document.querySelector('[data-section="profile-section"]');
          if (profileBtn) profileBtn.innerHTML = 'üë§ –ü—Ä–æ—Ñ–∏–ª—å';

          const contestsBtn = document.querySelector('[data-section="contests-section"]');
          if (contestsBtn) contestsBtn.innerHTML = 'üèÜ –ö–æ–Ω–∫—É—Ä—Å—ã';

          const ratingBtn = document.querySelector('[data-section="rating-section"]');
          if (ratingBtn) ratingBtn.innerHTML = '‚≠ê –†–µ–π—Ç–∏–Ω–≥';

          const changeThemeBtn = document.getElementById('change-theme-btn');
          if (changeThemeBtn) changeThemeBtn.innerHTML = '<span class="kitty-btn-icon">üé®</span> –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É';

          const contactBtn = document.getElementById('contact-owner-btn');
          if (contactBtn) contactBtn.innerHTML = 'üì® –°–≤—è–∑—å —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º';

          const levelBadgeSection = document.querySelector('h3.flex.items-center.gap-2');
          if (levelBadgeSection) {
            const starIcon = levelBadgeSection.querySelector('.text-violet-400');
            if (starIcon) {
              starIcon.textContent = '‚≠ê';
              starIcon.style.animation = '';
            }
          }

          const profileSection = document.querySelector('#profile-section h2');
          if (profileSection) profileSection.innerHTML = 'üë§ –ü—Ä–æ—Ñ–∏–ª—å';

          const contestsSection = document.querySelector('#contests-section h2');
          if (contestsSection) contestsSection.innerHTML = 'üèÜ –ö–æ–Ω–∫—É—Ä—Å—ã';

          const ratingSection = document.querySelector('#rating-section h2');
          if (ratingSection) ratingSection.innerHTML = '‚≠ê –†–µ–π—Ç–∏–Ω–≥';
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ —Ç–µ–º—ã
      function initThemeSelector() {
        const themeModal = document.getElementById('theme-selector-modal');
        const changeThemeBtn = document.getElementById('change-theme-btn');
        const closeThemeModal = document.getElementById('close-theme-modal');
        const themesList = document.getElementById('themes-list');

        if (!themeModal || !changeThemeBtn || !closeThemeModal || !themesList) {
          console.error('–≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ç–µ–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
          return;
        }

        function renderThemes() {
          updateThemeSelector();
        }

        changeThemeBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          renderThemes();
          themeModal.classList.remove('hidden');
          document.body.classList.add('modal-open');
        });

        closeThemeModal.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          themeModal.classList.add('hidden');
          document.body.classList.remove('modal-open');
        });

        themeModal.addEventListener('click', (e) => {
          if (e.target === themeModal) {
            themeModal.classList.add('hidden');
            document.body.classList.remove('modal-open');
          }
        });
      }

      // üõí –°–∏—Å—Ç–µ–º–∞ –º–∞–≥–∞–∑–∏–Ω–∞
      const shopItems = {
        avatarStars: [
          { id: 'star-gold', icon: '‚≠ê', name: '–ó–æ–ª–æ—Ç–∞—è –∑–≤–µ–∑–¥–∞', price: 10, priceType: 'stars' },
          { id: 'star-silver', icon: '‚ú®', name: '–°–µ—Ä–µ–±—Ä—è–Ω–∞—è –∑–≤–µ–∑–¥–∞', price: 5, priceType: 'stars' },
          { id: 'star-rainbow', icon: 'üåü', name: '–†–∞–¥—É–∂–Ω–∞—è –∑–≤–µ–∑–¥–∞', price: 20, priceType: 'stars' },
          { id: 'star-diamond', icon: 'üíé', name: '–ê–ª–º–∞–∑–Ω–∞—è –∑–≤–µ–∑–¥–∞', price: 50, priceType: 'stars' },
          { id: 'star-fire', icon: 'üî•', name: '–û–≥–Ω–µ–Ω–Ω–∞—è –∑–≤–µ–∑–¥–∞', price: 30, priceType: 'stars' },
          { id: 'star-ice', icon: '‚ùÑÔ∏è', name: '–õ–µ–¥—è–Ω–∞—è –∑–≤–µ–∑–¥–∞', price: 25, priceType: 'stars' }
        ],
        themes: [
          { 
            id: 'kitty', 
            name: 'Kitty', 
            icon: 'üê±', 
            priceMonkeyCoins: 150, 
            description: '–ú–∏–ª—ã–µ –∫–æ—Ç–∏–∫–∏ –∏ –ª–∞–ø–∫–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥—É' 
          },
          { 
            id: 'mario', 
            name: 'Mario', 
            icon: 'üçÑ', 
            priceMonkeyCoins: 250, 
            description: '–†–µ—Ç—Ä–æ —Å—Ç–∏–ª—å Super Mario Bros —Å –ø–∏–∫—Å–µ–ª—å–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫–æ–π' 
          }
        ],
        nftGifts: [
          { id: 'nft-gift-1', icon: 'üéÅ', name: 'NFT –ü–æ–¥–∞—Ä–æ–∫ 1', price: 200, priceType: 'stars', nftLink: '' },
          { id: 'nft-gift-2', icon: 'üéÅ', name: 'NFT –ü–æ–¥–∞—Ä–æ–∫ 2', price: 300, priceType: 'stars', nftLink: '' },
          { id: 'nft-gift-3', icon: 'üéÅ', name: 'NFT –ü–æ–¥–∞—Ä–æ–∫ 3', price: 500, priceType: 'stars', nftLink: '' }
        ]
      };

      // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ localStorage
      function getPurchasedItems() {
        try {
          const purchased = localStorage.getItem('purchasedItems');
          return purchased ? JSON.parse(purchased) : { avatarStars: [], themes: [], nftGifts: [] };
        } catch (e) {
          return { avatarStars: [], themes: [], nftGifts: [] };
        }
      }

      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
      function savePurchasedItems(items) {
        try {
          localStorage.setItem('purchasedItems', JSON.stringify(items));
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—É–ø–ª–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤:', e);
        }
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞, –∫—É–ø–ª–µ–Ω –ª–∏ —Ç–æ–≤–∞—Ä
      function isItemPurchased(category, itemId) {
        const purchased = getPurchasedItems();
        return purchased[category] && purchased[category].includes(itemId);
      }

      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫—É–ø–ª–µ–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
      function addPurchasedItem(category, itemId) {
        const purchased = getPurchasedItems();
        if (!purchased[category]) {
          purchased[category] = [];
        }
        if (!purchased[category].includes(itemId)) {
          purchased[category].push(itemId);
          savePurchasedItems(purchased);
        }
      }

      // –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä –¥–ª—è –ø–æ–∫—É–ø–∫–∏
      let currentPurchaseItem = null;

      // –ü–æ–∫—É–ø–∫–∞ —Ç–æ–≤–∞—Ä–∞
      async function purchaseItem(category, itemId) {
        const item = shopItems[category]?.find(i => i.id === itemId);
        if (!item) {
          alert('‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
          return;
        }

        if (isItemPurchased(category, itemId)) {
          alert('‚úÖ –≠—Ç–æ—Ç —Ç–æ–≤–∞—Ä —É–∂–µ –∫—É–ø–ª–µ–Ω!');
          return;
        }

        // –î–ª—è —Ç–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ Monkey Coins
        if (category === 'themes') {
          const price = item.priceMonkeyCoins || 0;
          if (price <= 0) {
            alert('‚ùå –¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞');
            return;
          }

          try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å Monkey Coins
            const balanceResponse = await window.fetchJSON(`/api/profile/monkey-coins?tg_id=${currentUserId}`);
            const balance = balanceResponse?.monkey_coins || 0;

            if (balance < price) {
              alert(`‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Monkey Coins!\n\n–£ –≤–∞—Å: ${balance}\n–ù—É–∂–Ω–æ: ${price}\n\n–ü–æ–ø–æ–ª–Ω–∏—Ç–µ —Å—á–µ—Ç —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "+" –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É.`);
              return;
            }

            // –°–ø–∏—Å—ã–≤–∞–µ–º Monkey Coins –∏ –ø–æ–∫—É–ø–∞–µ–º —Ç–µ–º—É
            const purchaseResponse = await window.fetchJSON('/api/shop/purchase-theme', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                user_id: currentUserId,
                theme_id: itemId,
                price: price
              })
            });

            if (purchaseResponse?.success) {
              // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä –≤ —Å–ø–∏—Å–æ–∫ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö
              addPurchasedItem(category, itemId);
              // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
              renderShop();
              // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –º–æ–Ω–µ—Ç–æ–∫
              updateCoinsDisplay();
              alert(`‚úÖ –¢–µ–º–∞ "${item.name}" —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω–∞!\n\n–°–ø–∏—Å–∞–Ω–æ: ${price} Monkey Coins`);
            } else {
              const errorMsg = purchaseResponse?.detail || purchaseResponse?.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ';
              alert(`‚ùå ${errorMsg}`);
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ —Ç–µ–º—ã:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ —Ç–µ–º—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
          }
          return;
        }

        // –î–ª—è –¥—Ä—É–≥–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π (avatarStars, nftGifts) –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Telegram WebApp –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –æ–ø–ª–∞—Ç—ã
        const isWebAppAvailable = window.Telegram?.WebApp?.initDataUnsafe;
        if (!isWebAppAvailable) {
          console.warn('‚ö†Ô∏è Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –≤ Telegram –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –æ–ø–ª–∞—Ç—ã.');
          console.warn('üì± –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (—Ç–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –æ–ø–ª–∞—Ç—ã).');
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ç–æ–≤–∞—Ä
        currentPurchaseItem = { category, itemId, item };

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
        showPaymentMethodModal();
      }

      // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª–∫–∏ –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
      function showPaymentMethodModal() {
        if (!currentPurchaseItem) return;

        const modal = document.getElementById('payment-method-modal');
        const methodsList = document.getElementById('payment-methods-list');
        
        if (!modal || !methodsList) return;

        const { item } = currentPurchaseItem;

        // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã
        let priceStars = item.priceStars || item.price || 0;
        let priceTON = item.priceTON || 0;
        let priceGifts = item.priceGifts;

        // –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã
        const paymentMethods = [
          {
            id: 'stars',
            name: 'Telegram Stars',
            icon: '‚≠ê',
            description: priceStars > 0 ? `${priceStars} ‚≠ê` : '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ',
            available: priceStars > 0,
            price: priceStars
          },
          {
            id: 'ton',
            name: 'CryptoBot',
            icon: 'ü§ñ',
            description: priceTON > 0 ? `${priceTON} TON` : '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ',
            available: priceTON > 0,
            price: priceTON
          },
          {
            id: 'gifts',
            name: 'NFT Gifts',
            icon: 'üéÅ',
            description: priceGifts !== null ? (typeof priceGifts === 'number' ? `${priceGifts} ‚≠ê` : priceGifts) : '–°–∫–æ—Ä–æ',
            available: priceGifts !== null && typeof priceGifts === 'number',
            price: priceGifts
          }
        ];

        methodsList.innerHTML = paymentMethods.map(method => `
          <div class="rounded-lg border ${method.available ? 'border-violet-400/30 bg-black/30 cursor-pointer hover:border-violet-400/50 hover:bg-black/40' : 'border-gray-600/30 bg-black/20 cursor-not-allowed opacity-60'} p-4 transition-all" 
               ${method.available ? `onclick="window.selectPaymentMethod('${method.id}')"` : ''}>
            <div class="flex items-center gap-3">
              <div class="text-3xl">${method.icon}</div>
              <div class="flex-1">
                <div class="font-semibold text-white">${method.name}</div>
                <div class="text-sm ${method.available ? 'text-gray-400' : 'text-gray-500'}">${method.description}</div>
              </div>
              ${method.available ? '<div class="text-violet-400 text-xl">‚Üí</div>' : '<div class="text-gray-500 text-sm">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</div>'}
            </div>
          </div>
        `).join('');

        modal.classList.remove('hidden');
        document.body.classList.add('modal-open');
      }

      // –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
      async function selectPaymentMethod(methodId) {
        if (!currentPurchaseItem) return;

        const { category, itemId, item } = currentPurchaseItem;
        const paymentModal = document.getElementById('payment-method-modal');

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
        if (paymentModal) {
          paymentModal.classList.add('hidden');
          document.body.classList.remove('modal-open');
        }

        try {
          if (methodId === 'stars') {
            await processStarsPayment(category, itemId, item);
          } else if (methodId === 'ton') {
            await processTONPayment(category, itemId, item);
          } else if (methodId === 'gifts') {
            await processGiftsPayment(category, itemId, item);
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–ø–ª–∞—Ç—ã:', error);
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–ø–ª–∞—Ç—ã');
        }
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ Telegram Stars
      async function processStarsPayment(category, itemId, item) {
        // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –≤ Stars
        const price = item.priceStars || item.price || 0;
        if (price <= 0) {
          alert('‚ùå –¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞');
          return;
        }
        
        // –°–æ–∑–¥–∞–µ–º invoice —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ –±–æ—Ç–∞
        try {
          console.log(`üìã –°–æ–∑–¥–∞–Ω–∏–µ —Å—á–µ—Ç–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏: ${item.name}, —Ü–µ–Ω–∞: ${price} ‚≠ê`);
          const response = await window.fetchJSON('/api/payment/create-stars-invoice', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              title: item.name,
              description: `–ü–æ–∫—É–ø–∫–∞: ${item.name}`,
              amount: price,
              user_id: currentUserId,
              category: category,
              item_id: itemId
            })
          });
          
          // –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
          console.log('üìã –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ–ª—É—á–µ–Ω (—Å—ã—Ä–æ–π):', response);
          console.log('üìã –¢–∏–ø response:', typeof response);
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
          if (!response) {
            console.error('‚ùå –ù–µ –ø–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞: –Ω–µ –ø–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.');
            return;
          }
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ response - –æ–±—ä–µ–∫—Ç
          if (typeof response !== 'object') {
            console.error('‚ùå –û—Ç–≤–µ—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º:', response);
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.');
            return;
          }
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º success (–º–æ–∂–µ—Ç –±—ã—Ç—å true, 'true', 1, –∏ —Ç.–¥.)
          const isSuccess = response.success === true || 
                           response.success === 'true' || 
                           response.success === 1 ||
                           (typeof response.success === 'string' && response.success.toLowerCase() === 'true');
          
          console.log('üìã response.success:', response.success);
          console.log('üìã response.success === true:', response.success === true);
          console.log('üìã isSuccess (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞):', isSuccess);
          console.log('üìã JSON –æ—Ç–≤–µ—Ç–∞:', JSON.stringify(response));
          
          if (isSuccess) {
            // –°—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –±–æ—Ç–∞, —É–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            console.log('‚úÖ –°—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω! –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.');
            alert('‚úÖ –°—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É ' + price + ' ‚≠ê –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –±–æ—Ç–∞!\n\n–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º, —á—Ç–æ–±—ã –æ–ø–ª–∞—Ç–∏—Ç—å –ø–æ–∫—É–ø–∫—É. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Ç–æ–≤–∞—Ä –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.');
            return;
          }
          
          // –ï—Å–ª–∏ success –Ω–µ true, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
          const errorMsg = response.message || response.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á–µ—Ç–∞. –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response);
          console.error('‚ùå response.success =', response.success, '(—Ç–∏–ø:', typeof response.success, ')');
          console.error('‚ùå –ü–æ–ª–Ω—ã–π response:', JSON.stringify(response, null, 2));
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞: ' + String(errorMsg));
          return;
          
        } catch (error) {
          console.error('‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ invoice:', error);
          console.error('‚ùå –¢–∏–ø –æ—à–∏–±–∫–∏:', typeof error);
          console.error('‚ùå error.message:', error.message);
          console.error('‚ùå error.response:', error.response);
          console.error('‚ùå –ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:', JSON.stringify(error, Object.getOwnPropertyNames(error)));
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ (–±–µ–∑–æ–ø–∞—Å–Ω–æ, –±–µ–∑ eval)
          let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
          
          if (error && typeof error === 'object') {
            if (error.message && typeof error.message === 'string') {
              errorMessage = error.message;
            } else if (error.response && typeof error.response === 'object') {
              // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∏–∑ response
              if (error.response.detail && typeof error.response.detail === 'string') {
                errorMessage = error.response.detail;
              } else if (error.response.message && typeof error.response.message === 'string') {
                errorMessage = error.response.message;
              }
            } else if (error.detail && typeof error.detail === 'string') {
              errorMessage = error.detail;
            }
          }
          
          // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞
          if (!errorMessage.includes('–°—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω') && !errorMessage.includes('—É—Å–ø–µ—à–Ω–æ')) {
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞: ' + String(errorMessage));
          }
        }
        
        // Fallback –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∫–æ–≥–¥–∞ WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
        if (!window.Telegram?.WebApp?.openInvoice) {
          // Fallback: —Å–∏–º—É–ª–∏—Ä—É–µ–º –ø–æ–∫—É–ø–∫—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∫–æ–≥–¥–∞ WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
          if (confirm(`–ö—É–ø–∏—Ç—å "${item.name}" –∑–∞ ${price} ‚≠ê?\n\n(–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º: Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)`)) {
            // –í —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ —Å—Ä–∞–∑—É –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã
            addPurchasedItem(category, itemId);
            alert(`‚úÖ ${item.name} —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω! (–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)`);
            renderShop();
            updateThemeSelector();
          }
        }
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ TON
      async function processTONPayment(category, itemId, item) {
        // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –≤ TON
        const tonAmount = item.priceTON || 0;
        if (tonAmount <= 0) {
          alert('‚ùå –¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞');
          return;
        }
        
        // –°–æ–∑–¥–∞–µ–º —Å—á–µ—Ç —á–µ—Ä–µ–∑ CryptoBot API
        try {
          const response = await window.fetchJSON('/api/payment/create-invoice', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              amount: tonAmount,
              currency: 'TON',
              description: `–ü–æ–∫—É–ø–∫–∞: ${item.name}`,
              user_id: currentUserId,
              category: category,
              item_id: itemId
            })
          });
          
          if (!response.success || !response.invoice_url) {
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            return;
          }
          
          // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ Telegram WebApp
          if (window.Telegram?.WebApp?.openLink) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Telegram WebApp API –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å—Å—ã–ª–∫–∏
            window.Telegram.WebApp.openLink(response.invoice_url);
          } else {
            // Fallback –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞
            window.open(response.invoice_url, '_blank');
          }
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
          alert(`‚úÖ –°—á–µ—Ç —Å–æ–∑–¥–∞–Ω!\n\nüí≥ –°—É–º–º–∞: ${tonAmount} TON\nüë§ –°—á–µ—Ç –¥–ª—è –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ (ID: ${currentUserId})\n\n–û—Ç–∫—Ä–æ–π—Ç–µ CryptoBot –¥–ª—è –æ–ø–ª–∞—Ç—ã.\n–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Ç–æ–≤–∞—Ä –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.`);
          
          // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã
          const invoiceId = response.invoice_id;
          let checkCount = 0;
          const maxChecks = 60; // –ü—Ä–æ–≤–µ—Ä—è–µ–º 60 —Ä–∞–∑ (5 –º–∏–Ω—É—Ç)
          
          const checkInterval = setInterval(async () => {
            checkCount++;
            
            try {
              const verifyResponse = await window.fetchJSON('/api/payment/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  invoice_id: invoiceId,
                  category: category,
                  itemId: itemId,
                  userId: currentUserId
                })
              });
              
              if (verifyResponse.verified) {
                clearInterval(checkInterval);
                addPurchasedItem(category, itemId);
                alert(`‚úÖ ${item.name} —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω!`);
                renderShop();
                updateThemeSelector();
              } else if (checkCount >= maxChecks) {
                clearInterval(checkInterval);
                alert('‚è± –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ–ø–ª–∞—Ç—ã –∏—Å—Ç–µ–∫–ª–æ. –ï—Å–ª–∏ –≤—ã –æ–ø–ª–∞—Ç–∏–ª–∏, —Ç–æ–≤–∞—Ä –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.');
              }
            } catch (error) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã:', error);
              if (checkCount >= maxChecks) {
                clearInterval(checkInterval);
              }
            }
          }, 5000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
          
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á–µ—Ç–∞:', error);
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ NFT Gifts
      async function processGiftsPayment(category, itemId, item) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–Ω—ã –ª–∏ Gifts –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
        if (item.priceGifts === null || typeof item.priceGifts !== 'number') {
          alert('‚ùå –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ NFT Gifts –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞');
          return;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º ID –∫—Ä–µ–∞—Ç–æ—Ä–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–¥–∞—Ä–∫–∞
        try {
          const response = await window.fetchJSON('/api/payment/get-creator-id');
          const creatorId = response.creator_id || '';
          
          if (!creatorId) {
            alert('‚ùå ID –∫—Ä–µ–∞—Ç–æ—Ä–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.');
            return;
          }

          // –î–ª—è Gifts –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π API Telegram
          // –°–æ–∑–¥–∞–µ–º invoice –¥–ª—è Gifts
          const invoice = {
            title: item.name,
            description: `–ü–æ–∫—É–ø–∫–∞: ${item.name} (NFT –ø–æ–¥–∞—Ä–æ–∫)`,
            payload: JSON.stringify({ category, itemId, userId: currentUserId, paymentMethod: 'gifts', creatorId: creatorId }),
            provider_token: '', // –î–ª—è Gifts
            currency: 'XTR', // Gifts –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ Stars
            prices: [{ label: item.name, amount: item.priceGifts * 100 }], // –í –∫–æ–ø–µ–π–∫–∞—Ö Stars
            max_tip_amount: 0,
            suggested_tip_amounts: [],
            start_parameter: `shop_${category}_${itemId}_gifts`,
            provider_data: JSON.stringify({ category, itemId, paymentMethod: 'gifts', creatorId: creatorId })
          };

          // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–ª–∞—Ç–µ–∂–Ω–æ–µ –æ–∫–Ω–æ Telegram –¥–ª—è Gifts
          if (window.Telegram?.WebApp?.openInvoice) {
            window.Telegram.WebApp.openInvoice(invoice, async (status) => {
              if (status === 'paid') {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–ª–∞—Ç—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                const verified = await verifyPayment(category, itemId, 'gifts', invoice.payload);
                if (verified) {
                  addPurchasedItem(category, itemId);
                  alert(`‚úÖ ${item.name} —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω! –ü–æ–¥–∞—Ä–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫—Ä–µ–∞—Ç–æ—Ä—É.`);
                  renderShop();
                  updateThemeSelector();
                } else {
                  alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –æ–ø–ª–∞—Ç—ã. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.');
                }
              } else if (status === 'failed') {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ');
              }
            });
          } else {
            // Fallback: —Å–∏–º—É–ª–∏—Ä—É–µ–º –ø–æ–∫—É–ø–∫—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∫–æ–≥–¥–∞ WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
            if (confirm(`–ö—É–ø–∏—Ç—å "${item.name}" –∑–∞ ${item.priceGifts} ‚≠ê (NFT Gifts)?\n\n(–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º: Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)`)) {
              // –í —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ —Å—Ä–∞–∑—É –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã
              addPurchasedItem(category, itemId);
              alert(`‚úÖ ${item.name} —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω! (–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)`);
              renderShop();
              updateThemeSelector();
            }
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è ID –∫—Ä–µ–∞—Ç–æ—Ä–∞:', error);
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–ø–ª–∞—Ç—ã');
        }
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
      async function verifyPayment(invoiceId, category, itemId, userId) {
        try {
          const response = await window.fetchJSON('/api/payment/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              invoice_id: invoiceId,
              category: category,
              itemId: itemId,
              userId: userId
            })
          });
          return response.verified === true;
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã:', error);
          return false;
        }
      }

      // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –º–∞–≥–∞–∑–∏–Ω–∞
      function renderShop() {
        const purchased = getPurchasedItems();

        // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–µ–º—ã
        const themesContainer = document.getElementById('themes-shop');
        if (themesContainer) {
          themesContainer.innerHTML = shopItems.themes.map(item => {
            const isPurchased = isItemPurchased('themes', item.id);
            return `
              <div class="rounded-lg border ${isPurchased ? 'border-green-400/50 bg-green-900/20' : 'border-violet-400/30 bg-black/30'} p-4">
                <div class="flex items-center gap-4">
                  <div class="text-4xl">${item.icon}</div>
                  <div class="flex-1">
                    <div class="font-semibold text-white mb-1">${item.name}</div>
                    <div class="text-sm text-gray-400 mb-2">${item.description}</div>
                    <div class="text-xs text-violet-400">
                      ${item.priceMonkeyCoins ? `${item.priceMonkeyCoins} Monkey Coins` : ''}
                    </div>
                  </div>
                  <button 
                    onclick="window.purchaseItem('themes', '${item.id}')"
                    class="px-4 py-2 rounded-lg text-sm font-semibold ${isPurchased ? 'bg-green-600/50 text-green-200 cursor-not-allowed' : 'neon-button'}"
                    ${isPurchased ? 'disabled' : ''}
                  >
                    ${isPurchased ? '‚úì –ö—É–ø–ª–µ–Ω–æ' : '–ö—É–ø–∏—Ç—å'}
                  </button>
                </div>
              </div>
            `;
          }).join('');
        }
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ —Ç–µ–º —Å –∫—É–ø–ª–µ–Ω–Ω—ã–º–∏ —Ç–µ–º–∞–º–∏
      function updateThemeSelector() {
        const purchased = getPurchasedItems();
        const purchasedThemes = purchased.themes || [];

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–Ω–¥–µ—Ä —Ç–µ–º –≤ –º–æ–¥–∞–ª–∫–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–º—ã
        const themesList = document.getElementById('themes-list');
        if (themesList) {
          const currentTheme = localStorage.getItem('selectedTheme') || 'default';
          themesList.innerHTML = '';
          
          // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–º—É "–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é"
          const defaultTheme = themes.default;
          if (defaultTheme) {
            const isActive = 'default' === currentTheme;
            const themeCard = document.createElement('div');
            themeCard.className = `rounded-lg border p-4 cursor-pointer transition-all ${
              isActive 
                ? 'border-violet-400 bg-violet-500/20' 
                : 'border-violet-400/30 bg-black/30 hover:border-violet-400/50 hover:bg-black/40'
            }`;
            themeCard.innerHTML = `
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="text-3xl">${defaultTheme.icon}</div>
                  <div>
                    <div class="font-semibold text-white">${defaultTheme.name}</div>
                    <div class="text-sm text-gray-400">${defaultTheme.description}</div>
                  </div>
                </div>
                ${isActive ? '<div class="text-violet-400 text-xl">‚úì</div>' : ''}
              </div>
            `;
            
            themeCard.addEventListener('click', () => {
              applyTheme('default');
              updateThemeSelector();
              const themeModal = document.getElementById('theme-selector-modal');
              if (themeModal) {
                setTimeout(() => {
                  themeModal.classList.add('hidden');
                  document.body.classList.remove('modal-open');
                }, 300);
              }
            });
            
            themesList.appendChild(themeCard);
          }
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫—É–ø–ª–µ–Ω–Ω—ã–µ —Ç–µ–º—ã
          purchasedThemes.forEach(themeId => {
            const theme = shopItems.themes.find(t => t.id === themeId);
            if (theme) {
              const isActive = themeId === currentTheme;
              const themeCard = document.createElement('div');
              themeCard.className = `rounded-lg border p-4 cursor-pointer transition-all ${
                isActive 
                  ? 'border-violet-400 bg-violet-500/20' 
                  : 'border-violet-400/30 bg-black/30 hover:border-violet-400/50 hover:bg-black/40'
              }`;
              themeCard.innerHTML = `
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="text-3xl">${theme.icon}</div>
                    <div>
                      <div class="font-semibold text-white">${theme.name}</div>
                      <div class="text-sm text-gray-400">${theme.description}</div>
                    </div>
                  </div>
                  ${isActive ? '<div class="text-violet-400 text-xl">‚úì</div>' : ''}
                </div>
              `;
              
              themeCard.addEventListener('click', () => {
                applyTheme(themeId);
                updateThemeSelector();
                const themeModal = document.getElementById('theme-selector-modal');
                if (themeModal) {
                  setTimeout(() => {
                    themeModal.classList.add('hidden');
                    document.body.classList.remove('modal-open');
                  }, 300);
                }
              });
              
              themesList.appendChild(themeCard);
            }
          });
        }
      }

      // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
      window.purchaseItem = purchaseItem;
      window.selectPaymentMethod = selectPaymentMethod;

      // üí∞ –°–∏—Å—Ç–µ–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ Monkey Coins
      let currentTopupMethod = null;

      // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
      function openTopupModal() {
        const modal = document.getElementById('topup-coins-modal');
        const nav = document.getElementById('user-nav');
        if (modal) {
          modal.classList.remove('hidden');
          document.body.classList.add('modal-open');
          // –°–∫—Ä—ã–≤–∞–µ–º –Ω–∏–∂–Ω—é—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é - –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
          if (nav) {
            nav.classList.add('hidden');
            nav.style.display = 'none';
            nav.style.visibility = 'hidden';
            nav.style.opacity = '0';
            nav.style.pointerEvents = 'none';
          }
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          currentTopupMethod = null;
          document.getElementById('topup-amount-section').classList.add('hidden');
          document.getElementById('topup-amount-input').value = '';
        }
      }

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
      function closeTopupModal() {
        const modal = document.getElementById('topup-coins-modal');
        const nav = document.getElementById('user-nav');
        if (modal) {
          modal.classList.add('hidden');
          document.body.classList.remove('modal-open');
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∏–∂–Ω—é—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é –æ–±—Ä–∞—Ç–Ω–æ
          if (nav) {
            nav.classList.remove('hidden');
            nav.style.display = 'flex';
            nav.style.visibility = 'visible';
            nav.style.opacity = '1';
            nav.style.pointerEvents = 'auto';
          }
          currentTopupMethod = null;
          document.getElementById('topup-amount-section').classList.add('hidden');
          document.getElementById('topup-amount-input').value = '';
        }
      }

      // –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
      function selectTopupMethod(method) {
        currentTopupMethod = method;
        const amountSection = document.getElementById('topup-amount-section');
        const amountInput = document.getElementById('topup-amount-input');
        const amountLabel = document.getElementById('topup-amount-label');
        const conversionInfo = document.getElementById('topup-conversion-info');
        
        // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤
        document.querySelectorAll('[id^="topup-method-"]').forEach(el => {
          el.classList.remove('border-violet-400', 'bg-violet-500/20', 'ring-2', 'ring-violet-400');
          el.classList.add('border-violet-400/30', 'bg-black/30');
        });
        
        // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥
        const selectedMethod = document.getElementById(`topup-method-${method}`);
        if (selectedMethod) {
          selectedMethod.classList.add('border-violet-400', 'bg-violet-500/20', 'ring-2', 'ring-violet-400');
          selectedMethod.classList.remove('border-violet-400/30', 'bg-black/30');
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Å—É–º–º—ã
        amountSection.classList.remove('hidden');
        amountInput.value = '';
        amountInput.focus();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –º–µ—Ç–æ–¥–∞
        if (method === 'stars') {
          amountLabel.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥:';
          amountInput.placeholder = '–ù–∞–ø—Ä–∏–º–µ—Ä: 100';
          conversionInfo.textContent = '1 ‚≠ê = 1 Monkey Coin';
        } else if (method === 'cryptobot') {
          amountLabel.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ TON:';
          amountInput.placeholder = '–ù–∞–ø—Ä–∏–º–µ—Ä: 1';
          conversionInfo.textContent = '1 TON = 100 Monkey Coins';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ
        amountInput.oninput = function() {
          const amount = parseFloat(this.value) || 0;
          if (method === 'stars') {
            conversionInfo.textContent = `${amount} ‚≠ê = ${amount} Monkey Coins`;
          } else if (method === 'cryptobot') {
            conversionInfo.textContent = `${amount} TON = ${amount * 100} Monkey Coins`;
          }
        };
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
      async function processTopupPayment() {
        if (!currentTopupMethod) {
          alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã');
          return;
        }

        const amountInput = document.getElementById('topup-amount-input');
        const amount = parseFloat(amountInput.value) || 0;

        if (amount <= 0) {
          alert('‚ùå –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –±–æ–ª—å—à–µ 0');
          return;
        }

        try {
          if (currentTopupMethod === 'stars') {
            // –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Telegram Stars
            const response = await window.fetchJSON('/api/topup/create-stars-invoice', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                amount: amount,
                user_id: currentUserId
              })
            });

            if (response?.success) {
              closeTopupModal();
              // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è (–ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã)
              setTimeout(() => {
                updateCoinsDisplay();
              }, 5000);
              alert(`‚úÖ –°—á–µ—Ç –Ω–∞ ${amount} ‚≠ê –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –±–æ—Ç–∞!\n\n–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º, —á—Ç–æ–±—ã –æ–ø–ª–∞—Ç–∏—Ç—å. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –±–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.`);
            } else {
              const errorMsg = response?.detail || response?.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞';
              alert(`‚ùå ${errorMsg}`);
            }
          } else if (currentTopupMethod === 'cryptobot') {
            // –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ CryptoBot
            const monkeyCoinsAmount = amount * 100; // 1 TON = 100 Monkey Coins
            
            const response = await window.fetchJSON('/api/topup/create-invoice', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                amount: amount,
                currency: 'TON',
                user_id: currentUserId,
                monkey_coins: monkeyCoinsAmount
              })
            });

            if (response?.success) {
              closeTopupModal();
              // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è (–ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã)
              setTimeout(() => {
                updateCoinsDisplay();
              }, 5000);
              if (response.invoice_url) {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É
                window.open(response.invoice_url, '_blank');
                alert(`‚úÖ –°—á–µ—Ç –Ω–∞ ${amount} TON —Å–æ–∑–¥–∞–Ω!\n\n–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –±–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.`);
              } else {
                alert(`‚úÖ –°—á–µ—Ç –Ω–∞ ${amount} TON —Å–æ–∑–¥–∞–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–æ—Ç–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã.`);
              }
            } else {
              const errorMsg = response?.detail || response?.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞';
              alert(`‚ùå ${errorMsg}`);
            }
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞:', error);
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
      (function initTopupHandlers() {
        const addCoinsBtn = document.getElementById('add-coins-btn');
        const closeTopupModalBtn = document.getElementById('close-topup-modal');
        const topupPayBtn = document.getElementById('topup-pay-btn');

        if (addCoinsBtn) {
          addCoinsBtn.addEventListener('click', openTopupModal);
        }

        if (closeTopupModalBtn) {
          closeTopupModalBtn.addEventListener('click', closeTopupModal);
        }

        if (topupPayBtn) {
          topupPayBtn.addEventListener('click', processTopupPayment);
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª–∫–∏
        const topupModal = document.getElementById('topup-coins-modal');
        if (topupModal) {
          topupModal.addEventListener('click', function(e) {
            if (e.target === topupModal) {
              closeTopupModal();
            }
          });
        }
      })();

      // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ
      window.openTopupModal = openTopupModal;
      window.closeTopupModal = closeTopupModal;
      window.selectTopupMethod = selectTopupMethod;
      window.processTopupPayment = processTopupPayment;
      window.renderShop = renderShop;
      window.updateThemeSelector = updateThemeSelector;

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª–∫–∏ –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
      function initPaymentMethodModal() {
        const modal = document.getElementById('payment-method-modal');
        const closeBtn = document.getElementById('close-payment-modal');
        
        if (closeBtn) {
          closeBtn.addEventListener('click', () => {
            if (modal) {
              modal.classList.add('hidden');
              document.body.classList.remove('modal-open');
            }
            currentPurchaseItem = null;
          });
        }

        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.classList.add('hidden');
              document.body.classList.remove('modal-open');
              currentPurchaseItem = null;
            }
          });
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞–≥–∞–∑–∏–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–µ–∫—Ü–∏–∏
      function initShop() {
        renderShop();
        initPaymentMethodModal();
      }

      // –í–´–ó–´–í–ê–ï–ú –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Æ –ü–û–°–õ–ï –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –í–°–ï–• –§–£–ù–ö–¶–ò–ô
      console.log('‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã, –∑–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é');
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–º—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          loadTheme();
          setTimeout(initThemeSelector, 100);
          setTimeout(initShop, 200);
        });
      } else {
        loadTheme();
        setTimeout(initThemeSelector, 100);
        setTimeout(initShop, 200);
      }
      
      startInit();
    })();
  </script>
</body>
</html>
